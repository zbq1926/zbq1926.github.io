<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <title>管理后台</title>
    <script data-cfasync="false" src="https://cdn.jsdelivr.net/npm/@keeex/qrcodejs-kx@1.0.2/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&family=Orbitron:wght@700;800;900&display=swap"
        rel="stylesheet">
    <style>
        /* 基础重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden
        }

        /* 通用动画 */
        @keyframes blurOverlayAppear {
            0% {
                opacity: 0;
                -webkit-backdrop-filter: blur(0px);
                backdrop-filter: blur(0px);
            }

            100% {
                opacity: 1;
                -webkit-backdrop-filter: blur(12px);
                backdrop-filter: blur(12px);
            }
        }

        @keyframes containerAppear {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.9)
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1)
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0)
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-5px)
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(5px)
            }
        }

        @keyframes gradientShift {
            0% {
                background-position: 0 50%
            }

            50% {
                background-position: 100% 50%
            }

            100% {
                background-position: 0 50%
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg)
            }

            to {
                transform: rotate(360deg)
            }
        }

        /* 背景和遮罩层 */
        #background-iframe {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
            z-index: -3 !important
        }

        #blur-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0, rgba(118, 75, 162, 0.15) 100%);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            z-index: -2 !important;
            animation: blurOverlayAppear 1.5s ease-out forwards .3s;
            pointer-events: none;
            opacity: 0
        }

        /* 通用容器包装器 */
        .page-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1 !important;
            padding: 20px;
            overflow-y: auto
        }

        /* 通用卡片容器 */
        .card-container {
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            padding: 50px 40px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            width: 100%;
            animation: containerAppear 1s ease-out .8s backwards;
            position: relative;
            overflow: hidden
        }

        .card-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #faab41 0, #f6821f 50%, #faab41 100%);
            background-size: 200% 100%;
            animation: gradientShift 3s ease infinite
        }

        /* 页面标题和图标 */
        .page-header {
            margin-bottom: 35px;
            text-align: center
        }

        .page-icon {
            width: 70px;
            height: 70px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #faab41 0, #f6821f 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            animation: fadeIn .8s ease-out 1s backwards
        }

        .page-icon svg {
            width: 36px;
            height: 36px;
            fill: white
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #faab41 0, #f6821f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 0 12px;
            line-height: 1.2;
            letter-spacing: -0.5px
        }

        .page-subtitle {
            font-size: 16px;
            color: #6b7280;
            margin: 0;
            line-height: 1.5;
            font-weight: 400
        }

        /* 表单样式 */
        .page-form {
            display: flex;
            flex-direction: column;
            margin-top: 35px
        }

        .form-group {
            margin-bottom: 24px;
            text-align: left;
            position: relative
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            letter-spacing: .3px
        }

        .input-wrapper {
            position: relative
        }

        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            opacity: .4;
            pointer-events: none;
            transition: opacity .3s ease
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid #e5e7eb !important;
            border-radius: 12px;
            font-size: 16px;
            color: #1f2937 !important;
            background-color: #fff !important;
            box-sizing: border-box;
            transition: all .3s ease;
            -webkit-appearance: none;
            appearance: none;
            font-family: inherit
        }

        .form-group input.with-icon {
            padding-left: 48px
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: 0 !important;
            border-color: #faab41 !important;
            box-shadow: 0 0 0 4px rgba(250, 171, 65, 0.1) !important
        }

        .form-group input:focus+.input-icon {
            opacity: .7
        }

        .form-group input:disabled,
        .form-group select:disabled {
            background-color: #f3f4f6 !important;
            color: #9ca3af !important;
            cursor: not-allowed;
            opacity: 1
        }

        .form-group input[readonly] {
            background-color: #f9fafb !important;
            color: #6b7280 !important
        }

        .form-group textarea {
            resize: vertical;
            min-height: 382px;
            font-family: 'Monaco', 'Courier New', monospace
        }

        /* 按钮样式 */
        .btn {
            padding: 10px 20px;
            border: 0;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            cursor: pointer;
            transition: all .3s ease;
            box-sizing: border-box;
            -webkit-appearance: none;
            appearance: none;
            letter-spacing: .5px;
            position: relative;
            overflow: hidden
        }

        .btn-primary {
            background: linear-gradient(135deg, #faab41 0, #f6821f 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4)
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left .5s ease
        }

        .btn-primary:hover::before {
            left: 100%
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5)
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.4)
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151
        }

        .btn-secondary:hover {
            background: #d1d5db
        }

        .btn-search-proxy {
            background: linear-gradient(135deg, #8b5cf6 0, #6d28d9 100%);
            color: #fff !important;
            padding: 10px 16px;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
            transition: all 0.3s ease;
        }

        .btn-search-proxy:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.5);
        }

        .btn-search-proxy:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(139, 92, 246, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none
        }

        .btn-group {
            display: flex;
            gap: 10px
        }

        /* 页脚提示 */
        .footer-hint {
            margin-top: 30px;
            font-size: 13px;
            color: #9ca3af;
            animation: fadeIn 1s ease-out 1.5s backwards;
            text-align: center
        }

        .footer-hint a {
            color: #faab41;
            text-decoration: none;
            font-weight: 500;
            transition: color .3s ease
        }

        .footer-hint a:hover {
            color: #f6821f
        }

        /* HOSTS badge 样式 */
        .hosts-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: #fff;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
            transition: all 0.3s ease;
        }

        .hosts-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        html.dark-mode .hosts-badge {
            background: linear-gradient(135deg, #1E88E5 0%, #1565C0 100%);
            box-shadow: 0 2px 8px rgba(30, 136, 229, 0.4);
        }

        html.dark-mode .hosts-badge:hover {
            box-shadow: 0 4px 12px rgba(30, 136, 229, 0.5);
        }

        /* HOSTS 警告按钮样式 */
        .btn-hosts-warning {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%) !important;
            color: #fff !important;
            border: 2px solid #b71c1c !important;
            font-weight: 700 !important;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4) !important;
            transition: all 0.3s ease !important;
        }

        .btn-hosts-warning:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 16px rgba(244, 67, 54, 0.5) !important;
            background: linear-gradient(135deg, #e53935 0%, #c62828 100%) !important;
        }

        .btn-hosts-warning:active {
            transform: translateY(0) !important;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3) !important;
        }

        html.dark-mode .btn-hosts-warning {
            background: linear-gradient(135deg, #ef5350 0%, #e53935 100%) !important;
            border-color: #c62828 !important;
            box-shadow: 0 4px 12px rgba(239, 83, 80, 0.4) !important;
        }

        html.dark-mode .btn-hosts-warning:hover {
            box-shadow: 0 6px 16px rgba(239, 83, 80, 0.5) !important;
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%) !important;
        }

        /* Toast 通知 */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            z-index: 10000000;
            transform: translateX(100%);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            max-width: 300px;
            word-wrap: break-word
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1
        }

        .toast-success {
            background: linear-gradient(135deg, #10b981 0, #059669 100%);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3)
        }

        .toast-error {
            background: linear-gradient(135deg, #ef4444 0, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3)
        }

        .toast-info {
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3)
        }

        /* 消息提示 */
        .message {
            margin-top: 24px;
            font-size: 14px;
            line-height: 1.5;
            padding: 14px 18px;
            border-radius: 12px;
            font-weight: 500;
            animation: slideIn .3s ease-out
        }

        .message-success {
            background: linear-gradient(135deg, #10b981 0, #059669 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3)
        }

        .message-error {
            background: linear-gradient(135deg, #ef4444 0, #dc2626 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            animation: shake .5s ease-in-out, slideIn .3s ease-out
        }

        /* 模态框 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000000000;
            justify-content: center;
            align-items: center
        }

        .modal-overlay.show {
            display: flex
        }

        .modal {
            background: #fff;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 95%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            z-index: 2000000001;
            position: relative;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        #qrcodeModal .modal {
            background: #808080;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #9ca3af
        }

        .modal-close:hover {
            color: #1f2937
        }

        /* SOCKS5 模态框样式 */
        #exploreSocks5Modal .modal {
            max-width: 550px;
        }

        .socks5-list-container {
            width: 100%;
        }

        .socks5-loading-info {
            display: none;
            padding: 12px;
            background: rgba(255, 193, 7, 0.1);
            border-left: 3px solid #ffc107;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
            margin: 12px 0;
        }

        html.dark-mode .socks5-loading-info {
            background: rgba(255, 193, 7, 0.15);
            color: #ccc;
            border-left-color: #ffb300;
        }

        /* 社交链接 - 重构为统一风格 */
        .social-links {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            padding: 20px 0;
            border-top: 1px solid rgba(0, 0, 0, 0.08)
        }

        .social-text {
            font-size: 14px;
            color: #666;
            margin-right: 10px
        }

        .social-link {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(249, 250, 251, 0.9) 100%);
            border: 1px solid rgba(229, 231, 235, 0.8);
            border-radius: 12px;
            color: #6b7280;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04)
        }

        .social-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(250, 171, 65, 0) 0%, rgba(246, 130, 31, 0) 100%);
            opacity: 0;
            transition: opacity 0.35s ease;
            border-radius: 11px
        }

        .social-link:hover {
            transform: translateY(-4px) scale(1.05);
            border-color: rgba(250, 171, 65, 0.5);
            box-shadow: 0 8px 24px rgba(250, 171, 65, 0.25), 0 4px 12px rgba(246, 130, 31, 0.15);
            color: #f6821f
        }

        .social-link:hover::before {
            opacity: 0.08
        }

        .social-link:active {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 12px rgba(250, 171, 65, 0.2)
        }

        .social-link svg {
            width: 22px;
            height: 22px;
            position: relative;
            z-index: 1;
            transition: transform 0.35s ease
        }

        .social-link:hover svg {
            transform: scale(1.08)
        }

        /* 主题图标特殊样式 */
        .social-link.theme-toggle .theme-icon {
            transition: all 0.35s ease
        }

        .social-link.theme-toggle:hover .sun-icon {
            color: #faab41
        }

        .social-link.theme-toggle:hover .moon-icon {
            color: #7c3aed
        }

        /* GitHub图标样式 */
        .social-link[title="GitHub"]:hover {
            color: #1f2937;
            border-color: rgba(31, 41, 55, 0.4);
            box-shadow: 0 8px 24px rgba(31, 41, 55, 0.2), 0 4px 12px rgba(31, 41, 55, 0.1)
        }

        .social-link[title="GitHub"]:hover::before {
            background: linear-gradient(135deg, rgba(31, 41, 55, 0.05) 0%, rgba(31, 41, 55, 0.02) 100%);
            opacity: 1
        }

        /* Telegram图标样式 */
        .social-link[title="Telegram"]:hover {
            border-color: rgba(42, 171, 238, 0.4);
            box-shadow: 0 8px 24px rgba(42, 171, 238, 0.25), 0 4px 12px rgba(34, 158, 217, 0.15)
        }

        .social-link[title="Telegram"]:hover::before {
            background: linear-gradient(135deg, rgba(42, 171, 238, 0.08) 0%, rgba(34, 158, 217, 0.04) 100%);
            opacity: 1
        }

        /* 返回顶部图标样式 */
        .social-link[title="返回顶部"]:hover {
            color: #10b981;
            border-color: rgba(16, 185, 129, 0.4);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.25), 0 4px 12px rgba(5, 150, 105, 0.15)
        }

        .social-link[title="返回顶部"]:hover::before {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(5, 150, 105, 0.04) 100%);
            opacity: 1
        }

        /* 复选框样式 */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            padding: 0;
            border: 2px solid #e5e7eb;
            border-radius: 4px;
            -webkit-appearance: none;
            appearance: none;
            position: relative;
            transition: all 0.3s ease;
            background-color: #fff
        }

        .checkbox-group input[type="checkbox"]:hover {
            border-color: #faab41
        }

        .checkbox-group input[type="checkbox"]:checked {
            background: linear-gradient(135deg, #faab41 0, #f6821f 100%);
            border-color: #faab41
        }

        .checkbox-group input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 2px;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg)
        }

        .checkbox-group input[type="checkbox"]:disabled {
            background-color: #f3f4f6;
            border-color: #d1d5db;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .checkbox-group input[type="checkbox"]:disabled:hover {
            border-color: #d1d5db;
        }

        .checkbox-label {
            font-size: 14px;
            color: #374151;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
        }

        .checkbox-row {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .checkbox-row .form-group {
            margin-bottom: 0;
            display: flex !important;
            grid-template-columns: unset !important;
            gap: unset !important;
        }

        .checkbox-row .form-group[style*="display: none"] {
            display: none !important;
        }

        /* 响应式设计 - 平板 */
        @media(max-width:768px) {
            .checkbox-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .page-wrapper {
                padding: 20px 16px;
                padding-top: 20px;
                padding-bottom: 20px;
                justify-content: flex-start;
                align-items: center
            }

            .card-container {
                padding: 40px 28px;
                border-radius: 20px;
                max-width: 100%;
                margin-top: auto;
                margin-bottom: auto
            }

            .page-icon {
                width: 60px;
                height: 60px;
                border-radius: 16px;
                margin-bottom: 16px
            }

            .page-icon svg {
                width: 30px;
                height: 30px
            }

            .page-title {
                font-size: 26px;
                margin-bottom: 10px
            }

            .page-subtitle {
                font-size: 15px
            }

            .page-form {
                margin-top: 28px
            }

            .form-group {
                margin-bottom: 20px
            }

            .form-group label {
                font-size: 13px;
                margin-bottom: 8px
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 14px;
                font-size: 16px;
                border-radius: 10px
            }

            .form-group input.with-icon {
                padding-left: 44px
            }

            .input-icon {
                left: 14px;
                width: 18px;
                height: 18px
            }

            .btn {
                padding: 15px 20px;
                font-size: 15px;
                border-radius: 10px
            }

            .message {
                margin-top: 20px;
                font-size: 13px;
                padding: 12px 16px;
                border-radius: 10px
            }

            .footer-hint {
                margin-top: 24px;
                font-size: 12px
            }
        }

        /* 响应式设计 - 手机 */
        @media(max-width:480px) {
            .page-wrapper {
                padding: 12px;
                justify-content: flex-start;
                align-items: center
            }

            .card-container {
                padding: 35px 24px;
                border-radius: 18px;
                margin-top: auto;
                margin-bottom: auto
            }

            .page-icon {
                width: 55px;
                height: 55px;
                border-radius: 14px
            }

            .page-icon svg {
                width: 28px;
                height: 28px
            }

            .page-title {
                font-size: 24px
            }

            .page-subtitle {
                font-size: 14px
            }
        }

        /* 响应式设计 - 横屏 */
        @media(max-height:600px) and (orientation:landscape) {
            .page-wrapper {
                padding: 20px;
                justify-content: flex-start;
                align-items: center
            }

            .card-container {
                padding: 30px 35px;
                margin-top: auto;
                margin-bottom: auto
            }

            .page-icon {
                width: 50px;
                height: 50px;
                margin-bottom: 12px
            }

            .page-icon svg {
                width: 26px;
                height: 26px
            }

            .page-title {
                font-size: 22px;
                margin-bottom: 8px
            }

            .page-subtitle {
                font-size: 13px
            }

            .page-form {
                margin-top: 20px
            }

            .form-group {
                margin-bottom: 16px
            }

            .footer-hint {
                margin-top: 16px
            }
        }

        /* 夜间模式 */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: rgba(255, 255, 255, 0.95);
            --text-primary: #1f2937;
            --text-secondary: #666;
            --border-color: #e5e7eb;
            --border-light: rgba(255, 255, 255, 0.1);
            --input-bg: #f3f4f6;
            --input-border: #e5e7eb;
            --overlay-bg: rgba(255, 255, 255, 0.7);
            --blur-overlay: rgba(0, 0, 0, 0.3);
            --latency-49: #4CAF50;
            --latency-149: #83DA00;
            --latency-299: #f58722;
            --latency-999: #ff404a;
            --latency-1000: #c40003;
        }

        html.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #0f0d0a;
            --text-primary: #e5e5e5;
            --text-secondary: #a0a0a0;
            --border-color: #333333;
            --border-light: rgba(255, 255, 255, 0.1);
            --input-bg: #2a2a2a;
            --input-border: #444444;
            --overlay-bg: rgba(32, 32, 32, 0.7);
            --blur-overlay: rgba(0, 0, 0, 0.8)
        }

        html.dark-mode body {
            background: linear-gradient(135deg, #1a1a1a 0, #2a2a2a 50%, #1a1a1a 100%) !important;
            color: var(--text-primary)
        }

        html.dark-mode #blur-overlay {
            background: var(--blur-overlay)
        }

        html.dark-mode .card-container {
            color: var(--text-primary)
        }

        html.dark-mode .page-wrapper {
            background: transparent
        }

        html.dark-mode .header {
            background: rgba(39, 39, 39, 0.95);
            border-image: linear-gradient(90deg, #7c3aed 0, #5b21b6 50%, #7c3aed 100%) 1
        }

        html.dark-mode .module {
            background: rgba(39, 39, 39, 0.95);
            color: var(--text-primary)
        }

        html.dark-mode .module-title {
            color: var(--text-primary)
        }

        html.dark-mode .form-group input:not([type="checkbox"]),
        html.dark-mode .form-group select,
        html.dark-mode .form-group textarea {
            background: var(--input-bg) !important;
            color: var(--text-primary) !important;
            border-color: var(--input-border) !important
        }

        html.dark-mode .form-group input:not([type="checkbox"])::placeholder,
        html.dark-mode .form-group textarea::placeholder {
            color: var(--text-secondary) !important
        }

        html.dark-mode .form-group input:not([type="checkbox"]):focus,
        html.dark-mode .form-group select:focus,
        html.dark-mode .form-group textarea:focus {
            border-color: #7c3aed !important;
            box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1) !important
        }

        html.dark-mode .form-group input:not([type="checkbox"]):disabled,
        html.dark-mode .form-group select:disabled {
            background-color: var(--input-bg) !important;
            color: var(--text-secondary) !important
        }

        html.dark-mode .form-group input:not([type="checkbox"])[readonly] {
            background-color: var(--input-bg) !important;
            color: var(--text-secondary) !important
        }

        html.dark-mode .module .form-group input,
        html.dark-mode .module .form-group select,
        html.dark-mode .module .form-group textarea {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--input-border)
        }

        html.dark-mode .module .form-group input::placeholder,
        html.dark-mode .module .form-group textarea::placeholder {
            color: var(--text-secondary)
        }

        html.dark-mode .modal-overlay {
            background: var(--blur-overlay)
        }

        html.dark-mode .modal {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-color)
        }

        html.dark-mode #qrcodeModal .modal {
            background: #808080;
        }

        html.dark-mode .modal input,
        html.dark-mode .modal select,
        html.dark-mode .modal textarea {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--input-border)
        }

        html.dark-mode .form-group label {
            color: var(--text-primary) !important
        }

        html.dark-mode .card-container {
            color: var(--text-primary);
        }

        html.dark-mode .modal-close {
            color: var(--text-primary)
        }

        html.dark-mode .page-header {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-image: linear-gradient(90deg, #7c3aed 0, #5b21b6 50%, #7c3aed 100%) 1 !important
        }

        html.dark-mode .page-title {
            color: var(--text-primary) !important
        }

        html.dark-mode .page-subtitle {
            color: var(--text-secondary) !important
        }

        html.dark-mode table {
            color: var(--text-primary)
        }

        html.dark-mode thead {
            background: #2a2a2a !important
        }

        html.dark-mode thead th {
            background: #2a2a2a !important;
            color: var(--text-primary) !important;
            border-color: #333333 !important
        }

        html.dark-mode tbody tr {
            border-color: #333333
        }

        html.dark-mode tbody td {
            color: var(--text-primary)
        }

        html.dark-mode .social-links {
            border-top-color: rgba(255, 255, 255, 0.1)
        }

        html.dark-mode .social-link {
            background: linear-gradient(135deg, rgba(42, 42, 42, 0.95) 0%, rgba(34, 34, 34, 0.9) 100%);
            border-color: rgba(75, 75, 75, 0.6);
            color: #e5e7eb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), 0 1px 2px rgba(0, 0, 0, 0.15)
        }

        html.dark-mode .social-link:hover {
            color: #ffffff;
            border-color: rgba(124, 58, 237, 0.6);
            box-shadow: 0 8px 24px rgba(124, 58, 237, 0.3), 0 4px 12px rgba(91, 33, 182, 0.2)
        }

        html.dark-mode .social-link::before {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.08) 0%, rgba(91, 33, 182, 0.04) 100%)
        }

        html.dark-mode .social-link.theme-toggle:hover .moon-icon {
            color: #a78bfa
        }

        html.dark-mode .social-link[title="GitHub"]:hover {
            color: #ffffff;
            border-color: rgba(229, 231, 235, 0.4);
            box-shadow: 0 8px 24px rgba(229, 231, 235, 0.15), 0 4px 12px rgba(229, 231, 235, 0.1)
        }

        html.dark-mode .social-link[title="Telegram"]:hover {
            border-color: rgba(42, 171, 238, 0.5);
            box-shadow: 0 8px 24px rgba(42, 171, 238, 0.3), 0 4px 12px rgba(34, 158, 217, 0.2)
        }

        html.dark-mode .social-link[title="返回顶部"]:hover {
            color: #34d399;
            border-color: rgba(52, 211, 153, 0.5);
            box-shadow: 0 8px 24px rgba(52, 211, 153, 0.3), 0 4px 12px rgba(16, 185, 129, 0.2)
        }

        html.dark-mode .btn-secondary {
            background: var(--input-bg) !important;
            color: var(--text-primary) !important;
            border-color: var(--input-border) !important
        }

        html.dark-mode .btn-qrcode {
            background: linear-gradient(135deg, #0891b2 0, #065f73 100%) !important;
            color: #fff !important;
            box-shadow: 0 4px 15px rgba(8, 145, 178, 0.3) !important;
        }

        html.dark-mode .btn-mode-toggle {
            background: #f3f4f6;
            color: #1f2937;
            box-shadow: 0 4px 15px rgba(243, 244, 246, 0.3);
        }

        html.dark-mode .btn-mode-toggle:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(243, 244, 246, 0.4);
        }

        html.dark-mode .btn-mode-toggle:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(243, 244, 246, 0.3);
        }

        html.dark-mode .checkbox-group input[type="checkbox"] {
            border-color: var(--border-color);
            background: var(--input-bg)
        }

        html.dark-mode .checkbox-group input[type="checkbox"]:checked {
            background: linear-gradient(135deg, #7c3aed 0, #5b21b6 100%);
            border-color: #7c3aed
        }

        html.dark-mode .loading {
            border-color: rgba(124, 58, 237, 0.3);
            border-top-color: #7c3aed
        }

        html.dark-mode .message {
            animation: slideIn .3s ease-out
        }

        html.dark-mode .success-message {
            background: linear-gradient(135deg, #059669 0, #047857 100%)
        }

        html.dark-mode .error-message {
            background: linear-gradient(135deg, #dc2626 0, #b91c1c 100%)
        }

        html.dark-mode .collapse-btn {
            color: #7c3aed
        }

        html.dark-mode .collapse-btn:hover {
            color: #9f7aea
        }

        html.dark-mode .collapse-section {
            border-left-color: #7c3aed;
            color: var(--text-primary)
        }

        html.dark-mode .module-footer {
            border-color: rgba(255, 255, 255, 0.1)
        }

        html.dark-mode .readonly-wrapper input[readonly] {
            background-color: var(--input-bg) !important;
            border-color: var(--input-border) !important;
            color: var(--text-primary) !important;
        }

        html.dark-mode .readonly-wrapper input[readonly]:hover {
            border-color: #7c3aed;
            background-color: var(--input-bg);
        }

        html.dark-mode .subapi-input {
            background-color: var(--input-bg) !important;
            color: var(--text-primary) !important;
        }

        html.dark-mode .form-group input[readonly].subapi-input {
            background-color: var(--input-bg) !important;
            color: var(--text-primary) !important;
        }

        html.dark-mode .input-icon {
            opacity: 0.6
        }

        html.dark-mode .module-title {
            color: var(--text-primary) !important
        }

        html.dark-mode .module-title .collapse-icon {
            fill: var(--text-secondary)
        }

        html.dark-mode .footer-hint {
            color: var(--text-secondary) !important
        }

        html.dark-mode .footer-hint a {
            color: #7c3aed !important
        }

        html.dark-mode .footer-hint a:hover {
            color: #9f7aea !important
        }

        .theme-icon {
            transition: transform 0.3s ease
        }

        .social-link.theme-toggle:hover .theme-icon {
            transform: rotate(20deg)
        }

        .social-link.theme-toggle {
            font-size: 0;
            line-height: 0
        }

        .theme-icon {
            width: 20px;
            height: 20px;
            display: block !important;
            transition: all 0.3s ease
        }

        .sun-icon {
            display: none !important;
            opacity: 0
        }

        .moon-icon {
            display: block !important;
            opacity: 1
        }

        html.dark-mode .sun-icon {
            display: block !important;
            opacity: 1
        }

        html.dark-mode .moon-icon {
            display: none !important;
            opacity: 0
        }

        .page-wrapper {
            justify-content: flex-start;
            align-items: flex-start
        }

        .card-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0;
            background: transparent !important;
            box-shadow: none !important
        }

        .card-container::before {
            display: none
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            padding: 25px 30px;
            border-radius: 16px;
            border-top: 4px solid;
            border-image: linear-gradient(90deg, #faab41 0, #f6821f 50%, #faab41 100%) 1
        }

        .header-title h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #faab41 0, #f6821f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0
        }

        .header-buttons {
            display: flex;
            gap: 12px
        }

        .header .btn {
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 8px
        }

        .module {
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 4px 4px 8px -3px rgba(0, 0, 0, 0.12);
            transition: box-shadow 280ms cubic-bezier(.2, .9, .2, 1), transform 220ms ease;
            will-change: transform
        }

        .module:hover,
        .module:focus-within {
            box-shadow: 0 8px 16px -2px rgba(0, 0, 0, 0.14), 0 0 12px rgba(250, 171, 65, 0.08);
            transform: translateY(-4px)
        }

        .module-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #1f2937;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            gap: 10px;
        }

        .module-title .collapse-icon {
            width: 24px;
            height: 24px;
            transition: transform 0.28s;
            fill: #666;
            flex-shrink: 0;
        }

        .module.collapsed .collapse-icon {
            transform: rotate(90deg)
        }

        /* 网络信息模块的折叠图标 */
        #network-module-content~.module-title .collapse-icon,
        .module-title .collapse-icon {
            transition: transform 0.3s ease;
        }

        .module-content {
            display: block;
            /* overflow: hidden; */
            max-height: 2000px;
            opacity: 1;
            transition: max-height 320ms cubic-bezier(.2, .8, .2, 1), opacity 220ms ease
        }

        .module.collapsed .module-content {
            max-height: 0;
            opacity: 0
        }

        .module .form-group,
        #portSection {
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 20px;
            align-items: center;
            text-align: left
        }

        .module .form-group label {
            display: block
        }

        .module .form-group input,
        .module .form-group select,
        .module .form-group textarea {
            padding: 8px 8px;
            border-radius: 8px
        }

        .module .input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .module .input-wrapper input {
            flex: 1
        }

        .readonly-wrapper {
            position: relative;
        }

        .proxy-input-wrapper {
            flex: 1;
        }

        .readonly-wrapper input[readonly] {
            cursor: pointer;
            background-color: #fff !important;
            border: 2px solid #e5e7eb !important;
            color: #1f2937 !important;
            width: 100%;
        }

        .readonly-wrapper input[readonly]:hover {
            border-color: #faab41;
            background-color: #fff;
        }

        .readonly-wrapper input[readonly]:focus {
            outline: 0 !important;
            border-color: #faab41 !important;
            box-shadow: 0 0 0 4px rgba(250, 171, 65, 0.1) !important;
        }

        .copy-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer
        }

        .module-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb
        }

        .module-footer .btn-group {
            margin-left: auto;
        }

        .collapse-section {
            margin-top: 15px;
            border-left: 3px solid #faab41;
            padding-left: 20px
        }

        .collapse-btn {
            background: none;
            border: none;
            color: #faab41;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease
        }

        .collapse-btn:hover {
            color: #f6821f
        }

        .success-message,
        .error-message {
            display: none;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 500;
            animation: slideIn 0.3s ease
        }

        .success-message {
            background: linear-gradient(135deg, #10b981 0, #059669 100%);
            color: #fff
        }

        .error-message {
            background: linear-gradient(135deg, #ef4444 0, #dc2626 100%);
            color: #fff
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #faab41;
            border-top-color: transparent;
            border-radius: 50%;
            animation: rotate 0.6s linear infinite
        }

        @media(max-width:768px) {
            .optimize-params-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .card-container {
                padding: 20px;
                margin: 0
            }

            .header {
                flex-direction: column;
                gap: 15px;
                padding: 20px;
                margin-bottom: 20px
            }

            .module {
                padding: 20px;
                margin-bottom: 20px
            }

            .module .form-group {
                grid-template-columns: 1fr;
                gap: 10px
            }

            .header-buttons {
                width: 100%;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px
            }

            .btn-mode-toggle {
                grid-column: 1 / -1;
            }

            .header-buttons .btn {
                width: 100%;
            }
        }

        @media(max-width:768px) {
            .module-footer {
                flex-direction: column;
                align-items: flex-start;
            }

            .module-footer .btn-group {
                margin-left: auto;
                width: auto;
                align-self: flex-end;
            }

            .module-footer .btn-ech-help,
            .module-footer .btn-proxyip-help,
            .module-footer .btn-search-proxy {
                width: 100%;
                margin-bottom: 10px;
            }

            .ech-tabs::-webkit-scrollbar {
                height: 3px;
            }

            .ech-tab {
                padding: 7px 12px;
                font-size: 12px;
            }

            .ech-tab-content {
                min-height: 80px;
                max-height: calc(100vh - 220px);
            }
        }

        @media(max-width:480px) {
            .card-container {
                padding: 15px
            }

            .ech-tabs::-webkit-scrollbar {
                height: 2px;
            }

            .ech-tab {
                padding: 6px 10px;
                font-size: 11px;
            }

            .ech-tab-content {
                min-height: 60px;
                max-height: calc(100vh - 240px);
            }
        }

        @media(max-height:600px) and (orientation:landscape) {
            .card-container {
                padding: 15px
            }
        }

        /* 自定义按钮样式 */
        .btn-mode-toggle {
            background: #1f2937;
            color: #fff;
            box-shadow: 0 4px 15px rgba(31, 41, 55, 0.4);
            transition: all 0.3s ease;
        }

        .btn-mode-toggle:hover {
            background: #111827;
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(31, 41, 55, 0.5);
        }

        .btn-mode-toggle:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(31, 41, 55, 0.4);
        }

        .btn-reset {
            background: linear-gradient(135deg, #ef4444 0, #dc2626 100%);
            color: #fff;
        }

        .btn-all-logs {
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            flex-shrink: 0;
        }

        .btn-online-optimize {
            background: linear-gradient(135deg, #10b981 0, #059669 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-online-optimize:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.5);
        }

        .btn-online-optimize:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(16, 185, 129, 0.4);
        }

        .btn-close-modal {
            width: 100%;
            margin-top: 20px;
        }

        .btn-confirm-reset {
            background: linear-gradient(135deg, #ef4444 0, #dc2626 100%);
            color: #fff;
        }

        .btn-test-api {
            flex: 2;
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            color: #fff;
        }

        .btn-confirm-api {
            flex: 1;
            opacity: 0.5;
        }

        .btn-confirm-api:not([disabled]) {
            opacity: 1;
        }

        .btn-cancel-api {
            flex: 1;
        }

        .btn-qrcode {
            background: linear-gradient(135deg, #06b6d4 0, #0891b2 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
        }

        .btn-qrcode:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(6, 182, 212, 0.5);
        }

        .btn-qrcode:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(6, 182, 212, 0.4);
        }

        .btn-api-optimize {
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-api-optimize:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
        }

        .btn-api-optimize:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.4);
        }

        /* API优选模态框样式 */
        .api-optimize-modal {
            overflow-y: auto;
            width: 90vw;
            max-width: 600px;
            margin: 0 auto;
            max-height: 90vh;
        }

        .api-optimize-modal-title {
            margin-bottom: 20px;
        }

        .api-form-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .api-form-row {
            display: grid;
            grid-template-columns: 80px 1fr;
            gap: 10px;
            align-items: center;
        }

        .api-form-row label {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .api-form-row input {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            font-size: 14px;
        }

        .api-results-container {
            margin: 20px 0;
        }

        .api-results-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            text-align: left;
        }

        .api-results-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            height: 200px;
            background-color: #f9fafb;
            color: #1f2937;
            resize: vertical;
            overflow-y: auto;
        }

        .api-buttons {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            margin-top: 20px;
        }

        .btn-verify-api {
            background: linear-gradient(135deg, #10b981 0, #059669 100%);
            color: #fff;
            flex: 1;
        }

        .btn-verify-api:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.5);
        }

        .btn-append-api {
            background: linear-gradient(135deg, #f59e0b 0, #d97706 100%);
            color: #fff;
            opacity: 0.5;
            pointer-events: none;
        }

        .btn-append-api:not([disabled]) {
            opacity: 1;
            pointer-events: all;
        }

        .btn-append-api:hover:not([disabled]) {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(245, 158, 11, 0.5);
        }

        .btn-append-results {
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            color: #fff;
            opacity: 0.5;
            pointer-events: none;
        }

        .btn-append-results:not([disabled]) {
            opacity: 1;
            pointer-events: all;
        }

        .btn-append-results:hover:not([disabled]) {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
        }

        .btn-close-api {
            background: linear-gradient(135deg, #e5e7eb 0, #d1d5db 100%);
            color: #374151;
        }

        .btn-close-api:hover {
            background: linear-gradient(135deg, #d1d5db 0, #b3b8be 100%);
        }

        .btn-proxyip-help {
            background: linear-gradient(135deg, #10b981 0, #059669 100%);
            color: #fff !important;
            padding: 10px 16px;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
        }

        .btn-proxyip-help:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.5);
        }

        .btn-proxyip-help:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(16, 185, 129, 0.4);
        }

        .btn-fofa {
            background: linear-gradient(135deg, #439aff 0, #05f2f2 100%);
            color: #fff !important;
            padding: 10px 16px;
            font-size: 14px;
            box-shadow: 0 4px 15px rgb(67, 154, 255, 0.3);
            transition: all 0.3s ease;
        }

        .btn-fofa:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(5, 244, 244, 0.5);
        }

        .btn-fofa:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(5, 244, 244, 0.4);
        }

        .btn-360quake {
            background: linear-gradient(135deg, #00AB7A 0, #00AB7A 100%);
            color: #fff !important;
            padding: 10px 16px;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(0, 171, 122, 0.3);
            transition: all 0.3s ease;
        }

        .btn-360quake:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 171, 122, 0.5);
        }

        .btn-360quake:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 171, 122, 0.4);
        }

        .btn-ech-help {
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            color: #fff !important;
            padding: 10px 16px;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }

        .btn-ech-help:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
        }

        .btn-ech-help:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.4);
        }

        .proxyip-help-modal {
            max-width: 1200px;
            width: 90vw;
            max-height: 100vh;
            overflow-y: auto;
        }

        .ech-help-modal {
            max-width: 1200px;
            width: 90vw;
            max-height: 100vh;
            overflow-y: auto;
        }

        .api-docs {
            text-align: left;
        }

        .api-docs h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            margin-top: 0;
        }

        .api-docs h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 20px 0 12px;
        }

        .api-docs p {
            font-size: 14px;
            line-height: 1.8;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .api-docs a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .api-docs a:hover {
            text-decoration: underline;
        }

        .code-block {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
            padding: 12px;
            border-radius: 4px;
            margin: 12px 0;
            font-size: 13px;
            line-height: 1.6;
            font-family: 'Monaco', 'Courier New', monospace;
            overflow-x: auto;
        }

        .simple-explanation {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
            padding: 16px;
            border-radius: 4px;
            margin: 16px 0;
            font-size: 14px;
            line-height: 1.8;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .toggle-switch input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .toggle-switch label {
            cursor: pointer;
            margin: 0;
            font-weight: 600;
            -webkit-user-select: none;
            user-select: none;
        }

        html.dark-mode .code-block {
            background: #2a2a2a;
            color: #ffd699;
            border-left-color: #ffc107;
        }

        html.dark-mode .simple-explanation {
            background: #1b4620;
            color: #81c784;
            border-left-color: #4caf50;
        }

        html.dark-mode .btn-proxyip-help {
            background: linear-gradient(135deg, #10b981 0, #059669 100%);
            color: #fff !important;
        }

        html.dark-mode .btn-proxyip-help:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.5);
        }

        html.dark-mode .btn-ech-help {
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            color: #fff !important;
        }

        html.dark-mode .btn-ech-help:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
        }

        html.dark-mode .api-optimize-modal {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        html.dark-mode .ech-help-modal {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        html.dark-mode .api-form-row label {
            color: var(--text-primary);
        }

        html.dark-mode .api-form-row input {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--input-border);
        }

        html.dark-mode .api-results-label {
            color: var(--text-primary);
        }

        html.dark-mode .api-results-textarea {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--input-border);
        }

        html.dark-mode .btn-api-optimize {
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            color: #fff;
        }

        html.dark-mode .btn-verify-api {
            background: linear-gradient(135deg, #10b981 0, #059669 100%);
            color: #fff;
        }

        html.dark-mode .btn-append-api {
            background: linear-gradient(135deg, #f59e0b 0, #d97706 100%);
            color: #fff;
        }

        html.dark-mode .btn-append-results {
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            color: #fff;
        }

        html.dark-mode .btn-close-api {
            background: var(--input-bg);
            color: var(--text-primary);
        }

        html.dark-mode .btn-close-api:hover {
            background: var(--border-color);
        }

        /* 隐藏元素 */
        .hidden-section {
            display: none;
        }

        /* 简单模式 - 隐藏高级模块 */
        .advanced-module {
            transition: opacity 0.4s ease-in-out, max-height 0.5s ease-in-out, transform 0.4s ease-in-out, margin 0.5s ease-in-out, padding 0.5s ease-in-out, border-width 0.5s ease-in-out;
            transform-origin: top;
            overflow: hidden;
            transform: scaleY(1);
            opacity: 1;
        }

        .simple-mode .advanced-module {
            opacity: 0;
            max-height: 0;
            transform: scaleY(0.95);
            margin-top: 0;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
            border-width: 0;
            pointer-events: none;
        }

        /* Cloudflare 配置部分样式 */
        #cloudflareEmailSection,
        #cloudflareAccountIDSection {
            display: none;
        }

        /* QRCode 容器 */
        .qrcode-container {
            margin: 30px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 350px;
            background: #808080;
        }

        /* 重置配置弹窗 */
        .reset-modal-title {
            color: #ef4444;
            margin-bottom: 15px;
        }

        .reset-modal-description {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .reset-modal-confirm {
            color: #ef4444;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .reset-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }

        /* 日志容器 */
        .logs-container {
            margin-bottom: 20px;
        }

        .logs-loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }

        .logs-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
        }

        .logs-footer-text {
            font-size: 12px;
            color: #9ca3af;
            margin: 0;
        }

        /* 日志模态框 */
        .logs-modal {
            overflow-y: auto;
            width: 90vw;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logs-modal-title {
            margin-bottom: 20px;
        }

        .logs-all-container {
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: auto;
        }

        /* 订阅 API 弹窗 */
        .subapi-modal-title {
            margin-bottom: 20px;
        }

        .subapi-form-group {
            grid-template-columns: 1fr;
        }

        .subapi-status {
            margin: 15px 0;
            padding: 12px 16px;
            border-radius: 8px;
            display: none;
        }

        .subapi-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* 输入字段特殊样式 */
        .subapi-input {
            cursor: pointer !important;
            background-color: #fff !important;
            color: #1f2937 !important;
        }

        /* 节点链接输入包装器 */
        .link-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .link-input-field {
            flex: 1;
        }

        /* 在线优选模态框样式 */
        .optimize-modal {
            overflow-y: auto;
            width: 90vw;
            max-width: 960px;
            margin: 0 auto;
            max-height: 90vh;
        }

        .optimize-modal-title {
            margin-bottom: 20px;
        }

        .ip-detection-box {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(6, 182, 212, 0.05) 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 20px;
        }

        .optimize-params-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-end;
        }

        .optimize-concurrency-input {
            width: 100%;
            max-width: none;
        }

        @media (max-width: 768px) {
            .optimize-params-row {
                grid-template-columns: 1fr;
            }
        }

        .ip-detection-info {
            font-size: 14px;
            color: #374151;
            line-height: 1.6;
        }

        .ip-detection-warning {
            color: #ef4444;
            font-size: 12px;
            margin-top: 8px;
            line-height: 1.5;
        }

        .optimize-progress-bar {
            width: 100%;
            height: 30px;
            background: #4b5563;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            margin: 20px 0;
        }

        .optimize-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: width 0.3s ease, background 0.3s ease;
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 15px;
        }

        .optimize-progress-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 13px;
            font-weight: 700;
            z-index: 1;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .optimize-results-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .optimize-tab {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .optimize-tab:hover {
            border-color: #10b981;
        }

        .optimize-tab.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #10b981;
        }

        .optimize-results-content {
            background: #f9fafb;
            border-radius: 8px;
            padding: 15px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.1;
            text-align: left;
        }

        .ech-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 15px;
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            cursor: grab;
            user-select: none;
            -webkit-user-select: none;
        }

        .ech-tabs.dragging {
            cursor: grabbing;
        }

        .ech-tabs::-webkit-scrollbar {
            height: 4px;
        }

        .ech-tabs::-webkit-scrollbar-track {
            background: transparent;
        }

        .ech-tabs::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 2px;
        }

        .ech-tabs::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .ech-tab {
            padding: 8px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
            pointer-events: auto;
        }

        .ech-tab:hover {
            border-color: #3b82f6;
        }

        .ech-tab.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border-color: #3b82f6;
        }

        .ech-tab-content {
            background: #f9fafb;
            border-radius: 8px;
            padding: 15px;
            min-height: 100px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .ech-tab-pane {
            display: none;
        }

        .ech-tab-pane.active {
            display: block;
        }

        .optimize-result-item {
            padding: 1px 0;
            color: #1f2937;
            text-align: left;
        }

        .optimize-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 8px;
        }

        .btn-start-optimize {
            background: linear-gradient(135deg, #10b981 0, #059669 100%);
            color: #fff;
        }

        .btn-save-override,
        .btn-save-append {
            opacity: 0.5;
            pointer-events: none;
        }

        .btn-save-override:not([disabled]),
        .btn-save-append:not([disabled]) {
            opacity: 1;
            pointer-events: all;
        }

        .save-tip {
            font-size: 12px;
            color: #7a7f88;
            font-weight: normal;
            display: flex;
            align-items: center;
            min-height: 32px;
            margin-right: auto;
        }

        .btn-save-override {
            background: linear-gradient(135deg, #f59e0b 0, #d97706 100%);
            color: #fff;
        }

        .btn-save-append {
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            color: #fff;
        }

        html.dark-mode .ip-detection-box {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
            border-color: rgba(59, 130, 246, 0.3);
        }

        html.dark-mode .ip-detection-info {
            color: var(--text-primary);
        }

        html.dark-mode .optimize-progress-bar {
            background: #1f2937;
        }

        html.dark-mode .optimize-tab {
            background: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        html.dark-mode .optimize-tab.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        html.dark-mode .optimize-results-content {
            background: var(--input-bg);
        }

        html.dark-mode .optimize-result-item {
            color: var(--text-primary);
        }

        html.dark-mode .ech-tab {
            background: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        html.dark-mode .ech-tab.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }

        html.dark-mode .ech-tab-content {
            background: var(--input-bg);
        }

        html.dark-mode .ech-tabs::-webkit-scrollbar-thumb {
            background: #4b5563;
        }

        html.dark-mode .ech-tabs::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* 消息通知设置样式 */
        .notification-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px !important;
            padding: 2px 0;
        }

        .notification-row>label:first-child {
            display: flex;
            align-items: center;
            gap: 70px;
            margin: 0 !important;
            white-space: nowrap;
            flex: 1;
        }

        .notification-row>label:first-child .checkbox-group {
            display: flex;
            margin: 0;
            white-space: nowrap;
            gap: 6px;
        }

        .notification-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: auto;
            flex-shrink: 0;
        }

        .notification-controls .btn {
            flex-shrink: 0;
            font-size: 14px;
        }

        .btn-notification-config {
            background: linear-gradient(135deg, #8b5cf6 0, #7c3aed 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-notification-config::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left .5s ease
        }

        .btn-notification-config:hover::before {
            left: 100%
        }

        .btn-notification-config:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.5);
        }

        .btn-notification-config:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(139, 92, 246, 0.3);
        }

        .btn-clear-config {
            background: linear-gradient(135deg, #ef4444 0, #dc2626 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-clear-config::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left .5s ease
        }

        .btn-clear-config:hover::before {
            left: 100%
        }

        .btn-clear-config:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(239, 68, 68, 0.5);
        }

        .btn-clear-config:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(239, 68, 68, 0.3);
        }

        html.dark-mode .btn-clear-config {
            background: linear-gradient(135deg, #ef4444 0, #dc2626 100%);
            color: #fff;
        }

        /* Telegram 按钮状态样式 */
        .btn-clear-config.btn-configured {
            background: linear-gradient(135deg, #ef4444 0, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            cursor: pointer;
            opacity: 1;
        }

        .btn-clear-config.btn-not-configured {
            background: linear-gradient(135deg, #d1d5db 0, #9ca3af 100%);
            box-shadow: 0 4px 15px rgba(209, 213, 219, 0.3);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .btn-clear-config.btn-not-configured:hover {
            transform: none;
            box-shadow: 0 4px 15px rgba(209, 213, 219, 0.3);
        }

        /* ==================== CF 使用统计模块样式 ==================== */

        .cf-usage-module {
            display: none;
        }

        .cf-usage-module[style*="display: block"] {
            display: block !important;
        }

        .cf-usage-wrapper {
            padding: 20px 0;
        }

        /* 统计卡片 */
        .cf-stats-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            border-left: 4px solid #3b82f6;
        }

        .cf-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
        }

        .cf-stat-item {
            display: flex;
            flex-direction: column;
        }

        .cf-stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .cf-stat-value {
            font-size: 24px;
            font-weight: 700;
        }

        .cf-value-green {
            color: #10b981;
        }

        .cf-value-blue {
            color: #3b82f6;
        }

        .cf-value-orange {
            color: #f59e0b;
        }

        .cf-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .cf-progress-title {
            font-size: 13px;
            font-weight: 600;
            color: #1f2937;
        }

        .cf-percentage-badge {
            font-size: 13px;
            font-weight: 600;
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
        }

        .cf-progress-bar {
            position: relative;
            height: 28px;
            background: linear-gradient(90deg, #9ca3af 0%, #6b7280 100%);
            border-radius: 14px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .cf-bar-segment {
            position: absolute;
            height: 100%;
            border-radius: 0;
            width: 0%;
            transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            font-size: 11px;
            font-weight: 700;
            color: white;
        }

        .cf-bar-green {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.5);
            justify-content: flex-end;
            padding-right: 12px;
            opacity: 0.9;
        }

        .cf-bar-blue {
            background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.5);
            justify-content: center;
            opacity: 0.85;
        }

        .cf-percentage-center {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* 信息提示框 */
        .cf-info-box {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.05) 0%, rgba(234, 179, 8, 0.05) 100%);
            border: 1px solid rgba(249, 115, 22, 0.2);
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 0;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .cf-info-icon {
            font-size: 16px;
            flex-shrink: 0;
        }

        .cf-info-text {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.6;
        }

        .cf-info-text strong {
            color: #1f2937;
        }

        .cf-highlight {
            color: #f59e0b !important;
        }

        /* 倒计时数字样式 */
        .countdown-numbers {
            color: #f59e0b;
            font-weight: bold;
        }

        /* 倒计时文字样式 */
        .countdown-text {
            color: #6b7280;
        }

        /* 响应式布局：桌面端隐藏换行符，移动端显示 */
        @media (min-width: 768px) {
            .cf-info-text br {
                display: none;
            }

            .cf-info-text {
                white-space: nowrap;
            }
        }

        @media (max-width: 767px) {
            .cf-info-text br {
                display: block;
            }

            .cf-info-text {
                white-space: normal;
            }
        }

        /* ==================== 深色模式支持 ==================== */

        html.dark-mode .cf-stats-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(6, 182, 212, 0.2) 100%);
            border-left-color: #3b82f6;
        }

        html.dark-mode .cf-stat-label {
            color: var(--text-secondary);
        }

        html.dark-mode .cf-progress-title {
            color: var(--text-primary);
        }

        html.dark-mode .cf-percentage-badge {
            color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }

        html.dark-mode .cf-progress-bar {
            background: linear-gradient(90deg, #111827 0%, #0f172a 100%);
        }

        html.dark-mode .cf-percentage-center {
            color: white;
        }

        html.dark-mode .cf-info-box {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.1) 0%, rgba(234, 179, 8, 0.1) 100%);
            border-color: rgba(249, 115, 22, 0.3);
        }

        html.dark-mode .cf-info-text {
            color: var(--text-secondary);
        }

        html.dark-mode .cf-info-text strong {
            color: var(--text-primary);
        }

        html.dark-mode .cf-highlight {
            color: #fbbf24 !important;
        }

        /* 深色模式倒计时数字样式 */
        html.dark-mode .countdown-numbers {
            color: #fbbf24;
            font-weight: bold;
        }

        /* 深色模式倒计时文字样式 */
        html.dark-mode .countdown-text {
            color: #9ca3af;
        }

        html.dark-mode .qrcode-container {
            background: #808080;
        }

        /* 网络信息卡片样式 */
        .port-info {
            margin-top: 30px;
            padding: 0 20px;
        }

        .port-info>h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        html.dark-mode .port-info>h3 {
            color: #e0e0e0;
        }

        .network-cards-container {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 16px;
            margin-bottom: 10px;
            margin-top: 2px;
        }


        .network-card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }

        html.dark-mode .network-card-title {
            color: #e0e0e0;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: none;
        }

        .status-indicator.status-loading {
            background-color: #ffa500;
            box-shadow: 0 0 5px #ffa500;
            animation: pulse 1.5s infinite;
        }

        .status-indicator.status-success {
            background-color: #4caf50;
            box-shadow: 0 0 5px #4caf50;
        }

        .status-indicator.status-error {
            background-color: #f44336;
            box-shadow: 0 0 5px #f44336;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .network-info-content {
            padding-left: 20px;
        }

        .ip-text {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            word-break: break-all;
            margin-bottom: 8px;
            cursor: default;
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }

        html.dark-mode .ip-text {
            color: #ffffff;
        }

        .ip-text.clickable {
            cursor: pointer;
            color: #2196F3;
        }

        .ip-text.clickable:hover {
            color: #1976D2;
        }

        html.dark-mode .ip-text.clickable {
            color: #64B5F6;
        }

        html.dark-mode .ip-text.clickable:hover {
            color: #90CAF9;
        }

        .ip-text .error {
            color: #f44336;
            font-size: 14px;
        }

        .location-text {
            display: flex;
            gap: 15px;
            margin-bottom: 8px;
            font-size: 14px;
            color: #666;
            min-width: 0;
        }

        .country-text {
            color: var(--text-color-secondary);
            font-size: 0.875rem;
            white-space: nowrap;
            flex-shrink: 0;
        }

        html.dark-mode .location-text {
            color: #b0b0b0;
        }

        .country-text,
        .city-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }

        .network-tip {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }

        html.dark-mode .network-tip {
            color: #999;
        }

        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* IP 详情弹窗样式 */
        .ip-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000000001;
            padding: 20px;
            overflow-y: auto;
        }

        .ip-detail-content {
            background: white;
            border-radius: 12px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        html.dark-mode .ip-detail-content {
            background: #2c2c2c;
            color: #e0e0e0;
        }

        .ip-detail-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            transition: color 0.2s;
        }

        .ip-detail-close:hover {
            color: #f44336;
        }

        html.dark-mode .ip-detail-close {
            color: #b0b0b0;
        }

        .ip-detail-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        html.dark-mode .ip-detail-title {
            color: #ffffff;
        }

        .ip-detail-source {
            font-size: 12px;
            color: #999;
            font-weight: 400;
        }

        html.dark-mode .ip-detail-source {
            color: #999;
        }

        .ip-detail-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 20px;
        }

        html.dark-mode .ip-detail-section {
            border-bottom-color: #444;
        }

        .ip-detail-section:last-child {
            border-bottom: none;
        }

        .ip-detail-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }

        html.dark-mode .ip-detail-section-title {
            color: #e0e0e0;
        }

        .ip-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 14px;
        }

        .ip-detail-label {
            color: #666;
            font-weight: 500;
            min-width: 120px;
        }

        html.dark-mode .ip-detail-label {
            color: #b0b0b0;
        }

        .ip-detail-value {
            text-align: right;
            color: #333;
            flex: 1;
            word-break: break-all;
        }

        html.dark-mode .ip-detail-value {
            color: #e0e0e0;
        }

        .ip-detail-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        .badge-success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .badge-info {
            background-color: #e3f2fd;
            color: #1565c0;
        }

        .badge-warning {
            background-color: #fff3e0;
            color: #e65100;
        }

        .badge-danger {
            background-color: #ffebee;
            color: #c62828;
        }

        .badge-high {
            background-color: #ffe0b2;
            color: #e65100;
        }

        .badge-critical {
            background-color: #ffcdd2;
            color: #b71c1c;
        }

        .badge-elevated {
            background-color: #fff9c4;
            color: #f57f17;
        }

        .badge-low {
            background-color: #c8e6c9;
            color: #1b5e20;
        }

        .badge-verylow {
            background-color: #a5d6a7;
            color: #00320c;
        }

        html.dark-mode .badge-success {
            background-color: #1b5e20;
            color: #81c784;
        }

        html.dark-mode .badge-info {
            background-color: #0d47a1;
            color: #64b5f6;
        }

        html.dark-mode .badge-warning {
            background-color: #e65100;
            color: #ffb74d;
        }

        html.dark-mode .badge-danger {
            background-color: #b71c1c;
            color: #ef5350;
        }

        /* IP 类型样式 */
        .ip-type-residential {
            color: #2e7d32;
            font-weight: bold;
        }

        .ip-type-business {
            color: #f59e0b;
            font-weight: bold;
        }

        .ip-type-hosting {
            font-weight: bold;
        }

        .ip-type-unknown {
            font-weight: bold;
        }

        html.dark-mode .ip-type-residential {
            color: #81c784;
            font-weight: bold;
        }

        html.dark-mode .ip-type-business {
            color: #fbbf24;
            font-weight: bold;
        }

        html.dark-mode .ip-type-hosting {
            font-weight: bold;
        }

        html.dark-mode .ip-type-unknown {
            font-weight: bold;
        }

        /* 风险等级文本样式 */
        .success-text {
            color: #2e7d32;
        }

        .warning-text {
            color: #e65100;
        }

        .danger-text {
            color: #c62828;
        }

        html.dark-mode .success-text {
            color: #81c784;
        }

        html.dark-mode .warning-text {
            color: #ffb74d;
        }

        html.dark-mode .danger-text {
            color: #ef5350;
        }

        /* 评分算法说明气泡 */
        .score-help-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            background-color: #2196F3;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .score-help-icon:hover {
            background-color: #1976D2;
        }

        html.dark-mode .score-help-icon {
            background-color: #1976D2;
        }

        html.dark-mode .score-help-icon:hover {
            background-color: #64B5F6;
        }

        .score-tooltip {
            display: none;
            position: fixed;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            min-width: 300px;
            max-width: 350px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            font-size: 13px;
            line-height: 1.6;
        }

        /* 气泡位置调整类 */
        .score-tooltip.tooltip-bottom {
            display: none;
        }

        .score-tooltip.tooltip-left {
            display: none;
        }

        .score-tooltip.tooltip-right {
            display: none;
        }

        html.dark-mode .score-tooltip {
            background: #3c3c3c;
            border-color: #444;
            color: #e0e0e0;
        }

        .score-tooltip.show {
            display: block;
        }

        .tooltip-header {
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
        }

        html.dark-mode .tooltip-header {
            border-bottom-color: #444;
        }

        .tooltip-section {
            margin-top: 10px;
        }

        .tooltip-section-title {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .formula-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding-left: 10px;
        }

        .formula-equation code {
            background-color: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        html.dark-mode .formula-equation code {
            background-color: #444;
        }

        .risk-list {
            list-style: none;
            padding-left: 0;
        }

        .risk-list li {
            padding: 4px 0;
            padding-left: 20px;
            position: relative;
        }

        .risk-list li::before {
            content: '•';
            position: absolute;
            left: 0;
        }

        /* 响应式设计 */
        @media (max-width: 1024px) {
            .network-cards-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .network-cards-container {
                grid-template-columns: 1fr;
            }

            .ip-detail-content {
                padding: 20px;
                max-width: 100%;
            }

            .ip-detail-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .ip-detail-label {
                min-width: unset;
            }

            .ip-detail-value {
                text-align: left;
                width: 100%;
            }

            .score-tooltip {
                position: fixed;
                bottom: auto;
                right: auto;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                min-width: 280px;
                max-width: 90%;
            }
        }

        /* 网络信息和延迟测试样式 */
        .network-cards-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-top: 16px;
        }

        @media (max-width: 1200px) {
            .network-cards-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .network-cards-container {
                grid-template-columns: 1fr;
            }
        }

        .network-card,
        .latency-card {
            background: var(--bg-secondary);
            border: 1.5px solid var(--border-color);
            border-radius: 14px;
            padding: 16px;
            position: relative;
            overflow: hidden;
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        html.dark-mode .network-card,
        html.dark-mode .latency-card {
            background: rgba(39, 39, 39, 0.7);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
        }

        .latency-card {
            padding: 12px 16px;
            min-height: 80px;
            flex-direction: row;
            /* 延迟卡片内部通常是横向排列 header 和 graph */
            align-items: center;
        }

        .network-card:hover,
        .latency-card:hover {
            transform: translateY(-4px) scale(1.02);
            border-color: #f6821f;
            box-shadow: 0 12px 20px rgba(246, 130, 31, 0.15);
        }

        .network-card-title {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }

        .status-loading {
            background: #fbbf24;
            animation: pulse-loading 1.5s ease-in-out infinite;
        }

        .status-success {
            background: #10b981;
        }

        .status-error {
            background: #ef4444;
        }

        @keyframes pulse-loading {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .network-info-content {
            display: flex;
            flex-direction: column;
        }

        .ip-text {
            color: var(--text-primary);
            font-weight: 700;
            font-family: 'Fira Code', monospace;
            font-size: 15px;
            word-break: break-all;
        }

        .location-text {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .network-tip {
            margin-top: 4px;
            font-size: 11px;
            color: #9ca3af;
            line-height: 1.4;
        }

        .latency-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            row-gap: 8px;
            margin-top: 16px;
        }

        @media (max-width: 1200px) {
            .latency-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .latency-cards {
                grid-template-columns: 1fr;
            }
        }

        .latency-card-header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            position: relative;
            z-index: 2;
            width: 100%;
        }

        .latency-card-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .latency-card-icon-wrapper {
            width: 36px;
            height: 36px;
            background: var(--border-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1.5px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .latency-card:hover .latency-card-icon-wrapper {
            background: white;
            border-color: #f6821f;
            transform: rotate(5deg);
        }

        html.dark-mode .latency-card:hover .latency-card-icon-wrapper {
            background: #333;
        }

        .latency-card-icon-wrapper svg {
            width: 20px;
            height: 20px;
        }

        .latency-card-text {
            display: flex;
            flex-direction: row;
            align-items: flex-end;
            gap: 4px;
        }

        .latency-card-name {
            font-size: 14px;
            font-weight: 800;
            color: var(--text-primary);
            /*letter-spacing: 0.5px;*/
        }

        .latency-card-region {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            white-space: nowrap;
        }

        .latency-card-region[data-region="国内"] {
            color: #16a34a;
        }

        .latency-card-region[data-region="国际"] {
            color: #3b82f6;
        }

        html.dark-mode .latency-card-region[data-region="国内"] {
            color: #4ade80;
        }

        html.dark-mode .latency-card-region[data-region="国际"] {
            color: #60a5fa;
        }

        .latency-status {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.6rem;
            font-weight: 800;
            font-style: italic;
            color: #f6821f;
            text-shadow: var(--bg-secondary);
            z-index: 3;
        }

        html.dark-mode .latency-status {
            text-shadow: rgba(39, 39, 39, 0.7),
        }

        .latency-status .unit {
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            font-style: normal;
            margin-left: 1px;
            opacity: 0.7;
            vertical-align: baseline;
            text-transform: lowercase;
        }

        .latency-graph-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: transparent;
            pointer-events: none;
            opacity: 0.15;
        }

        .ecg-path {
            fill: none;
            stroke: #f6821f;
            stroke-width: 3.5;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: d 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ecg-path-bg {
            fill: none;
            stroke: var(--border-color);
            stroke-width: 1;
            opacity: 0.3;
        }

        .graph-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(var(--border-color) 0.5px, transparent 0.5px),
                linear-gradient(90deg, var(--border-color) 0.5px, transparent 0.5px);
            background-size: 15px 15px;
            pointer-events: none;
            opacity: 0.1;
        }

        .ecg-cursor {
            fill: #f6821f;
            filter: drop-shadow(0 0 5px #f6821f);
        }

        /* GitHub logo 在浅色模式下显示为黑色 */
        .latency-card-icon-wrapper[data-site="github"] {
            color: #181717 !important;
        }

        .latency-card-icon-wrapper[data-site="github"] svg path {
            fill: #181717 !important;
        }

        html.dark-mode .latency-card-icon-wrapper[data-site="github"] {
            color: #ffffff !important;
        }

        html.dark-mode .latency-card-icon-wrapper[data-site="github"] svg path {
            fill: #ffffff !important;
        }

        /* 加载动画 */
        @keyframes latencyPulse {

            0%,
            100% {
                opacity: 0.4;
            }

            50% {
                opacity: 1;
            }
        }

        .latency-bar.loading {
            animation: latencyPulse 1.5s ease-in-out infinite;
        }

        /* HOSTS 编辑模态框样式 */
        .hosts-edit-modal {
            overflow-y: auto;
            width: 90vw;
            max-width: 500px;
            margin: 0 auto;
            max-height: 90vh;
        }

        .hosts-edit-modal-title {
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
        }

        .hosts-edit-container {
            margin: 20px 0;
        }

        .hosts-edit-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            text-align: left;
        }

        .hosts-edit-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            height: 200px;
            background-color: #f9fafb;
            color: #1f2937;
            resize: vertical;
            overflow-y: auto;
            box-sizing: border-box;
            line-height: 1.6;
        }

        .hosts-edit-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .hosts-edit-hint {
            font-size: 12px;
            color: #9ca3af;
            text-align: left;
        }

        .hosts-edit-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
        }

        .hosts-edit-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-hosts-confirm {
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-hosts-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
        }

        .btn-hosts-cancel {
            background: linear-gradient(135deg, #e5e7eb 0, #d1d5db 100%);
            color: #374151;
        }

        .btn-hosts-cancel:hover {
            background: linear-gradient(135deg, #d1d5db 0, #b3b8be 100%);
        }

        .form-group input[readonly].nodeHost-clickable {
            cursor: pointer;
            background-color: #ffffff !important;
            color: #1f2937 !important;
        }

        html.dark-mode .hosts-edit-modal {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        html.dark-mode .hosts-edit-modal-title {
            color: var(--text-primary);
        }

        html.dark-mode .hosts-edit-label {
            color: var(--text-primary);
        }

        html.dark-mode .hosts-edit-textarea {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--input-border);
        }

        html.dark-mode .hosts-edit-hint {
            color: #6b7280;
        }

        html.dark-mode .btn-hosts-cancel {
            background: var(--input-bg);
            color: var(--text-primary);
        }

        html.dark-mode .btn-hosts-cancel:hover {
            background: var(--border-color);
        }

        html.dark-mode .form-group input[readonly].nodeHost-clickable {
            background-color: var(--input-bg) !important;
            color: var(--text-primary) !important;
        }

        /* 增强型文本编辑器样式 */
        .line-editor {
            display: flex;
            gap: 0;
            align-items: stretch;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            background: #ffffff;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            margin-top: 8px;
            min-height: 300px;
        }

        .line-editor:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .line-editor .gutter {
            display: none;
            /* 移除旧的独立 gutter */
        }

        .line-editor .editor-area {
            position: relative;
            flex-grow: 1;
            background: transparent;
            min-height: 300px;
            z-index: 1;
        }

        /* 模拟左侧 gutter 背景 - 固定位置 */
        .line-editor .editor-area::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 48px;
            background: #f9fafb;
            border-right: 1px solid #e5e7eb;
            z-index: 0;
            pointer-events: none;
        }

        .line-editor .mirror {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 12px 12px 12px 60px !important;
            /* 左侧预留给行号 */
            margin: 0 !important;
            white-space: pre-wrap !important;
            word-break: break-all !important;
            pointer-events: none;
            font-family: 'Monaco', 'Courier New', monospace !important;
            font-size: 14px !important;
            line-height: 24px !important;
            color: transparent;
            overflow-y: scroll;
            overflow-x: hidden;
            box-sizing: border-box !important;
            border: none !important;
            scrollbar-width: none;
            z-index: 2;
            width: 100%;
            /* 初始宽度，后续由 JS 动态调整 */
            /* 确保在最上层，包括在 textarea 背景之上 */
        }

        .line-editor .mirror::-webkit-scrollbar {
            display: none;
        }

        .line-editor .mirror .logical-line {
            display: block;
            margin: 0 !important;
            padding: 0 !important;
            position: relative;
            color: transparent;
            word-wrap: break-word;
            min-height: 24px;
            box-sizing: border-box;
        }

        .line-editor .mirror .logical-line:nth-child(even) {
            background: rgba(59, 130, 246, 0.06);
        }

        html.dark-mode .line-editor .mirror .logical-line:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        .line-editor .mirror .logical-line::before {
            content: attr(data-line-number);
            position: absolute;
            left: -60px;
            /* 相对于 mirror 的 padding-left */
            top: 0;
            width: 48px;
            height: 24px;
            line-height: 24px;
            text-align: right;
            padding-right: 12px;
            color: #9ca3af;
            font-size: 13px;
            box-sizing: border-box;
            z-index: 1;
        }

        html.dark-mode .line-editor .mirror .logical-line::before {
            color: #6b7280;
        }

        /* 在真实换行处显示一个微小的符号 */
        .line-editor .mirror .logical-line::after {
            content: "↵";
            position: absolute;
            right: -4px;
            bottom: 0;
            color: rgba(59, 130, 246, 0.3);
            font-size: 12px;
            display: none;
        }

        .line-editor textarea {
            width: 100% !important;
            min-height: 300px;
            border: none !important;
            background: transparent !important;
            padding: 12px 12px 12px 60px !important;
            /* 对齐 mirror */
            margin: 0 !important;
            font-family: 'Monaco', 'Courier New', monospace !important;
            font-size: 14px !important;
            line-height: 24px !important;
            color: #1f2937;
            resize: vertical !important;
            outline: none !important;
            box-sizing: border-box !important;
            display: block;
            white-space: pre-wrap !important;
            word-break: break-all !important;
            scrollbar-width: thin;
            position: relative;
            z-index: 1;
            overflow-y: scroll;
        }

        html.dark-mode .line-editor {
            border-color: var(--input-border);
            background: var(--input-bg);
        }

        html.dark-mode .line-editor .gutter {
            background: rgba(255, 255, 255, 0.03);
            border-right-color: var(--border-color);
            color: #6b7280;
        }

        html.dark-mode .line-editor textarea {
            color: var(--text-primary);
        }

        html.dark-mode .line-editor .mirror .logical-line:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        html.dark-mode .line-editor .editor-area::before {
            background: rgba(255, 255, 255, 0.03);
            border-right-color: var(--border-color);
        }
    </style>

</head>

<body>
    <!-- 背景内容 -->
    <iframe id="background-iframe" src="/" title="背景内容"></iframe>

    <!-- 毛玻璃效果遮盖层 -->
    <div id="blur-overlay"></div>

    <!-- 管理后台容器 -->
    <div class="page-wrapper">
        <div class="card-container">
            <div class="success-message" id="successMsg"></div>
            <div class="error-message" id="errorMsg"></div>

            <div class="header">
                <div class="header-title">
                    <h1 id="pageTitle">加载中...</h1>
                </div>
                <div class="header-buttons">
                    <button type="button" class="btn btn-mode-toggle" id="modeToggleBtn" onclick="toggleUserMode()">🐣
                        我是小白！我想简单点！</button>
                    <button type="button" class="btn btn-danger btn-reset"
                        onclick="resetConfigWithConfirm()">⚠️重置配置</button>
                    <button type="button" class="btn btn-primary" onclick="logout()">👋退出登录</button>
                </div>
            </div>

            <!-- Cloudflare Workers/Pages 使用统计模块 -->
            <div class="module cf-usage-module collapsed" id="cfUsageModule">
                <div class="module-title" onclick="toggleModule(this)">
                    Workers/Pages 请求使用情况
                    <svg class="collapse-icon" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5z" />
                    </svg>
                </div>
                <!-- 进度条 -->
                <div>
                    <div class="cf-progress-bar">
                        <!-- Workers 进度条 (绿色) -->
                        <div class="cf-bar-segment cf-bar-green" id="cfWorkerBar" title="Workers 请求"></div>
                        <!-- Pages 进度条 (蓝色) -->
                        <div class="cf-bar-segment cf-bar-blue" id="cfPagesBar" title="Pages 请求"></div>
                        <!-- 总体百分比文字 (中央) -->
                        <div class="cf-percentage-center" id="cfPercentageCenter">0%</div>
                    </div>
                </div>
                <div class="module-content">
                    <div class="cf-usage-wrapper">
                        <!-- 使用统计卡片 -->
                        <div class="cf-stats-card">
                            <div class="cf-stats-grid">
                                <div class="cf-stat-item">
                                    <div class="cf-stat-label">Workers 请求</div>
                                    <div class="cf-stat-value cf-value-green" id="cfWorkerCount">-</div>
                                </div>
                                <div class="cf-stat-item">
                                    <div class="cf-stat-label">Pages 请求</div>
                                    <div class="cf-stat-value cf-value-blue" id="cfPagesCount">-</div>
                                </div>
                                <div class="cf-stat-item">
                                    <div class="cf-stat-label">日配额</div>
                                    <div class="cf-stat-value cf-value-orange" id="cfDailyQuota">100,000</div>
                                </div>
                            </div>
                        </div>

                        <!-- 信息提示 -->
                        <div class="cf-info-box">
                            <div class="cf-info-icon">ℹ️</div>
                            <div class="cf-info-text">
                                <strong>每日请求数重置清零：</strong><br><span id="countdown" class="cf-highlight">距离重置还有 15小时24分
                                    34秒</span>，<br>北京时间 (UTC+8) <strong
                                    class="cf-highlight">8:00</strong>重置，<br>今日使用情况总计：<strong class="cf-highlight"
                                    id="cfTotalDisplay">-</strong>。
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 网络信息模块 -->
            <div class="module advanced-module">
                <div class="module-title" onclick="toggleNetworkModule(this)">
                    🌍 当前网络信息
                    <svg class="collapse-icon" viewBox="0 0 24 24" style="transform: rotate(90deg);">
                        <path d="M7 10l5 5 5-5z" />
                    </svg>
                </div>
                <div class="module-content">
                    <div class="network-cards-container">
                        <div class="network-card">
                            <div class="network-card-title">
                                <span class="status-indicator" id="status-ipip"></span>
                                国内测试
                            </div>
                            <div class="network-info-content">
                                <span id="ipip-ip" class="ip-text">-</span>
                                <div class="location-text">
                                    <span id="ipip-country" class="country-text">-</span>
                                </div>
                                <div class="network-tip">· 您访问国内站点所使用的IP</div>
                            </div>
                        </div>

                        <div class="network-card">
                            <div class="network-card-title">
                                <span class="status-indicator" id="status-edgeone"></span>
                                国外测试
                            </div>
                            <div class="network-info-content">
                                <span id="edgeone-ip" class="ip-text">-</span>
                                <div class="location-text">
                                    <span id="edgeone-country" class="country-text">-</span>
                                </div>
                                <div class="network-tip">· 您访问没有被封的国外站点所使用的IP</div>
                            </div>
                        </div>

                        <div class="network-card">
                            <div class="network-card-title">
                                <span class="status-indicator" id="status-cf"></span>
                                CloudFlare(ProxyIP)
                            </div>
                            <div class="network-info-content">
                                <span id="cf-ip" class="ip-text">-</span>
                                <div class="location-text">
                                    <span id="cf-country" class="country-text">-</span>
                                </div>
                                <div class="network-tip">· 您访问CFCDN站点所使用的落地IP</div>
                            </div>
                        </div>

                        <div class="network-card">
                            <div class="network-card-title">
                                <span class="status-indicator" id="status-twitter"></span>
                                X.com(推特)
                            </div>
                            <div class="network-info-content">
                                <span id="twitter-ip" class="ip-text">-</span>
                                <div class="location-text">
                                    <span id="twitter-country" class="country-text">-</span>
                                </div>
                                <div class="network-tip">· 您访问Twitter(x.com)所使用的IP</div>
                            </div>
                        </div>
                    </div>
                    <small style="font-size: 12px; color: #9ca3af; margin-top: 6px; display: block;">💡 <b>国内测试</b>
                        是由您梯子的 <b>分流规则</b> 决定的，<b>国外测试</b> 是由您的 <b>优选IP</b> 决定的，而 <b>CF、Twitter、ChatGPT</b> 是由您的
                        <b>PROXYIP</b> 决定的。</small>
                    <div class="module-content" style="display: none;" id="network-module-content">
                        <!-- 延迟测试卡片 -->
                        <div class="latency-cards" id="latency-cards">
                            <!-- 卡片将通过JavaScript动态生成 -->
                        </div>
                        <small
                            style="font-size: 12px; color: #9ca3af; margin-top: 6px; display: block;">💡<b>更多测试项目</b>，可前往
                            <a href="https://ip.skk.moe/" target="_blank" rel="noopener"
                                style="font-weight: bold; color: #6b7280;">ip.skk.moe</a> 自行测试。
                        </small>
                    </div>

                </div>
            </div>

            <!-- 模块1: 订阅链接 -->
            <div class="module">
                <div class="module-title" onclick="toggleModule(this)">
                    📋 获取节点链接
                    <svg class="collapse-icon" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5z" />
                    </svg>
                </div>
                <div class="form-group">
                    <label for="LinkURL">节点链接格式</label>
                    <div class="input-wrapper">
                        <input type="text" id="LinkURL" title="节点链接格式" readonly>
                        <button type="button" class="btn btn-qrcode" onclick="showQRCode('LinkURL')">📱二维码</button>
                        <button type="button" class="btn btn-primary"
                            onclick="copySubscription('LinkURL')">复制节点</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="subLink">自适应订阅</label>
                    <div class="input-wrapper">
                        <input type="text" id="subLink" title="自适应订阅" readonly>
                        <button type="button" class="btn btn-qrcode" onclick="showQRCode('subLink')">📱二维码</button>
                        <button type="button" class="btn btn-primary"
                            onclick="copySubscription('subLink')">复制订阅</button>
                    </div>
                </div>
                <div class="module-content">
                    <div class="form-group">
                        <label for="base64Link">Base64订阅</label>
                        <div class="input-wrapper">
                            <input type="text" id="base64Link" title="Base64订阅" readonly>
                            <button type="button" class="btn btn-qrcode"
                                onclick="showQRCode('base64Link')">📱二维码</button>
                            <button type="button" class="btn btn-primary"
                                onclick="copySubscription('base64Link')">复制订阅</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="clashLink">Clash订阅</label>
                        <div class="input-wrapper">
                            <input type="text" id="clashLink" title="Clash订阅" readonly>
                            <button type="button" class="btn btn-qrcode"
                                onclick="showQRCode('clashLink')">📱二维码</button>
                            <button type="button" class="btn btn-primary"
                                onclick="copySubscription('clashLink')">复制订阅</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="singboxLink">SingBox订阅</label>
                        <div class="input-wrapper">
                            <input type="text" id="singboxLink" title="SingBox订阅" readonly>
                            <button type="button" class="btn btn-qrcode"
                                onclick="showQRCode('singboxLink')">📱二维码</button>
                            <button type="button" class="btn btn-primary"
                                onclick="copySubscription('singboxLink')">复制订阅</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 模块2: 编辑订阅生成 -->
            <div class="module collapsed">
                <div class="module-title" onclick="toggleModule(this)">
                    ⚡️ 优选订阅生成
                    <svg class="collapse-icon" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5z" />
                    </svg>
                </div>
                <div class="module-content">

                    <div class="form-group">
                        <label for="ipMode">优选订阅模式</label>
                        <select id="ipMode" title="优选订阅模式" onchange="updateIPMode()">
                            <option value="generator">优选订阅生成器</option>
                            <option value="random">随机优选</option>
                            <option value="custom">自定义订阅（支持汇聚订阅）</option>
                        </select>
                    </div>

                    <div id="randomIPSection" class="form-group">
                        <label for="randomCount">随机优选数量</label>
                        <input type="number" id="randomCount" title="随机优选数量 1~99" min="1" max="99" value="16"
                            onchange="markModified('sub')" oninput="if(this.value>99){this.value=99;}">
                    </div>

                    <div id="portSection" class="form-group hidden-section">
                        <label for="specifiedPort">指定优选端口</label>
                        <select id="specifiedPort" onchange="markModified('sub')">
                            <option value="-1">随机端口</option>
                            <option value="443">443</option>
                            <option value="2053">2053</option>
                            <option value="2083">2083</option>
                            <option value="2087">2087</option>
                            <option value="2096">2096</option>
                            <option value="8443">8443</option>
                        </select>
                    </div>

                    <div id="customIPSection" class="form-group hidden-section">
                        <label for="customIPs">自定义优选地址</label>
                        <div class="line-editor" id="subCustomEditor">
                            <div class="gutter" aria-hidden="true"></div>
                            <div class="editor-area">
                                <pre class="mirror" aria-hidden="true"></pre>
                                <textarea id="customIPs" title="自定义优选地址"
                                    placeholder="注意：
每行一个地址，如：地址:端口#备注
IPv6地址需要用中括号括起来，如：[2606:4700::]:2053
端口不写，默认为 443 端口，如：www.visa.cn#优选域名

示例：
www.visa.cn#优选域名
127.0.0.1:1234#CFnat
[2606:4700::]:2053#IPv6

API示例：
https://raw.githubusercontent.com/cmliu/WorkerVless2sub/main/addressesapi.txt

其他节点示例：
vless://7b102311-43fd-4e8f-977e-8090623c101d@edt-pages.github.io:443?security=tls&type=ws&host=edt-pages.github.io&path=%2F#edgetunnel"
                                    onchange="markModified('sub')"></textarea>
                            </div>
                        </div>
                    </div>

                    <div id="generatorSection" class="form-group hidden-section">
                        <label for="generatorURL">优选订阅生成器</label>
                        <input type="text" id="generatorURL" title="优选订阅生成器" placeholder="sub.cmliussss.net"
                            onchange="processGeneratorURL()" oninput="processGeneratorURL()">
                    </div>

                    <div class="module-footer">
                        <button type="button" class="btn btn-online-optimize hidden-section" id="onlineOptimizeBtn"
                            onclick="openOnlineOptimizeModal()">在线优选</button>
                        <button type="button" class="btn btn-api-optimize hidden-section" id="apiOptimizeBtn"
                            onclick="openAPIOptimizeModal()">订阅接口</button>
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit('sub')" disabled
                                id="cancelSubBtn">取消</button>
                            <button type="button" class="btn btn-primary" onclick="saveSub()" disabled
                                id="saveSubBtn">保存</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 模块3: 详细配置信息 -->
            <div class="module collapsed advanced-module">
                <div class="module-title" onclick="toggleModule(this)">
                    ⚙️ 详细配置信息
                    <svg class="collapse-icon" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5z" />
                    </svg>
                </div>
                <div class="module-content">

                    <div class="form-group">
                        <label for="subName">订阅名称</label>
                        <input type="text" id="subName" title="订阅名称" onchange="markModified('config')">
                    </div>

                    <div class="form-group">
                        <label for="nodeHost">HOST</label>
                        <input type="text" id="nodeHost" title="节点域名" readonly>
                    </div>

                    <div class="form-group">
                        <label for="nodeUUID">UUID</label>
                        <input type="text" id="nodeUUID" title="用于节点验证的UUID 仅可通过 'UUID'环境变量 进行修改" readonly>
                    </div>

                    <div class="form-group">
                        <label for="nodePATH">PATH</label>
                        <input type="text" id="nodePATH" title="节点的伪装路径 仅可通过 'PATH'环境变量 进行修改">
                    </div>

                    <div class="form-group">
                        <label for="protocol">节点协议</label>
                        <select id="protocol" title="节点协议" onchange="updateProtocol(); markModified('config')">
                            <option value="vless">VLESS</option>
                            <option value="trojan">Trojan</option>
                        </select>
                    </div>

                    <div class="form-group" id="fingerprintGroup">
                        <label for="fingerprint">指纹伪装</label>
                        <select id="fingerprint" title="浏览器指纹"
                            onchange="handleFingerprintChange(); markModified('config')">
                            <option value="chrome">chrome（支持ECH）</option>
                            <option value="firefox">firefox（支持ECH）</option>
                            <option value="safari">safari</option>
                            <option value="ios">ios</option>
                            <option value="android">android</option>
                            <option value="edge">edge</option>
                            <option value="360">360</option>
                            <option value="qq">qq</option>
                            <option value="random">random（支持ECH）</option>
                            <option value="randomized">randomized</option>
                        </select>
                    </div>

                    <!--- 节点配置 
                <div class="form-group">
                    <label>传输协议</label>
                    <select id="transport" onchange="markModified('config')">
                        <option value="ws">WebSocket</option>
                        <option value="xhttp">XHTTP</option>
                    </select>
                </div>
                --->
                    <div class="checkbox-row">
                        <div class="form-group">
                            <div class="input-wrapper">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="skipVerify" title="跳过TLS证书验证"
                                        onchange="markModified('config')">
                                    <label for="skipVerify" class="checkbox-label" title="跳过TLS证书验证">跳过证书验证</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group" id="randomPathGroup" style="display: none;">
                            <div class="input-wrapper">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="randomPath" title="随机伪装路径(自慰功能)"
                                        onchange="markModified('config')">
                                    <label for="randomPath" class="checkbox-label" title="随机伪装路径(自慰功能)">随机伪装路径</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group" id="enable0RTTGroup" style="display: none;">
                            <div class="input-wrapper">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="enable0RTT" title="启用0-RTT(小白勿用)"
                                        onchange="markModified('config')">
                                    <label for="enable0RTT" class="checkbox-label"
                                        title="启用0-RTT(小白勿用)">启用0-RTT(ed=2560)</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group" id="tlsFragmentGroup" style="display: none;">
                            <div class="input-wrapper">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="tlsFragmentShadowrocket"
                                        title="Shadowrocket(小火箭)专用的TLS分片功能"
                                        onchange="handleTLSFragmentChange('Shadowrocket'); markModified('config')">
                                    <label for="tlsFragmentShadowrocket" class="checkbox-label"
                                        title="Shadowrocket(小火箭)专用的TLS分片功能">启用分片(Shadowrocket)</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group" id="tlsFragmentHappGroup" style="display: none;">
                            <div class="input-wrapper">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="tlsFragmentHapp" title="Happ客户端专用的TLS分片功能"
                                        onchange="handleTLSFragmentChange('Happ'); markModified('config')">
                                    <label for="tlsFragmentHapp" class="checkbox-label"
                                        title="Happ客户端专用的TLS分片功能">启用分片(Happ)</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="module-footer">
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit('config')" disabled
                                id="cancelConfigBtn">取消</button>
                            <button type="button" class="btn btn-primary" onclick="saveConfig()" disabled
                                id="saveConfigBtn">保存</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 模块3.5: ECH 设置(实验性质) -->
            <div class="module collapsed advanced-module" id="echModule" style="display: none;">
                <div class="module-title" onclick="toggleModule(this)">
                    🔐 Encrypted Client Hello（实验性质）
                    <svg class="collapse-icon" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5z" />
                    </svg>
                </div>
                <div class="module-content">
                    <div class="form-group">
                        <label>ECH 设置</label>
                        <div class="input-wrapper">
                            <div class="checkbox-group">
                                <input type="checkbox" id="enableECH"
                                    title="启用ECH可以避免域名阻断-1现象！&#10;&#10;支持版本&#10;v2rayN v7.17.0+&#10;v2rayNG v2.0.0+&#10;Clash.Meta(Mihomo)&#10;Singbox"
                                    onchange="handleECHEnableChange()">
                                <label for="enableECH" class="checkbox-label"
                                    title="启用ECH可以避免域名阻断-1现象！&#10;&#10;支持版本&#10;v2rayN v7.17.0+&#10;v2rayNG v2.0.0+&#10;Clash.Meta(Mihomo)&#10;Singbox">启用</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="echDNSGroup" style="display: none; align-items: start;">
                        <label for="echDNSSelect" style="padding-top: 10px;">ECH DNS服务</label>
                        <div class="input-wrapper" style="flex-direction: column; align-items: stretch;">
                            <select id="echDNSSelect" title="ECH DNS服务" style="display: none;"
                                onchange="onEchDNSSelectChange()">
                                <option value="udp://45.90.28.0:5353" data-region="international">
                                    udp://45.90.28.0:5353（NextDNS）小白推荐选这个！！！</option>
                                <option value="udp://208.67.220.220:443" data-region="international">
                                    udp://208.67.220.220:443（OpenDNS）</option>
                                <option value="udp://149.112.112.112:9953" data-region="international">
                                    udp://149.112.112.112:9953（Quad9）</option>
                                <option value="udp://188.166.206.224:5003" data-region="international">
                                    udp://188.166.206.224:5003（Tiarap）</option>
                                <option value="https://doh.applied-privacy.net/query" data-region="international">
                                    https://doh.applied-privacy.net/query（Applied Privacy DoH）</option>
                                <option value="https://odvr.nic.cz/doh" data-region="international">
                                    https://odvr.nic.cz/doh（CZ.NIC DoH）</option>
                                <option value="https://doh.cmliussss.net/CMLiussss" data-region="international">
                                    https://doh.cmliussss.net/CMLiussss（Cloudflare DoH：CM镜像）</option>
                                <option value="https://doh.cmliussss.com/CMLiussss" data-region="international">
                                    https://doh.cmliussss.com/CMLiussss（Google DoH：CM镜像）</option>
                                <option value="https://dns.alidns.com/dns-query" data-region="domestic">
                                    https://dns.alidns.com/dns-query（阿里 DoH：国内DNS需搭配设置ECH解析域名，是否可用需自行验证）</option>
                                <option value="https://sm2.doh.pub/dns-query" data-region="domestic">
                                    https://sm2.doh.pub/dns-query（腾讯国密 DoH：国内DNS需搭配设置ECH解析域名，是否可用需自行验证）</option>
                                <option value="https://doh.360.cn/dns-query" data-region="domestic">
                                    https://doh.360.cn/dns-query（360 DoH：国内DNS需搭配设置ECH解析域名，是否可用需自行验证）</option>
                                <option value="https://doh.onedns.net/dns-query" data-region="domestic">
                                    https://doh.onedns.net/dns-query（OneDNS DoH：国内DNS需搭配设置ECH解析域名，是否可用需自行验证）</option>
                                <option value="custom">自定义</option>
                            </select>
                            <input type="text" id="echDNSCustomInput" title="自定义ECH DNS服务"
                                placeholder="udp://... 或 https://..." onchange="onEchDNSCustomInput()"
                                style="display: none; margin-top: 8px;">
                            <input type="hidden" id="echDNSValue">
                        </div>
                    </div>

                    <div class="form-group" id="echSNIGroup" style="display: none; align-items: start;">
                        <label for="echSNISelect" style="padding-top: 10px;">ECH 解析域名</label>
                        <div class="input-wrapper" style="flex-direction: column; align-items: stretch;">
                            <select id="echSNISelect" title="ECH 解析域名" style="display: none;"
                                onchange="onEchSNISelectChange()">
                                <option value="__AUTO__">默认使用节点HOST伪装域名</option>
                                <option value="cloudflare-ech.com">cloudflare-ech.com 小白推荐选这个！！！</option>
                                <option value="custom">自定义</option>
                            </select>
                            <input type="text" id="echSNICustomInput" title="自定义ECH 解析域名"
                                placeholder="cloudflare-ech.com" onchange="onEchSNICustomInput()"
                                style="display: none; margin-top: 8px;">
                            <input type="hidden" id="echSNIValue">
                        </div>
                    </div>

                    <div class="module-footer">
                        <button type="button" class="btn btn-ech-help" onclick="showECHHelpModal()"
                            title="了解 ECH 的相关信息">
                            💡 为什么需要ECH？ECH又是什么？
                        </button>
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit('ech')" disabled
                                id="cancelEchBtn">取消</button>
                            <button type="button" class="btn btn-primary" onclick="saveEch()" disabled
                                id="saveEchBtn">保存</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 模块4: 反代落地设置 -->
            <div class="module collapsed advanced-module">
                <div class="module-title" onclick="toggleModule(this)">
                    🌐 Cloudflare CDN 访问设置
                    <svg class="collapse-icon" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5z" />
                    </svg>
                </div>
                <div class="module-content">

                    <div class="form-group">
                        <label for="proxyMode">反代模式</label>
                        <select id="proxyMode" title="反代模式" onchange="updateProxyMode()">
                            <option value="auto">PROXYIP</option>
                            <option value="socks5">SOCKS5</option>
                            <option value="http">HTTP</option>
                        </select>
                    </div>

                    <div id="proxyIPSection" class="form-group">
                        <div class="form-group">
                            <label for="proxyIP">PROXYIP</label>
                            <div class="input-wrapper">
                                <input type="text" id="proxyIP" title="PROXYIP" placeholder="proxyip.cmliussss.net"
                                    onchange="processProxyIP()" oninput="processProxyIP()">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="autoProxy" title="启用自动获取: 使用默认内置的PROXYIP"
                                        onchange="toggleAutoProxy(); markModified('proxy')">
                                    <label for="autoProxy" class="checkbox-label"
                                        title="启用自动获取: 使用默认内置的PROXYIP">启用自动获取</label>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div id="socks5Section" class="hidden-section">
                        <div class="form-group">
                            <label for="socks5Addr">SOCKS5</label>
                            <div class="input-wrapper">
                                <div class="readonly-wrapper proxy-input-wrapper"
                                    onclick="openProxyVerificationModal('socks5')">
                                    <input type="text" id="socks5Addr" title="SOCKS5"
                                        placeholder="user:password@127.0.0.1:1080" readonly class="subapi-input">
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="globalSocks5" title="启用全局代理: 将非CFCDN站点的流量也走SOCKS5代理"
                                        onchange="markModified('proxy')">
                                    <label for="globalSocks5" class="checkbox-label"
                                        title="启用全局代理: 将非CFCDN站点的流量也走SOCKS5代理">启用全局代理</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="httpSection" class="hidden-section">
                        <div class="form-group">
                            <label for="httpAddr">HTTP</label>
                            <div class="input-wrapper">
                                <div class="readonly-wrapper proxy-input-wrapper"
                                    onclick="openProxyVerificationModal('http')">
                                    <input type="text" id="httpAddr" title="HTTP"
                                        placeholder="user:password@127.0.0.1:8080" readonly class="subapi-input">
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="globalHTTP" title="启用全局代理: 将非CFCDN站点的流量也走HTTP代理"
                                        onchange="markModified('proxy')">
                                    <label for="globalHTTP" class="checkbox-label"
                                        title="启用全局代理: 将非CFCDN站点的流量也走HTTP代理">启用全局代理</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="module-footer">
                        <button type="button" class="btn btn-proxyip-help" onclick="showProxyIPHelpModal()"
                            title="了解 ProxyIP 的相关信息">
                            💡 为什么需要反代模式？PROXYIP又是什么？
                        </button>
                        <button type="button" class="btn btn-search-proxy" id="getMoreProxyIPBtn"
                            onclick="showGetMoreProxyIPModal()" style="display: none;"
                            title="使用网络测绘引擎寻找可用的PROXYIP">
                            🗺️ 探索更多 PROXYIP
                        </button>
                        <button type="button" class="btn btn-search-proxy" id="exploreSocks5Btn"
                            onclick="showExploreSocks5Modal()" style="display: none;"
                            title="从SOCKS5列表中选择可用的代理">
                            🧩 探索更多 SOCKS5
                        </button>
                        <button type="button" class="btn btn-search-proxy" id="exploreHTTPBtn"
                            onclick="showExploreHTTPModal()" style="display: none;"
                            title="从HTTP列表中选择可用的代理">
                            🧩 探索更多 HTTP
                        </button>
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit('proxy')" disabled
                                id="cancelProxyBtn">取消</button>
                            <button type="button" class="btn btn-primary" onclick="saveProxy()" disabled
                                id="saveProxyBtn">保存</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 模块5: 订阅转换配置 -->
            <div class="module collapsed advanced-module">
                <div class="module-title" onclick="toggleModule(this)">
                    🔄 订阅转换配置
                    <svg class="collapse-icon" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5z" />
                    </svg>
                </div>
                <div class="module-content">

                    <div class="form-group">
                        <label for="subAPI">订阅转换后端</label>
                        <div class="readonly-wrapper" onclick="openSubAPIModal()">
                            <input type="text" id="subAPI" title="订阅转换后端" readonly
                                placeholder="https://SUBAPI.cmliussss.net" class="subapi-input">
                        </div>
                    </div>

                    <div class="form-group" style="align-items: start;">
                        <label for="subConfigSelect" style="padding-top: 10px;">订阅转换配置文件</label>
                        <div class="input-wrapper" style="flex-direction: column; align-items: stretch;">
                            <select id="subConfigSelect" title="订阅转换配置文件" style="display: none;">
                                <option value="">正在加载...</option>
                            </select>
                            <input type="text" id="subConfigCustomInput" title="自定义订阅转换配置文件URL"
                                placeholder="https://raw.githubusercontent.com/..." onchange="onSubConfigCustomInput()"
                                style="display: none; margin-top: 8px;">
                            <input type="hidden" id="subConfig">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="emoji">Emoji</label>
                        <div class="input-wrapper">
                            <div class="checkbox-group">
                                <input type="checkbox" id="emoji" title="启用Emoji" onchange="markModified('convert')">
                                <label for="emoji" class="checkbox-label">启用</label>
                            </div>
                        </div>
                    </div>

                    <div class="module-footer">
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit('convert')" disabled
                                id="cancelConvertBtn">取消</button>
                            <button type="button" class="btn btn-primary" onclick="saveConvert()" disabled
                                id="saveConvertBtn">保存</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 模块6: 消息通知设置 -->
            <div class="module collapsed advanced-module">
                <div class="module-title" onclick="toggleModule(this)">
                    🔔 消息通知设置
                    <svg class="collapse-icon" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5z" />
                    </svg>
                </div>
                <div class="module-content">

                    <!-- Telegram Bot 通知设置 -->
                    <div class="form-group notification-row">
                        <label>
                            Telegram Bot 通知设置
                            <div class="checkbox-group">
                                <input type="checkbox" id="telegramEnabled" title="启用TelegramBot通知"
                                    onchange="markModified('notification')" disabled>
                                <label for="telegramEnabled" class="checkbox-label">启用</label>
                            </div>
                        </label>
                        <div class="notification-controls">
                            <button type="button" class="btn btn-notification-config"
                                onclick="openTelegramConfigModal()">⚙️参数配置</button>
                            <button type="button" class="btn btn-clear-config"
                                onclick="clearTelegramConfig()">🗑️清除配置</button>
                        </div>
                    </div>

                    <!-- Cloudflare 可用请求数统计 -->
                    <div class="form-group notification-row">
                        <label>
                            Cloudflare Workers/Pages 可用请求数统计
                        </label>
                        <div class="notification-controls">
                            <button type="button" class="btn btn-notification-config"
                                onclick="openCloudflareConfigModal()">⚙️参数配置</button>
                            <button type="button" class="btn btn-clear-config"
                                onclick="clearCloudflareConfig()">🗑️清除配置</button>
                        </div>
                    </div>

                    <div class="module-footer">
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit('notification')"
                                disabled id="cancelNotificationBtn">取消</button>
                            <button type="button" class="btn btn-primary" onclick="saveNotification()" disabled
                                id="saveNotificationBtn">保存</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 模块7: 查看所有日志 -->
            <div class="module collapsed advanced-module">
                <div class="module-title" onclick="toggleModule(this); loadLogsOnExpand(this)">
                    📋 查看操作日志
                    <svg class="collapse-icon" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5z" />
                    </svg>
                </div>
                <div class="module-content">
                    <div id="logsContainer" class="logs-container">
                        <div class="logs-loading">加载中...</div>
                    </div>
                    <div class="logs-footer">
                        <p class="logs-footer-text">因为KV空间有限，所以只保留4MB的操作日志，当日志大小超过该容量会自动清理最老的日志记录。</p>
                        <button type="button" class="btn btn-primary btn-all-logs" onclick="showAllLogs()">全部日志</button>
                    </div>
                </div>
            </div>

            <div class="social-links">
                <!-- 主题切换按钮 -->
                <button type="button" class="social-link theme-toggle" id="themeToggle" title="切换日间模式"
                    onclick="toggleTheme()">
                    <!-- 太阳图标 (日间模式显示) -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="theme-icon sun-icon">
                        <circle cx="12" cy="12" r="5" fill="currentColor" />
                        <g stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none">
                            <line x1="12" y1="1" x2="12" y2="3" />
                            <line x1="12" y1="21" x2="12" y2="23" />
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                            <line x1="1" y1="12" x2="3" y2="12" />
                            <line x1="21" y1="12" x2="23" y2="12" />
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
                        </g>
                    </svg>
                    <!-- 月亮图标 (夜间模式显示) -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="theme-icon moon-icon">
                        <path fill="currentColor" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                    </svg>
                </button>
                <!-- GitHub 链接 -->
                <a href="https://github.com/cmliu/edgetunnel" target="_blank" rel="noopener" class="social-link"
                    title="GitHub">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path fill="currentColor"
                            d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385c.6.105.825-.255.825-.57c0-.285-.015-1.23-.015-2.235c-3.015.555-3.795-.735-4.035-1.41c-.135-.345-.72-1.41-1.23-1.695c-.42-.225-1.02-.78-.015-.795c.945-.015 1.62.87 1.845 1.23c1.08 1.815 2.805 1.305 3.495.99c.105-.78.42-1.305.765-1.605c-2.67-.3-5.46-1.335-5.46-5.925c0-1.305.465-2.385 1.23-3.225c-.12-.3-.54-1.53.12-3.18c0 0 1.005-.315 3.3 1.23c.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23c.66 1.65.24 2.88.12 3.18c.765.84 1.23 1.905 1.23 3.225c0 4.605-2.805 5.625-5.475 5.925c.435.375.81 1.095.81 2.22c0 1.605-.015 2.895-.015 3.3c0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12Z" />
                    </svg>
                </a>
                <!-- Telegram 链接 -->
                <a href="https://t.me/CMLiussss" target="_blank" rel="noopener" class="social-link" title="Telegram">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path fill="currentColor"
                            d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12a12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472c-.18 1.898-.962 6.502-1.36 8.627c-.168.9-.499 1.201-.82 1.23c-.696.065-1.225-.46-1.9-.902c-1.056-.693-1.653-1.124-2.678-1.8c-1.185-.78-.417-1.21.258-1.91c.177-.184 3.247-2.977 3.307-3.23c.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345c-.48.33-.913.49-1.302.48c-.428-.008-1.252-.241-1.865-.44c-.752-.245-1.349-.374-1.297-.789c.027-.216.325-.437.893-.663c3.498-1.524 5.83-2.529 6.998-3.014c3.332-1.386 4.025-1.627 4.476-1.635z" />
                    </svg>
                </a>
                <!-- 返回顶部按钮 -->
                <button type="button" class="social-link" title="返回顶部" onclick="scrollToTop()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" d="M12 19V5M5 12l7-7l7 7" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- 二维码弹窗 -->
    <div class="modal-overlay" id="qrcodeModal" onclick="closeQRCode(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeQRCode()">×</button>
            <div id="qrcodeContainer" class="qrcode-container"></div>
            <button type="button" class="btn btn-primary btn-close-modal" onclick="closeQRCode()">关闭</button>
        </div>
    </div>

    <!-- 重置配置确认弹窗 -->
    <div class="modal-overlay" id="resetModal" onclick="closeResetModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <h2 class="reset-modal-title">⚠️ 重置配置</h2>
            <p class="reset-modal-description">重置配置将会初始化所有设置，包括订阅生成、节点信息、反代配置等。此操作不可撤销，请谨慎操作。</p>
            <p class="reset-modal-confirm">确定是否完全重置配置？</p>
            <div class="reset-modal-buttons">
                <button type="button" class="btn btn-primary btn-confirm-reset" onclick="confirmReset()">确定重置</button>
                <button type="button" class="btn btn-secondary" onclick="closeResetModal()">取消重置</button>
            </div>
        </div>
    </div>

    <!-- 清除Telegram配置确认弹窗 -->
    <div class="modal-overlay" id="clearTelegramModal" onclick="closeClearTelegramModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <h2 class="reset-modal-title">⚠️ 清除 Telegram 配置</h2>
            <p class="reset-modal-description">清除 Telegram Bot 通知配置后，将无法继续接收 Telegram 消息通知。此操作不可撤销，请谨慎操作。</p>
            <p class="reset-modal-confirm">确定是否清除 Telegram 通知配置？</p>
            <div class="reset-modal-buttons">
                <button type="button" class="btn btn-primary btn-confirm-reset"
                    onclick="confirmClearTelegramConfig()">确定清除</button>
                <button type="button" class="btn btn-secondary" onclick="closeClearTelegramModal()">取消</button>
            </div>
        </div>
    </div>

    <!-- 清除Cloudflare配置确认弹窗 -->
    <div class="modal-overlay" id="clearCloudflareModal" onclick="closeClearCloudflareModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <h2 class="reset-modal-title">⚠️ 清除 Cloudflare 配置</h2>
            <p class="reset-modal-description">清除 Cloudflare 配置后，将无法继续统计 Workers/Pages 的请求数。此操作不可撤销，请谨慎操作。</p>
            <p class="reset-modal-confirm">确定是否清除 Cloudflare 通知配置？</p>
            <div class="reset-modal-buttons">
                <button type="button" class="btn btn-primary btn-confirm-reset"
                    onclick="confirmClearCloudflareConfig()">确定清除</button>
                <button type="button" class="btn btn-secondary" onclick="closeClearCloudflareModal()">取消</button>
            </div>
        </div>
    </div>

    <!-- 日志查看弹窗 -->
    <div class="modal-overlay" id="logsModal">
        <div class="modal logs-modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeLogsModal()">×</button>
            <h2 class="logs-modal-title">📋 所有操作日志</h2>
            <div id="allLogsContainer" class="logs-all-container"></div>
            <button type="button" class="btn btn-primary btn-close-modal" onclick="closeLogsModal()">关闭</button>
        </div>
    </div>

    <!-- 订阅转换后端设置弹窗 -->
    <div class="modal-overlay" id="subAPIModal">
        <div class="modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeSubAPIModal()">×</button>
            <h2 class="subapi-modal-title">⚙️ 订阅转换后端</h2>
            <div class="form-group subapi-form-group">
                <label>订阅转换后端地址</label>
                <input type="text" id="testSubAPIInput" placeholder="输入订阅转换后端地址">
            </div>
            <div id="subAPIStatus" class="subapi-status"></div>
            <div class="subapi-buttons">
                <button type="button" class="btn btn-primary btn-test-api" onclick="testSubAPI()">可用性验证</button>
                <button type="button" class="btn btn-primary btn-confirm-api" id="subAPIConfirmBtn"
                    onclick="confirmSubAPI()" disabled>确定</button>
                <button type="button" class="btn btn-secondary btn-cancel-api" onclick="closeSubAPIModal()">取消</button>
            </div>
        </div>
    </div>

    <!-- TelegramBot 通知设置弹窗 -->
    <div class="modal-overlay" id="telegramConfigModal">
        <div class="modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeTelegramConfigModal()">×</button>
            <h2 class="subapi-modal-title">🤖 TelegramBot 通知参数配置</h2>
            <div class="form-group subapi-form-group">
                <label>Bot Token</label>
                <input type="text" id="telegramBotToken" placeholder="输入Telegram Bot Token">
            </div>
            <div class="form-group subapi-form-group">
                <label>Chat ID</label>
                <input type="text" id="telegramChatID" placeholder="输入Chat ID">
            </div>
            <div id="telegramStatus" class="subapi-status"></div>
            <div class="subapi-buttons">
                <button type="button" class="btn btn-primary btn-test-api" onclick="testTelegramConfig()">可用性验证</button>
                <button type="button" class="btn btn-primary btn-confirm-api" id="telegramConfirmBtn"
                    onclick="confirmTelegramConfig()" disabled>保存</button>
                <button type="button" class="btn btn-secondary btn-cancel-api"
                    onclick="closeTelegramConfigModal()">取消</button>
            </div>
        </div>
    </div>

    <!-- Cloudflare 通知设置弹窗 -->
    <div class="modal-overlay" id="cloudflareConfigModal">
        <div class="modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeCloudflareConfigModal()">×</button>
            <h2 class="subapi-modal-title">☁️ Workers/Pages 可用请求数统计</h2>

            <!-- 请求方案选择 -->
            <div class="form-group subapi-form-group">
                <label>请求方案</label>
                <select id="cloudflareAuthMethod" title="请求方案" onchange="updateCloudflareAuthMethod()">
                    <option id="usageapiOption" value="usageapi">UsageAPI</option>
                    <option value="accountid">Account ID + API Token</option>
                    <option value="email">Email + Global API Key</option>
                </select>
            </div>

            <!-- Email + Global API Key 方案 -->
            <div id="cloudflareEmailSection">
                <div class="form-group subapi-form-group">
                    <label>Email</label>
                    <input type="text" id="cloudflareEmail" placeholder="输入Cloudflare账户邮箱">
                </div>
                <div class="form-group subapi-form-group">
                    <label>Global API Key</label>
                    <input type="password" id="cloudflareGlobalAPIKey" placeholder="输入Global API Key">
                </div>
            </div>

            <!-- Account ID + API Token 方案 -->
            <div id="cloudflareAccountIDSection" class="hidden-section">
                <div class="form-group subapi-form-group">
                    <label>Account ID</label>
                    <input type="text" id="cloudflareAccountID" placeholder="输入Account ID">
                </div>
                <div class="form-group subapi-form-group">
                    <label>API Token</label>
                    <input type="password" id="cloudflareAPIToken" placeholder="输入API Token">
                    <small style="font-size: 12px; color: #9ca3af; margin-top: 6px; display: block;">💡 API令牌权限 使用
                        "阅读分析数据和日志" 模板即可</small>
                </div>
            </div>

            <!-- UsageAPI 方案 -->
            <div id="cloudflareUsageAPISection" class="hidden-section">
                <div class="form-group subapi-form-group">
                    <label>UsageAPI地址</label>
                    <input type="text" id="cloudflareUsageAPI"
                        placeholder="https://usagepanel.pages.dev/usage.json?token=4941477918857b30d8234ac19441ebb2">
                    <small style="font-size: 12px; color: #9ca3af; margin-top: 6px; display: block;">💡 支持多账号汇总，可通过部署 <a
                            href="https://github.com/cmliu/CF-Workers-UsagePanel" target="_blank" rel="noopener"
                            style="color: #3b82f6; text-decoration: none;">UsagePanel</a> 项目获取 UsageAPI 地址</small>
                </div>
            </div>

            <!-- 验证状态提示 -->
            <div id="cloudflareStatus" class="subapi-status"></div>

            <!-- 按钮组 -->
            <div class="subapi-buttons">
                <button type="button" class="btn btn-primary btn-test-api"
                    onclick="testCloudflareConfig()">可用性验证</button>
                <button type="button" class="btn btn-primary btn-confirm-api" id="cloudflareConfirmBtn"
                    onclick="confirmCloudflareConfig()" disabled>保存</button>
                <button type="button" class="btn btn-secondary btn-cancel-api"
                    onclick="closeCloudflareConfigModal()">取消</button>
            </div>
        </div>
    </div>

    <!-- 在线优选弹窗 -->
    <div class="modal-overlay" id="onlineOptimizeModal">
        <div class="modal optimize-modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeOnlineOptimizeModal()">×</button>
            <h2 class="optimize-modal-title">🚀 在线优选</h2>

            <!-- IP检测信息 -->
            <div id="ipDetectionBox" class="ip-detection-box">
                <div class="ip-detection-info">
                    正在检测您的网络环境...
                </div>
            </div>

            <!-- 参数选择 -->
            <div class="optimize-params-row">
                <div class="form-group">
                    <label for="optimizeIPLibrary">IP库：</label>
                    <select id="optimizeIPLibrary">
                        <option value="cf-official">CF官方列表</option>
                        <option value="cm-list">CM整理列表</option>
                        <option value="as13335">AS13335列表</option>
                        <option value="as209242">AS209242列表</option>
                        <option value="reverse-proxy">反向代理列表</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="optimizePort">端口：</label>
                    <select id="optimizePort">
                        <option value="443">443</option>
                        <option value="2053">2053</option>
                        <option value="2083">2083</option>
                        <option value="2087">2087</option>
                        <option value="2096">2096</option>
                        <option value="8443">8443</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="optimizeConcurrency">测试线程数：</label>
                    <input type="number" id="optimizeConcurrency" min="1" max="32" value="8"
                        class="optimize-concurrency-input" placeholder="1-32" oninput="validateConcurrency(this)"
                        onchange="validateConcurrency(this)">
                </div>
            </div>

            <!-- 进度条 -->
            <div class="optimize-progress-bar hidden-section" id="optimizeProgressBar">
                <div class="optimize-progress-fill" id="optimizeProgressFill"></div>
                <div class="optimize-progress-text" id="optimizeProgressText">0/512 (0.00%) - 成功: 0, 失败: 0</div>
            </div>

            <!-- 结果选项卡 -->
            <div id="optimizeResultsTabs" class="optimize-results-tabs hidden-section"></div>

            <!-- 结果内容 -->
            <div id="optimizeResultsContent" class="optimize-results-content hidden-section"></div>

            <!-- 按钮组 -->
            <div class="optimize-buttons">
                <span class="save-tip">💡 保存提示：仅保存延迟最低的前16个优选IP</span>
                <button type="button" class="btn btn-start-optimize" id="btnStartOptimize"
                    onclick="startOptimize()">开始优选</button>
                <button type="button" class="btn btn-save-override" id="btnSaveOverride"
                    onclick="saveOptimizeResults('override')" disabled>覆盖保存</button>
                <button type="button" class="btn btn-save-append" id="btnSaveAppend"
                    onclick="saveOptimizeResults('append')" disabled>追加保存</button>
                <button type="button" class="btn btn-secondary" onclick="closeOnlineOptimizeModal()">关闭</button>
            </div>
        </div>
    </div>

    <!-- API优选模态框 -->
    <div class="modal-overlay" id="apiOptimizeModal">
        <div class="modal api-optimize-modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeAPIOptimizeModal()">×</button>
            <h2 class="api-optimize-modal-title">🔌 订阅接口</h2>

            <!-- API URL 输入 -->
            <div class="api-form-group">
                <div class="api-form-row">
                    <label>API URL:</label>
                    <input type="text" id="apiOptimizeURL" placeholder="请输入 优选API地址 或 需要汇聚的订阅地址"
                        title="请输入 优选API地址 或 需要汇聚的订阅地址" oninput="autoConvertGitHubURL(); autoDetectPortFromURL()">
                </div>
            </div>

            <!-- 默认端口输入 -->
            <div class="api-form-group">
                <div class="api-form-row">
                    <label>默认端口:</label>
                    <input type="number" id="apiOptimizePort" value="443" min="1" max="65535" placeholder="1-65535"
                        title="默认端口(1-65535)">
                </div>
            </div>

            <!-- 结果显示区域 -->
            <div class="api-results-container">
                <label class="api-results-label">接口结果:</label>
                <div class="line-editor" id="apiResultsEditor">
                    <div class="gutter" aria-hidden="true"></div>
                    <div class="editor-area">
                        <pre class="mirror" aria-hidden="true"></pre>
                        <textarea id="apiOptimizeResults" title="API接口结果" placeholder="接口返回结果将显示在这里，每行一个地址"
                            readonly></textarea>
                    </div>
                </div>
            </div>

            <!-- 按钮组 -->
            <div class="api-buttons">
                <button type="button" class="btn btn-verify-api" id="btnVerifyAPI"
                    onclick="verifyAPIOptimize()">可用性验证</button>
                <button type="button" class="btn btn-append-api" id="btnAppendAPI" onclick="appendAPIToCustom()"
                    disabled>追加API</button>
                <button type="button" class="btn btn-append-results" id="btnAppendResults"
                    onclick="appendResultsToCustom()" disabled>追加结果</button>
                <button type="button" class="btn btn-close-api" onclick="closeAPIOptimizeModal()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 代理验证模态框 -->
    <div class="modal-overlay" id="proxyVerificationModal">
        <div class="modal" id="proxyVerificationContent" style="min-width: 450px;" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeProxyVerificationModal()">×</button>

            <h2 id="proxyVerificationTitle"
                style="margin-bottom: 20px; font-size: 18px; font-weight: 600; text-align: center;"></h2>

            <div class="form-group" style="margin-bottom: 20px;">
                <label id="proxyVerificationLabel" for="proxyVerificationInput"
                    style="display: block; margin-bottom: 10px; font-weight: 600;"></label>
                <input type="text" id="proxyVerificationInput" title="代理地址"
                    style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>

            <div id="proxyVerificationStatus"
                style="margin-bottom: 20px; padding: 12px; border-radius: 8px; display: none; font-size: 14px;">
            </div>

            <div class="api-buttons" style="display: flex; gap: 10px; justify-content: space-between;">
                <button type="button" class="btn btn-verify-api" onclick="verifyProxyAvailability()" style="flex: 1;">
                    可用性验证
                </button>
                <button type="button" class="btn btn-append-api" id="proxyConfirmBtn" onclick="confirmProxyAddress()"
                    style="flex: 1; opacity: 0.5;" disabled>
                    确定
                </button>
                <button type="button" class="btn btn-close-api" onclick="closeProxyVerificationModal()"
                    style="flex: 1;">
                    取消
                </button>
            </div>
        </div>
    </div>

    <!-- ProxyIP 帮助科普弹窗 -->
    <div class="modal-overlay" id="proxyIPHelpModal" onclick="closeProxyIPHelpModal(event)">
        <div class="modal proxyip-help-modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeProxyIPHelpModal()">×</button>

            <!-- 简易模式 -->
            <div id="proxyIPHelpSimple" style="display: none;">
                <div class="api-docs">
                    <h2 class="section-title">🤔 为什么需要反代模式？PROXYIP又是什么？</h2>

                    <div class="simple-explanation">
                        <strong>用最简单的话解释：</strong><br><br>

                        <strong>🚀 问题是这样的：</strong><br>
                        我们的 edgetunnel 服务部署在 Cloudflare Workers 上。但是 Cloudflare 有个限制——他们的 Workers 无法直接访问 Cloudflare
                        自己的服务。<br><b>这就像名叫 Cloudflare 的小白永远无法从自己的眼睛里看到自己。</b><br><br>

                        <strong>💡 解决方案：</strong><br>
                        为了解决这个问题，我们需要借助外部服务器（ProxyIP、SOCKS5 或 HTTP）作为「跳板」，通过这些第三方服务器来代理访问 Cloudflare
                        的服务。<br><b>相当于找了一面（ProxyIP/SOCKS5/HTTP）镜子，这样 Cloudflare 就能通过镜子看到了自己。</b><br><br>

                        <strong>📍 实际效果：</strong>
                        <ul style="margin: 12px 0 0 20px; padding-left: 0;">
                            <li style="margin-bottom: 8px;">👤 访问<strong>非 Cloudflare CDN
                                    的网站</strong>时（如<b>油管、谷歌</b>等），你的 IP 由「优选 IP」决定</li>
                            <li>🌐 访问<strong>由 Cloudflare CDN 托管的网站</strong>时（如<b>推特、ChatGPT</b>等），你的 IP
                                由「反代模式（PROXYIP/SOCKS5/HTTP）」决定</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 详细模式 -->
            <div id="proxyIPHelpDetail" style="display: block;">
                <div class="api-docs">
                    <h2 class="section-title">🤔 为什么需要反代模式？PROXYIP又是什么？</h2>
                    <h3 style="color: var(--text-primary); margin: 24px 0 16px;">❓ 为什么需要反代模式？</h3>
                    <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                        根据 Cloudflare Workers 的 <a
                            href="https://developers.cloudflare.com/workers/runtime-apis/tcp-sockets/" target="_blank"
                            rel="noopener" style="color: var(--primary-color); text-decoration: none;">TCP Sockets
                            官方文档</a> 说明，存在以下技术限制：
                    </p>
                    <div class="code-block">
                        ⚠️ Outbound TCP sockets to <a href="https://www.cloudflare.com/ips/" target="_blank"
                            rel="noopener" style="color: inherit; text-decoration: underline;">Cloudflare IP ranges
                            ↗</a> are temporarily blocked, but will be re-enabled shortly.
                    </div>

                    <p style="margin: 16px 0; line-height: 1.8; color: var(--text-secondary);">
                        这意味着 Cloudflare Workers 无法直接连接到 Cloudflare 自有的 IP 地址段。为了解决这个限制，需要借助第三方云服务商的服务器作为「跳板」：
                    </p>

                    <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                        而我们的 <b>edgetunnel</b> 是部署在 Cloudflare Workers 上的代理服务。根据 Cloudflare Workers 的限制政策，Workers
                        节点无法直接连接到
                        Cloudflare 自有的 IP 地址段。这意味着：
                    </p>
                    <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                        <li style="margin-bottom: 8px; color: var(--text-secondary);">✅ 可以正常访问非 Cloudflare CDN 的站点</li>
                        <li style="color: var(--text-secondary);">❌ 无法直接访问由 Cloudflare CDN 托管的网站</li>
                    </ul>
                    <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                        因此需要反代模式来解决这个问题。反代模式通过第三方服务器作为「中介」，帮助 Workers 绕过这一限制。
                    </p>

                    <div
                        style="background: var(--bg-secondary); padding: 20px; border-radius: var(--border-radius-sm); margin: 20px 0;">
                        <div
                            style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 16px;">
                            <div
                                style="background: #e3f2fd; padding: 12px; border-radius: 8px; text-align: center; flex: 1; min-width: 120px;">
                                <div style="font-weight: 600; color: #1976d2;">Cloudflare Workers</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">发起请求</div>
                            </div>
                            <div style="color: var(--primary-color); font-size: 1.5rem;">→</div>
                            <div
                                style="background: #f3e5f5; padding: 12px; border-radius: 8px; text-align: center; flex: 1; min-width: 120px;">
                                <div style="font-weight: 600; color: #7b1fa2;">PROXYIP/SOCKS5/HTTP 服务器</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">第三方代理</div>
                            </div>
                            <div style="color: var(--primary-color); font-size: 1.5rem;">→</div>
                            <div
                                style="background: #e8f5e8; padding: 12px; border-radius: 8px; text-align: center; flex: 1; min-width: 120px;">
                                <div style="font-weight: 600; color: #388e3c;">Cloudflare 服务</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">目标服务</div>
                            </div>
                        </div>
                        <p style="text-align: center; color: var(--text-secondary); font-size: 0.95rem; margin: 0;">
                            通过第三方服务器反向代理 Cloudflare 的 443 端口，实现 Workers 对 Cloudflare 服务的访问
                        </p>
                    </div>

                    <h3 style="color: var(--text-primary); margin: 24px 0 16px;">💡 实际应用效果</h3>
                    <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                        因此，你访问网络时的 IP 归属地取决于访问的目标网站类型：
                    </p>
                    <ul style="margin: 12px 0; padding-left: 20px; line-height: 1.8;">
                        <li style="margin-bottom: 12px; color: var(--text-secondary);">👤 访问<strong>非 Cloudflare CDN
                                站点</strong>时（如<b>油管、谷歌</b>等），你的 IP 归属地由「优选 IP」决定</li>
                        <li style="color: var(--text-secondary);">🌐 访问<strong>由 Cloudflare CDN
                                托管的网站</strong>时（如<b>推特、ChatGPT</b>等），你的 IP
                            归属地由「ProxyIP/SOCKS5/HTTP」决定</li>
                    </ul>
                </div>
            </div>

            <!-- 切换按钮 -->
            <div class="toggle-switch">
                <input type="checkbox" id="proxyIPSimpleMode" onchange="toggleProxyIPHelpMode()">
                <label for="proxyIPSimpleMode">我是小白，我看不懂</label>
            </div>

            <button type="button" class="btn btn-primary btn-close-modal" onclick="closeProxyIPHelpModal()"
                style="margin-top: 20px;">关闭</button>
        </div>
    </div>

    <!-- ECH 帮助模态框 -->
    <div class="modal-overlay" id="echHelpModal" onclick="closeECHHelpModal(event)">
        <div class="modal ech-help-modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeECHHelpModal()">×</button>

            <!-- 选项卡 -->
            <div class="ech-tabs">
                <button class="ech-tab active" onclick="switchECHTab(0)">什么是ECH？</button>
                <button class="ech-tab" onclick="switchECHTab(1)">如何使用？</button>
                <button class="ech-tab" onclick="switchECHTab(2)">如何确认 ECH 是否已经生效？</button>
            </div>

            <!-- 选项卡内容 -->
            <div class="ech-tab-content">
                <div class="ech-tab-pane active" id="echTab0">
                    <div class="api-docs">
                        <h2 class="section-title">🔐 什么是 ECH？</h2>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            <strong>ECH（Encrypted Client Hello，加密客户端问候）</strong> 是 TLS 的一项新特性，用来
                            <strong>将原本会明文暴露的域名信息一起加密</strong>。
                        </p>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            如果你希望了解更完整、偏技术细节的说明，可以参考 Cloudflare 官方博客：<br>
                            👉 <a href="https://blog.cloudflare.com/zh-cn/announcing-encrypted-client-hello/"
                                target="_blank" rel="noopener"
                                style="color: var(--primary-color); text-decoration: none;">https://blog.cloudflare.com/zh-cn/announcing-encrypted-client-hello/</a>
                        </p>

                        <h3 style="color: var(--text-primary); margin: 24px 0 16px;">📖 背景说明</h3>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            当我们使用 <strong>WS + TLS</strong> 的节点进行代理时：
                        </p>

                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">✅ 实际通信内容已经被 TLS 加密，GFW
                                <strong>无法看到你访问的具体内容</strong>
                            </li>
                            <li style="color: var(--text-secondary);">❌ 但在 TLS 握手阶段，仍然会暴露一个关键信息：<strong>SNI</strong>
                            </li>
                        </ul>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            <strong>SNI 就是节点的伪装域名（HOST）</strong>
                        </p>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            也就是说：
                        </p>

                        <div class="code-block"
                            style="background: #fff3cd; color: #856404; border-left-color: #ffc107;">
                            GFW 虽然不知道你在访问什么，但知道你在"扶墙"，并且知道你连接的是哪个域名。
                        </div>

                        <h3 style="color: var(--text-primary); margin: 24px 0 16px;">⚠️ 会带来什么问题？</h3>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            这就是为什么在以下场景中经常出现异常情况：
                        </p>

                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">❌ v2rayN 批量测试真链接延迟</li>
                            <li style="color: var(--text-secondary);">❌ Clash 策略组自动选择节点</li>
                        </ul>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            表现通常为：
                        </p>

                        <div class="code-block"
                            style="background: #f8d7da; color: #721c24; border-left-color: #dc3545;">
                            所有节点瞬间 -1，全部无法使用
                        </div>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            其原因并不是节点真的失效，而是 <strong>运营商 / GFW 通过阻断节点域名的访问来干扰代理连接</strong>。<br>
                            由于这种阻断大多是自动化策略，容易误判，因此 <strong>过一段时间节点又可能恢复正常</strong>，反复循环。
                        </p>

                        <h3 style="color: var(--text-primary); margin: 24px 0 16px;">💡 ECH 的作用</h3>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            ECH 的核心作用是：
                        </p>

                        <div class="code-block"
                            style="background: #d1ecf1; color: #0c5460; border-left-color: #17a2b8;">
                            将 SNI（也就是节点域名）加密
                        </div>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            启用 ECH 后：
                        </p>

                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">✅ GFW
                                <strong>无法获取真实的节点域名</strong>
                            </li>
                            <li style="color: var(--text-secondary);">✅ 外部观察到的域名将统一显示为：<code
                                    style="background: #e9ecef; padding: 2px 4px; border-radius: 3px;">cloudflare-ech.com</code>
                            </li>
                        </ul>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            这从源头上 <strong>阻断了通过域名精准封锁节点的手段</strong>。
                        </p>

                        <h3 style="color: var(--text-primary); margin: 24px 0 16px;">🤔 ECH 会不会被封？</h3>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            理论上，GFW 只需 <strong>直接阻断 <code>cloudflare-ech.com</code></strong> 即可。
                        </p>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            但这样会：
                        </p>

                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">❌ 误伤大量正常使用 ECH 的网站和服务</li>
                            <li style="color: var(--text-secondary);">❌ 带来较高的封锁成本和副作用</li>
                        </ul>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            因此，<strong>ECH 能持续多久，取决于 GFW 的取舍与策略</strong>，至少在目前阶段仍然非常有效。
                        </p>
                    </div>
                </div>

                <div class="ech-tab-pane" id="echTab1">
                    <div class="api-docs">
                        <h2 class="section-title">🚀 如何使用 ECH？</h2>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            使用 ECH 非常简单，只需要 <strong>ECH 设置</strong> 为 <strong>开启</strong> 后更新订阅即可。
                        </p>

                        <h3 style="color: var(--text-primary); margin: 24px 0 16px;">📱 支持 ECH 的客户端</h3>

                        <h4 style="color: var(--text-primary); margin: 20px 0 12px;">Windows：</h4>
                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">
                                <strong>v2rayN ≥ v7.17.0</strong><br>
                                <a href="https://github.com/2dust/v2rayN/releases" target="_blank" rel="noopener"
                                    style="color: var(--primary-color); text-decoration: none;">https://github.com/2dust/v2rayN/releases</a>
                            </li>
                        </ul>

                        <h4 style="color: var(--text-primary); margin: 20px 0 12px;">Android：</h4>
                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">
                                <strong>v2rayNG ≥ v2.0.0</strong><br>
                                <a href="https://github.com/2dust/v2rayNG/releases" target="_blank" rel="noopener"
                                    style="color: var(--primary-color); text-decoration: none;">https://github.com/2dust/v2rayNG/releases</a>
                            </li>
                        </ul>

                        <h4 style="color: var(--text-primary); margin: 20px 0 12px;">Clash.Meta（mihomo 内核）：</h4>
                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">
                                所有使用 <strong>clash.meta / mihomo 内核</strong> 的客户端均支持 ECH
                            </li>
                            <li style="color: var(--text-secondary);">
                                ⚠️ <strong>需要 DNS 配合使用</strong>
                            </li>
                        </ul>

                        <h3 style="color: var(--text-primary); margin: 24px 0 16px;">⚠️ Clash 用户注意事项</h3>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            当前订阅配置中已 <strong>内置 ECH 所需的 DNS 设置</strong>。
                        </p>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            如果出现以下情况：
                        </p>

                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">✅ 已开启 ECH</li>
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">✅ 已更新订阅</li>
                            <li style="color: var(--text-secondary);">❌ ECH 节点仍然无法使用</li>
                        </ul>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            请检查：
                        </p>

                        <div class="code-block"
                            style="background: #fff3cd; color: #856404; border-left-color: #ffc107;">
                            是否在更新订阅时覆盖了原有的 DNS 配置
                        </div>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            建议：<strong>不要覆盖订阅中自带的 DNS 设置</strong>
                        </p>
                    </div>
                </div>

                <div class="ech-tab-pane" id="echTab2">
                    <div class="api-docs">
                        <h2 class="section-title">🔍 如何确认 ECH 是否已经生效？</h2>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            可以通过一个 <strong>简单且直观的方法</strong> 来验证 ECH 是否正常工作。
                        </p>

                        <h3 style="color: var(--text-primary); margin: 24px 0 16px;">📋 验证步骤</h3>

                        <ol style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 12px; color: var(--text-secondary);">打开节点的 <strong>「⚙️
                                    详细配置信息」</strong></li>
                            <li style="margin-bottom: 12px; color: var(--text-secondary);">在 <strong>HOST</strong>
                                中手动填写一个 <strong>已被墙的域名</strong>，例如： <code
                                    style="background: #e9ecef; padding: 2px 4px; border-radius: 3px;">*.workers.dev</code>
                            </li>
                            <li style="margin-bottom: 12px; color: var(--text-secondary);">保存配置后 <strong>重新更新订阅</strong>
                            </li>
                            <li style="color: var(--text-secondary);">在节点列表中查找：
                                <ul style="margin: 8px 0 0 20px; padding-left: 0;">
                                    <li style="margin-bottom: 4px;">- HOST 为 <code
                                            style="background: #e9ecef; padding: 2px 4px; border-radius: 3px;">*.workers.dev</code>
                                        的节点</li>
                                    <li>- 并尝试连接该节点</li>
                                </ul>
                            </li>
                        </ol>

                        <h3 style="color: var(--text-primary); margin: 24px 0 16px;">✅ 如何判断结果？</h3>

                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 12px; color: var(--text-secondary);">
                                <strong style="color: #28a745;">✅ 如果节点可以正常连接使用</strong><br>
                                说明 <strong>ECH 已成功生效</strong>，真实被墙的域名已被隐藏，对外仅显示为 <code
                                    style="background: #e9ecef; padding: 2px 4px; border-radius: 3px;">cloudflare-ech.com</code>
                            </li>
                            <li style="color: var(--text-secondary);">
                                <strong style="color: #dc3545;">❌ 如果节点无法连接</strong><br>
                                说明 ECH 未生效，或客户端版本、DNS 配置存在问题
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <button type="button" class="btn btn-primary btn-close-modal" onclick="closeECHHelpModal()"
                style="margin-top: 20px;">关闭</button>
        </div>
    </div>

    <!-- HOSTS 编辑模态框 -->
    <div class="modal-overlay" id="hostsEditModal">
        <div class="modal hosts-edit-modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeHostsEditModal()">×</button>
            <h2 class="hosts-edit-modal-title">✏️ 编辑节点 自定义域名 列表</h2>

            <div class="hosts-edit-container">
                <label class="hosts-edit-label">自定义域名列表:</label>
                <textarea id="hostsEditTextarea" class="hosts-edit-textarea" placeholder="每行输入一个域名"></textarea>
            </div>

            <div class="hosts-edit-footer">
                <div class="hosts-edit-hint">💡 一行一个节点域名，无需添加逗号</div>
                <div class="hosts-edit-buttons">
                    <button type="button" class="btn btn-hosts-cancel" onclick="closeHostsEditModal()">取消</button>
                    <button type="button" class="btn btn-hosts-confirm" onclick="confirmHostsEdit()">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 获取更多 PROXYIP 弹窗 -->
    <div class="modal-overlay" id="getMoreProxyIPModal">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 420px; text-align: left;">
            <button type="button" class="modal-close" onclick="closeGetMoreProxyIPModal()">×</button>
            <h2 class="section-title" style="margin-bottom: 15px; text-align: center;">🗺️ 探索更多 PROXYIP</h2>
            <p style="text-align: center; color: #666; font-size: 14px; margin-bottom: 25px;">
                通过网络测绘搜索引擎，查找指定地区的 反代IP 资源。<br>
                <span style="font-size: 12px; color: #999;">(搜索结果仅供参考，请自行验证连通性)</span>
            </p>

            <div class="form-group">
                <label for="proxyRegionSelect">🏳️‍🌈 选择目标地区</label>
                <div class="input-wrapper">
                    <select id="proxyRegionSelect" onchange="onProxyRegionChange()" style="padding-left: 16px;">
                        <option value="custom">✍️ 自定义地区</option>
                        <optgroup label="🌏 亚洲 / AS">
                            <option value="HK">🇭🇰 香港</option>
                            <option value="TW">🇨🇳 台湾</option>
                            <option value="KR">🇰🇷 韩国</option>
                            <option value="JP">🇯🇵 日本</option>
                            <option value="SG">🇸🇬 新加坡</option>
                            <option value="IN">🇮🇳 印度</option>
                        </optgroup>
                        <optgroup label="🌎 北美 / NA">
                            <option value="US">🇺🇸 美国</option>
                            <option value="CA">🇨🇦 加拿大</option>
                        </optgroup>
                        <optgroup label="🌍 欧洲 / EU">
                            <option value="GB">🇬🇧 英国</option>
                            <option value="DE">🇩🇪 德国</option>
                            <option value="FR">🇫🇷 法国</option>
                        </optgroup>
                        <optgroup label="🌏 大洋洲 / OC">
                            <option value="AU">🇦🇺 澳大利亚</option>
                        </optgroup>
                    </select>
                </div>
            </div>

            <div class="form-group" id="customRegionInputGroup">
                <label for="customRegionInput">⌨️ 输入地区代码</label>
                <div class="input-wrapper">
                    <input type="text" id="customRegionInput" placeholder="请输入两位字母代码，例如: US" maxlength="2"
                        style="text-transform: uppercase;" disabled oninput="this.value = this.value.toUpperCase();">
                </div>
            </div>

            <div class="form-group">
                <label for="proxyPortSelect">🔌 选择目标端口</label>
                <div class="input-wrapper">
                    <select id="proxyPortSelect" style="padding-left: 16px;">
                        <option value="443">443</option>
                        <option value="nonstandard">非标</option>
                    </select>
                </div>
            </div>

            <div class="btn-group" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-top: 30px; max-width: 600px; margin-left: auto; margin-right: auto;">
                <button type="button" class="btn btn-fofa" onclick="openFOFA()" style="padding: 12px 16px; font-size: 14px; font-weight: 500; white-space: nowrap;">
                    FOFA 测绘
                </button>
                <button type="button" class="btn btn-360quake" onclick="open360Quake()" style="padding: 12px 16px; font-size: 14px; font-weight: 500; white-space: nowrap;">
                    360 测绘
                </button>
                <button type="button" class="btn btn-ech-help" onclick="window.open('https://check.proxyip.cmliussss.net/', '_blank')" style="padding: 12px 16px; font-size: 14px; font-weight: 500; white-space: nowrap;">
                    可用性验证
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeGetMoreProxyIPModal()" style="padding: 12px 16px; font-size: 14px; font-weight: 500; white-space: nowrap;">
                    关闭
                </button>
            </div>
        </div>
    </div>

    <!-- 探索SOCKS5弹窗 -->
    <div class="modal-overlay" id="exploreSocks5Modal">
        <div class="modal" style="max-width: 550px; text-align: left;">
            <button type="button" class="modal-close" onclick="closeExploreSocks5Modal(event)" style="cursor: pointer;">×</button>
            <h2 class="section-title" style="margin-bottom: 15px; text-align: center;">🗺️ 探索更多 SOCKS5</h2>
            
            <div class="socks5-list-container">
                <div class="form-group">
                    <label for="socks5RegionSelect">🏳️‍🌈 选择目标地区</label>
                    <div class="input-wrapper">
                        <select id="socks5RegionSelect" onchange="onSocks5RegionChange()" style="padding-left: 16px;">
                            <option value="">加载中...</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id="socks5ProxySelectGroup" style="display: none;">
                    <label for="socks5ProxySelect">🌐 选择目标代理</label>
                    <div class="input-wrapper">
                        <select id="socks5ProxySelect" onchange="updateSocks5ConfirmButton()" style="padding-left: 16px; font-family: 'Fira Code', monospace; font-size: 12px;">
                            <option value="">加载中...</option>
                        </select>
                    </div>
                </div>

                <div class="socks5-loading-info" id="socks5LoadingInfo" style="display: none; padding: 12px; background: rgba(255,193,7,0.1); border-radius: 4px; font-size: 12px; color: #666; margin: 12px 0;">
                    正在验证SOCKS5可用性，请稍候...
                </div>
            </div>

            <div class="btn-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 30px;">
                <button type="button" class="btn btn-primary" id="socks5ConfirmBtn" onclick="confirmSelectSocks5()" disabled style="padding: 12px 16px; font-size: 14px; font-weight: 500; white-space: nowrap;">
                    确定
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeExploreSocks5Modal(event)" style="padding: 12px 16px; font-size: 14px; font-weight: 500; white-space: nowrap;">
                    取消
                </button>
            </div>
        </div>
    </div>

    <!-- 探索HTTP弹窗 -->
    <div class="modal-overlay" id="exploreHTTPModal">
        <div class="modal" style="max-width: 550px; text-align: left;">
            <button type="button" class="modal-close" onclick="closeExploreHTTPModal(event)" style="cursor: pointer;">×</button>
            <h2 class="section-title" style="margin-bottom: 15px; text-align: center;">🗺️ 探索更多 HTTP</h2>
            
            <div class="http-list-container">
                <div class="form-group">
                    <label for="httpRegionSelect">🏳️‍🌈 选择目标地区</label>
                    <div class="input-wrapper">
                        <select id="httpRegionSelect" onchange="onHTTPRegionChange()" style="padding-left: 16px;">
                            <option value="">加载中...</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id="httpProxySelectGroup" style="display: none;">
                    <label for="httpProxySelect">🌐 选择目标代理</label>
                    <div class="input-wrapper">
                        <select id="httpProxySelect" onchange="updateHTTPConfirmButton()" style="padding-left: 16px; font-family: 'Fira Code', monospace; font-size: 12px;">
                            <option value="">加载中...</option>
                        </select>
                    </div>
                </div>

                <div class="http-loading-info" id="httpLoadingInfo" style="display: none; padding: 12px; background: rgba(255,193,7,0.1); border-radius: 4px; font-size: 12px; color: #666; margin: 12px 0;">
                    正在验证HTTP可用性，请稍候...
                </div>
            </div>

            <div class="btn-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 30px;">
                <button type="button" class="btn btn-primary" id="httpConfirmBtn" onclick="confirmSelectHTTP()" disabled style="padding: 12px 16px; font-size: 14px; font-weight: 500; white-space: nowrap;">
                    确定
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeExploreHTTPModal(event)" style="padding: 12px 16px; font-size: 14px; font-weight: 500; white-space: nowrap;">
                    取消
                </button>
            </div>
        </div>
    </div>

    <!-- HOSTS 检查提示弹窗 -->
    <div class="modal-overlay" id="hostsMismatchModal" onclick="closeHostsMismatchModal(event)">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px;">
            <button type="button" class="modal-close" onclick="closeHostsMismatchModal()">×</button>
            <div style="text-align: center; padding: 20px 0;">
                <h2 style="color: #f44336; margin: 0 0 16px 0; font-size: 22px; font-weight: 700;">⚠️ 域名配置提示</h2>
                <p style="margin: 0 0 12px 0; font-size: 14px; line-height: 1.6; text-align: left;">
                    您当前访问管理面板使用的域名是：<strong id="currentHostname" style="color: #2196F3;"></strong>
                </p>
                <p style="margin: 0 0 12px 0; font-size: 14px; line-height: 1.6; text-align: left; color: #f44336;">
                    <strong>⚠️ 注意：</strong>该域名 <strong>未配置为节点伪装域名</strong>。这意味着生成的订阅配置将 <strong>不会使用当前域名</strong> 作为 <strong>节点域名</strong>。
                </p>
                <p style="margin: 0 0 12px 0; font-size: 14px; line-height: 1.6; text-align: left;">
                    <strong>当前配置的节点伪装域名：</strong>
                </p>
                <div id="currentHosts" style="margin: 0 0 16px 0; padding: 12px; background-color: transparent; border-radius: 0; text-align: left; font-size: 13px; max-height: 120px; overflow-y: auto; word-break: break-all; display: flex; flex-wrap: wrap; gap: 8px; align-content: flex-start;"></div>
                <p style="margin: 0 0 16px 0; font-size: 13px; line-height: 1.6; text-align: left;">
                    <strong>如何修改？</strong>请在高手模式下的"⚙️ 详细配置信息"，在"HOST"里添加您的域名"<strong id="hostToAdd" style="color: #2196F3;"></strong>"，保存配置后即可生效。
                </p>
            </div>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button type="button" class="btn btn-hosts-warning" onclick="dismissHostsMismatchNotification()" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: #fff; border: none; padding: 12px 16px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3); transition: all 0.3s ease;">我知道了！24小时内不再提示！</button>
            </div>
        </div>
    </div>

    <script data-cfasync="false">
        let currentConfig = {};
        let originalConfig = {};
        let modifiedSections = new Set();
        let subConfigData = null;
        let hasMultipleHosts = false; // 标记是否存在多个 HOSTS

        // 延迟测试配置
        const latencyTestConfig = {
            count: 16  // 采样和显示数量
        };

        // 追踪延迟显示的动画状态
        const latencyUIState = {};

        // 标记延迟测试是否已经开始，防止重复执行
        let latencyTestStarted = false;

        // 延迟测试数据
        const latencySites = [
            {
                name: '字节抖音',
                region: '国内',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#1677FF" d="m19.9 1.5 4.1 1v19l-4.1 1zM6.5 10.9l4.1 1v9l-4 1.1zM0 2.6l4.1 1v16.8l-4.1 1zm17.5 5.6v11.1l-4.2-1v-9z"></path></svg>',
                url: 'https://lf3-zlink-tos.ugurl.cn/obj/zebra-public/resource_lmmizj_1632398893.png'
            },
            {
                name: 'Bilibili',
                region: '国内',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#FB7299" d="M17.813 4.653h.854q2.266.08 3.773 1.574Q23.946 7.72 24 9.987v7.36q-.054 2.266-1.56 3.773c-1.506 1.507-2.262 1.524-3.773 1.56H5.333q-2.266-.054-3.773-1.56C.053 19.614.036 18.858 0 17.347v-7.36q.054-2.267 1.56-3.76t3.773-1.574h.774l-1.174-1.12a1.23 1.23 0 0 1-.373-.906q0-.534.373-.907l.027-.027q.4-.373.92-.373t.92.373L9.653 4.44q.107.106.187.213h4.267a.8.8 0 0 1 .16-.213l2.853-2.747q.4-.373.92-.373c.347 0 .662.151.929.4s.391.551.391.907q0 .532-.373.906zM5.333 7.24q-1.12.027-1.88.773q-.76.748-.786 1.894v7.52q.026 1.146.786 1.893t1.88.773h13.334q1.12-.026 1.88-.773t.786-1.893v-7.52q-.026-1.147-.786-1.894t-1.88-.773zM8 11.107q.56 0 .933.373q.375.374.4.96v1.173q-.025.586-.4.96q-.373.375-.933.374c-.56-.001-.684-.125-.933-.374q-.375-.373-.4-.96V12.44q0-.56.386-.947q.387-.386.947-.386m8 0q.56 0 .933.373q.375.374.4.96v1.173q-.025.586-.4.96q-.373.375-.933.374c-.56-.001-.684-.125-.933-.374q-.375-.373-.4-.96V12.44q.025-.586.4-.96q.373-.373.933-.373"></path></svg>',
                url: 'https://i0.hdslb.com/bfs/face/member/noface.jpg@24w_24h_1c'
            },
            {
                name: '腾讯微信',
                region: '国内',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#09B83E" d="M8.7 2.19C3.9 2.19 0 5.48 0 9.53c0 2.21 1.17 4.2 3 5.55a.6.6 0 0 1 .21.66l-.39 1.48q-.03.11-.04.22c0 .16.13.3.29.3a.3.3 0 0 0 .16-.06l1.9-1.11a.9.9 0 0 1 .72-.1 10 10 0 0 0 2.84.4q.41-.01.81-.05a5.85 5.85 0 0 1 1.93-6.45 8.3 8.3 0 0 1 5.86-1.83c-.58-3.59-4.2-6.35-8.6-6.35m-2.9 3.8c.64 0 1.16.53 1.16 1.18a1.17 1.17 0 0 1-1.16 1.18 1.17 1.17 0 0 1-1.17-1.18c0-.65.52-1.18 1.17-1.18m5.8 0c.65 0 1.17.53 1.17 1.18a1.17 1.17 0 0 1-1.16 1.18 1.17 1.17 0 0 1-1.16-1.18c0-.65.52-1.18 1.16-1.18m5.34 2.87a8 8 0 0 0-5.28 1.78 5.5 5.5 0 0 0-1.78 6.22c.94 2.46 3.66 4.23 6.88 4.23q1.25 0 2.36-.33a.7.7 0 0 1 .6.08l1.59.93.14.04c.13 0 .24-.1.24-.24q-.01-.09-.04-.18l-.33-1.23-.02-.16a.5.5 0 0 1 .2-.4 5.8 5.8 0 0 0 2.5-4.62c0-3.21-2.93-5.84-6.66-6.09zm-2.53 3.27c.53 0 .97.44.97.98a1 1 0 0 1-.97.99 1 1 0 0 1-.97-.99c0-.54.43-.98.97-.98zm4.84 0c.54 0 .97.44.97.98a1 1 0 0 1-.97.99 1 1 0 0 1-.97-.99c0-.54.44-.98.97-.98"></path></svg>',
                url: 'https://res.wx.qq.com/a/wx_fed/assets/res/NTI4MWU5.ico'
            },
            {
                name: '阿里淘宝',
                region: '国内',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#E16322" d="M21.31 9.9a3 3 0 1 1 0 1.92.96.96 0 0 1 0-1.92m2.39 3.05H13.3v-.96h4.14V9.76h-2.89v-.77h2.9v-.92h-2.52v.2H13.3v-2.9h1.64v.35l2.52-.3V4.6h1.85v.64c.93-.08 1.76-.13 2.21-.1 1.5.06 2.45.27 2.49 1.26.03 1-1.43 1.9-1.43 1.9l-.45-.43v.2h-2.8v.92h3.22v.77h-3.23v2.23h4.39zM21.53 7.3l-.02-.01s1.38-.76.35-1.27c-.87-.43-5.54.3-6.93.62v.66zM1.88 6.42a1 1 0 0 0 0-2 1 1 0 0 0-1 1 1 1 0 0 0 1 1m3.41-.86a7 7 0 0 0 .37-.72L4.2 4.42s-.6 1.93-1.65 2.83c0 0 1.02.6 1.01.58a10 10 0 0 0 .78-.88l.68-.3a9 9 0 0 1-1.14 1.69l.61.54s.42-.4.88-.9h.53v.9H3.86v.73H5.9v1.72h-.08c-.23-.01-.58-.05-.71-.27-.17-.26-.05-.75-.04-1.04h-1.4l-.06.02s-.52 2.32 1.5 2.27a5.3 5.3 0 0 0 3.46-.92l.2.76 1.17-.48-.79-1.92-.94.3.18.65a3 3 0 0 1-.82.42V9.6h2v-.72h-2v-.9h2v-.72H6.01c.26-.31.46-.6.51-.78l-.62-.17c2.67-.95 4.15-.79 4.13.77v4.12s.16 1.4-1.46 1.3l-.87-.18-.21.83s3.78 1.08 4.1-1.82-.09-4.76-.09-4.76-.34-2.68-6.2-1.02zm-5.23 6.6 1.58.98c1.1-2.38 1.03-2.06 1.3-2.92.29-.87.35-1.54-.13-2.02a10 10 0 0 0-1.6-1.36L.55 7.86l1.21.75s.82.42.43 1.2c-.36.73-2.13 2.34-2.13 2.34M20 19s-.02.53-.67.53c-.6 0-.64-.42-.64-.42q-.39.45-1.07.46c-.76 0-1.3-.51-1.3-1.3 0-.78.56-1.27 1.4-1.27.39 0 .73.15.93.4l.01-.2c0-.56-.3-.8-1-.8q-.51 0-1.02.13.16-.33.3-.45.18-.14.94-.14c1.27 0 1.74.42 1.74 1.42v1.2c0 .32.03.44.38.44m-1.33-.74c0-.48-.25-.75-.64-.75-.4 0-.66.28-.66.76 0 .47.27.76.65.76.39 0 .65-.27.65-.77m5.27-.5c0 1.15-.7 1.82-1.78 1.82-1.1 0-1.77-.67-1.77-1.82 0-1.16.68-1.83 1.77-1.83s1.78.67 1.78 1.83m-1.08 0q0-1.3-.7-1.3t-.69 1.3.7 1.3.69-1.3m-7.14-.05c0 1.17-.65 1.86-1.57 1.86q-.66-.01-1.05-.47s-.1.42-.66.42c-.69 0-.67-.52-.67-.52.4.02.38-.21.38-.43v-2.89c0-.36-.07-.48-.43-.49.02-.1.08-.53.68-.53.82 0 .76.91.76.91v.79q.34-.4 1-.4c.96 0 1.56.65 1.56 1.75m-1.09.08q-.01-1.35-.76-1.35c-.44 0-.74.4-.74 1.1v.36c0 .72.31 1.12.76 1.12q.73 0 .74-1.23m-3.24-.03c0 1.15-.7 1.82-1.78 1.82-1.1 0-1.78-.67-1.78-1.82 0-1.16.68-1.83 1.78-1.83s1.78.67 1.78 1.83m-1.09 0q0-1.3-.7-1.3-.69 0-.68 1.3t.69 1.3q.7 0 .7-1.3m-6-2.72q-.4.11-1.55.1-1.38-.02-1.85-.04c-.52 0-.73.13-.91.66q.45-.13 1.13-.11c.36 0 .42.04.42.3v2.9c0 .28.11.67.72.67.71 0 .84-.52.84-.52-.36 0-.43-.13-.43-.49v-2.56c0-.27.1-.28.47-.28h.26c.55 0 .7-.1.9-.63M7.46 19s-.02.52-.67.52c-.56 0-.64-.4-.64-.4q-.39.45-1.07.45c-.76 0-1.3-.52-1.3-1.3S4.33 17 5.17 17c.39 0 .73.14.93.4v-.2c0-.56-.3-.8-1-.8q-.5 0-1.01.13.15-.33.3-.46.17-.14.94-.14c1.26 0 1.74.43 1.74 1.43v1.2c0 .32.03.44.38.44m-1.33-.75c0-.48-.26-.74-.64-.74-.4 0-.67.28-.67.76 0 .46.28.76.66.76.39 0 .65-.28.65-.78"></path></svg>',
                url: 'https://img.alicdn.com/imgextra/i2/O1CN01qnQCrN1VkzAWiU4Hs_!!6000000002692-2-tps-33-33.png'
            },
            {
                name: 'GitHub',
                region: '国际',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#181717" d="M12 .3a12 12 0 0 0-3.8 23.38c.6.12.83-.26.83-.57L9 21.07c-3.34.72-4.04-1.61-4.04-1.61-.55-1.39-1.34-1.76-1.34-1.76-1.08-.74.09-.73.09-.73 1.2.09 1.84 1.24 1.84 1.24 1.07 1.83 2.8 1.3 3.49 1 .1-.78.42-1.31.76-1.61-2.66-.3-5.47-1.33-5.47-5.93 0-1.31.47-2.38 1.24-3.22-.14-.3-.54-1.52.1-3.18 0 0 1-.32 3.3 1.23a11.5 11.5 0 0 1 6 0c2.28-1.55 3.29-1.23 3.29-1.23.64 1.66.24 2.88.12 3.18a4.7 4.7 0 0 1 1.23 3.22c0 4.61-2.8 5.63-5.48 5.92.42.36.81 1.1.81 2.22l-.01 3.29c0 .31.2.69.82.57A12 12 0 0 0 12 .3"></path></svg>',
                url: 'https://github.github.io/janky/images/bg_hr.png'
            },
            {
                name: 'Telegram',
                region: '国际',
                icon: '<svg width="24px" height="24px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><linearGradient x1="50%" y1="0%" x2="50%" y2="100%" id="linearGradient-1"><stop stop-color="#38AEEB" offset="0%"></stop><stop stop-color="#279AD1" offset="100%"></stop></linearGradient></defs><g id="Artboard" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><circle id="Oval" fill="url(#linearGradient-1)" cx="8" cy="8" r="8"></circle><path d="M3.17026167,7.83635602 C5.78750201,6.74265999 7.53273882,6.02162863 8.40597211,5.67326193 C10.8992306,4.67860423 11.2454541,4.53439191 11.5831299,4.52864956 C11.6573986,4.52743168 11.8385417,4.55776042 11.9798438,4.67645833 C12.1211458,4.79515625 12.1635786,4.87206678 12.1755371,4.93908691 C12.1874957,5.00610705 12.1862759,5.21456762 12.1744385,5.3338623 C12.0393279,6.69547283 11.5259342,9.83829771 11.2285121,11.3633248 C11.1026617,12.008621 10.8548582,12.2249854 10.6149558,12.2461596 C10.0935924,12.2921758 9.69769267,11.9156852 9.19272668,11.5981993 C8.40255458,11.1013965 8.13911734,10.9180161 7.3721185,10.4332283 C6.48571864,9.87297217 6.85080034,9.6784879 7.35595703,9.17524981 C7.48815894,9.04355001 9.67825076,7.04590073 9.71077046,6.86250183 C9.7391276,6.70257812 9.7494847,6.68189389 9.67664063,6.60973958 C9.60379655,6.53758527 9.51674192,6.54658941 9.46083149,6.55876051 C9.38158015,6.57601267 8.17521836,7.33962686 5.84174612,8.84960308 C5.48344358,9.08558775 5.15890428,9.20056741 4.86812819,9.19454205 C4.54757089,9.18789957 3.93094724,9.02070014 3.47255094,8.87778221 C2.91030922,8.70248755 2.46345069,8.609808 2.50236203,8.31210343 C2.52262946,8.15704047 2.74526267,7.998458 3.17026167,7.83635602 Z" id="Path-3" fill="#FFFFFF"></path></g></svg>',
                url: 'https://web.telegram.org/k/'
            },
            {
                name: 'X.com',
                region: '国际',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#1DA1F2" d="M23.643 4.937c-.835.37-1.732.62-2.675.733.962-.576 1.7-1.49 2.048-2.578-.9.534-1.897.922-2.958 1.13-.85-.904-2.06-1.47-3.4-1.47-2.572 0-4.658 2.086-4.658 4.66 0 .364.042.718.12 1.06-3.873-.195-7.304-2.05-9.602-4.868-.4.69-.63 1.49-.63 2.342 0 1.616.823 3.043 2.072 3.878-.764-.025-1.482-.234-2.11-.583v.06c0 2.257 1.605 4.14 3.737 4.568-.392.106-.803.162-1.227.162-.3 0-.593-.028-.877-.082.594 1.85 2.323 3.196 4.368 3.233-1.595 1.25-3.604 1.995-5.786 1.995-.376 0-.747-.022-1.112-.065 2.072 1.328 4.532 2.104 7.172 2.104 8.607 0 13.3-7.132 13.3-13.3 0-.202-.005-.403-.014-.602.913-.66 1.706-1.477 2.332-2.41z"></path></svg>',
                url: 'https://abs.twimg.com/favicons/twitter.3.ico'
            },
            {
                name: 'YouTube',
                region: '国际',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#FF0000" d="M23.5 6.19a3 3 0 0 0-2.12-2.14c-1.87-.5-9.38-.5-9.38-.5s-7.5 0-9.38.5A3 3 0 0 0 .5 6.19C0 8.07 0 12 0 12s0 3.93.5 5.81a3 3 0 0 0 2.12 2.14c1.87.5 9.38.5 9.38.5s7.5 0 9.38-.5a3 3 0 0 0 2.12-2.14C24 15.93 24 12 24 12s0-3.93-.5-5.81M9.55 15.57V8.43L15.82 12z"></path></svg>',
                url: 'https://www.youtube.com/favicon.ico'
            }
        ];

        // 初始化主题
        function initializeTheme() {
            const saved = localStorage.getItem('theme');
            let theme = saved;

            // 如果第一次打开，按系统主题决定
            if (!saved) {
                theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }

            applyTheme(theme);
        }

        // 应用主题
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
                document.getElementById('themeToggle').title = '切换日间模式';
            } else {
                document.documentElement.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
                document.getElementById('themeToggle').title = '切换夜间模式';
            }
        }

        // 生成延迟卡片
        function generateLatencyCards() {
            const container = document.getElementById('latency-cards');
            if (!container) return;
            container.innerHTML = '';

            // 按地区排序：国内优先，然后国际
            const sortedSites = [...latencySites].sort((a, b) => {
                const aIsChina = a.region === '国内' ? 0 : 1;
                const bIsChina = b.region === '国内' ? 0 : 1;
                return aIsChina - bIsChina;
            });

            sortedSites.forEach(site => {
                const card = document.createElement('div');
                card.className = 'latency-card';
                const siteName = site.name.toLowerCase().replace(/\s+/g, '-');
                card.innerHTML = `
                    <div class="latency-card-header">
                        <div class="latency-card-info">
                            <div class="latency-card-icon-wrapper" data-site="${siteName}">
                                ${site.icon}
                            </div>
                            <div class="latency-card-text">
                                <span class="latency-card-name">${site.name}</span>
                                <span class="latency-card-region" data-region="${site.region}">${site.region}</span>
                            </div>
                        </div>
                        <div class="latency-status" id="latency-${siteName}">...<span class="unit">ms</span></div>
                    </div>
                    <div class="latency-graph-container">
                        <div class="graph-grid"></div>
                        <svg class="latency-ecg" viewBox="0 0 400 60" preserveAspectRatio="none">
                            <path class="ecg-path-bg" d="M0,30 L400,30"></path>
                            <path class="ecg-path" id="path-${siteName}" d="M0,30 L400,30"></path>
                            <circle class="ecg-cursor" id="cursor-${siteName}" r="3" cx="0" cy="30" style="display:none"></circle>
                        </svg>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // 测试延迟
        async function testLatency(site) {
            const start = Date.now();
            try {
                const response = await fetch(site.url + '?t=' + Date.now(), {
                    method: 'HEAD',
                    cache: 'no-cache',
                    mode: 'no-cors',
                    referrerPolicy: 'no-referrer'
                });
                const latency = Date.now() - start;
                return latency;
            } catch (error) {
                return -1; // 连接失败
            }
        }

        // 获取延迟颜色
        function getLatencyColor(latency) {
            if (latency === -1) return 'var(--destructive)';
            if (latency <= 49) return 'var(--latency-49)';
            if (latency <= 149) return 'var(--latency-149)';
            if (latency <= 299) return 'var(--latency-299)';
            if (latency <= 999) return 'var(--latency-999)';
            return 'var(--latency-1000)';
        }

        // 更新延迟显示
        function updateLatencyDisplay(siteName, latencies) {
            const valueElement = document.getElementById(`latency-${siteName}`);
            const pathElement = document.getElementById(`path-${siteName}`);
            const cursorElement = document.getElementById(`cursor-${siteName}`);

            if (!valueElement || !pathElement) return;

            // 计算平均延迟
            const lastLatency = latencies[latencies.length - 1];
            const validLatencies = latencies.filter(l => l !== -1);
            let avgLatency = -1;

            if (validLatencies.length > 0) {
                // 如果有足够的数据，去掉最高和最低延迟以获得更稳定的平均值
                if (validLatencies.length > 5) {
                    const sorted = [...validLatencies].sort((a, b) => a - b);
                    const trimmed = sorted.slice(1, -1);
                    avgLatency = trimmed.reduce((a, b) => a + b, 0) / trimmed.length;
                } else {
                    avgLatency = validLatencies.reduce((a, b) => a + b, 0) / validLatencies.length;
                }
            }

            const targetValue = Math.round(avgLatency);

            // 更新文字显示
            if (validLatencies.length === 0) {
                if (lastLatency === -1) {
                    valueElement.innerHTML = 'TIMEOUT';
                    valueElement.style.color = 'var(--latency-999)';
                } else {
                    valueElement.innerHTML = '...<span class="unit">ms</span>';
                    valueElement.style.color = '#f6821f';
                }
            } else {
                const siteState = latencyUIState[siteName] || { current: targetValue, timer: null };
                latencyUIState[siteName] = siteState;

                // 设置颜色
                const avgColor = getLatencyColor(targetValue);
                valueElement.style.color = avgColor;

                // 如果数值变化较小，直接显示
                if (Math.abs(siteState.current - targetValue) < 2) {
                    siteState.current = targetValue;
                    valueElement.innerHTML = `${targetValue}<span class="unit">ms</span>`;
                } else {
                    // 清除旧的计时器
                    if (siteState.timer) clearInterval(siteState.timer);

                    // 每 30ms 更新一次数字，实现滚动的动态效果
                    const step = () => {
                        if (siteState.current < targetValue) {
                            siteState.current += Math.ceil((targetValue - siteState.current) / 5);
                        } else if (siteState.current > targetValue) {
                            siteState.current -= Math.ceil((siteState.current - targetValue) / 5);
                        }

                        valueElement.innerHTML = `${siteState.current}<span class="unit">ms</span>`;

                        if (siteState.current === targetValue) {
                            clearInterval(siteState.timer);
                            siteState.timer = null;
                        }
                    };

                    siteState.timer = setInterval(step, 30);
                }
            }

            // 更新 SVG 路径
            const width = 400;
            const height = 60;
            const padding = 10;
            const step = width / (latencyTestConfig.count - 1);

            let points = [];
            latencies.forEach((l, i) => {
                const x = i * step;
                let y;
                if (l === -1) {
                    y = height - 5;
                } else {
                    // 映射 0-500ms 到高度，高延迟在上，低延迟在下？通常ECG是越高表示值越大或者越快？
                    // demo里是 height - padding - (Math.min(l, 500) / 500 * (height - 2 * padding))
                    // 这意味着延迟越低，y越大（越靠下）。延迟越高，y越小（越靠上）。
                    y = height - padding - (Math.min(l, 500) / 800 * (height - 2 * padding));
                }
                points.push({ x, y });
            });

            if (points.length > 0) {
                // 生成平滑曲线路径 (Bezier)
                let d = `M${points[0].x},${points[0].y}`;
                for (let i = 0; i < points.length - 1; i++) {
                    const x_mid = (points[i].x + points[i + 1].x) / 2;
                    const y_mid = (points[i].y + points[i + 1].y) / 2;
                    d += ` Q${points[i].x},${points[i].y} ${x_mid},${y_mid}`;
                }
                const lastPoint = points[points.length - 1];
                d += ` L${lastPoint.x},${lastPoint.y}`;

                pathElement.setAttribute('d', d);
                const avgColor = getLatencyColor(targetValue);
                pathElement.style.stroke = avgColor;

                // 更新光标位置
                if (cursorElement) {
                    cursorElement.style.display = 'block';
                    cursorElement.setAttribute('cx', lastPoint.x);
                    cursorElement.setAttribute('cy', lastPoint.y);
                    cursorElement.style.fill = avgColor;
                }
            }
        }

        // 开始延迟测试
        async function startLatencyTest() {
            if (latencyTestStarted) return;
            latencyTestStarted = true;

            generateLatencyCards();

            // 为每个网站维护最新的N个延迟数据
            const siteLatencies = {};
            latencySites.forEach(site => {
                const siteName = site.name.toLowerCase().replace(/\s+/g, '-');
                siteLatencies[siteName] = [];
            });

            // 初始采样测试
            const initialPromises = latencySites.map(async (site) => {
                const siteName = site.name.toLowerCase().replace(/\s+/g, '-');
                for (let i = 0; i < latencyTestConfig.count; i++) {
                    const latency = await testLatency(site);
                    siteLatencies[siteName].push(latency);
                    updateLatencyDisplay(siteName, siteLatencies[siteName]);
                    if (i < latencyTestConfig.count - 1) {
                        await new Promise(resolve => setTimeout(resolve, 0));
                    }
                }
            });

            await Promise.all(initialPromises);

            // 之后每 3.09 秒测试一次，更新最新的数据 (保持 ECG 曲线流动)
            setInterval(async () => {
                const updatePromises = latencySites.map(async (site) => {
                    const siteName = site.name.toLowerCase().replace(/\s+/g, '-');
                    const latency = await testLatency(site);
                    // 添加新数据，保持只有N个
                    siteLatencies[siteName].push(latency);
                    if (siteLatencies[siteName].length > latencyTestConfig.count) {
                        siteLatencies[siteName].shift(); // 移除最旧的
                    }
                    updateLatencyDisplay(siteName, siteLatencies[siteName]);
                });
                await Promise.all(updatePromises);
            }, 618 * 3);
        }

        // 切换主题
        function toggleTheme() {
            const isDark = document.documentElement.classList.contains('dark-mode');
            applyTheme(isDark ? 'light' : 'dark');
        }

        // 返回顶部
        function scrollToTop() {
            const pageWrapper = document.querySelector('.page-wrapper');
            if (pageWrapper) {
                pageWrapper.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // 初始化增强型文本编辑器
        function initLineEditor(textareaId) {
            const ta = document.getElementById(textareaId);
            if (!ta) return;
            const container = ta.closest('.line-editor');
            if (!container) return;
            const mirror = container.querySelector('.mirror');

            function escapeHtml(str) {
                return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            }

            function render() {
                const value = ta.value || '';
                const lines = value.split(/\r\n|\r|\n/);

                mirror.style.width = ta.clientWidth + 'px';

                mirror.innerHTML = lines.map((l, i) => `<div class="logical-line" data-line-number="${i + 1}">${escapeHtml(l) || ' '}</div>`).join('');

                syncScroll();
            }

            function syncScroll() {
                mirror.scrollTop = ta.scrollTop;
            }

            let throttleTimeout;
            const debouncedRender = () => {
                cancelAnimationFrame(throttleTimeout);
                throttleTimeout = requestAnimationFrame(render);
            };

            // 监听输入、滚动
            ta.addEventListener('input', debouncedRender);
            ta.addEventListener('scroll', syncScroll);

            // 监听高度变化（ResizeObserver），解决拖拽角标后的同步问题
            if (window.ResizeObserver) {
                const ro = new ResizeObserver(() => {
                    // 当 textarea 高度或宽度变化时，重新渲染以确保宽度同步
                    render();
                });
                ro.observe(ta);
            }

            // 窗口缩放时也刷新一下
            window.addEventListener('resize', debouncedRender);

            // 暴露渲染函数
            ta._refreshLineEditor = render;

            // 初始渲染
            render();
        }

        async function loadConfig() {
            try {
                // 禁用 Rocket Loader 对该请求的影响
                const response = await fetch('/admin/config.json?_t=' + Date.now(), {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                if (!response.ok) throw new Error('加载配置失败');
                currentConfig = await response.json();
                originalConfig = JSON.parse(JSON.stringify(currentConfig));
                renderUI();
                // 设置网页标题
                document.title = `${currentConfig.优选订阅生成?.SUBNAME || 'edgetunnel'} 设置页面 - 管理后台`;
            } catch (error) {
                showToast('加载配置失败: ' + error.message, 'error');
            }
        }

        function renderUI() {
            // 标题
            document.getElementById('pageTitle').textContent = (currentConfig.优选订阅生成?.SUBNAME || 'edgetunnel') + ' 设置页面';

            // 检查 CF 使用情况并显示模块
            const cfUsageModule = document.getElementById('cfUsageModule');
            const cfUsage = currentConfig.CF?.Usage;
            if (cfUsage && cfUsage.success) {
                cfUsageModule.style.display = 'block';
                cfUsageModule.classList.remove('cf-usage-module');
                updateCFUsageDisplay(cfUsage);
                updateCloudflareButtonStates(true);
            } else {
                cfUsageModule.style.display = 'none';
                cfUsageModule.classList.add('cf-usage-module');
                updateCloudflareButtonStates(false);
            }

            // 检查 CF.UsageAPI 字段是否存在，向下兼容旧版本
            const usageapiOption = document.getElementById('usageapiOption');
            if (usageapiOption) {
                // 如果 CF.UsageAPI 字段不存在（旧版本），隐藏 UsageAPI 选项
                if (currentConfig.CF?.UsageAPI === undefined) {
                    usageapiOption.style.display = 'none';
                } else {
                    usageapiOption.style.display = '';
                }
            }

            // 订阅链接
            const token = currentConfig.优选订阅生成?.TOKEN;
            const host = window.location.host;
            const link = currentConfig.LINK;
            document.getElementById('LinkURL').value = currentConfig.LINK;
            document.getElementById('subLink').value = `https://${host}/sub?token=${token}`;
            document.getElementById('base64Link').value = `https://${host}/sub?token=${token}&b64`;
            document.getElementById('clashLink').value = `https://${host}/sub?token=${token}&clash`;
            document.getElementById('singboxLink').value = `https://${host}/sub?token=${token}&sb`;

            // 编辑订阅生成
            const local = currentConfig.优选订阅生成?.local ?? true;
            const randomIP = currentConfig.优选订阅生成?.本地IP库?.随机IP ?? true;

            if (!local) {
                document.getElementById('ipMode').value = 'generator';
                document.getElementById('generatorURL').value = currentConfig.优选订阅生成?.SUB || '';
            } else if (randomIP) {
                document.getElementById('ipMode').value = 'random';
                document.getElementById('randomCount').value = currentConfig.优选订阅生成?.本地IP库?.随机数量 || 16;
                // 设置指定端口
                if (currentConfig.优选订阅生成?.本地IP库?.指定端口 !== undefined) {
                    document.getElementById('specifiedPort').value = currentConfig.优选订阅生成.本地IP库.指定端口;
                }
            } else {
                document.getElementById('ipMode').value = 'custom';
                loadCustomIPs();
            }
            updateIPMode();

            // 详细配置
            document.getElementById('subName').value = currentConfig.优选订阅生成?.SUBNAME || '';

            // 检查 HOSTS 数组是否存在
            hasMultipleHosts = Array.isArray(currentConfig.HOSTS) && currentConfig.HOSTS.length > 0;

            const nodeHostInput = document.getElementById('nodeHost');
            if (hasMultipleHosts) {
                // 如果存在 HOSTS 数组，用逗号连接显示所有 host
                nodeHostInput.value = currentConfig.HOSTS.join('、');
                // 添加可点击样式和事件
                nodeHostInput.classList.add('nodeHost-clickable');
                nodeHostInput.title = '点击 可编辑多个节点域名';
                nodeHostInput.onclick = openHostsEditModal;
            } else {
                // 否则显示单个 HOST
                nodeHostInput.value = currentConfig.HOST || '';
                // 移除可点击样式和事件
                nodeHostInput.classList.remove('nodeHost-clickable');
                nodeHostInput.title = '节点域名';
                nodeHostInput.onclick = null;
            }

            document.getElementById('nodeUUID').value = currentConfig.UUID || '';
            document.getElementById('nodePATH').value = currentConfig.PATH || '';
            document.getElementById('protocol').value = currentConfig.协议类型 || 'vless';
            //document.getElementById('transport').value = currentConfig.传输协议 || 'ws';
            document.getElementById('skipVerify').checked = currentConfig.跳过证书验证 || false;

            // 检查"完整节点路径"字段是否存在，判断PATH是否可编辑
            const nodePathInput = document.getElementById('nodePATH');
            if (currentConfig['完整节点路径'] !== undefined) {
                // 存在该字段，表示后端支持编辑PATH，移除readonly属性
                nodePathInput.removeAttribute('readonly');
                nodePathInput.title = '节点的伪装路径';
                nodePathInput.onchange = handlePathChange;
            } else {
                // 不存在该字段，PATH保持只读状态
                nodePathInput.setAttribute('readonly', '');
                nodePathInput.title = '节点的伪装路径 仅可通过 \'PATH\'环境变量 进行修改';
                nodePathInput.onchange = null;
            }

            // 检查Fingerprint字段是否存在
            const fingerprintGroup = document.getElementById('fingerprintGroup');
            const fingerprintSelect = document.getElementById('fingerprint');
            if (currentConfig['Fingerprint'] == undefined) {
                fingerprintGroup.style.setProperty('display', 'none', 'important');
            } else {
                fingerprintSelect.value = currentConfig['Fingerprint'] || 'chrome';
            }

            // 检查随机路径字段是否存在
            const randomPathGroup = document.getElementById('randomPathGroup');
            const randomPathCheckbox = document.getElementById('randomPath');
            if (currentConfig['随机路径'] !== undefined) {
                randomPathGroup.style.setProperty('display', 'flex', 'important');
                randomPathCheckbox.checked = currentConfig['随机路径'] || false;
            } else {
                randomPathGroup.style.setProperty('display', 'none', 'important');
            }

            // 检查启用0RTT字段是否存在
            const enable0RTTGroup = document.getElementById('enable0RTTGroup');
            const enable0RTTCheckbox = document.getElementById('enable0RTT');
            if (currentConfig['启用0RTT'] !== undefined) {
                enable0RTTGroup.style.setProperty('display', 'flex', 'important');
                enable0RTTCheckbox.checked = currentConfig['启用0RTT'] || false;
            } else {
                enable0RTTGroup.style.setProperty('display', 'none', 'important');
            }

            // 检查TLS分片字段是否存在
            const tlsFragmentGroup = document.getElementById('tlsFragmentGroup');
            const tlsFragmentHappGroup = document.getElementById('tlsFragmentHappGroup');
            const tlsFragmentShadowrocket = document.getElementById('tlsFragmentShadowrocket');
            const tlsFragmentHapp = document.getElementById('tlsFragmentHapp');
            if (currentConfig['TLS分片'] !== undefined) {
                tlsFragmentGroup.style.setProperty('display', 'flex', 'important');
                tlsFragmentHappGroup.style.setProperty('display', 'flex', 'important');
                // 根据当前值设置勾选状态
                tlsFragmentShadowrocket.checked = currentConfig['TLS分片'] === 'Shadowrocket';
                tlsFragmentHapp.checked = currentConfig['TLS分片'] === 'Happ';
            } else {
                tlsFragmentGroup.style.setProperty('display', 'none', 'important');
                tlsFragmentHappGroup.style.setProperty('display', 'none', 'important');
            }

            // 检查ECH字段是否存在
            const echModule = document.getElementById('echModule');
            const enableECHCheckbox = document.getElementById('enableECH');
            if (currentConfig['ECH'] !== undefined) {
                echModule.style.display = 'block';
                enableECHCheckbox.checked = currentConfig['ECH'] || false;
                // 根据Fingerprint值初始化ECH选项的禁用状态
                updateECHOptionState();

                // 填充ECH DNS下拉框
                populateEchDNSSelect();

                // 填充ECH SNI下拉框
                populateEchSNISelect();
            } else {
                echModule.style.display = 'none';
            }

            // 反代落地设置
            const socksEnabled = currentConfig.反代?.SOCKS5?.启用;
            if (!socksEnabled) {
                document.getElementById('proxyMode').value = 'auto';
                document.getElementById('proxyIP').value = currentConfig.反代?.PROXYIP || '';
                document.getElementById('autoProxy').checked = (currentConfig.反代?.PROXYIP === 'auto');
                if (currentConfig.反代?.PROXYIP === 'auto') {
                    document.getElementById('proxyIP').disabled = true;
                }
            } else if (socksEnabled === 'socks5') {
                document.getElementById('proxyMode').value = 'socks5';
                document.getElementById('socks5Addr').value = currentConfig.反代?.SOCKS5?.账号 || '';
                document.getElementById('globalSocks5').checked = currentConfig.反代?.SOCKS5?.全局 || false;
            } else if (socksEnabled === 'http') {
                document.getElementById('proxyMode').value = 'http';
                document.getElementById('httpAddr').value = currentConfig.反代?.SOCKS5?.账号 || '';
                document.getElementById('globalHTTP').checked = currentConfig.反代?.SOCKS5?.全局 || false;
            }
            updateProxyMode();

            // 订阅转换配置
            document.getElementById('subAPI').value = currentConfig.订阅转换配置?.SUBAPI || '';
            document.getElementById('subConfig').value = currentConfig.订阅转换配置?.SUBCONFIG || '';
            document.getElementById('emoji').checked = currentConfig.订阅转换配置?.SUBEMOJI || false;

            // 消息通知设置 - 兼容两种config结构
            // 优先读取 TG 字段，如果没有则读取 通知.Telegram
            const telegramBotToken = currentConfig.TG?.BotToken || currentConfig.通知?.Telegram?.BotToken;
            const telegramChatID = currentConfig.TG?.ChatID || currentConfig.通知?.Telegram?.ChatID;
            const telegramCheckbox = document.getElementById('telegramEnabled');

            // 判断TG配置是否完整（BotToken和ChatID都非null且非空字符串）
            if (telegramBotToken && telegramChatID) {
                // 两个都有，启用checkbox，并加载 TG.启用 的状态
                telegramCheckbox.disabled = false;
                telegramCheckbox.checked = currentConfig.TG?.启用 ?? false;
                // "参数配置"按钮颜色为绿色，表示已配置
                updateTelegramButtonStates(true);
                // "清除配置"按钮为红色，且可点击
            } else {
                // 任意一个缺少，禁用checkbox
                telegramCheckbox.disabled = true;
                telegramCheckbox.checked = false;
                // "参数配置"按钮颜色为默认色，表示未配置
                updateTelegramButtonStates(false);
                // "清除配置"按钮为灰色，且不可点击
            }

            modifiedSections.clear();
            resetAllButtons();

            // 从 localStorage 加载模块展开/折叠状态
            loadModuleStates();

            // 填充 SubConfig 下拉框（如果数据已加载，会自动设置选中值）
            populateSubConfigSelect();

            // 检查当前域名是否在 HOSTS 数组中
            checkHostsMismatch();
        }

        // CF 使用情况显示函数
        function updateCFUsageDisplay(cfUsage) {
            const workers = cfUsage.workers || 0;
            const pages = cfUsage.pages || 0;
            const total = cfUsage.total || 0;
            const dailyQuota = cfUsage.max || 100000;

            // 更新显示数值
            document.getElementById('cfWorkerCount').textContent = workers.toLocaleString();
            document.getElementById('cfPagesCount').textContent = pages.toLocaleString();
            document.getElementById('cfDailyQuota').textContent = dailyQuota.toLocaleString();
            document.getElementById('cfTotalDisplay').textContent = total.toLocaleString();

            // 计算百分比
            const percentage = ((total / dailyQuota) * 100).toFixed(2);

            // 计算比例并设置进度条宽度
            const workersRatio = (workers / dailyQuota) * 100;
            const pagesRatio = (pages / dailyQuota) * 100;

            // Workers 进度条：从左边开始
            const workerBarEl = document.getElementById('cfWorkerBar');
            workerBarEl.style.width = Math.min(workersRatio, 100) + '%';
            workerBarEl.textContent = '';

            // Pages 进度条：紧跟在 Workers 进度条后面
            const pagesBarEl = document.getElementById('cfPagesBar');
            pagesBarEl.style.width = Math.min(pagesRatio, 100 - workersRatio) + '%';
            pagesBarEl.style.left = Math.min(workersRatio, 100) + '%';
            pagesBarEl.textContent = '';

            // 总体百分比文字 (中央)
            const percentageCenterEl = document.getElementById('cfPercentageCenter');
            percentageCenterEl.textContent = `请求使用进度: ${total.toLocaleString()} (${percentage}%)`;
        }

        async function loadCustomIPs() {
            const textarea = document.getElementById('customIPs');
            textarea.disabled = true;
            textarea.value = '正在加载...';
            if (textarea._refreshLineEditor) textarea._refreshLineEditor();

            try {
                const response = await fetch('/admin/ADD.txt?_t=' + Date.now(), {
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                if (response.ok) {
                    textarea.value = await response.text();
                } else {
                    textarea.value = '';
                }
            } catch (error) {
                showToast('加载自定义IP失败', 'error');
                textarea.value = '';
            } finally {
                textarea.disabled = false;
                if (textarea._refreshLineEditor) textarea._refreshLineEditor();
            }
        }

        function updateIPMode() {
            const mode = document.getElementById('ipMode').value;

            const sections = {
                'random': document.getElementById('randomIPSection'),
                'custom': document.getElementById('customIPSection'),
                'generator': document.getElementById('generatorSection')
            };

            Object.keys(sections).forEach(key => {
                const el = sections[key];
                if (el) {
                    if (key === mode) {
                        el.classList.remove('hidden-section');
                        el.style.display = (key === 'custom') ? 'block' : 'grid';
                    } else {
                        el.classList.add('hidden-section');
                        el.style.display = 'none';
                    }
                }
            });

            // 显示或隐藏指定端口
            const portSection = document.getElementById('portSection');
            if (portSection) {
                if (mode === 'random' && currentConfig.优选订阅生成?.本地IP库?.指定端口 !== undefined) {
                    portSection.classList.remove('hidden-section');
                    portSection.style.display = 'grid';
                } else {
                    portSection.classList.add('hidden-section');
                    portSection.style.display = 'none';
                }
            }

            // 显示或隐藏在线优选和订阅接口按钮（仅在自定义优选模式下显示）
            const onlineOptimizeBtn = document.getElementById('onlineOptimizeBtn');
            const apiOptimizeBtn = document.getElementById('apiOptimizeBtn');
            if (onlineOptimizeBtn) {
                if (mode === 'custom') {
                    onlineOptimizeBtn.classList.remove('hidden-section');
                } else {
                    onlineOptimizeBtn.classList.add('hidden-section');
                }
            }
            if (apiOptimizeBtn) {
                if (mode === 'custom') {
                    apiOptimizeBtn.classList.remove('hidden-section');
                } else {
                    apiOptimizeBtn.classList.add('hidden-section');
                }
            }

            // 当切换到自定义优选时，自动加载现有的ADD.txt内容
            if (mode === 'custom') {
                loadCustomIPs();
            }

            markModified('sub');
        }

        // 处理优选订阅生成器URL
        function processGeneratorURL() {
            const input = document.getElementById('generatorURL').value.trim();
            let domain = '';

            if (input) {
                // 如果输入不是空的，提取域名
                domain = extractDomain(input);
                document.getElementById('generatorURL').value = domain;
            }

            markModified('sub');
        }

        // 提取URL中的纯域名
        function extractDomain(url) {
            try {
                url = url.trim();

                // 如果不包含协议，尝试识别是否为完整URL或纯域名
                if (!url.includes('://')) {
                    // 检查是否包含路径、查询参数或端口
                    if (url.includes('/') || url.includes('?') || url.includes(':')) {
                        // 这是一个完整的URL，补充https协议
                        url = 'https://' + url;
                    } else {
                        // 这是纯域名，直接返回
                        return url;
                    }
                }

                // 解析URL
                const urlObj = new URL(url);

                // 获取hostname（不包含端口）
                let domain = urlObj.hostname;

                // 移除www前缀（如果有）
                if (domain.startsWith('www.')) {
                    domain = domain.substring(4);
                }

                return domain;
            } catch (error) {
                // 如果URL解析失败，返回原始输入去掉协议部分的结果
                let temp = url.trim();
                if (temp.includes('://')) {
                    temp = temp.split('://')[1];
                }
                if (temp.includes('/')) {
                    temp = temp.split('/')[0];
                }
                if (temp.includes('?')) {
                    temp = temp.split('?')[0];
                }
                if (temp.includes(':')) {
                    temp = temp.split(':')[0];
                }
                if (temp.startsWith('www.')) {
                    temp = temp.substring(4);
                }
                return temp;
            }
        }

        function updateProtocol() {
            const protocol = document.getElementById('protocol').value;
            /*
            const transport = document.getElementById('transport');
            if (protocol === 'trojan') {
                transport.value = 'ws';
                transport.disabled = true;
            } else {
                transport.disabled = false;
            }
            */
        }

        // 处理浏览器指纹变化，联动ECH选项
        function handleFingerprintChange() {
            updateECHOptionState();
        }

        // 处理ECH启用状态变化
        function handleECHEnableChange() {
            const enableECHCheckbox = document.getElementById('enableECH');
            const fingerprintSelect = document.getElementById('fingerprint');

            // 支持ECH的指纹类型
            const supportECH = ['chrome', 'firefox', 'random'];

            // 如果用户开启ECH，但当前指纹不支持ECH，自动切换到chrome
            if (enableECHCheckbox && enableECHCheckbox.checked) {
                const currentFingerprint = fingerprintSelect?.value;
                if (currentFingerprint && !supportECH.includes(currentFingerprint)) {
                    fingerprintSelect.value = 'chrome';
                    // 同时标记详细配置模块为已修改
                    markModified('config');
                }
            }

            markModified('ech');
        }

        // 更新ECH选项的状态（禁用/启用）
        function updateECHOptionState() {
            const fingerprint = document.getElementById('fingerprint').value;
            const enableECHCheckbox = document.getElementById('enableECH');

            // 支持ECH的指纹类型
            const supportECH = ['chrome', 'firefox', 'random'];

            if (enableECHCheckbox) {
                // 当指纹不支持ECH时，自动取消勾选
                if (!supportECH.includes(fingerprint) && enableECHCheckbox.checked) {
                    enableECHCheckbox.checked = false;
                    markModified('ech');
                }
            }
        }

        // 填充ECH DNS下拉框
        function populateEchDNSSelect() {
            const formGroup = document.getElementById('echDNSGroup');
            const select = document.getElementById('echDNSSelect');
            const customInput = document.getElementById('echDNSCustomInput');
            const hiddenValue = document.getElementById('echDNSValue');

            if (!select || !formGroup) return;

            // 检查ECHConfig.DNS字段是否存在
            if (currentConfig.ECHConfig?.DNS === undefined) {
                formGroup.style.display = 'none';
                return;
            }

            // 显示form-group和下拉框
            formGroup.style.display = 'grid';
            select.style.display = 'block';

            // 如果已有保存的DNS值，设置选中状态
            const savedDNS = currentConfig.ECHConfig?.DNS || '';
            if (savedDNS) {
                // 尝试在下拉框中找到匹配的选项
                select.value = savedDNS;

                // 如果没有匹配到（值不在列表中），选择"自定义"并显示输入框
                if (select.value !== savedDNS) {
                    select.value = 'custom';
                    customInput.value = savedDNS;
                    customInput.style.display = 'block';
                    hiddenValue.value = savedDNS;
                } else {
                    // 匹配成功，隐藏自定义输入框
                    customInput.style.display = 'none';
                    customInput.value = '';
                    hiddenValue.value = savedDNS;
                }
            } else {
                // 没有保存值，默认选择"自定义"
                select.value = 'custom';
                customInput.style.display = 'block';
            }
        }

        // 填充ECH SNI下拉框
        function populateEchSNISelect() {
            const formGroup = document.getElementById('echSNIGroup');
            const select = document.getElementById('echSNISelect');
            const customInput = document.getElementById('echSNICustomInput');
            const hiddenValue = document.getElementById('echSNIValue');

            if (!select || !formGroup) return;

            // 检查ECHConfig.SNI字段是否存在
            if (currentConfig.ECHConfig?.SNI === undefined) {
                formGroup.style.display = 'none';
                return;
            }

            // 显示form-group和下拉框
            formGroup.style.display = 'grid';
            select.style.display = 'block';

            // 如果已有保存的SNI值，设置选中状态
            const savedSNI = currentConfig.ECHConfig?.SNI;
            if (savedSNI !== undefined) {
                if (savedSNI === null) {
                    // 自动获取
                    select.value = '__AUTO__';
                    customInput.style.display = 'none';
                    customInput.value = '';
                    hiddenValue.value = null;
                } else {
                    // 尝试在下拉框中找到匹配的选项
                    select.value = savedSNI;

                    // 如果没有匹配到（值不在列表中），选择"自定义"并显示输入框
                    if (select.value !== savedSNI) {
                        select.value = 'custom';
                        customInput.value = savedSNI;
                        customInput.style.display = 'block';
                        hiddenValue.value = savedSNI;
                    } else {
                        // 匹配成功，隐藏自定义输入框
                        customInput.style.display = 'none';
                        customInput.value = '';
                        hiddenValue.value = savedSNI;
                    }
                }
            } else {
                // 没有保存值，默认选择"自定义"
                select.value = 'custom';
                customInput.style.display = 'block';
            }
        }

        // ECH DNS select 变化处理
        function onEchDNSSelectChange() {
            const select = document.getElementById('echDNSSelect');
            const customInput = document.getElementById('echDNSCustomInput');
            const hiddenValue = document.getElementById('echDNSValue');

            if (select.value === 'custom') {
                customInput.style.display = 'block';
                hiddenValue.value = customInput.value;
            } else {
                customInput.style.display = 'none';
                customInput.value = '';
                hiddenValue.value = select.value;
            }

            // 检查是否选择了国内DNS，若是则自动调整ECH解析域名
            const selectedOption = select.options[select.selectedIndex];
            const region = selectedOption.dataset.region;

            if (region === 'domestic') {
                const echSNISelect = document.getElementById('echSNISelect');
                // 如果当前选择是 __AUTO__，自动改为 cloudflare-ech.com
                if (echSNISelect.value === '__AUTO__') {
                    echSNISelect.value = 'cloudflare-ech.com';
                    onEchSNISelectChange();
                }
            }

            markModified('ech');
        }

        // ECH DNS 自定义输入框变化处理
        function onEchDNSCustomInput() {
            const customInput = document.getElementById('echDNSCustomInput');
            const hiddenValue = document.getElementById('echDNSValue');
            hiddenValue.value = customInput.value;
            markModified('ech');
        }

        // ECH SNI select 变化处理
        function onEchSNISelectChange() {
            const select = document.getElementById('echSNISelect');
            const customInput = document.getElementById('echSNICustomInput');
            const hiddenValue = document.getElementById('echSNIValue');

            if (select.value === '__AUTO__') {
                customInput.style.display = 'none';
                customInput.value = '';
                hiddenValue.value = null;

                // 检查当前DNS服务是否为国内DNS
                const echDNSSelect = document.getElementById('echDNSSelect');
                const selectedDNSOption = echDNSSelect.options[echDNSSelect.selectedIndex];
                const dnsRegion = selectedDNSOption.dataset.region;

                if (dnsRegion === 'domestic') {
                    alert('⚠️ ECH 配置提示\n\n默认使用节点HOST伪装域名 配合 国内 DNS 可能导致 ECH 解析失败。\n\n解决方案（任选其一）：\n① 将 ECH 解析域名改为 cloudflare-ech.com（推荐）\n② 将 ECH DNS 切换为国际服务（如 NextDNS）');
                    select.value = 'cloudflare-ech.com';
                }
            } else if (select.value === 'custom') {
                customInput.style.display = 'block';
                hiddenValue.value = customInput.value;
            } else {
                customInput.style.display = 'none';
                customInput.value = '';
                hiddenValue.value = select.value;
            }
            markModified('ech');
        }

        // ECH SNI 自定义输入框变化处理
        function onEchSNICustomInput() {
            const customInput = document.getElementById('echSNICustomInput');
            const hiddenValue = document.getElementById('echSNIValue');
            hiddenValue.value = customInput.value;
            markModified('ech');
        }

        // 处理PROXYIP地址
        function processProxyIP() {
            const input = document.getElementById('proxyIP').value.trim();

            if (input && input !== 'auto') {
                const cleanAddress = extractProxyIPAddress(input);
                document.getElementById('proxyIP').value = cleanAddress;
            }

            markModified('proxy');
        }

        // 提取PROXYIP地址中的纯格式（保留端口号）
        function extractProxyIPAddress(input) {
            input = input.trim();

            // 首先检查是否包含 "ip=" (包括 proxyip= 和 pyip=)
            const ipPatterns = ['proxyip=', 'pyip=', 'ip='];
            for (const pattern of ipPatterns) {
                const index = input.toLowerCase().indexOf(pattern);
                if (index !== -1) {
                    input = input.substring(index + pattern.length).trim();
                    break;
                }
            }

            // 移除协议前缀 (http:// 或 https://)
            if (input.toLowerCase().startsWith('http://')) {
                input = input.substring(7).trim();
            } else if (input.toLowerCase().startsWith('https://')) {
                input = input.substring(8).trim();
            }

            // 移除末尾的斜杠
            if (input.endsWith('/')) {
                input = input.substring(0, input.length - 1).trim();
            }

            // 移除末尾的备注（#符号之后的内容）
            if (input.includes('#')) {
                input = input.split('#')[0].trim();
            }

            return input;
        }

        // 处理SOCKS5和HTTP代理地址
        function processProxyAddress(type) {
            const fieldId = type === 'socks5' ? 'socks5Addr' : 'httpAddr';
            const input = document.getElementById(fieldId).value.trim();
            let cleanAddress = '';

            if (input) {
                cleanAddress = extractProxyAddress(input, type);
                document.getElementById(fieldId).value = cleanAddress;

                // 如果输入内容包含协议标识，自动切换反代模式并转移内容
                switchProxyModeByProtocol(input, cleanAddress);
            }

            markModified('proxy');
        }

        // 提取代理地址中的纯格式
        function extractProxyAddress(input, type) {
            input = input.trim();

            // 移除开头的 "/" 或 "/"
            if (input.startsWith('/')) {
                input = input.substring(1).trim();
            }

            // 检测并移除协议前缀
            const socks5Prefixes = ['socks5://', 'socks5=', 'socks5://'];
            const httpPrefixes = ['http://', 'http=', 'https://'];

            for (const prefix of socks5Prefixes) {
                if (input.toLowerCase().startsWith(prefix)) {
                    input = input.substring(prefix.length).trim();
                    break;
                }
            }

            for (const prefix of httpPrefixes) {
                if (input.toLowerCase().startsWith(prefix)) {
                    input = input.substring(prefix.length).trim();
                    break;
                }
            }

            // 移除末尾的备注（#符号之后的内容）
            if (input.includes('#')) {
                input = input.split('#')[0].trim();
            }

            return input;
        }

        // 根据协议自动切换反代模式
        function switchProxyModeByProtocol(input, cleanAddress) {
            const lowerInput = input.toLowerCase();

            // 检查是否包含socks5协议
            if (lowerInput.includes('socks5://') || lowerInput.includes('socks5=') || lowerInput.startsWith('/socks')) {
                // 切换到SOCKS5模式
                document.getElementById('proxyMode').value = 'socks5';

                // 清空其他模式的内容，填充SOCKS5
                document.getElementById('proxyIP').value = '';
                document.getElementById('socks5Addr').value = cleanAddress;
                document.getElementById('httpAddr').value = '';

                updateProxyMode();
                return;
            }

            // 检查是否包含http协议
            if (lowerInput.includes('http://') || lowerInput.includes('http=') || lowerInput.includes('https://') || lowerInput.startsWith('/http')) {
                // 切换到HTTP模式
                document.getElementById('proxyMode').value = 'http';

                // 清空其他模式的内容，填充HTTP
                document.getElementById('proxyIP').value = '';
                document.getElementById('socks5Addr').value = '';
                document.getElementById('httpAddr').value = cleanAddress;

                updateProxyMode();
                return;
            }
        }

        function updateProxyMode() {
            const mode = document.getElementById('proxyMode').value;
            document.getElementById('proxyIPSection').style.display = mode === 'auto' ? 'block' : 'none';
            document.getElementById('socks5Section').style.display = mode === 'socks5' ? 'block' : 'none';
            document.getElementById('httpSection').style.display = mode === 'http' ? 'block' : 'none';

            // 更新 "获取更多PROXYIP" 按钮的显示状态
            const getMoreBtn = document.getElementById('getMoreProxyIPBtn');
            if (getMoreBtn) {
                getMoreBtn.style.display = mode === 'auto' ? 'inline-block' : 'none';
            }

            // 更新 "探索更多SOCKS5" 按钮的显示状态
            const exploreSocks5Btn = document.getElementById('exploreSocks5Btn');
            if (exploreSocks5Btn) {
                exploreSocks5Btn.style.display = mode === 'socks5' ? 'inline-block' : 'none';
            }

            // 更新 "探索更多HTTP" 按钮的显示状态
            const exploreHTTPBtn = document.getElementById('exploreHTTPBtn');
            if (exploreHTTPBtn) {
                exploreHTTPBtn.style.display = mode === 'http' ? 'inline-block' : 'none';
            }

            markModified('proxy');
        }

        function toggleAutoProxy() {
            const autoProxy = document.getElementById('autoProxy').checked;
            document.getElementById('proxyIP').disabled = autoProxy;
            markModified('proxy');
        }

        function toggleModule(titleEl) {
            const module = titleEl.parentElement;
            const content = module.querySelector('.module-content');

            // If there's no collapsible content, just toggle the class
            if (!content) {
                module.classList.toggle('collapsed');
                saveModuleStates();
                return;
            }

            // If a transition is currently attached, remove it to avoid duplicate handlers
            if (content._transitionHandler) {
                content.removeEventListener('transitionend', content._transitionHandler);
                content._transitionHandler = null;
            }

            const isCollapsed = module.classList.contains('collapsed');

            if (isCollapsed) {
                // Expand
                content.style.display = 'block';

                // 检查是否是网络模块，如果是则加载数据
                if (module.querySelector('.network-cards-container') && !networkInfoLoaded) {
                    loadNetworkInfo();
                }

                // Measure height
                const height = content.scrollHeight;
                // Start from 0
                content.style.maxHeight = '0px';
                content.style.opacity = '0';
                // Force reflow
                content.getBoundingClientRect();
                // Animate to measured height
                content.style.maxHeight = height + 'px';
                content.style.opacity = '1';

                const onEnd = function (e) {
                    if (e.propertyName === 'max-height') {
                        // Clear fixed max-height so content can grow/shrink naturally
                        content.style.maxHeight = '';
                        content.removeEventListener('transitionend', onEnd);
                        content._transitionHandler = null;
                    }
                };
                content._transitionHandler = onEnd;
                content.addEventListener('transitionend', onEnd);

                module.classList.remove('collapsed');
            } else {
                // Collapse
                const height = content.scrollHeight;
                // Ensure starting height is set
                content.style.maxHeight = height + 'px';
                content.style.opacity = '1';
                // Force reflow
                content.getBoundingClientRect();
                // Animate to 0
                content.style.maxHeight = '0px';
                content.style.opacity = '0';

                const onEnd = function (e) {
                    if (e.propertyName === 'max-height') {
                        // Hide after collapsing to remove from tab order
                        content.style.display = 'none';
                        content.removeEventListener('transitionend', onEnd);
                        content._transitionHandler = null;
                    }
                };
                content._transitionHandler = onEnd;
                content.addEventListener('transitionend', onEnd);

                module.classList.add('collapsed');
            }

            // 保存模块状态到 localStorage
            saveModuleStates();
        }

        // 网络信息模块的折叠/展开函数
        function toggleNetworkModule(titleEl) {
            const module = titleEl.closest('.module');
            const content = document.getElementById('network-module-content');
            const icon = titleEl.querySelector('.collapse-icon');

            // If a transition is currently attached, remove it to avoid duplicate handlers
            if (content._transitionHandler) {
                content.removeEventListener('transitionend', content._transitionHandler);
                content._transitionHandler = null;
            }

            const isHidden = content.style.display === 'none' || getComputedStyle(content).display === 'none';

            if (isHidden) {
                // Expand - show latency tests and start testing
                content.style.display = 'block';
                content.style.maxHeight = '0px';
                content.style.opacity = '0';

                requestAnimationFrame(() => {
                    const height = content.scrollHeight;
                    content.style.maxHeight = height + 'px';
                    content.style.opacity = '1';
                });

                if (icon) {
                    icon.style.transform = 'rotate(0deg)';
                }

                const onEnd = function (e) {
                    if (e.propertyName === 'max-height') {
                        // Clear fixed max-height so content can grow/shrink naturally
                        content.style.maxHeight = '';
                        content.removeEventListener('transitionend', onEnd);
                        content._transitionHandler = null;
                    }
                };
                content._transitionHandler = onEnd;
                content.addEventListener('transitionend', onEnd);

                // 生成卡片并开始测试
                startLatencyTest();
            } else {
                // Collapse - hide latency tests
                const height = content.scrollHeight;
                // Ensure starting height is set
                content.style.maxHeight = height + 'px';
                content.style.opacity = '1';
                // Force reflow
                content.getBoundingClientRect();
                // Animate to 0
                content.style.maxHeight = '0px';
                content.style.opacity = '0';

                if (icon) {
                    icon.style.transform = 'rotate(90deg)';
                }

                const onEnd = function (e) {
                    if (e.propertyName === 'max-height') {
                        content.style.display = 'none';
                        content.removeEventListener('transitionend', onEnd);
                        content._transitionHandler = null;
                    }
                };
                content._transitionHandler = onEnd;
                content.addEventListener('transitionend', onEnd);
            }
        }

        // 规范化PATH字段
        function normalizePath(path) {
            // 如果为空，返回原值
            if (!path) return path;

            // 移除 '#' 及其之后的所有内容（注释）
            let normalizedPath = path.split('#')[0];

            // 去除首尾空格
            normalizedPath = normalizedPath.trim();

            // 如果第一个字符不是 '/'，则添加 '/'
            if (normalizedPath && !normalizedPath.startsWith('/')) {
                normalizedPath = '/' + normalizedPath;
            }

            return normalizedPath;
        }

        // 处理PATH输入完成后的规范化
        function handlePathChange() {
            const nodePathInput = document.getElementById('nodePATH');
            const originalValue = nodePathInput.value;
            const normalizedValue = normalizePath(originalValue);

            // 如果规范化后的值与原值不同，更新输入框
            if (normalizedValue !== originalValue) {
                nodePathInput.value = normalizedValue;
            }

            // 标记为已修改
            markModified('config');
        }

        function markModified(section) {
            modifiedSections.add(section);

            // 特殊处理 notification 部分：更新 TG.启用 状态
            if (section === 'notification') {
                const telegramCheckbox = document.getElementById('telegramEnabled');
                if (!currentConfig.TG) currentConfig.TG = {};
                currentConfig.TG.启用 = telegramCheckbox.checked;
            }

            updateButtonStates();
        }

        function updateButtonStates() {
            // 订阅生成模块
            const subModified = modifiedSections.has('sub');
            document.getElementById('saveSubBtn').disabled = !subModified;
            document.getElementById('cancelSubBtn').disabled = !subModified;

            // 配置信息模块
            const configModified = modifiedSections.has('config');
            document.getElementById('saveConfigBtn').disabled = !configModified;
            document.getElementById('cancelConfigBtn').disabled = !configModified;

            // ECH设置模块
            const echModified = modifiedSections.has('ech');
            document.getElementById('saveEchBtn').disabled = !echModified;
            document.getElementById('cancelEchBtn').disabled = !echModified;

            // 反代设置模块
            const proxyModified = modifiedSections.has('proxy');
            document.getElementById('saveProxyBtn').disabled = !proxyModified;
            document.getElementById('cancelProxyBtn').disabled = !proxyModified;

            // 订阅转换模块
            const convertModified = modifiedSections.has('convert');
            document.getElementById('saveConvertBtn').disabled = !convertModified;
            document.getElementById('cancelConvertBtn').disabled = !convertModified;

            // 通知设置模块
            const notificationModified = modifiedSections.has('notification');
            document.getElementById('saveNotificationBtn').disabled = !notificationModified;
            document.getElementById('cancelNotificationBtn').disabled = !notificationModified;
        }

        function resetAllButtons() {
            document.querySelectorAll('[id^="save"]').forEach(btn => btn.disabled = true);
            document.querySelectorAll('[id^="cancel"]').forEach(btn => btn.disabled = true);
        }

        function copySubscription(elementId) {
            const element = document.getElementById(elementId);
            navigator.clipboard.writeText(element.value).then(() => {
                showToast('已复制到剪贴板', 'success');
            }).catch(() => {
                showToast('复制失败', 'error');
            });
        }

        function handleTLSFragmentChange(type) {
            const shadowrocket = document.getElementById('tlsFragmentShadowrocket');
            const happ = document.getElementById('tlsFragmentHapp');

            if (type === 'Shadowrocket') {
                if (shadowrocket.checked) {
                    happ.checked = false;
                }
            } else if (type === 'Happ') {
                if (happ.checked) {
                    shadowrocket.checked = false;
                }
            }
        }

        function showQRCode(elementId) {
            const text = document.getElementById(elementId).value;
            const container = document.getElementById('qrcodeContainer');
            container.innerHTML = '';

            // 如果文本过长，使用较低的纠错等级来支持更长的内容
            let correctLevel = QRCode.CorrectLevel.H;
            if (text.length > 1500) {
                correctLevel = QRCode.CorrectLevel.M;
            }
            if (text.length > 2500) {
                correctLevel = QRCode.CorrectLevel.L;
            }

            try {
                new QRCode(container, {
                    text: text,
                    width: 300,
                    height: 300,
                    colorDark: '#000',
                    colorLight: '#fff',
                    correctLevel: correctLevel
                });
                document.getElementById('qrcodeModal').classList.add('show');
            } catch (error) {
                // 如果文本过长，显示错误提示
                console.error('二维码生成失败:', error);
                showToast('链接过长，无法生成二维码。联系项目作者修复问题。', 'error');
                container.innerHTML = '<div style="padding:20px;text-align:center;color:#f44336;">二维码生成失败：内容过长</div>';
            }
        }

        function closeQRCode(event) {
            if (!event || event.target.id === 'qrcodeModal') {
                document.getElementById('qrcodeModal').classList.remove('show');
            }
        }

        // HOSTS 编辑模态框相关函数
        function openHostsEditModal(event) {
            if (event) event.stopPropagation();
            const modal = document.getElementById('hostsEditModal');
            const textarea = document.getElementById('hostsEditTextarea');

            // 将 HOSTS 数组内容填入文本框，每行一个
            if (currentConfig.HOSTS && Array.isArray(currentConfig.HOSTS)) {
                textarea.value = currentConfig.HOSTS.join('\n');
            } else {
                textarea.value = '';
            }

            modal.classList.add('show');
            textarea.focus();
        }

        function closeHostsEditModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('hostsEditModal');
            modal.classList.remove('show');
        }

        function confirmHostsEdit() {
            const textarea = document.getElementById('hostsEditTextarea');
            const nodeHostInput = document.getElementById('nodeHost');

            // 将文本框内容按 逗号、中文逗号 和 换行 分割成数组
            const text = textarea.value;
            // 使用正则表达式，将 , 、， 和 \n 都作为分隔符
            const items = text.split(/[ ,，。\n]+/)
                .map(item => cleanHostDomain(item.trim()))
                .filter(item => item.length > 0);

            if (items.length === 0) {
                showToast('请至少输入一个域名', 'error');
                return;
            }

            // 更新 currentConfig.HOSTS 数组
            currentConfig.HOSTS = items;

            // 更新输入框显示（用逗号连接）
            nodeHostInput.value = items.join('、');

            // 关闭模态框
            closeHostsEditModal();

            // 标记配置已修改
            markModified('config');

            showToast('域名列表已更新，请保存配置', 'success');
        }

        // 清理域名格式：去掉协议、路径、端口号，只保留纯域名
        function cleanHostDomain(input) {
            if (!input) return '';

            let domain = input;

            // 去掉协议前缀 (http:// 或 https://)
            domain = domain.replace(/^https?:\/\//i, '');

            // 去掉路径部分（第一个 / 及之后的内容）
            const slashIndex = domain.indexOf('/');
            if (slashIndex !== -1) {
                domain = domain.substring(0, slashIndex);
            }

            // 去掉端口号（: 及之后的数字）
            domain = domain.replace(/:\d+$/, '');

            return domain.trim();
        }

        async function saveSub() {
            const mode = document.getElementById('ipMode').value;

            // 检查文本框内容是否为空
            if (mode === 'random') {
                const randomCount = document.getElementById('randomCount').value.trim();
                if (!randomCount) {
                    showToast('随机优选数量不能为空', 'error');
                    return;
                }
            } else if (mode === 'custom') {
                const customIPs = document.getElementById('customIPs').value.trim();
                if (!customIPs) {
                    showToast('自定义优选地址不能为空', 'error');
                    return;
                }
            } else if (mode === 'generator') {
                const generatorURL = document.getElementById('generatorURL').value.trim();
                if (!generatorURL) {
                    showToast('优选订阅生成器地址不能为空', 'error');
                    return;
                }
            }

            const updates = {
                local: mode !== 'generator',
                本地IP库: { 随机IP: mode === 'random', 随机数量: parseInt(document.getElementById('randomCount').value) || 16 },
                SUB: mode === 'generator' ? document.getElementById('generatorURL').value : null,
                SUBNAME: currentConfig.优选订阅生成.SUBNAME,
                SUBUpdateTime: currentConfig.优选订阅生成.SUBUpdateTime,
                TOKEN: currentConfig.优选订阅生成.TOKEN
            };

            // 如果指定端口存在，添加到本地IP库
            if (currentConfig.优选订阅生成?.本地IP库?.指定端口 !== undefined) {
                updates.本地IP库.指定端口 = parseInt(document.getElementById('specifiedPort').value);
            }

            currentConfig.优选订阅生成 = { ...currentConfig.优选订阅生成, ...updates };

            if (mode === 'custom') {
                const customIPs = document.getElementById('customIPs').value;
                try {
                    await fetch('/admin/ADD.txt', { method: 'POST', body: customIPs });
                } catch (error) {
                    showToast('保存自定义IP失败', 'error');
                    return;
                }
            }

            await saveConfigToServer('sub');
        }

        async function saveConfig() {
            currentConfig.优选订阅生成.SUBNAME = document.getElementById('subName').value;
            currentConfig.协议类型 = document.getElementById('protocol').value;
            //currentConfig.传输协议 = currentConfig.协议类型 === 'trojan' ? 'ws' : document.getElementById('transport').value;
            currentConfig.跳过证书验证 = document.getElementById('skipVerify').checked;

            // 保存PATH（如果"完整节点路径"字段存在，表示后端支持编辑PATH）
            if (currentConfig['完整节点路径'] !== undefined) {
                currentConfig.PATH = document.getElementById('nodePATH').value;
            }

            // 保存Fingerprint（如果字段存在）
            if (currentConfig['Fingerprint'] !== undefined) {
                currentConfig['Fingerprint'] = document.getElementById('fingerprint').value;
            }

            // 保存随机路径（如果字段存在）
            if (currentConfig['随机路径'] !== undefined) {
                currentConfig['随机路径'] = document.getElementById('randomPath').checked;
            }

            // 保存启用0RTT（如果字段存在）
            if (currentConfig['启用0RTT'] !== undefined) {
                currentConfig['启用0RTT'] = document.getElementById('enable0RTT').checked;
            }

            // 保存TLS分片（如果字段存在）
            if (currentConfig['TLS分片'] !== undefined) {
                const shadowrocket = document.getElementById('tlsFragmentShadowrocket').checked;
                const happ = document.getElementById('tlsFragmentHapp').checked;

                if (shadowrocket) {
                    currentConfig['TLS分片'] = 'Shadowrocket';
                } else if (happ) {
                    currentConfig['TLS分片'] = 'Happ';
                } else {
                    currentConfig['TLS分片'] = null;
                }
            }

            await saveConfigToServer('config');
            // 更新网页标题
            document.title = `${currentConfig.优选订阅生成?.SUBNAME || 'edgetunnel'}设置页面 - 管理后台`;
        }

        async function saveEch() {
            // 保存ECH（如果字段存在）
            if (currentConfig['ECH'] !== undefined) {
                currentConfig['ECH'] = document.getElementById('enableECH').checked;

                // 保存ECHConfig.DNS（如果存在）
                if (currentConfig.ECHConfig?.DNS !== undefined) {
                    const dnsValue = document.getElementById('echDNSValue').value;
                    if (dnsValue) {
                        currentConfig.ECHConfig.DNS = dnsValue;
                    }
                }

                // 保存ECHConfig.SNI（如果存在）
                if (currentConfig.ECHConfig?.SNI !== undefined) {
                    const sniValue = document.getElementById('echSNIValue').value;
                    currentConfig.ECHConfig.SNI = sniValue === '' ? null : sniValue;
                }
            }

            await saveConfigToServer('ech');
        }

        async function saveProxy() {
            const mode = document.getElementById('proxyMode').value;
            let socksEnabled = null;
            let socksAccount = '';
            let globalProxy = false;
            let proxyIP = currentConfig.反代.PROXYIP;

            // 检查文本框内容是否为空
            if (mode === 'auto') {
                socksEnabled = null;
                const autoProxy = document.getElementById('autoProxy').checked;
                proxyIP = autoProxy ? 'auto' : document.getElementById('proxyIP').value.trim();

                if (!autoProxy && !proxyIP) {
                    showToast('PROXYIP地址不能为空', 'error');
                    return;
                }
            } else if (mode === 'socks5') {
                socksEnabled = 'socks5';
                socksAccount = document.getElementById('socks5Addr').value.trim();
                globalProxy = document.getElementById('globalSocks5').checked;

                if (!socksAccount) {
                    showToast('SOCKS5地址不能为空', 'error');
                    return;
                }
            } else if (mode === 'http') {
                socksEnabled = 'http';
                socksAccount = document.getElementById('httpAddr').value.trim();
                globalProxy = document.getElementById('globalHTTP').checked;

                if (!socksAccount) {
                    showToast('HTTP地址不能为空', 'error');
                    return;
                }
            }

            currentConfig.反代 = {
                PROXYIP: proxyIP,
                SOCKS5: {
                    启用: socksEnabled,
                    全局: globalProxy,
                    账号: socksAccount,
                    白名单: currentConfig.反代.SOCKS5.白名单
                }
            };

            await saveConfigToServer('proxy');
        }

        // 加载SubConfig JSON数据
        async function loadSubConfigData() {
            try {
                const url = 'https://raw.githubusercontent.com/cmliu/cmliu/main/SUBCONFIG.json';
                const text = await fetchWithAutoMirror(url, 'SubConfig');
                subConfigData = JSON.parse(text);
                populateSubConfigSelect();
                console.log('[订阅转换配置列表] SUBCONFIG 数据加载成功');
            } catch (error) {
                console.error('Error loading SubConfig:', error);
                // 加载失败时，仍然显示下拉框（只有自定义选项）
                subConfigData = null;
                populateSubConfigSelect();
            }
        }

        // 填充SubConfig下拉框
        function populateSubConfigSelect() {
            const select = document.getElementById('subConfigSelect');
            const customInput = document.getElementById('subConfigCustomInput');
            if (!select) return; // 元素还不存在，等待后续调用

            // 始终添加"自定义"选项作为第一项
            select.innerHTML = '<option value="custom">&nbsp;&nbsp;&nbsp;&nbsp;自定义</option>';

            // 如果有数据，添加分组选项
            if (subConfigData && Array.isArray(subConfigData)) {
                subConfigData.forEach(group => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = group.label;

                    if (group.options && Array.isArray(group.options)) {
                        group.options.forEach(option => {
                            const opt = document.createElement('option');
                            opt.value = option.value;
                            opt.textContent = option.label;
                            optgroup.appendChild(opt);
                        });
                    }

                    select.appendChild(optgroup);
                });
            }

            // 显示下拉框
            select.style.display = 'block';

            // 如果已有保存的配置值，设置选中状态
            const savedSubConfig = currentConfig.订阅转换配置?.SUBCONFIG || '';
            if (savedSubConfig) {
                // 尝试在下拉框中找到匹配的选项
                select.value = savedSubConfig;

                // 如果没有匹配到（值不在列表中），选择"自定义"并显示输入框
                if (select.value !== savedSubConfig) {
                    select.value = 'custom';
                    customInput.value = savedSubConfig;
                    customInput.style.display = 'block';
                    document.getElementById('subConfig').value = savedSubConfig;
                } else {
                    // 匹配成功，隐藏自定义输入框
                    customInput.style.display = 'none';
                    customInput.value = '';
                    document.getElementById('subConfig').value = savedSubConfig;
                }
            } else {
                // 没有保存值，默认选择"自定义"
                select.value = 'custom';
                customInput.style.display = 'block';
            }

            // 设置change事件监听
            select.onchange = function () {
                if (this.value === 'custom') {
                    // 选择自定义，显示输入框
                    customInput.style.display = 'block';
                    document.getElementById('subConfig').value = customInput.value;
                } else {
                    // 选择预设值，隐藏输入框并更新值
                    customInput.style.display = 'none';
                    customInput.value = '';
                    document.getElementById('subConfig').value = this.value;
                }
                markModified('convert');
            };
        }

        // 自定义输入框变化时的处理
        function onSubConfigCustomInput() {
            const customInput = document.getElementById('subConfigCustomInput');
            document.getElementById('subConfig').value = customInput.value;
            markModified('convert');
        }

        async function saveConvert() {
            currentConfig.订阅转换配置 = {
                SUBAPI: document.getElementById('subAPI').value,
                SUBCONFIG: document.getElementById('subConfig').value,
                SUBEMOJI: document.getElementById('emoji').checked
            };

            await saveConfigToServer('convert');
        }

        async function saveConfigToServer(section) {
            try {
                const response = await fetch('/admin/config.json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    },
                    body: JSON.stringify(currentConfig)
                });

                if (!response.ok) throw new Error('保存失败');
                showToast('✅ 配置已保存，请更新订阅，才能获取最新节点内容！', 'success');
                modifiedSections.delete(section);
                updateButtonStates();
            } catch (error) {
                showToast('😢 ' + error.message + '，请检测网络环境，或关闭代理后再试！', 'error');
            }
        }

        function cancelEdit(section) {
            currentConfig = JSON.parse(JSON.stringify(originalConfig));

            // 只重置该模块的值，不调用 renderUI 以保持展开状态
            if (section === 'sub') {
                const local = currentConfig.优选订阅生成?.local ?? true;
                const randomIP = currentConfig.优选订阅生成?.本地IP库?.随机IP ?? true;

                if (!local) {
                    document.getElementById('ipMode').value = 'generator';
                    document.getElementById('generatorURL').value = currentConfig.优选订阅生成?.SUB || '';
                } else if (randomIP) {
                    document.getElementById('ipMode').value = 'random';
                    document.getElementById('randomCount').value = currentConfig.优选订阅生成?.本地IP库?.随机数量 || 16;
                    // 设置指定端口
                    if (currentConfig.优选订阅生成?.本地IP库?.指定端口 !== undefined) {
                        document.getElementById('specifiedPort').value = currentConfig.优选订阅生成.本地IP库.指定端口;
                    }
                } else {
                    document.getElementById('ipMode').value = 'custom';
                    loadCustomIPs();
                }
                updateIPMode();
            } else if (section === 'config') {
                document.getElementById('subName').value = currentConfig.优选订阅生成?.SUBNAME || '';
                document.getElementById('nodeHost').value = currentConfig.HOST || '';
                document.getElementById('nodeUUID').value = currentConfig.UUID || '';
                document.getElementById('nodePATH').value = currentConfig.PATH || '';
                document.getElementById('protocol').value = currentConfig.协议类型 || 'vless';
                document.getElementById('skipVerify').checked = currentConfig.跳过证书验证 || false;

                // 处理PATH字段的只读状态
                const nodePathInput = document.getElementById('nodePATH');
                if (currentConfig['完整节点路径'] !== undefined) {
                    nodePathInput.removeAttribute('readonly');
                    nodePathInput.title = '节点的伪装路径';
                    nodePathInput.onchange = handlePathChange;
                } else {
                    nodePathInput.setAttribute('readonly', '');
                    nodePathInput.title = '节点的伪装路径 仅可通过 \'PATH\'环境变量 进行修改';
                    nodePathInput.onchange = null;
                }

                // 重置随机路径（如果字段存在）
                if (currentConfig['随机路径'] !== undefined) {
                    document.getElementById('randomPath').checked = currentConfig['随机路径'] || false;
                }

                // 重置启用0RTT（如果字段存在）
                if (currentConfig['启用0RTT'] !== undefined) {
                    document.getElementById('enable0RTT').checked = currentConfig['启用0RTT'] || false;
                }

                // 重置TLS分片（如果字段存在）
                if (currentConfig['TLS分片'] !== undefined) {
                    document.getElementById('tlsFragmentShadowrocket').checked = currentConfig['TLS分片'] === 'Shadowrocket';
                    document.getElementById('tlsFragmentHapp').checked = currentConfig['TLS分片'] === 'Happ';
                }

                // 重置ECH（如果字段存在）
                if (currentConfig['ECH'] !== undefined) {
                    document.getElementById('enableECH').checked = currentConfig['ECH'] || false;

                    // 重置ECHConfig的下拉框
                    populateEchDNSSelect();
                    populateEchSNISelect();
                }

                updateProtocol();
            } else if (section === 'ech') {
                // 重置ECH设置
                if (currentConfig['ECH'] !== undefined) {
                    document.getElementById('enableECH').checked = currentConfig['ECH'] || false;

                    // 重置ECHConfig的下拉框
                    populateEchDNSSelect();
                    populateEchSNISelect();
                }
            } else if (section === 'proxy') {
                const socksEnabled = currentConfig.反代?.SOCKS5?.启用;
                if (!socksEnabled) {
                    document.getElementById('proxyMode').value = 'auto';
                    document.getElementById('proxyIP').value = currentConfig.反代?.PROXYIP || '';
                    document.getElementById('autoProxy').checked = (currentConfig.反代?.PROXYIP === 'auto');
                    if (currentConfig.反代?.PROXYIP === 'auto') {
                        document.getElementById('proxyIP').disabled = true;
                    }
                } else if (socksEnabled === 'socks5') {
                    document.getElementById('proxyMode').value = 'socks5';
                    document.getElementById('socks5Addr').value = currentConfig.反代?.SOCKS5?.账号 || '';
                    document.getElementById('globalSocks5').checked = currentConfig.反代?.SOCKS5?.全局 || false;
                } else if (socksEnabled === 'http') {
                    document.getElementById('proxyMode').value = 'http';
                    document.getElementById('httpAddr').value = currentConfig.反代?.SOCKS5?.账号 || '';
                    document.getElementById('globalHTTP').checked = currentConfig.反代?.SOCKS5?.全局 || false;
                }
                updateProxyMode();
            } else if (section === 'convert') {
                document.getElementById('subAPI').value = currentConfig.订阅转换配置?.SUBAPI || '';
                document.getElementById('subConfig').value = currentConfig.订阅转换配置?.SUBCONFIG || '';
                document.getElementById('emoji').checked = currentConfig.订阅转换配置?.SUBEMOJI || false;
                // 重新填充下拉框以恢复正确的选中状态
                populateSubConfigSelect();
            }

            modifiedSections.delete(section);
            updateButtonStates();
        }

        // 保存模块展开/折叠状态到 localStorage
        function saveModuleStates() {
            const states = {};
            document.querySelectorAll('.module').forEach((module, index) => {
                const title = module.querySelector('.module-title')?.textContent?.trim() || ('module-' + index);
                // 不保存"查看操作日志"和"当前网络信息"模块的状态
                if (title !== '📋 查看操作日志' && title !== '🌍 当前网络信息') {
                    states[title] = !module.classList.contains('collapsed');
                }
            });
            localStorage.setItem('adminModuleStates', JSON.stringify(states));
        }

        // 从 localStorage 加载模块展开/折叠状态
        function loadModuleStates() {
            const savedStates = localStorage.getItem('adminModuleStates');
            const states = savedStates ? JSON.parse(savedStates) : {};

            // 如果是第一次访问（localStorage中没有保存状态），所有模块默认折叠
            const isFirstVisit = !savedStates;

            document.querySelectorAll('.module').forEach((module, index) => {
                const title = module.querySelector('.module-title')?.textContent?.trim() || ('module-' + index);
                let shouldBeExpanded;

                // "查看操作日志"模块始终保持折叠状态，"当前网络信息"模块始终展开
                if (title === '📋 查看操作日志') {
                    shouldBeExpanded = false;
                } else if (title === '🌍 当前网络信息') {
                    shouldBeExpanded = true;
                } else {
                    shouldBeExpanded = isFirstVisit ? false : (states[title] !== false); // 第一次默认折叠，之后按保存的状态
                }

                const isCurrentlyCollapsed = module.classList.contains('collapsed');
                const content = module.querySelector('.module-content');

                if (shouldBeExpanded && isCurrentlyCollapsed) {
                    // 需要展开
                    module.classList.remove('collapsed');
                    if (content) {
                        content.style.display = 'block';
                        content.style.maxHeight = '';
                        content.style.opacity = '1';
                    }
                } else if (!shouldBeExpanded && !isCurrentlyCollapsed) {
                    // 需要折叠
                    module.classList.add('collapsed');
                    if (content) {
                        content.style.display = 'none';
                        content.style.maxHeight = '0px';
                        content.style.opacity = '0';
                    }
                }
            });
        }

        async function refreshConfig() {
            await loadConfig();
            const loadTime = currentConfig.加载时间 || '未知';
            showToast(`配置已刷新 (加载时间: ${loadTime})`, 'success');
        }

        function resetConfigWithConfirm() {
            document.getElementById('resetModal').classList.add('show');
        }

        function closeResetModal(event) {
            if (event && event.target.id !== 'resetModal') return;
            document.getElementById('resetModal').classList.remove('show');
        }

        async function confirmReset() {
            try {
                const response = await fetch('/admin/init');
                if (!response.ok) throw new Error('重置失败');

                closeResetModal();
                showToast('配置已重置为默认值', 'success');

                // 延迟1秒后刷新页面，让用户看到成功提示
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } catch (error) {
                showToast('重置失败: ' + error.message, 'error');
            }
        }

        function logout() {
            window.location.href = '/logout';
        }

        // 切换用户模式（小白模式 / 高手模式）
        function toggleUserMode() {
            const cardContainer = document.querySelector('.card-container');
            const btn = document.getElementById('modeToggleBtn');

            if (cardContainer.classList.contains('simple-mode')) {
                // 切换到高手模式
                cardContainer.classList.remove('simple-mode');
                btn.textContent = '🐣 我是小白！我想简单点！';
                localStorage.setItem('userMode', 'expert');
                showToast('🚀 已切换到高手模式，显示所有功能', 'success');
            } else {
                // 切换到小白模式
                cardContainer.classList.add('simple-mode');
                btn.textContent = '🚀 我是高手！我就要折腾！';
                localStorage.setItem('userMode', 'simple');
                showToast('🐣 已切换到小白模式，只显示常用功能', 'success');
            }

            // 使用 requestAnimationFrame 确保动画流畅
            requestAnimationFrame(() => {
                void cardContainer.offsetHeight;
            });
        }

        // 初始化用户模式
        function initUserMode() {
            const userMode = localStorage.getItem('userMode') || 'simple'; // 默认为小白模式
            const cardContainer = document.querySelector('.card-container');
            const btn = document.getElementById('modeToggleBtn');

            if (userMode === 'simple') {
                cardContainer.classList.add('simple-mode');
                btn.textContent = '🚀 我是高手！我就要折腾！';
            } else {
                cardContainer.classList.remove('simple-mode');
                btn.textContent = '🐣 我是小白！我想简单点！';
            }
        }

        function showToast(message, type = 'info') {
            // 移除现有的toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            // 创建新的toast
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            // 显示动画
            setTimeout(() => toast.classList.add('show'), 10);

            // 自动隐藏
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 日志类型翻译
        function translateLogType(type, ua = '') {
            // 如果是 Get_SUB 类型，检查 UA 是否包含 subconverter
            if (type === 'Get_SUB') {
                const uaLowercase = (ua || '').toLowerCase();
                if (uaLowercase.includes('subconverter')) {
                    return { text: '订阅转换', color: '#3b82f6' };
                }
                return { text: '获取订阅', color: '#10b981' };
            }

            const typeMap = {
                'Admin_Login': { text: '登录后台', color: '#f59e0b' },
                'Save_Config': { text: '保存配置', color: '#8b5cf6' },
                'Init_Config': { text: '重置配置', color: '#ef4444' },
                'Save_Custom_IPs': { text: '自定义优选', color: '#06b6d4' }
            };
            return typeMap[type] || { text: type, color: '#6b7280' };
        }

        // 格式化时间戳为 UTC+8
        function formatTime(timestamp) {
            const date = new Date(timestamp + 8 * 3600 * 1000);
            const year = date.getUTCFullYear();
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const day = String(date.getUTCDate()).padStart(2, '0');
            const hours = String(date.getUTCHours()).padStart(2, '0');
            const minutes = String(date.getUTCMinutes()).padStart(2, '0');
            const seconds = String(date.getUTCSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // 在展开日志模块时加载日志
        let logsLoaded = false;
        function loadLogsOnExpand(titleEl) {
            const module = titleEl.parentElement;
            const isCollapsed = module.classList.contains('collapsed');

            // 如果是展开状态且还未加载过日志，则加载
            if (!isCollapsed && !logsLoaded) {
                loadLogs();
            }
        }

        // 加载最近8条日志
        async function loadLogs() {
            try {
                const response = await fetch('/admin/log.json?_t=' + Date.now(), {
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                if (!response.ok) throw new Error('加载日志失败');
                const logs = await response.json();
                logsLoaded = true;

                // 按时间从新到旧排序，取前6条
                const recentLogs = logs.sort((a, b) => b.TIME - a.TIME).slice(0, 6);

                const container = document.getElementById('logsContainer');
                if (recentLogs.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;">暂无日志记录</div>';
                    return;
                }

                // 检查是否为移动设备
                const isMobile = window.innerWidth <= 768;

                let html = '<table style="width: 100%; border-collapse: collapse;">';
                if (isMobile) {
                    // 移动设备：显示时间、IP、操作
                    html += '<thead><tr style="border-bottom: 2px solid #e5e7eb;"><th style="text-align: left; padding: 10px; font-weight: 600;">时间 (UTC+8)</th><th style="text-align: left; padding: 10px; font-weight: 600;">IP</th><th style="text-align: left; padding: 10px; font-weight: 600;">操作</th></tr></thead>';
                } else {
                    // 桌面设备：显示时间、IP、地区、操作
                    html += '<thead><tr style="border-bottom: 2px solid #e5e7eb;"><th style="text-align: left; padding: 10px; font-weight: 600;">时间 (UTC+8)</th><th style="text-align: left; padding: 10px; font-weight: 600;">IP</th><th style="text-align: left; padding: 10px; font-weight: 600;">地区</th><th style="text-align: left; padding: 10px; font-weight: 600;">操作</th></tr></thead>';
                }
                html += '<tbody>';

                recentLogs.forEach(log => {
                    const logType = translateLogType(log.TYPE, log.UA);
                    const cc = log.CC || '未知';
                    const timeStr = formatTime(log.TIME);
                    const ip = log.IP || '未知';

                    if (isMobile) {
                        // 移动设备：不显示地区
                        html += `<tr style="border-bottom: 1px solid #f3f4f6;"><td style="padding: 10px; font-size: 12px;">${timeStr}</td><td style="padding: 10px; font-family: monospace; font-size: 12px;">${ip}</td><td style="padding: 10px;"><span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 12px; color: #fff; background-color: ${logType.color};">${logType.text}</span></td></tr>`;
                    } else {
                        // 桌面设备：显示地区
                        html += `<tr style="border-bottom: 1px solid #f3f4f6;"><td style="padding: 10px;">${timeStr}</td><td style="padding: 10px; font-family: monospace; font-size: 12px;">${ip}</td><td style="padding: 10px;">${cc}</td><td style="padding: 10px;"><span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 12px; color: #fff; background-color: ${logType.color};">${logType.text}</span></td></tr>`;
                    }
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                const container = document.getElementById('logsContainer');
                container.innerHTML = `<div style="text-align: center; padding: 20px; color: #ef4444;">加载日志失败: ${error.message}</div>`;
            }
        }

        // 显示全部日志
        async function showAllLogs() {
            try {
                const response = await fetch('/admin/log.json?_t=' + Date.now(), {
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                if (!response.ok) throw new Error('加载日志失败');
                const logs = await response.json();

                // 按时间从新到旧排序
                const sortedLogs = logs.sort((a, b) => b.TIME - a.TIME);

                const container = document.getElementById('allLogsContainer');
                let html = '<table style="width: 100%; border-collapse: collapse; font-size: 12px; table-layout: auto;">';
                html += '<thead><tr style="border-bottom: 2px solid #e5e7eb; background: #f9fafb; white-space: nowrap;"><th style="text-align: left; padding: 10px; font-weight: 600; width: 160px;">时间 (UTC+8)</th><th style="text-align: left; padding: 10px; font-weight: 600; width: 120px;">IP</th><th style="text-align: left; padding: 10px; font-weight: 600; width: 80px;">地区</th><th style="text-align: left; padding: 10px; font-weight: 600; width: 80px;">ASN</th><th style="text-align: left; padding: 10px; font-weight: 600; width: 150px;">操作</th><th style="text-align: left; padding: 10px; font-weight: 600; flex: 1; min-width: 300px;">URL</th><th style="text-align: left; padding: 10px; font-weight: 600; flex: 1; min-width: 200px;">UA</th></tr></thead>';
                html += '<tbody>';

                sortedLogs.forEach(log => {
                    const logType = translateLogType(log.TYPE, log.UA);
                    const cc = log.CC || '未知';
                    const asn = log.ASN || '未知';
                    const timeStr = formatTime(log.TIME);
                    const ip = log.IP || '未知';
                    const url = log.URL || '无';
                    const ua = log.UA ? log.UA.substring(0, 60) : '无';

                    html += `<tr style="border-bottom: 1px solid #f3f4f6;"><td style="text-align: left; padding: 8px; white-space: nowrap; width: 160px; font-size: 11px;">${timeStr}</td><td style="text-align: left; padding: 8px; font-family: monospace; font-size: 10px; white-space: nowrap; width: 120px; word-break: break-word;">${ip}</td><td style="text-align: left; padding: 8px; white-space: nowrap; width: 80px; font-size: 11px;">${cc}</td><td style="text-align: left; padding: 8px; white-space: nowrap; width: 80px; font-size: 11px; font-family: monospace;">${asn}</td><td style="text-align: left; padding: 8px; width: 150px;"><span style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; color: #fff; background-color: ${logType.color}; white-space: nowrap;">${logType.text}</span></td><td style="text-align: left; padding: 8px; font-size: 11px; word-break: break-word; min-width: 300px;">${url}</td><td style="text-align: left; padding: 8px; font-size: 10px; color: #6b7280; min-width: 200px; word-break: break-word;">${ua}</td></tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
                document.getElementById('logsModal').classList.add('show');
            } catch (error) {
                showToast('加载日志失败: ' + error.message, 'error');
            }
        }

        // 关闭日志模态框
        function closeLogsModal(event) {
            if (event && event.target.id !== 'logsModal') return;
            document.getElementById('logsModal').classList.remove('show');
        }

        // ==================== 代理验证模态框函数 ====================

        // 全局变量存储当前验证的代理类型
        let currentProxyType = null;
        let currentProxyFieldId = null;

        function openProxyVerificationModal(proxyType) {
            currentProxyType = proxyType;
            currentProxyFieldId = proxyType === 'socks5' ? 'socks5Addr' : 'httpAddr';

            // 设置模态框标题和标签
            const title = proxyType === 'socks5' ? '🔒 SOCKS5代理验证' : '🌐 HTTP代理验证';
            const label = proxyType === 'socks5' ? 'SOCKS5代理:' : 'HTTP代理:';

            document.getElementById('proxyVerificationTitle').textContent = title;
            document.getElementById('proxyVerificationLabel').textContent = label;
            document.getElementById('proxyVerificationInput').placeholder = proxyType === 'socks5'
                ? 'user:password@127.0.0.1:1080'
                : 'user:password@127.0.0.1:8080';

            // 设置输入框的当前值
            const currentValue = document.getElementById(currentProxyFieldId).value;
            document.getElementById('proxyVerificationInput').value = currentValue;

            // 重置状态
            document.getElementById('proxyVerificationStatus').style.display = 'none';
            document.getElementById('proxyVerificationStatus').textContent = '';
            document.getElementById('proxyConfirmBtn').disabled = true;
            document.getElementById('proxyConfirmBtn').style.opacity = '0.5';

            // 显示模态框
            document.getElementById('proxyVerificationModal').classList.add('show');
        }

        function closeProxyVerificationModal(event) {
            document.getElementById('proxyVerificationModal').classList.remove('show');
            currentProxyType = null;
            currentProxyFieldId = null;
            document.getElementById('proxyVerificationInput').value = '';
            document.getElementById('proxyVerificationStatus').style.display = 'none';
        }

        async function verifyProxyAvailability() {
            const input = document.getElementById('proxyVerificationInput').value.trim();
            if (!input) {
                showProxyVerificationStatus('请输入代理地址', 'error');
                return;
            }

            // 预处理代理地址
            const processedAddress = processProxyAddressForValidation(input, currentProxyType);
            if (!processedAddress) {
                showProxyVerificationStatus('代理地址格式无效', 'error');
                return;
            }

            const statusEl = document.getElementById('proxyVerificationStatus');
            const verifyBtn = document.querySelector('#proxyVerificationModal .btn-verify-api');

            try {
                verifyBtn.disabled = true;
                statusEl.textContent = '⏳ 验证中...';
                statusEl.style.display = 'block';
                statusEl.style.background = 'linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%)';
                statusEl.style.color = '#fff';
                statusEl.style.padding = '16px';
                statusEl.style.borderRadius = '8px';

                // 构建请求参数
                const params = new URLSearchParams();
                if (currentProxyType === 'socks5') {
                    params.append('socks5', processedAddress);
                } else {
                    params.append('http', processedAddress);
                }

                // 创建 AbortController 实现 5 秒超时
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 12000);

                const response = await fetch(`/admin/check?${params}&_t=${Date.now()}`, {
                    method: 'GET',
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                const data = await response.json();

                // 检查是否有 success 字段
                if (!data.hasOwnProperty('success')) {
                    statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                    statusEl.style.padding = '16px';
                    statusEl.style.borderRadius = '8px';
                    statusEl.innerHTML = '❌ <strong>后端版本过旧</strong><br/><small style="opacity: 0.9;">请升级 edgetunnel 代码</small>';
                    document.getElementById('proxyConfirmBtn').disabled = true;
                    document.getElementById('proxyConfirmBtn').style.opacity = '0.5';
                } else if (data.success === false) {
                    statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                    statusEl.style.padding = '16px';
                    statusEl.style.borderRadius = '8px';
                    statusEl.innerHTML = `❌ <strong>代理无效</strong><br/><small style="opacity: 0.9;">${data.error || '未知错误'}</small>`;
                    document.getElementById('proxyConfirmBtn').disabled = true;
                    document.getElementById('proxyConfirmBtn').style.opacity = '0.5';
                } else if (data.success === true) {
                    const ip = data.ip || '未知';
                    const loc = data.loc || '未知';
                    const responseTime = data.responseTime || 0;
                    const responseTimeDisplay = responseTime > 0 ? `${responseTime}ms` : '未知';

                    statusEl.style.background = 'linear-gradient(135deg, #10b981 0, #059669 100%)';
                    statusEl.style.padding = '16px';
                    statusEl.style.borderRadius = '8px';
                    statusEl.innerHTML = `
                        <div style="line-height: 1.8;">
                            <div style="margin-bottom: 8px;">✅ <strong>代理有效</strong></div>
                            <div style="margin-bottom: 8px;">📍 落地IP: <span style="cursor: pointer; text-decoration: underline; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;" onclick="showIpDetailForProxy('${ip}')" title="点击查看IP详情">${ip} <span style="font-size: 16px;">🔍</span></span></div>
                            <div style="margin-bottom: 8px;">🌍 落地国家: <strong>${loc}</strong></div>
                            <div>⏱️ 响应时间: <strong>${responseTimeDisplay}</strong></div>
                        </div>
                    `;

                    // 启用确定按钮
                    document.getElementById('proxyConfirmBtn').disabled = false;
                    document.getElementById('proxyConfirmBtn').style.opacity = '1';

                    // 存储验证后的地址以备后用
                    document.getElementById('proxyConfirmBtn').dataset.validAddress = processedAddress;
                }
            } catch (error) {
                statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                statusEl.style.padding = '16px';
                statusEl.style.borderRadius = '8px';

                // 判断是否为超时错误
                if (error.name === 'AbortError') {
                    statusEl.innerHTML = `❌ <strong>验证超时</strong><br/><small style="opacity: 0.9;">请求超过 10 秒无响应，请检查代理连接</small>`;
                } else {
                    statusEl.innerHTML = `❌ <strong>验证失败</strong><br/><small style="opacity: 0.9;">${error.message}</small>`;
                }

                document.getElementById('proxyConfirmBtn').disabled = true;
                document.getElementById('proxyConfirmBtn').style.opacity = '0.5';
            } finally {
                verifyBtn.disabled = false;
            }
        }

        function processProxyAddressForValidation(input, type) {
            input = input.trim();

            // 移除开头的 "/" 或 "/"
            if (input.startsWith('/')) {
                input = input.substring(1).trim();
            }

            // 检测并移除协议前缀
            const socks5Prefixes = ['socks5://', 'socks5=', 'socks5://'];
            const httpPrefixes = ['http://', 'http=', 'https://'];

            for (const prefix of socks5Prefixes) {
                if (input.toLowerCase().startsWith(prefix)) {
                    input = input.substring(prefix.length).trim();
                    break;
                }
            }

            for (const prefix of httpPrefixes) {
                if (input.toLowerCase().startsWith(prefix)) {
                    input = input.substring(prefix.length).trim();
                    break;
                }
            }

            // 移除末尾的备注（#符号之后的内容）
            if (input.includes('#')) {
                input = input.split('#')[0].trim();
            }

            return input;
        }

        function showProxyVerificationStatus(message, type) {
            const statusEl = document.getElementById('proxyVerificationStatus');
            const prefix = type === 'error' ? '❌' : 'ℹ️';
            statusEl.textContent = prefix + ' ' + message;
            statusEl.style.display = 'block';
            if (type === 'error') {
                statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
            } else {
                statusEl.style.background = 'linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%)';
            }
            statusEl.style.color = '#fff';
        }

        function showIpDetailForProxy(ip) {
            // 异步获取 IP 详情
            fetch(`https://api.ipapi.is/?ip=${ip}`)
                .then(response => response.json())
                .then(data => showIpDetailModal(data))
                .catch(error => {
                    showToast('❌ 查询IP详细信息失败');
                    console.error('IP查询错误:', error);
                });
        }

        function confirmProxyAddress() {
            const validAddress = document.getElementById('proxyConfirmBtn').dataset.validAddress;
            if (!validAddress) return;

            document.getElementById(currentProxyFieldId).value = validAddress;
            markModified('proxy');
            closeProxyVerificationModal();
        }

        function openSubAPIModal() {
            const currentValue = document.getElementById('subAPI').value;
            document.getElementById('testSubAPIInput').value = currentValue;
            document.getElementById('subAPIStatus').style.display = 'none';
            document.getElementById('subAPIStatus').textContent = '';
            document.getElementById('subAPIConfirmBtn').disabled = true;
            document.getElementById('subAPIConfirmBtn').style.opacity = '0.5';
            document.getElementById('subAPIModal').classList.add('show');
        }

        function closeSubAPIModal(event) {
            if (event && event.target.id !== 'subAPIModal') return;
            document.getElementById('subAPIModal').classList.remove('show');
            document.getElementById('testSubAPIInput').value = '';
            document.getElementById('subAPIStatus').style.display = 'none';
        }

        // ProxyIP 帮助模态框函数
        function showProxyIPHelpModal() {
            document.getElementById('proxyIPHelpModal').classList.add('show');
        }

        function closeProxyIPHelpModal(event) {
            if (event && event.target.id !== 'proxyIPHelpModal') return;
            document.getElementById('proxyIPHelpModal').classList.remove('show');
        }

        function toggleProxyIPHelpMode() {
            const checkbox = document.getElementById('proxyIPSimpleMode');
            const simpleDiv = document.getElementById('proxyIPHelpSimple');
            const detailDiv = document.getElementById('proxyIPHelpDetail');

            if (checkbox.checked) {
                // 显示简易模式
                simpleDiv.style.display = 'block';
                detailDiv.style.display = 'none';
            } else {
                // 显示详细模式
                simpleDiv.style.display = 'none';
                detailDiv.style.display = 'block';
            }
        }

        // ECH 帮助模态框函数
        function showECHHelpModal() {
            document.getElementById('echHelpModal').classList.add('show');

            // 计算并设置内容高度以适应浏览器高度
            setTimeout(() => {
                calculateECHContentHeight();
                // 窗口大小改变时重新计算
                window.addEventListener('resize', calculateECHContentHeight);
            }, 0);
        }

        function calculateECHContentHeight() {
            const modal = document.querySelector('.ech-help-modal');
            const tabContent = document.querySelector('.ech-tab-content');
            const tabs = document.querySelector('.ech-tabs');
            const closeBtn = document.querySelector('#echHelpModal .modal-close');
            const bottomBtn = document.querySelector('#echHelpModal .btn-close-modal');

            if (!modal || !tabContent) return;

            // 获取浏览器视口高度
            const viewportHeight = window.innerHeight;

            // 计算各个元素的高度（带上下文margin/padding）
            const modalPadding = 20; // 模态框内边距
            const tabsHeight = tabs ? tabs.offsetHeight + 15 : 50; // 选项卡高度 + margin
            const closeBtnHeight = 40; // 关闭按钮高度
            const bottomBtnHeight = bottomBtn ? bottomBtn.offsetHeight + 20 : 60; // 底部按钮高度 + margin
            const headerHeight = 20; // 其他上边距

            // 计算可用的内容高度
            // viewportHeight - (顶部padding + 选项卡 + 底部按钮 + 底部padding)
            const availableHeight = viewportHeight - (modalPadding * 2 + tabsHeight + bottomBtnHeight + headerHeight);

            // 设置最大高度，确保不超出视口
            tabContent.style.maxHeight = Math.max(200, availableHeight) + 'px';
        }

        function closeECHHelpModal(event) {
            if (event && event.target.id !== 'echHelpModal') return;
            document.getElementById('echHelpModal').classList.remove('show');
        }

        function switchECHTab(tabIndex) {
            // 切换选项卡按钮状态
            const tabs = document.querySelectorAll('.ech-tab');
            tabs.forEach((tab, index) => {
                if (index === tabIndex) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // 切换选项卡内容
            const panes = document.querySelectorAll('.ech-tab-pane');
            panes.forEach((pane, index) => {
                if (index === tabIndex) {
                    pane.classList.add('active');
                } else {
                    pane.classList.remove('active');
                }
            });

            // 自动滚动到活跃选项卡
            const activeTab = tabs[tabIndex];
            if (activeTab) {
                const tabsContainer = document.querySelector('.ech-tabs');
                if (tabsContainer) {
                    activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            }
        }

        // ECH 选项卡拖拽功能
        function initECHTabsDrag() {
            const tabsContainer = document.querySelector('.ech-tabs');
            if (!tabsContainer) return;

            let isDown = false;
            let startX;
            let scrollLeft;
            let isDragged = false;

            tabsContainer.addEventListener('mousedown', (e) => {
                // 如果点击的是按钮，不启动拖拽
                if (e.target.closest('.ech-tab')) {
                    isDown = true;
                    isDragged = false;
                    startX = e.pageX - tabsContainer.offsetLeft;
                    scrollLeft = tabsContainer.scrollLeft;
                    tabsContainer.classList.add('dragging');
                }
            });

            tabsContainer.addEventListener('mouseleave', () => {
                isDown = false;
                tabsContainer.classList.remove('dragging');
            });

            tabsContainer.addEventListener('mouseup', () => {
                isDown = false;
                tabsContainer.classList.remove('dragging');
            });

            tabsContainer.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();

                const x = e.pageX - tabsContainer.offsetLeft;
                const walk = (x - startX) * 1; // 拖拽速度

                if (Math.abs(walk) > 5) {
                    isDragged = true;
                }

                tabsContainer.scrollLeft = scrollLeft - walk;
            });

            // 触摸设备支持
            tabsContainer.addEventListener('touchstart', (e) => {
                isDown = true;
                isDragged = false;
                startX = e.touches[0].pageX - tabsContainer.offsetLeft;
                scrollLeft = tabsContainer.scrollLeft;
            });

            tabsContainer.addEventListener('touchend', () => {
                isDown = false;
            });

            tabsContainer.addEventListener('touchmove', (e) => {
                if (!isDown) return;

                const x = e.touches[0].pageX - tabsContainer.offsetLeft;
                const walk = (x - startX) * 1;

                if (Math.abs(walk) > 5) {
                    isDragged = true;
                }

                tabsContainer.scrollLeft = scrollLeft - walk;
            });

            // 为选项卡按钮添加点击拦截，防止拖拽时误触发
            const tabs = document.querySelectorAll('.ech-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    if (isDragged) {
                        e.preventDefault();
                        e.stopPropagation();
                        isDragged = false;
                    }
                });
            });
        }

        // 在模态框显示时初始化拖拽
        const echHelpModalOriginal = showECHHelpModal;
        showECHHelpModal = function () {
            echHelpModalOriginal.call(this);
            setTimeout(() => {
                initECHTabsDrag();
            }, 0);
        }

        function normalizeSubAPIURL(url) {
            url = url.trim();
            if (!url) return null;

            let parsedURL;

            if (!url.includes('://')) {
                url = 'https://' + url;
            }

            try {
                parsedURL = new URL(url);
            } catch (e) {
                return null;
            }

            const baseURL = parsedURL.origin;
            return baseURL;
        }

        async function testSubAPI() {
            const input = document.getElementById('testSubAPIInput').value.trim();
            if (!input) {
                showStatus('请输入地址', 'error');
                return;
            }

            const baseURL = normalizeSubAPIURL(input);
            if (!baseURL) {
                showStatus('地址格式无效', 'error');
                return;
            }

            const testURL = baseURL + '/version';
            const statusEl = document.getElementById('subAPIStatus');
            const buttons = document.querySelectorAll('#subAPIModal button.btn');
            const testBtn = buttons[0];

            try {
                testBtn.disabled = true;
                statusEl.textContent = '⏳ 检测中...';
                statusEl.style.display = 'block';
                statusEl.style.background = 'linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%)';
                statusEl.style.color = '#fff';

                const response = await fetch(testURL, {
                    method: 'GET'
                });

                if (response.status === 200) {
                    const content = await response.text();
                    const lowerContent = content.toLowerCase();

                    if (lowerContent.includes('subconverter')) {
                        statusEl.style.background = 'linear-gradient(135deg, #10b981 0, #059669 100%)';
                        statusEl.textContent = '✅ ' + content;
                        document.getElementById('subAPIConfirmBtn').disabled = false;
                        document.getElementById('subAPIConfirmBtn').style.opacity = '1';
                        document.getElementById('subAPIConfirmBtn').dataset.validURL = baseURL;
                    } else {
                        statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                        statusEl.textContent = '❌ 响应内容无效';
                        document.getElementById('subAPIConfirmBtn').disabled = true;
                        document.getElementById('subAPIConfirmBtn').style.opacity = '0.5';
                    }
                } else {
                    statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                    statusEl.textContent = '❌ 请求失败 (HTTP ' + response.status + ')';
                    document.getElementById('subAPIConfirmBtn').disabled = true;
                    document.getElementById('subAPIConfirmBtn').style.opacity = '0.5';
                }
            } catch (error) {
                statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                statusEl.textContent = '❌ 检测失败: ' + error.message;
                document.getElementById('subAPIConfirmBtn').disabled = true;
                document.getElementById('subAPIConfirmBtn').style.opacity = '0.5';
            } finally {
                testBtn.disabled = false;
            }
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('subAPIStatus');
            const prefix = type === 'error' ? '❌' : 'ℹ️';
            statusEl.textContent = prefix + ' ' + message;
            statusEl.style.display = 'block';
            if (type === 'error') {
                statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
            } else {
                statusEl.style.background = 'linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%)';
            }
            statusEl.style.color = '#fff';
        }

        function confirmSubAPI() {
            const validURL = document.getElementById('subAPIConfirmBtn').dataset.validURL;
            if (!validURL) return;

            document.getElementById('subAPI').value = validURL;
            markModified('convert');
            closeSubAPIModal();
        }

        // ==================== 消息通知设置相关函数 ====================

        // 更新 Telegram 按钮状态和颜色
        function updateTelegramButtonStates(isConfigured) {
            // 获取 Telegram 按钮元素（第一组通知按钮是 Telegram）
            const buttons = document.querySelectorAll('.notification-controls');

            if (buttons.length > 0) {
                const telegramControls = buttons[0];
                const configBtn = telegramControls.querySelector('.btn-notification-config');
                const clearBtn = telegramControls.querySelector('.btn-clear-config');

                if (isConfigured) {
                    // 已配置：参数配置按钮为绿色，清除配置按钮为红色且可点击
                    clearBtn.classList.remove('btn-not-configured');
                    clearBtn.classList.add('btn-configured');
                    clearBtn.disabled = false;
                } else {
                    // 未配置：参数配置按钮保持绿色，清除配置按钮为灰色且禁用
                    clearBtn.classList.remove('btn-configured');
                    clearBtn.classList.add('btn-not-configured');
                    clearBtn.disabled = true;
                }
            }
        }

        // 清除 Telegram 配置
        async function clearTelegramConfig() {
            if (confirm('确定要清除 Telegram 配置吗？')) {
                currentConfig.TG = {
                    BotToken: null,
                    ChatID: null,
                    启用: false
                };

                try {
                    await saveConfigToServer('notification');
                    showToast('Telegram 配置已清除', 'success');
                    updateTelegramButtonStates(false);
                    const telegramCheckbox = document.getElementById('telegramEnabled');
                    telegramCheckbox.disabled = true;
                    telegramCheckbox.checked = false;
                } catch (error) {
                    showToast('清除配置失败: ' + error.message, 'error');
                }
            }
        }

        // 更新 Cloudflare 按钮状态和颜色
        function updateCloudflareButtonStates(isConfigured) {
            // 获取 Cloudflare 按钮元素（第二组通知按钮是 Cloudflare）
            const buttons = document.querySelectorAll('.notification-controls');

            if (buttons.length > 1) {
                const cloudflareControls = buttons[1];
                const clearBtn = cloudflareControls.querySelector('.btn-clear-config');

                if (isConfigured) {
                    // 已配置：清除配置按钮为红色且可点击
                    clearBtn.classList.remove('btn-not-configured');
                    clearBtn.classList.add('btn-configured');
                    clearBtn.disabled = false;
                } else {
                    // 未配置：清除配置按钮为灰色且禁用
                    clearBtn.classList.remove('btn-configured');
                    clearBtn.classList.add('btn-not-configured');
                    clearBtn.disabled = true;
                }
            }
        }

        // 清除 Cloudflare 配置
        async function clearCloudflareConfig() {
            if (confirm('确定要清除 Cloudflare 配置吗？')) {
                currentConfig.CF = {
                    Usage: null,
                    启用: false
                };

                try {
                    await saveConfigToServer('notification');
                    showToast('Cloudflare 配置已清除', 'success');
                    updateCloudflareButtonStates(false);
                } catch (error) {
                    showToast('清除配置失败: ' + error.message, 'error');
                }
            }
        }

        // 打开 TelegramBot 配置模态框
        function openTelegramConfigModal() {
            document.getElementById('telegramConfigModal').classList.add('show');
            // 只加载Chat ID，不加载Bot Token（因为Bot Token是敏感信息）
            const chatID = currentConfig.TG?.ChatID || currentConfig.通知?.Telegram?.ChatID || '';
            document.getElementById('telegramBotToken').value = '';
            document.getElementById('telegramChatID').value = chatID;

            // 重置状态和保存按钮
            document.getElementById('telegramStatus').style.display = 'none';
            document.getElementById('telegramStatus').textContent = '';
            document.getElementById('telegramConfirmBtn').disabled = true;
            document.getElementById('telegramConfirmBtn').style.opacity = '0.5';
        }

        // 关闭 TelegramBot 配置模态框
        function closeTelegramConfigModal(event) {
            if (event && event.target.id !== 'telegramConfigModal') return;
            document.getElementById('telegramConfigModal').classList.remove('show');
        }

        // 测试 TelegramBot 连接
        async function testTelegramConfig() {
            const token = document.getElementById('telegramBotToken').value.trim();
            const chatID = document.getElementById('telegramChatID').value.trim();
            const statusEl = document.getElementById('telegramStatus');
            const confirmBtn = document.getElementById('telegramConfirmBtn');
            const testBtn = event.target;

            if (!token || !chatID) {
                statusEl.textContent = '❌ 请填写Bot Token和Chat ID';
                statusEl.style.display = 'block';
                statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                statusEl.style.color = '#fff';
                confirmBtn.disabled = true;
                confirmBtn.style.opacity = '0.5';
                return;
            }

            try {
                testBtn.disabled = true;
                statusEl.textContent = '⏳ 验证中...';
                statusEl.style.display = 'block';
                statusEl.style.background = 'linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%)';
                statusEl.style.color = '#fff';

                // 第一步：验证 Bot Token 的有效性
                const getUrlParams = new URLSearchParams({
                    access_token: token
                });
                const getMeUrl = `https://api.telegram.org/bot${token}/getMe`;

                const getMeResponse = await fetch(getMeUrl);
                if (!getMeResponse.ok) {
                    throw new Error('Bot Token 无效，无法获取机器人信息');
                }

                const getMeData = await getMeResponse.json();
                if (!getMeData.ok) {
                    throw new Error('Bot Token 无效: ' + (getMeData.description || '未知错误'));
                }

                // 第二步：通过Bot Token向Chat ID推送测试消息
                const sendUrlParams = new URLSearchParams({
                    chat_id: chatID,
                    text: '✅ Telegram 通知配置已验证成功！'
                });
                const sendUrl = `https://api.telegram.org/bot${token}/sendMessage?${sendUrlParams}`;

                const sendResponse = await fetch(sendUrl);
                if (!sendResponse.ok) {
                    throw new Error('发送消息失败，请检查Chat ID是否正确');
                }

                const sendData = await sendResponse.json();
                if (!sendData.ok) {
                    throw new Error('Chat ID 无效: ' + (sendData.description || '未知错误'));
                }

                // 验证成功
                statusEl.style.background = 'linear-gradient(135deg, #10b981 0, #059669 100%)';
                statusEl.textContent = '✅ Bot Token 和 Chat ID 均有效';
                confirmBtn.disabled = false;
                confirmBtn.style.opacity = '1';

            } catch (error) {
                statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                statusEl.textContent = '❌ 验证失败: ' + error.message;
                confirmBtn.disabled = true;
                confirmBtn.style.opacity = '0.5';
            } finally {
                testBtn.disabled = false;
            }
        }

        // 保存 TelegramBot 配置
        async function confirmTelegramConfig() {
            const token = document.getElementById('telegramBotToken').value.trim();
            const chatID = document.getElementById('telegramChatID').value.trim();
            const confirmBtn = document.getElementById('telegramConfirmBtn');

            // 检查按钮是否禁用（必须先通过验证）
            if (confirmBtn.disabled) {
                showToast('请先点击"可用性验证"按钮验证配置', 'error');
                return;
            }

            if (!token || !chatID) {
                showToast('请填写完整的Bot Token和Chat ID', 'error');
                return;
            }

            try {
                confirmBtn.disabled = true;
                confirmBtn.textContent = '保存中...';

                // 提交到后端
                const response = await fetch('/admin/tg.json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        BotToken: token,
                        ChatID: chatID
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast('✅ TelegramBot 配置已保存', 'success');
                    closeTelegramConfigModal();

                    // 更新按钮状态
                    currentConfig.TG = {
                        BotToken: token,
                        ChatID: chatID,
                        启用: true
                    };
                    updateTelegramButtonStates(true);

                    // 1秒后刷新页面
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    const errorData = await response.json();
                    showToast('❌ 保存失败: ' + (errorData.error || '未知错误'), 'error');
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = '保存';
                }
            } catch (error) {
                showToast('❌ 保存失败: ' + error.message, 'error');
                confirmBtn.disabled = false;
                confirmBtn.textContent = '保存';
            }
        }

        // 打开 Cloudflare 配置模态框
        function openCloudflareConfigModal() {
            document.getElementById('cloudflareConfigModal').classList.add('show');

            // 默认选择第一个方案
            document.getElementById('cloudflareAuthMethod').value = 'accountid';
            updateCloudflareAuthMethod();

            // 清空输入框
            document.getElementById('cloudflareEmail').value = '';
            document.getElementById('cloudflareGlobalAPIKey').value = '';
            document.getElementById('cloudflareAccountID').value = '';
            document.getElementById('cloudflareAPIToken').value = '';
            document.getElementById('cloudflareUsageAPI').value = '';

            // 重置状态和保存按钮
            document.getElementById('cloudflareStatus').style.display = 'none';
            document.getElementById('cloudflareStatus').textContent = '';
            document.getElementById('cloudflareConfirmBtn').disabled = true;
            document.getElementById('cloudflareConfirmBtn').style.opacity = '0.5';
            document.getElementById('cloudflareConfirmBtn').dataset.testPassed = 'false';
        }

        // 更新 Cloudflare 认证方法选择时的显示
        function updateCloudflareAuthMethod() {
            const method = document.getElementById('cloudflareAuthMethod').value;

            // 隐藏所有方案的输入框
            document.getElementById('cloudflareEmailSection').style.display = 'none';
            document.getElementById('cloudflareAccountIDSection').style.display = 'none';
            document.getElementById('cloudflareUsageAPISection').style.display = 'none';

            // 显示选中方案的输入框
            if (method === 'email') {
                document.getElementById('cloudflareEmailSection').style.display = 'block';
            } else if (method === 'accountid') {
                document.getElementById('cloudflareAccountIDSection').style.display = 'block';
            } else if (method === 'usageapi') {
                document.getElementById('cloudflareUsageAPISection').style.display = 'block';
            }

            // 切换方案时重置验证状态和保存按钮
            document.getElementById('cloudflareStatus').style.display = 'none';
            document.getElementById('cloudflareStatus').textContent = '';
            document.getElementById('cloudflareConfirmBtn').disabled = true;
            document.getElementById('cloudflareConfirmBtn').style.opacity = '0.5';
            document.getElementById('cloudflareConfirmBtn').dataset.testPassed = 'false';
        }

        // 关闭 Cloudflare 配置模态框
        function closeCloudflareConfigModal(event) {
            if (event && event.target.id !== 'cloudflareConfigModal') return;
            document.getElementById('cloudflareConfigModal').classList.remove('show');

            // 清空输入框和状态
            document.getElementById('cloudflareEmail').value = '';
            document.getElementById('cloudflareGlobalAPIKey').value = '';
            document.getElementById('cloudflareAccountID').value = '';
            document.getElementById('cloudflareAPIToken').value = '';
            document.getElementById('cloudflareUsageAPI').value = '';
            document.getElementById('cloudflareStatus').style.display = 'none';
            document.getElementById('cloudflareStatus').textContent = '';
        }

        // 测试 Cloudflare 连接
        async function testCloudflareConfig() {
            const method = document.getElementById('cloudflareAuthMethod').value;
            let email = '', globalAPIKey = '', accountID = '', apiToken = '', usageAPI = '';

            const statusEl = document.getElementById('cloudflareStatus');
            const confirmBtn = document.getElementById('cloudflareConfirmBtn');
            const testBtn = event.target;

            // 根据选择的方案获取输入值
            if (method === 'email') {
                email = document.getElementById('cloudflareEmail').value.trim();
                globalAPIKey = document.getElementById('cloudflareGlobalAPIKey').value.trim();

                if (!email || !globalAPIKey) {
                    statusEl.textContent = '❌ 请填写 Email 和 Global API Key';
                    statusEl.style.display = 'block';
                    statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                    statusEl.style.color = '#fff';
                    confirmBtn.disabled = true;
                    confirmBtn.style.opacity = '0.5';
                    confirmBtn.dataset.testPassed = 'false';
                    return;
                }
            } else if (method === 'accountid') {
                accountID = document.getElementById('cloudflareAccountID').value.trim();
                apiToken = document.getElementById('cloudflareAPIToken').value.trim();

                if (!accountID || !apiToken) {
                    statusEl.textContent = '❌ 请填写 Account ID 和 API Token';
                    statusEl.style.display = 'block';
                    statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                    statusEl.style.color = '#fff';
                    confirmBtn.disabled = true;
                    confirmBtn.style.opacity = '0.5';
                    confirmBtn.dataset.testPassed = 'false';
                    return;
                }
            } else if (method === 'usageapi') {
                usageAPI = document.getElementById('cloudflareUsageAPI').value.trim();

                if (!usageAPI) {
                    statusEl.textContent = '❌ 请填写 UsageAPI 地址';
                    statusEl.style.display = 'block';
                    statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                    statusEl.style.color = '#fff';
                    confirmBtn.disabled = true;
                    confirmBtn.style.opacity = '0.5';
                    confirmBtn.dataset.testPassed = 'false';
                    return;
                }
            }

            try {
                testBtn.disabled = true;
                statusEl.textContent = '⏳ 检测中...';
                statusEl.style.display = 'block';
                statusEl.style.background = 'linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%)';
                statusEl.style.color = '#fff';

                let response;

                if (method === 'usageapi') {
                    // UsageAPI 方案：直接请求外部 API
                    response = await fetch(usageAPI);
                } else {
                    // 构建请求 URL
                    let queryParams = new URLSearchParams();
                    if (method === 'email') {
                        queryParams.append('Email', email);
                        queryParams.append('GlobalAPIKey', globalAPIKey);
                    } else if (method === 'accountid') {
                        queryParams.append('AccountID', accountID);
                        queryParams.append('APIToken', apiToken);
                    }

                    response = await fetch('/admin/getCloudflareUsage?' + queryParams.toString());
                }

                if (!response.ok) {
                    throw new Error('请求失败 (HTTP ' + response.status + ')');
                }

                const data = await response.json();

                if (data.success) {
                    // 验证成功
                    statusEl.style.background = 'linear-gradient(135deg, #10b981 0, #059669 100%)';
                    const maxQuota = data.max || 100000;
                    const percentage = (data.total / maxQuota * 100).toFixed(2);
                    statusEl.textContent = `✅ 验证成功！ 今天的请求配额: ${data.total}/${maxQuota} (${percentage}%)`;
                    confirmBtn.disabled = false;
                    confirmBtn.style.opacity = '1';
                    confirmBtn.dataset.testPassed = 'true';

                    // 保存验证通过的数据供后续保存使用
                    confirmBtn.dataset.method = method;
                    confirmBtn.dataset.email = email;
                    confirmBtn.dataset.globalAPIKey = globalAPIKey;
                    confirmBtn.dataset.accountID = accountID;
                    confirmBtn.dataset.apiToken = apiToken;
                    confirmBtn.dataset.usageAPI = usageAPI;
                } else {
                    // 验证失败
                    statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                    statusEl.textContent = '❌ 验证失败：' + (data.msg || '凭证无效或无权限');
                    confirmBtn.disabled = true;
                    confirmBtn.style.opacity = '0.5';
                    confirmBtn.dataset.testPassed = 'false';
                }
            } catch (error) {
                statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                statusEl.textContent = '❌ 检测失败: ' + error.message;
                confirmBtn.disabled = true;
                confirmBtn.style.opacity = '0.5';
                confirmBtn.dataset.testPassed = 'false';
            } finally {
                testBtn.disabled = false;
            }
        }

        // 保存 Cloudflare 配置
        async function confirmCloudflareConfig() {
            const confirmBtn = document.getElementById('cloudflareConfirmBtn');

            // 检查是否通过了验证
            if (confirmBtn.dataset.testPassed !== 'true') {
                showToast('请先点击"可用性验证"按钮通过验证', 'error');
                return;
            }

            const method = confirmBtn.dataset.method;
            const email = confirmBtn.dataset.email || '';
            const globalAPIKey = confirmBtn.dataset.globalAPIKey || '';
            const accountID = confirmBtn.dataset.accountID || '';
            const apiToken = confirmBtn.dataset.apiToken || '';
            const usageAPI = confirmBtn.dataset.usageAPI || '';

            try {
                confirmBtn.disabled = true;
                confirmBtn.textContent = '保存中...';

                // 构建请求体
                let payload;
                if (method === 'usageapi') {
                    payload = {
                        Email: null,
                        GlobalAPIKey: null,
                        AccountID: null,
                        APIToken: null,
                        UsageAPI: usageAPI
                    };
                } else {
                    payload = {
                        Email: method === 'email' ? email : null,
                        GlobalAPIKey: method === 'email' ? globalAPIKey : null,
                        AccountID: method === 'accountid' ? accountID : null,
                        APIToken: method === 'accountid' ? apiToken : null,
                        UsageAPI: null
                    };
                }

                // 提交到后端
                const response = await fetch('/admin/cf.json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    showToast('✅ Cloudflare 配置已保存', 'success');
                    closeCloudflareConfigModal();

                    // 1秒后刷新页面
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    const errorData = await response.json();
                    showToast('❌ 保存失败: ' + (errorData.error || '未知错误'), 'error');
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = '保存';
                }
            } catch (error) {
                showToast('❌ 保存失败: ' + error.message, 'error');
                confirmBtn.disabled = false;
                confirmBtn.textContent = '保存';
            }
        }

        // 保存通知设置
        async function saveNotification() {
            try {
                // 只更新 TG.启用 字段
                if (!currentConfig.TG) currentConfig.TG = {};
                currentConfig.TG.启用 = document.getElementById('telegramEnabled').checked;

                // 提交到服务器，但整个 currentConfig
                const response = await fetch('/admin/config.json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentConfig)
                });

                if (!response.ok) throw new Error('保存失败');

                showToast('✅ 启用状态已保存', 'success');
                modifiedSections.delete('notification');
                updateButtonStates();
            } catch (error) {
                showToast('❌ 保存失败: ' + error.message, 'error');
            }
        }

        // 清除 Telegram 配置
        // 清除 Telegram 配置
        function clearTelegramConfig() {
            document.getElementById('clearTelegramModal').classList.add('show');
        }

        function closeClearTelegramModal(event) {
            if (!event || event.target.id === 'clearTelegramModal') {
                document.getElementById('clearTelegramModal').classList.remove('show');
            }
        }

        async function confirmClearTelegramConfig() {
            try {
                const response = await fetch('/admin/tg.json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ init: true })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    closeClearTelegramModal();
                    showToast('✅ Telegram 配置已清除，页面即将刷新...', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showToast('❌ 清除失败: ' + (data.message || '未知错误'), 'error');
                }
            } catch (error) {
                showToast('❌ 清除出错: ' + error.message, 'error');
            }
        }

        // 清除 Cloudflare 配置
        function clearCloudflareConfig() {
            document.getElementById('clearCloudflareModal').classList.add('show');
        }

        function closeClearCloudflareModal(event) {
            if (!event || event.target.id === 'clearCloudflareModal') {
                document.getElementById('clearCloudflareModal').classList.remove('show');
            }
        }

        async function confirmClearCloudflareConfig() {
            try {
                const response = await fetch('/admin/cf.json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ init: true })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    closeClearCloudflareModal();
                    showToast('✅ Cloudflare 配置已清除，页面即将刷新...', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showToast('❌ 清除失败: ' + (data.message || '未知错误'), 'error');
                }
            } catch (error) {
                showToast('❌ 清除出错: ' + error.message, 'error');
            }
        }

        // 取消通知设置编辑
        function cancelEdit(section) {
            if (section === 'notification') {
                // 重置通知启用状态为原始值
                const telegramCheckbox = document.getElementById('telegramEnabled');
                const originalEnabled = originalConfig.TG?.启用 ?? false;
                telegramCheckbox.checked = originalEnabled;
                currentConfig.TG.启用 = originalEnabled;
            } else {
                // 原有的cancelEdit逻辑
                currentConfig = JSON.parse(JSON.stringify(originalConfig));

                if (section === 'sub') {
                    const local = currentConfig.优选订阅生成?.local ?? true;
                    const randomIP = currentConfig.优选订阅生成?.本地IP库?.随机IP ?? true;

                    if (!local) {
                        document.getElementById('ipMode').value = 'generator';
                        document.getElementById('generatorURL').value = currentConfig.优选订阅生成?.SUB || '';
                    } else if (randomIP) {
                        document.getElementById('ipMode').value = 'random';
                        document.getElementById('randomCount').value = currentConfig.优选订阅生成?.本地IP库?.随机数量 || 16;
                    } else {
                        document.getElementById('ipMode').value = 'custom';
                        loadCustomIPs();
                    }
                    updateIPMode();
                } else if (section === 'config') {
                    document.getElementById('subName').value = currentConfig.优选订阅生成?.SUBNAME || '';
                    document.getElementById('nodeHost').value = currentConfig.HOST || '';
                    document.getElementById('nodeUUID').value = currentConfig.UUID || '';
                    document.getElementById('nodePATH').value = currentConfig.PATH || '';
                    document.getElementById('protocol').value = currentConfig.协议类型 || 'vless';
                    document.getElementById('skipVerify').checked = currentConfig.跳过证书验证 || false;
                    updateProtocol();
                } else if (section === 'proxy') {
                    const socksEnabled = currentConfig.反代?.SOCKS5?.启用;
                    if (!socksEnabled) {
                        document.getElementById('proxyMode').value = 'auto';
                        document.getElementById('proxyIP').value = currentConfig.反代?.PROXYIP || '';
                        document.getElementById('autoProxy').checked = (currentConfig.反代?.PROXYIP === 'auto');
                        if (currentConfig.反代?.PROXYIP === 'auto') {
                            document.getElementById('proxyIP').disabled = true;
                        }
                    } else if (socksEnabled === 'socks5') {
                        document.getElementById('proxyMode').value = 'socks5';
                        document.getElementById('socks5Addr').value = currentConfig.反代?.SOCKS5?.账号 || '';
                        document.getElementById('globalSocks5').checked = currentConfig.反代?.SOCKS5?.全局 || false;
                    } else if (socksEnabled === 'http') {
                        document.getElementById('proxyMode').value = 'http';
                        document.getElementById('httpAddr').value = currentConfig.反代?.SOCKS5?.账号 || '';
                        document.getElementById('globalHTTP').checked = currentConfig.反代?.SOCKS5?.全局 || false;
                    }
                    updateProxyMode();
                } else if (section === 'convert') {
                    document.getElementById('subAPI').value = currentConfig.订阅转换配置?.SUBAPI || '';
                    document.getElementById('subConfig').value = currentConfig.订阅转换配置?.SUBCONFIG || '';
                    document.getElementById('emoji').checked = currentConfig.订阅转换配置?.SUBEMOJI || false;
                }
            }

            modifiedSections.delete(section);
            updateButtonStates();
        }

        // 更新倒计时
        function updateCountdown() {
            const now = new Date();
            const nextMidnightUTC = new Date(now);
            nextMidnightUTC.setUTCHours(0, 0, 0, 0);
            nextMidnightUTC.setUTCDate(nextMidnightUTC.getUTCDate() + 1); // 总是设置为明天的0点

            const diff = nextMidnightUTC - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            document.getElementById('countdown').innerHTML = `<span class="countdown-text">距离重置还有</span> <span class="countdown-numbers">${hours.toString().padStart(2, '0')}</span><span class="countdown-text">小时</span><span class="countdown-numbers">${minutes.toString().padStart(2, '0')}</span><span class="countdown-text">分</span><span class="countdown-numbers">${seconds.toString().padStart(2, '0')}</span><span class="countdown-text">秒</span>`;
        }

        // ==================== 在线优选相关函数 ====================

        // IP打码函数 - 将IP中间段打码
        function expandIPv6(ip) {
            // 移除可能的[]包围
            ip = ip.replace(/^\[|\]$/g, '');
            // 如果没有::，直接split
            if (!ip.includes('::')) {
                return ip.split(':').map(part => part.padStart(4, '0')).join(':');
            }
            // 处理::
            const parts = ip.split('::');
            const left = parts[0] ? parts[0].split(':') : [];
            const right = parts[1] ? parts[1].split(':') : [];
            const missing = 8 - left.length - right.length;
            const middle = new Array(missing).fill('0000');
            const full = left.concat(middle).concat(right);
            return full.map(part => part.padStart(4, '0')).join(':');
        }

        function maskIP(ip) {
            if (!ip) return ip;
            // 检查是否为IPv4
            if (ip.includes('.') && !ip.includes(':')) {
                // IPv4: 例如 192.168.1.1 -> 192.*.*.1
                const parts = ip.split('.');
                if (parts.length === 4) {
                    return `${parts[0]}.*.*.${parts[3]}`;
                }
            } else if (ip.includes(':')) {
                // IPv6: 扩展并打码中间部分
                const expanded = expandIPv6(ip);
                const parts = expanded.split(':');
                if (parts.length === 8) {
                    return `${parts[0]}:****:****:****:****:****:${parts[6]}:${parts[7]}`;
                }
            }
            return ip;
        }

        // 切换IP显示模式
        function toggleIPDisplay() {
            ipDisplayMode = ipDisplayMode === 'masked' ? 'full' : 'masked';
            updateIPDisplay();
        }

        // 更新IP显示
        function updateIPDisplay() {
            const displayIP = ipDisplayMode === 'masked' ? maskIP(currentDetectedIP) : currentDetectedIP;
            const ipElement = document.getElementById('ipDisplayElement');
            if (ipElement) {
                ipElement.textContent = displayIP;
            }
        }

        let optimizeResults = {}; // 存储优选结果
        let currentSelectedCountry = ''; // 当前选中的国家
        let locationsData = []; // 存储位置数据
        let currentIPLibrary = ''; // 当前使用的IP库类型
        let currentDetectedIP = ''; // 当前检测到的IP
        let ipDisplayMode = 'masked'; // IP显示模式: 'masked' 或 'full'

        // 打开在线优选模态框
        async function openOnlineOptimizeModal() {
            document.getElementById('onlineOptimizeModal').classList.add('show');

            // 重置状态
            optimizeResults = {};
            currentSelectedCountry = '';
            document.getElementById('optimizeProgressBar').classList.add('hidden-section');
            document.getElementById('optimizeResultsTabs').classList.add('hidden-section');
            document.getElementById('optimizeResultsContent').classList.add('hidden-section');
            document.getElementById('btnSaveOverride').disabled = true;
            document.getElementById('btnSaveAppend').disabled = true;
            document.getElementById('btnStartOptimize').disabled = true;
            document.getElementById('btnStartOptimize').textContent = '检测中...';

            // 检测IP和环境
            await detectIPAndEnvironment();
        }

        // 关闭在线优选模态框
        function closeOnlineOptimizeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('onlineOptimizeModal').classList.remove('show');
        }

        // ==================== API优选相关函数 ====================

        // 打开API优选模态框
        function openAPIOptimizeModal() {
            document.getElementById('apiOptimizeModal').classList.add('show');
            // 重置表单
            document.getElementById('apiOptimizeURL').value = '';
            document.getElementById('apiOptimizePort').value = '443';
            document.getElementById('apiOptimizeResults').value = '';
            document.getElementById('btnAppendAPI').disabled = true;
            document.getElementById('btnAppendResults').disabled = true;
            // 初始化line-editor
            initLineEditor('apiOptimizeResults');
        }

        // 关闭API优选模态框
        function closeAPIOptimizeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('apiOptimizeModal').classList.remove('show');
        }

        // 验证和规范化端口号
        function validateAndNormalizePort(port) {
            let num = parseInt(port, 10);
            if (isNaN(num)) return '443';
            if (num < 1) return '1';
            if (num > 65535) return '65535';
            return num.toString();
        }

        // 验证API URL格式
        function isValidURL(url) {
            try {
                new URL(url);
                return true;
            } catch (e) {
                return false;
            }
        }

        // 将GitHub链接转换为raw格式
        function convertGitHubURLToRaw(url) {
            if (!url.includes('github.com')) {
                return url;
            }

            // 将 https://github.com/user/repo/blob/branch/path 转换为 https://raw.githubusercontent.com/user/repo/refs/heads/branch/path
            if (url.includes('/blob/')) {
                // 提取分支和文件路径
                const match = url.match(/github\.com\/([^/]+)\/([^/]+)\/blob\/([^/]+)\/(.*)/);
                if (match) {
                    const [, user, repo, branch, filePath] = match;
                    return `https://raw.githubusercontent.com/${user}/${repo}/refs/heads/${branch}/${filePath}`;
                }
            }

            // 将 https://github.com/user/repo/tree/branch/path 转换为 https://raw.githubusercontent.com/user/repo/refs/heads/branch/path
            if (url.includes('/tree/')) {
                const match = url.match(/github\.com\/([^/]+)\/([^/]+)\/tree\/([^/]+)\/(.*)/);
                if (match) {
                    const [, user, repo, branch, filePath] = match;
                    return `https://raw.githubusercontent.com/${user}/${repo}/refs/heads/${branch}/${filePath}`;
                }
            }

            return url;
        }

        // 实时自动转换GitHub链接
        function autoConvertGitHubURL() {
            const urlInput = document.getElementById('apiOptimizeURL');
            const url = urlInput.value.trim();

            if (url.includes('github.com/')) {
                const convertedURL = convertGitHubURLToRaw(url);
                if (convertedURL !== url) {
                    urlInput.value = convertedURL;
                }
            }
        }

        // 自动检测URL中的port参数并填充到默认端口字段
        function autoDetectPortFromURL() {
            const urlInput = document.getElementById('apiOptimizeURL').value.trim();
            const portInput = document.getElementById('apiOptimizePort');

            if (!urlInput) return;

            try {
                const urlObj = new URL(urlInput);
                const portParam = urlObj.searchParams.get('port');

                if (portParam) {
                    // 检测到port参数，验证并规范化
                    const normalizedPort = validateAndNormalizePort(portParam);
                    portInput.value = normalizedPort;
                }
            } catch (error) {
                // URL格式错误，忽略
                console.log('URL格式检查失败:', error);
            }
        }

        // 可用性验证
        async function verifyAPIOptimize() {
            let urlInput = document.getElementById('apiOptimizeURL').value.trim();
            const portInput = document.getElementById('apiOptimizePort').value.trim();

            if (!urlInput) {
                alert('请输入API URL');
                return;
            }

            // 自动转换GitHub链接为raw格式
            const convertedURL = convertGitHubURLToRaw(urlInput);
            if (convertedURL !== urlInput) {
                document.getElementById('apiOptimizeURL').value = convertedURL;
                urlInput = convertedURL;
                showToast('✅ GitHub链接已自动转换为raw格式', 'info');
            }

            if (!isValidURL(urlInput)) {
                alert('请输入有效的URL格式');
                return;
            }

            // 检测和提取URL中的port参数
            let detectedPort = null;
            let cleanURL = urlInput;

            try {
                const urlObj = new URL(urlInput);
                const portParam = urlObj.searchParams.get('port');

                if (portParam) {
                    // 识别到port参数
                    detectedPort = validateAndNormalizePort(portParam);

                    // 移除port参数
                    urlObj.searchParams.delete('port');
                    cleanURL = urlObj.toString();

                    // 更新URL输入框（移除port参数）
                    document.getElementById('apiOptimizeURL').value = cleanURL;

                    // 更新端口输入框
                    document.getElementById('apiOptimizePort').value = detectedPort;

                    showToast(`✅ 已自动识别URL中的端口号: ${detectedPort}，并已移除port参数`, 'success');
                }
            } catch (error) {
                console.log('URL port参数提取失败:', error);
            }

            // 规范化端口（如果没有从URL中检测到端口，则使用输入框中的值）
            const normalizedPort = detectedPort || validateAndNormalizePort(portInput);
            document.getElementById('apiOptimizePort').value = normalizedPort;

            // 使用清理后的URL构建完整URL
            const separator = cleanURL.includes('?') ? '&' : '?';
            const completeURL = `${cleanURL}${separator}port=${normalizedPort}`;

            // URL编码
            const encodedURL = encodeURIComponent(completeURL);

            // 构建请求URL
            const requestURL = `/admin/getADDAPI?url=${encodedURL}`;

            try {
                const btn = document.getElementById('btnVerifyAPI');
                btn.disabled = true;
                btn.textContent = '验证中...';

                const response = await fetch(requestURL);
                const data = await response.json();

                if (data.success && data.data && Array.isArray(data.data)) {
                    // 接口可用
                    const results = data.data.join('\n');
                    document.getElementById('apiOptimizeResults').value = results;
                    // 刷新line-editor行数
                    const resultsTA = document.getElementById('apiOptimizeResults');
                    if (resultsTA._refreshLineEditor) {
                        resultsTA._refreshLineEditor();
                    }
                    document.getElementById('btnAppendAPI').disabled = false;
                    document.getElementById('btnAppendResults').disabled = false;
                    showToast('✅ API接口验证成功！', 'success');
                } else {
                    // 接口不可用
                    document.getElementById('apiOptimizeResults').value = '❌ 接口不可用，请检查URL和端口是否正确';
                    // 刷新line-editor行数
                    const resultsTA = document.getElementById('apiOptimizeResults');
                    if (resultsTA._refreshLineEditor) {
                        resultsTA._refreshLineEditor();
                    }
                    document.getElementById('btnAppendAPI').disabled = true;
                    document.getElementById('btnAppendResults').disabled = true;
                    showToast('❌ API接口验证失败，请检查接口', 'error');
                }
            } catch (error) {
                console.error('API验证错误:', error);
                document.getElementById('apiOptimizeResults').value = `❌ 验证出错: ${error.message}`;
                // 刷新line-editor行数
                const resultsTA = document.getElementById('apiOptimizeResults');
                if (resultsTA._refreshLineEditor) {
                    resultsTA._refreshLineEditor();
                }
                document.getElementById('btnAppendAPI').disabled = true;
                document.getElementById('btnAppendResults').disabled = true;
                showToast('❌ 验证出错，请稍后重试', 'error');
            } finally {
                const btn = document.getElementById('btnVerifyAPI');
                btn.disabled = false;
                btn.textContent = '可用性验证';
            }
        }

        // 追加API到自定义优选地址
        function appendAPIToCustom() {
            let urlInput = document.getElementById('apiOptimizeURL').value.trim();
            const portInput = document.getElementById('apiOptimizePort').value.trim();

            if (!urlInput) {
                alert('请输入API URL');
                return;
            }

            // 移除URL中可能存在的port参数
            try {
                const urlObj = new URL(urlInput);
                urlObj.searchParams.delete('port');
                urlInput = urlObj.toString();
            } catch (error) {
                console.log('URL处理失败:', error);
            }

            // 构建完整URL
            const separator = urlInput.includes('?') ? '&' : '?';
            const completeURL = `${urlInput}${separator}port=${portInput}`;

            const customIPsTextarea = document.getElementById('customIPs');
            const currentValue = customIPsTextarea.value.trim();

            // 追加到文本框
            if (currentValue) {
                customIPsTextarea.value = currentValue + '\n' + completeURL;
            } else {
                customIPsTextarea.value = completeURL;
            }

            // 刷新line-editor行数
            if (customIPsTextarea._refreshLineEditor) {
                customIPsTextarea._refreshLineEditor();
            }

            // 标记为已修改
            markModified('sub');

            showToast('✅ API URL已追加到自定义优选地址', 'success');
            closeAPIOptimizeModal();
        }

        // 追加结果到自定义优选地址
        function appendResultsToCustom() {
            const resultsTextarea = document.getElementById('apiOptimizeResults');
            const results = resultsTextarea.value.trim();

            if (!results || results.startsWith('❌')) {
                alert('请先进行可用性验证且验证通过');
                return;
            }

            const customIPsTextarea = document.getElementById('customIPs');
            const currentValue = customIPsTextarea.value.trim();

            // 追加到文本框
            if (currentValue) {
                customIPsTextarea.value = currentValue + '\n' + results;
            } else {
                customIPsTextarea.value = results;
            }

            // 刷新line-editor行数
            if (customIPsTextarea._refreshLineEditor) {
                customIPsTextarea._refreshLineEditor();
            }

            // 标记为已修改
            markModified('sub');

            showToast('✅ API结果已追加到自定义优选地址', 'success');
            closeAPIOptimizeModal();
        }

        // 检测IP和网络环境
        async function detectIPAndEnvironment() {
            console.log('[在线优选] 开始: 检测网络环境');
            const detectionBox = document.getElementById('ipDetectionBox');
            const btnStart = document.getElementById('btnStartOptimize');
            detectionBox.innerHTML = '<div class="ip-detection-info">正在检测您的网络环境...</div>';

            try {
                // 首先尝试主链接
                let response, text;
                try {
                    console.log('[在线优选] 进度: 尝试使用主链接 speed.cloudflare.com 进行检测');
                    response = await fetch(`https://speed.cloudflare.com/cdn-cgi/trace?_t=${Date.now()}`, {
                        signal: AbortSignal.timeout(5000), // 5秒超时
                        cache: 'no-store' // 禁用所有缓存
                    });
                    text = await response.text();
                    console.log('[在线优选] 成功: 主链接检测通过');
                    // 保存使用的检测域名供locations使用
                    window.detectDomain = 'https://speed.cloudflare.com';
                } catch (primaryError) {
                    console.warn('[在线优选] 主链接检测失败，尝试使用当前域名本地路径...', primaryError);
                    response = await fetch(`/cdn-cgi/trace?_t=${Date.now()}`, {
                        signal: AbortSignal.timeout(5000), // 5秒超时
                        cache: 'no-store' // 禁用所有缓存
                    });
                    text = await response.text();
                    console.log('[在线优选] 成功: 本地路径检测通过（使用本地域名）');
                    // 保存使用的检测域名供locations使用
                    window.detectDomain = window.location.origin;
                }
                console.log('[在线优选] 调试: 检测响应:\n' + text);

                // 解析响应
                const lines = text.trim().split('\n');
                const data = {};
                lines.forEach(line => {
                    const [key, value] = line.split('=');
                    if (key && value) data[key.trim()] = value.trim();
                });

                const ip = data.ip || '未知';
                const loc = data.loc || '未知';
                currentDetectedIP = ip; // 保存完整IP
                ipDisplayMode = 'masked'; // 默认显示打码IP
                console.log(`[在线优选] 结果: IP=${ip}, 国家=${loc}`);

                // 显示打码的IP，并添加点击事件
                const displayIP = maskIP(ip);
                let html = `<div class="ip-detection-info">当前访问IP: <strong id="ipDisplayElement" style="cursor: pointer; transition: all 0.2s ease;" title="点击切换显示模式">${displayIP}</strong> | 访问国家: <strong>${loc}</strong></div>`;

                if (loc !== 'CN') {
                    console.warn('[在线优选] 警告: 检测到非CN地区访问，可能处于代理/VPN环境');
                    html += `<div class="ip-detection-warning" style="font-size: 16px; font-weight: 700; color: #dc2626; margin-top: 12px; line-height: 1.6;">⚠️ 检测到您当前很可能处于代理/VPN环境中！请确保处于直连网络环境下再进行在线优选，否则优选测试结果将因为不准确变得毫无意义！</div>`;
                    // 非CN地区，禁用开始优选按钮
                    btnStart.disabled = true;
                    btnStart.textContent = '仅限CN地区';
                } else {
                    // CN地区，启用开始优选按钮
                    btnStart.disabled = false;
                    btnStart.textContent = '开始优选';
                    console.log('[在线优选] 成功: 检测为 CN 地区，已启用优选按钮');
                }

                detectionBox.innerHTML = html;

                // 为IP元素添加点击事件
                const ipElement = document.getElementById('ipDisplayElement');
                if (ipElement) {
                    ipElement.addEventListener('click', toggleIPDisplay);
                }
            } catch (error) {
                console.error('[在线优选] 检测失败:', error);
                detectionBox.innerHTML = '<div class="ip-detection-info">⚠️ 无法访问 https://speed.cloudflare.com/cdn-cgi/trace 检测网络环境，请检查网络连接或关闭代理</div>';
                // 检测失败，禁用按钮
                btnStart.disabled = true;
                btnStart.textContent = '检测失败';
            }
        }

        // 验证测试线程数输入
        function validateConcurrency(input) {
            let value = parseInt(input.value);
            if (isNaN(value) || value < 1) {
                input.value = 1;
            } else if (value > 32) {
                input.value = 32;
            }
        }

        // 开始优选
        async function startOptimize() {
            console.log('[在线优选] 开始: 优选流程');
            const btnStart = document.getElementById('btnStartOptimize');
            btnStart.disabled = true;
            btnStart.textContent = '优选中...';

            const progressBar = document.getElementById('optimizeProgressBar');
            const progressFill = document.getElementById('optimizeProgressFill');
            const progressText = document.getElementById('optimizeProgressText');
            progressBar.classList.remove('hidden-section');
            progressFill.style.width = '0%';
            progressText.textContent = '0/512 (0.00%)';

            document.getElementById('optimizeResultsTabs').classList.add('hidden-section');
            document.getElementById('optimizeResultsContent').classList.add('hidden-section');

            try {
                // 加载locations数据
                console.log('[在线优选] 步骤1: 加载位置数据');
                await loadLocationsData();

                // 获取用户选择
                const ipLibrary = document.getElementById('optimizeIPLibrary').value;
                const port = document.getElementById('optimizePort').value;
                let concurrency = parseInt(document.getElementById('optimizeConcurrency').value) || 8;

                // 验证并发线程数
                if (isNaN(concurrency) || concurrency < 1 || concurrency > 32) {
                    concurrency = 8;
                    document.getElementById('optimizeConcurrency').value = '8';
                }

                console.log(`[在线优选] 步骤2: 用户选择 - IP库=${ipLibrary}, 端口=${port}, 并发线程=${concurrency}`);
                currentIPLibrary = ipLibrary; // 保存当前IP库类型

                // 获取IP列表
                console.log('[在线优选] 步骤3: 获取 IP 列表');
                const ips = await getIPList(ipLibrary, port);

                if (ips.length === 0) {
                    console.error('[在线优选] 错误: 未能获取到IP列表');
                    showToast('未能获取到IP列表', 'error');
                    return;
                }

                console.log(`[在线优选] 成功: 已获取 ${ips.length} 个 IP`);

                // 测速（多线程并发）
                console.log('[在线优选] 步骤4: 开始 IP 测速（多线程并发）');
                const results = await testIPsConcurrent(ips, progressFill, progressText, concurrency);
                console.log(`[在线优选] 完成: 测速完成，有效 IP 数量=${results.length}`);

                // 分类结果
                console.log('[在线优选] 步骤5: 开始分类结果');
                classifyResults(results);

                // 显示结果
                console.log('[在线优选] 步骤6: 显示结果');
                displayResults();

                console.log('[在线优选] 完成: 优选流程已完成');
                showToast('优选完成！', 'success');

            } catch (error) {
                console.error('[在线优选] 优选过程出错:', error);
                showToast('优选过程出错: ' + error.message, 'error');
            } finally {
                btnStart.disabled = false;
                btnStart.textContent = '开始优选';
            }
        }

        // 加载locations数据
        async function loadLocationsData() {
            const backupUrl = 'https://zip.cm.edu.kg/locations.json';

            try {
                // 使用当前域名加载位置数据，避免跨域问题
                const url = `${window.detectDomain}/locations`;
                console.log(`[在线优选] 进度: 加载位置数据 URL=${url}`);

                const response = await fetch(url, { headers: { 'Referer': window.detectDomain + '/' } });
                const data = await response.json();

                // 检查返回的数据是否为空对象或空数组
                if (!data || (Array.isArray(data) && data.length === 0) || (typeof data === 'object' && !Array.isArray(data) && Object.keys(data).length === 0)) {
                    console.warn('[在线优选] 主接口返回空数据，尝试备份接口...');
                    throw new Error('主接口返回空数据');
                }

                locationsData = data;
                console.log(`[在线优选] 成功: 已加载 ${locationsData.length} 个位置数据`);
            } catch (error) {
                console.error('[在线优选] 加载locations数据失败:', error);

                // 尝试从备份接口获取
                try {
                    console.log(`[在线优选] 进度: 尝试从备份接口加载 URL=${backupUrl}`);
                    const backupResponse = await fetch(backupUrl, { headers: { 'Referer': 'https://zip.cm.edu.kg/' } });
                    const backupData = await backupResponse.json();

                    if (backupData && Array.isArray(backupData) && backupData.length > 0) {
                        locationsData = backupData;
                        console.log(`[在线优选] 成功: 从备份接口加载到 ${locationsData.length} 个位置数据`);
                    } else {
                        console.error('[在线优选] 备份接口也返回空数据');
                        locationsData = [];
                    }
                } catch (backupError) {
                    console.error('[在线优选] 备份接口加载失败:', backupError);
                    locationsData = [];
                }
            }
        }

        // 智能镜像拉取函数 - 自动替换域名进行重试
        async function fetchWithAutoMirror(originalUrl, description = '资源') {
            // 备用域名列表（按优先级）
            const mirrorDomains = [
                'https://github.cmliussss.net/raw.githubusercontent.com',
                'https://github.cmliussss.com/raw.githubusercontent.com'
            ];

            // 第一次尝试：使用原始URL
            try {
                console.log(`[请求RAW] 进度: 尝试原始链接 URL=${originalUrl}`);
                const response = await fetch(originalUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const text = await response.text();
                console.log(`[请求RAW] 成功: 从原始链接拉取 ${description}，长度=${text.length} 字符`);
                return text;
            } catch (error) {
                console.warn(`[请求RAW] ❌ 原始链接拉取失败: ${error.message}`);
            }

            // 后续尝试：使用备用镜像域名
            for (let i = 0; i < mirrorDomains.length; i++) {
                try {
                    // 将原URL中的 https://raw.githubusercontent.com 替换为备用域名
                    const mirrorUrl = originalUrl.replace(
                        'https://raw.githubusercontent.com',
                        mirrorDomains[i]
                    );

                    console.log(`[请求RAW] 进度: 尝试备用镜像 (${i + 1}/${mirrorDomains.length}) URL=${mirrorUrl}`);
                    const response = await fetch(mirrorUrl);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    const text = await response.text();
                    console.log(`[请求RAW] 成功: 从备用镜像拉取 ${description}，长度=${text.length} 字符`);
                    return text;
                } catch (error) {
                    console.warn(`[请求RAW] ❌ 备用镜像 ${i + 1} 拉取失败: ${error.message}`);

                    // 如果是最后一个镜像，抛出错误
                    if (i === mirrorDomains.length - 1) {
                        throw new Error(`${description}拉取失败，已尝试原始链接和全部${mirrorDomains.length}个备用镜像`);
                    }
                }
            }
        }

        // 获取IP列表
        async function getIPList(ipLibrary, port) {
            // 定义各个IP库的原始URLs（仅使用官方地址）
            const urlMap = {
                'cf-official': 'https://cf.090227.xyz/ips-v4',
                'cm-list': 'https://raw.githubusercontent.com/cmliu/cmliu/main/CF-CIDR.txt',
                'as13335': 'https://raw.githubusercontent.com/ipverse/asn-ip/master/as/13335/ipv4-aggregated.txt',
                'as209242': 'https://raw.githubusercontent.com/ipverse/asn-ip/master/as/209242/ipv4-aggregated.txt',
                'reverse-proxy': 'https://raw.githubusercontent.com/cmliu/ACL4SSR/main/baipiao.txt'
            };

            try {
                const url = urlMap[ipLibrary];
                if (!url) throw new Error(`未知的IP库类型: ${ipLibrary}`);

                console.log(`[在线优选] 进度: 获取 ${ipLibrary} 的 IP 列表`);
                const text = await fetchWithAutoMirror(url, `${ipLibrary}数据`);

                if (ipLibrary === 'reverse-proxy') {
                    // 处理反向代理列表
                    console.log('[在线优选] 进度: 处理反向代理列表');
                    return processReverseProxyList(text, port);
                } else {
                    // 处理CIDR列表
                    console.log('[在线优选] 进度: 处理 CIDR 列表');
                    return processCIDRList(text, port);
                }
            } catch (error) {
                console.error('[在线优选] 获取IP列表失败:', error);
                throw new Error('获取IP列表失败: ' + error.message);
            }
        }

        // 处理反向代理列表
        function processReverseProxyList(text, targetPort) {
            const lines = text.trim().split('\n');
            const filteredIPs = [];

            console.log(`[在线优选] 调试: 反向代理列表原始行数=${lines.length}`);

            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed || trimmed.startsWith('#')) continue;

                // 格式: IP:PORT#备注
                const match = trimmed.match(/^([^:]+):(\d+)#(.+)$/);
                if (match) {
                    const [, ip, linePort, remark] = match;
                    if (linePort === targetPort) {
                        filteredIPs.push(`${ip}:${linePort}#${remark}`);
                    }
                }
            }

            console.log(`[在线优选] 结果: 匹配端口=${targetPort} 的 IP 数量=${filteredIPs.length}`);

            // 如果超过512个，随机选择512个
            if (filteredIPs.length > 512) {
                console.log('[在线优选] 提示: IP 数量超过 512，将随机选择 512 个');
                return shuffleArray(filteredIPs).slice(0, 512);
            }

            return filteredIPs;
        }

        // 处理CIDR列表
        function processCIDRList(text, port) {
            const lines = text.trim().split('\n');
            const cidrs = lines.filter(line => line.trim() && !line.startsWith('#'));

            console.log(`[在线优选] 调试: CIDR 列表数量=${cidrs.length}`);

            const ips = [];
            const targetCount = 512;

            while (ips.length < targetCount && cidrs.length > 0) {
                for (const cidr of cidrs) {
                    if (ips.length >= targetCount) break;

                    const ip = generateRandomIPFromCIDR(cidr);
                    const ipWithPort = `${ip}:${port}`;

                    // 检查是否重复
                    if (!ips.includes(ipWithPort)) {
                        ips.push(ipWithPort);
                    }
                }
            }

            console.log(`[在线优选] 成功: 已生成 ${ips.length} 个随机 IP`);
            return ips;
        }

        // 从CIDR生成随机IP
        function generateRandomIPFromCIDR(cidr) {
            const [network, bits] = cidr.split('/');
            const maskBits = parseInt(bits);
            const networkParts = network.split('.').map(Number);

            // 计算网络地址
            const networkInt = (networkParts[0] << 24) | (networkParts[1] << 16) |
                (networkParts[2] << 8) | networkParts[3];

            // 计算主机位数量
            const hostBits = 32 - maskBits;
            const hostCount = Math.pow(2, hostBits);

            // 随机选择一个主机地址
            const randomHost = Math.floor(Math.random() * hostCount);
            const ipInt = networkInt + randomHost;

            // 转换回IP地址
            const ip1 = (ipInt >>> 24) & 255;
            const ip2 = (ipInt >>> 16) & 255;
            const ip3 = (ipInt >>> 8) & 255;
            const ip4 = ipInt & 255;

            return `${ip1}.${ip2}.${ip3}.${ip4}`;
        }

        // 测试IP列表（4线程并发版本）
        async function testIPsConcurrent(ips, progressFill, progressText, concurrency = 8) {
            const results = [];
            const total = ips.length;
            let completedCount = 0;
            let successCount = 0;
            let failCount = 0;

            console.log(`[在线优选] 开始: 并发测试 总计=${total} 个 IP（线程=${concurrency}）`);

            // 更新进度的函数
            const updateProgress = () => {
                const progress = (completedCount / total * 100).toFixed(2);
                // 计算红色和绿色部分的比例（相对于已完成的IP）
                let failPercent = 0;
                if (completedCount > 0) {
                    failPercent = (failCount / completedCount * 100).toFixed(2);
                }

                // 设置进度条的渐变背景，红色表示失败，绿色表示成功
                progressFill.style.background = `linear-gradient(90deg, #ef4444 0%, #ef4444 ${failPercent}%, #10b981 ${failPercent}%, #10b981 100%)`;
                progressFill.style.width = progress + '%';
                progressText.textContent = `${completedCount}/${total} (${progress}%) - 成功: ${successCount}, 失败: ${failCount}`;

                // 每完成64个IP输出一次统计
                if (completedCount % 64 === 0 || completedCount === total) {
                    console.log(`[在线优选] 进度: 已完成 ${completedCount}/${total}，成功=${successCount}，失败=${failCount}`);
                }
            };

            // 测试单个IP的包装函数
            const testIPWrapper = async (ipWithPort) => {
                const result = await testSingleIP(ipWithPort);
                completedCount++;

                if (result) {
                    results.push(result);
                    successCount++;
                } else {
                    failCount++;
                }

                updateProgress();
                return result;
            };

            // 并发控制：将IP列表分成多个批次
            const batches = [];
            for (let i = 0; i < ips.length; i += concurrency) {
                batches.push(ips.slice(i, i + concurrency));
            }

            // 逐批次并发执行
            for (const batch of batches) {
                await Promise.all(batch.map(ip => testIPWrapper(ip)));
            }

            console.log(`[在线优选] 完成: 测试完成，总计=${total}，成功=${successCount}，失败=${failCount}`);
            return results;
        }

        // 测试IP列表（旧版单线程，保留作为备用）
        async function testIPs(ips, progressFill) {
            const results = [];
            const total = ips.length;
            let successCount = 0;
            let failCount = 0;

            console.log(`[在线优选] 开始: 开始测试 ${total} 个 IP`);

            for (let i = 0; i < total; i++) {
                const ipWithPort = ips[i];
                const result = await testSingleIP(ipWithPort);

                if (result) {
                    results.push(result);
                    successCount++;
                } else {
                    failCount++;
                }

                // 每测试50个IP输出一次统计
                if ((i + 1) % 50 === 0 || (i + 1) === total) {
                    console.log(`[在线优选] 进度: ${i + 1}/${total}，成功=${successCount}，失败=${failCount}`);
                }

                // 更新进度
                const progress = ((i + 1) / total * 100).toFixed(2);
                progressFill.style.width = progress + '%';
                progressFill.textContent = `${i + 1}/${total} (${progress}%)`;
            }

            console.log(`[在线优选] 完成: 测试完成，总计=${total}，成功=${successCount}，失败=${failCount}`);
            return results;
        }

        // 测试单个IP
        async function testSingleIP(ipWithPort) {
            try {
                // 解析IP和端口
                let ip, port, remark = '';
                if (ipWithPort.includes('#')) {
                    const [ipPort, remarkPart] = ipWithPort.split('#');
                    [ip, port] = ipPort.split(':');
                    remark = remarkPart;
                } else {
                    [ip, port] = ipWithPort.split(':');
                }

                // 转换IP为16进制
                const hexIP = ipToHex(ip);
                const testUrl = `https://${hexIP}.nip.lfree.org:${port}/cdn-cgi/trace?_t=${Date.now()}`;

                // 测试3次，取后2次平均值
                const times = [];
                let resultData = null;

                for (let i = 0; i < 3; i++) {
                    const start = performance.now();
                    try {
                        const response = await fetch(testUrl, {
                            method: 'GET',
                            signal: AbortSignal.timeout(5000) // 5秒超时
                        });

                        if (response.ok) {
                            const end = performance.now();
                            const time = end - start;

                            // 第一次不计入（DNS问题）
                            if (i > 0) {
                                times.push(time);
                            }

                            // 只在第一次解析响应数据
                            if (i === 0) {
                                const text = await response.text();
                                const lines = text.trim().split('\n');
                                const data = {};
                                lines.forEach(line => {
                                    const [key, value] = line.split('=');
                                    if (key && value) data[key] = value;
                                });

                                resultData = {
                                    ip: ip,
                                    port: port,
                                    remark: remark,
                                    responseIP: data.ip || ip,
                                    colo: data.colo || '',
                                    avgTime: 0 // 稍后计算
                                };
                            }
                        } else {
                            // 如果第一次就失败，直接返回null
                            if (i === 0) {
                                console.debug(`[在线优选] IP ${ip}:${port} 测试失败 (HTTP ${response.status})`);
                                return null;
                            }
                        }
                    } catch (error) {
                        // 请求失败，如果是第一次就返回null
                        if (i === 0) {
                            console.debug(`[在线优选] IP ${ip}:${port} 测试失败 (${error.message})`);
                            return null;
                        }
                    }
                }

                // 计算平均响应时间
                if (resultData && times.length > 0) {
                    const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
                    resultData.avgTime = Math.round(avgTime);
                    console.debug(`[在线优选] IP ${ip}:${port} 测试成功 - 平均响应: ${resultData.avgTime}ms, colo: ${resultData.colo}`);
                    return resultData;
                }

                return null;
            } catch (error) {
                return null;
            }
        }

        // IP转16进制
        function ipToHex(ip) {
            return ip.split('.').map(num => {
                const hex = parseInt(num).toString(16);
                return hex.padStart(2, '0');
            }).join('');
        }

        // 分类结果
        function classifyResults(results) {
            console.log('[在线优选] 开始: 分类结果');
            optimizeResults = {};

            // 根据IP库类型判断是否为优选反代
            // 只有使用"反向代理列表"IP库时，备注才是"优选反代"，其余一律为"官方优选"
            const isReverseProxy = currentIPLibrary === 'reverse-proxy';
            const type = isReverseProxy ? '优选反代' : '官方优选';
            console.log(`[在线优选] 调试: IP库类型=${currentIPLibrary}, 备注类型=${type}`);

            for (const result of results) {
                if (!result.colo) continue;

                // 通过colo查找国家编码
                const location = locationsData.find(loc => loc.iata === result.colo);
                const countryCode = location ? location.cca2 : result.colo;

                if (!optimizeResults[countryCode]) {
                    optimizeResults[countryCode] = [];
                }

                optimizeResults[countryCode].push({
                    ip: result.ip,
                    port: result.port,
                    remark: result.remark || countryCode,
                    type: type,
                    time: result.avgTime
                });
            }

            console.log(`[在线优选] 结果: 已分类到 ${Object.keys(optimizeResults).length} 个国家/地区`);

            // 对每个国家的结果按响应时间排序
            for (const country in optimizeResults) {
                optimizeResults[country].sort((a, b) => a.time - b.time);
                console.log(`[在线优选] 结果: ${country}=${optimizeResults[country].length} 个 IP`);
                // 不再限制为16个，保留所有结果
            }
        }

        // 显示结果
        function displayResults() {
            console.log('[在线优选] 进度: 显示优选结果');
            const tabsContainer = document.getElementById('optimizeResultsTabs');
            const contentContainer = document.getElementById('optimizeResultsContent');

            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';

            const countries = Object.keys(optimizeResults).sort();
            console.log(`[在线优选] 结果: 可用国家/地区=${countries.join(', ')}`);

            if (countries.length === 0) {
                console.warn('[在线优选] 警告: 未找到任何可用的优选IP');
                contentContainer.innerHTML = '<div style="text-align: center; color: #6b7280;">未找到可用的优选IP</div>';
                contentContainer.classList.remove('hidden-section');
                return;
            }

            // 创建选项卡 - 显示实际的IP数量
            countries.forEach((country, index) => {
                const tab = document.createElement('div');
                tab.className = 'optimize-tab';
                if (index === 0) {
                    tab.classList.add('active');
                    currentSelectedCountry = country;
                }
                const actualCount = optimizeResults[country].length;
                tab.textContent = `${country} (${actualCount})`;
                tab.onclick = () => selectCountryTab(country);
                tabsContainer.appendChild(tab);
            });

            // 显示第一个国家的结果
            showCountryResults(currentSelectedCountry);

            tabsContainer.classList.remove('hidden-section');
            contentContainer.classList.remove('hidden-section');

            // 启用保存按钮
            document.getElementById('btnSaveOverride').disabled = false;
            document.getElementById('btnSaveAppend').disabled = false;

            console.log('[在线优选] 完成: 结果显示完成');
        }

        // 选择国家选项卡
        function selectCountryTab(country) {
            currentSelectedCountry = country;

            // 更新选项卡样式
            const tabs = document.querySelectorAll('.optimize-tab');
            tabs.forEach(tab => {
                if (tab.textContent === country) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // 显示对应国家的结果
            showCountryResults(country);
        }

        // 显示国家结果
        function showCountryResults(country, showAll = false) {
            const contentContainer = document.getElementById('optimizeResultsContent');
            const results = optimizeResults[country] || [];

            if (results.length === 0) {
                contentContainer.innerHTML = '<div style="text-align: center; color: #6b7280;">暂无数据</div>';
                return;
            }

            // 默认只显示前16个，可通过showAll参数显示全部
            const displayCount = showAll ? results.length : Math.min(16, results.length);
            const displayResults = results.slice(0, displayCount);

            const html = displayResults.map(r => {
                // 根据延迟时间确定颜色
                let color = '#10b981'; // 100ms以下绿色
                if (r.time > 100 && r.time <= 200) {
                    color = '#f59e0b'; // 101~200ms黄色
                } else if (r.time > 200) {
                    color = '#ef4444'; // 201ms以上红色
                }

                return `<div class="optimize-result-item" style="color: ${color}; font-weight: bold;">${r.ip}:${r.port}#${r.remark} ${r.type} ${r.time}ms</div>`;
            }).join('');

            let finalHtml = html;

            // 如果有更多结果且未展开，添加展开按钮
            if (!showAll && results.length > 16) {
                finalHtml += `<div style="margin-top: 15px; text-align: center;">
                    <button type="button" class="btn btn-secondary" onclick="showCountryResults('${country}', true)" style="padding: 8px 16px; font-size: 12px;">
                        📂 展开所有IP (${results.length} 个)
                    </button>
                </div>`;
            }

            contentContainer.innerHTML = finalHtml;
        }

        // 保存优选结果
        async function saveOptimizeResults(mode) {
            console.log(`[在线优选] 进度: 保存结果（模式=${mode}）`);

            if (!currentSelectedCountry || !optimizeResults[currentSelectedCountry]) {
                console.warn('[在线优选] 未选择国家或无结果数据');
                showToast('请先选择一个国家', 'error');
                return;
            }

            const allResults = optimizeResults[currentSelectedCountry];
            // 只保存前16个
            const resultsToSave = allResults.slice(0, 16);
            // 修改格式：包含国家、类型和时间信息
            const newContent = resultsToSave.map(r => `${r.ip}:${r.port}#${r.remark}|${r.type}|${r.time}ms`).join('\n');
            console.log(`[在线优选] 成功: ${currentSelectedCountry} 保存 ${resultsToSave.length} 个 IP（总共 ${allResults.length} 个）`);

            const textarea = document.getElementById('customIPs');

            if (mode === 'override') {
                textarea.value = newContent;
                console.log('[在线优选] 成功: 覆盖保存完成');
                showToast('已覆盖到自定义优选地址 (前16个)', 'success');
            } else if (mode === 'append') {
                const currentValue = textarea.value.trim();

                // 追加保存时进行去重处理
                if (currentValue) {
                    // 将现有内容和新内容合并
                    const existingLines = currentValue.split('\n').map(line => line.trim()).filter(line => line);
                    const newLines = newContent.split('\n').map(line => line.trim()).filter(line => line);

                    // 使用 Set 进行去重（基于完整行内容）
                    const uniqueLinesSet = new Set(existingLines);
                    let addedCount = 0;

                    // 添加新行，同时统计实际添加的数量
                    newLines.forEach(line => {
                        if (!uniqueLinesSet.has(line)) {
                            uniqueLinesSet.add(line);
                            addedCount++;
                        }
                    });

                    // 合并去重后的内容
                    textarea.value = Array.from(uniqueLinesSet).join('\n');

                    console.log(`[在线优选] 成功: 追加保存完成，新增=${addedCount} 个 IP，重复=${newLines.length - addedCount} 个`);
                    if (addedCount === 0) {
                        showToast('所有IP均已存在，未添加新内容', 'info');
                    } else if (addedCount < newLines.length) {
                        showToast(`已追加 ${addedCount} 个新IP，过滤 ${newLines.length - addedCount} 个重复项`, 'success');
                    } else {
                        showToast(`已追加 ${addedCount} 个IP到自定义优选地址`, 'success');
                    }
                } else {
                    textarea.value = newContent;
                    console.log('[在线优选] 成功: 追加保存完成（原内容为空）');
                    showToast('已追加到自定义优选地址 (前16个)', 'success');
                }
            }

            // 标记为已修改
            markModified('sub');
        }

        // 工具函数：数组随机打乱
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // 初始化
        initializeTheme();
        window.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            initUserMode();
            initLineEditor('customIPs');
            // 独立预加载 SubConfig 数据，不阻塞主流程
            loadSubConfigData().catch(err => console.error('SubConfig预加载失败:', err));
        });

        // 启动倒计时更新
        setInterval(updateCountdown, 1000);
        updateCountdown(); // 立即执行一次

        // ==================== 网络信息相关函数 ====================

        // 设置状态指示器
        function setStatus(id, status) {
            const indicator = document.getElementById(id);
            if (indicator) {
                indicator.className = 'status-indicator status-' + status;
            }
        }

        // 获取国内测试数据 (遍历多个 API: speedtest.cn > ipipv.com > ipip.net)
        async function fetchIpipData() {
            setStatus('status-ipip', 'loading');

            // 获取标题元素,用于动态更新 API 来源
            const titleElement = document.querySelector('#status-ipip').parentElement;

            // 定义 API 配置列表,按优先级排序
            const apiConfigs = [
                {
                    name: 'speedtest.cn',
                    url: 'https://api-v3.speedtest.cn/ip',
                    parser: (data) => {
                        if (data.code === 0 && data.data) {
                            return {
                                ip: data.data.ip || '未知',
                                country: data.data.country || '未知',
                                city: data.data.city || '未知'
                            };
                        }
                        throw new Error('数据格式错误');
                    }
                },
                {
                    name: 'ipipv.com',
                    url: 'https://myip.ipipv.com/',
                    parser: (data) => {
                        return {
                            ip: data.Ip || '未知',
                            country: data.Country || '未知',
                            city: data.City || '未知'
                        };
                    }
                },
                {
                    name: 'ipip.net',
                    url: 'https://myip.ipip.net/json',
                    parser: (data) => {
                        if (data.ret === 'ok' && data.data) {
                            return {
                                ip: data.data.ip || '未知',
                                country: data.data.location[0] || '未知',
                                city: data.data.location[2] || '未知'
                            };
                        }
                        throw new Error('数据格式错误');
                    }
                }
            ];

            // 遍历 API 配置列表
            for (const config of apiConfigs) {
                try {
                    // 添加时间戳参数避免缓存
                    const timestamp = Date.now();
                    const url = config.url + (config.url.includes('?') ? '&' : '?') + `_t=${timestamp}`;
                    const response = await fetch(url);
                    const data = await response.json();

                    // 使用对应的解析器解析数据
                    const result = config.parser(data);

                    // 更新页面显示
                    document.getElementById('ipip-ip').textContent = result.ip;
                    document.getElementById('ipip-country').textContent = result.country + ' ' + result.city;
                    setStatus('status-ipip', 'success');

                    // 更新标题显示当前使用的 API
                    if (titleElement) {
                        titleElement.innerHTML = `<span class="status-indicator" id="status-ipip"></span>国内测试(${config.name})`;
                        setStatus('status-ipip', 'success'); // 重新设置状态,因为 innerHTML 会清除
                    }

                    console.log(`[国内API:${config.name}] 成功: IP=${result.ip}, 位置=${result.country} ${result.city}`);
                    return; // 成功则返回,不再尝试其他 API

                } catch (error) {
                    console.warn(`${config.name} 接口失败:`, error);
                    // 继续尝试下一个 API
                }
            }

            // 所有 API 都失败
            document.getElementById('ipip-ip').innerHTML = '<span class="error">加载失败</span>';
            document.getElementById('ipip-country').textContent = '';
            document.getElementById('ipip-city').textContent = '';
            setStatus('status-ipip', 'error');
            console.error('所有国内测试 API 都失败');
        }

        // 获取 EdgeOne 数据
        async function fetchEdgeOneData() {
            setStatus('status-edgeone', 'loading');
            try {
                const response = await fetch(`https://api.ipapi.cmliussss.net`);
                const data = await response.json();

                const edgeIp = data.ip || '未知';
                const edgeLoc = `${data.location?.country_code || '未知'} AS${data.asn?.asn || ''} ${data.asn?.org || ''}`.trim();
                document.getElementById('edgeone-ip').textContent = edgeIp;
                document.getElementById('edgeone-country').textContent = edgeLoc || '未知';
                setStatus('status-edgeone', 'success');

                console.log(`[EdgeOne] 成功: IP=${edgeIp}, 位置=${edgeLoc}`);
            } catch (error) {
                document.getElementById('edgeone-ip').innerHTML = '<span class="error">加载失败</span>';
                document.getElementById('edgeone-country').textContent = '';
                setStatus('status-edgeone', 'error');
                console.error('EdgeOne 接口错误:', error);
            }
        }

        // 获取 CloudFlare 数据
        async function fetchCloudFlareData() {
            setStatus('status-cf', 'loading');
            try {
                const timestamp = Date.now();
                const response = await fetch(`https://cf.090227.xyz/ip.json?_t=${timestamp}`);
                const data = await response.json();

                const cfIp = data.ip || '未知';
                const cfLoc = ((data.country || '') + ' ' + (data.org || '')).trim() || '未知';
                document.getElementById('cf-ip').textContent = cfIp;
                document.getElementById('cf-country').textContent = cfLoc;
                setStatus('status-cf', 'success');

                console.log(`[CloudFlare] 成功: IP=${cfIp}, 位置=${cfLoc}`);
            } catch (error) {
                document.getElementById('cf-ip').innerHTML = '<span class="error">加载失败</span>';
                document.getElementById('cf-country').textContent = '';
                setStatus('status-cf', 'error');
                console.error('CloudFlare 接口错误:', error);
            }
        }

        // 获取推特入口数据
        async function fetchTwitterData() {
            setStatus('status-twitter', 'loading');
            try {
                const timestamp = Date.now();
                const response = await fetch(`https://help.x.com/cdn-cgi/trace?_t=${timestamp}`);
                const text = await response.text();

                // 解析文本格式的响应 (key=value 格式,每行一个)
                const data = {};
                text.split('\n').forEach(line => {
                    const [key, value] = line.split('=');
                    if (key && value) {
                        data[key.trim()] = value.trim();
                    }
                });

                const twIp = data.ip || '未知';
                const twLoc = ((data.loc || '') + ' ' + (data.colo || '')).trim() || '未知';
                document.getElementById('twitter-ip').textContent = twIp;
                document.getElementById('twitter-country').textContent = twLoc;
                setStatus('status-twitter', 'success');

                console.log(`[Twitter] 成功: IP=${twIp}, 位置=${twLoc}`);
            } catch (error) {
                document.getElementById('twitter-ip').innerHTML = '<span class="error">加载失败</span>';
                document.getElementById('twitter-country').textContent = '';
                setStatus('status-twitter', 'error');
                console.error('推特入口接口错误:', error);
            }
        }

        // 网络信息加载标志
        let networkInfoLoaded = false;

        // 加载网络信息
        async function loadNetworkInfo() {
            // 检查容器是否存在
            const container = document.querySelector('.network-cards-container');
            if (!container) return;

            // 设置加载标志
            networkInfoLoaded = true;

            // 并行获取所有网络信息
            await Promise.all([
                fetchIpipData(),
                fetchEdgeOneData(),
                fetchCloudFlareData(),
                fetchTwitterData()
            ]);

            // 所有网络信息加载完成后,使 IP 可点击
            setTimeout(() => {
                makeIpClickable();
            }, 500);
        }

        // 页面加载时自动获取网络信息（因为模块现在默认展开）
        if (document.readyState !== 'loading') {
            // 页面已加载，直接加载数据
            loadNetworkInfo();
        } else {
            // 页面还在加载，等待加载完成
            document.addEventListener('DOMContentLoaded', () => {
                loadNetworkInfo();
            });
        }

        // IP 点击查询详情功能
        function makeIpClickable() {
            const ipElements = document.querySelectorAll('.ip-text');

            ipElements.forEach(element => {
                const ipText = element.textContent.trim();

                // 跳过已经标记为错误、加载中、未知的元素
                if (element.querySelector('.error') ||
                    ipText === '加载中...' ||
                    ipText === '未知' ||
                    element.classList.contains('clickable')) {
                    return;
                }

                // 添加可点击样式
                element.classList.add('clickable');

                element.addEventListener('click', async function () {
                    let ipText = this.textContent.trim();

                    // 移除可能存在的加载动画
                    const existingSpinner = this.querySelector('.loading-spinner');
                    if (existingSpinner) {
                        return; // 正在加载中,不重复请求
                    }

                    // 跳过显示"加载中..."或"未知"的元素
                    if (ipText === '加载中...' || ipText === '未知') {
                        return;
                    }

                    // 将 * 替换为 0
                    const cleanIp = ipText.replace(/\*/g, '0');

                    // 添加加载动画
                    const spinner = document.createElement('span');
                    spinner.className = 'loading-spinner';
                    this.appendChild(spinner);

                    try {
                        const response = await fetch(`https://api.ipapi.is/?ip=${cleanIp}`);

                        if (!response.ok) {
                            throw new Error('查询失败');
                        }

                        const data = await response.json();

                        // 移除加载动画
                        spinner.remove();

                        // 显示详情弹窗
                        showIpDetailModal(data);

                    } catch (error) {
                        // 移除加载动画
                        spinner.remove();

                        // 显示错误提示
                        showToast('❌ 查询IP详细信息失败');
                        console.error('IP查询错误:', error);
                    }
                });
            });
        }

        // 将布尔值转换为 emoji
        function boolToEmoji(value, trueEmoji = '✅', falseEmoji = '❌') {
            return value ? trueEmoji : falseEmoji;
        }

        // 将 IP 类型转换为中文并添加样式
        function formatIpType(type) {
            if (!type) return '<span class="ip-type-unknown">未知</span>';

            const typeMap = {
                'isp': { text: '住宅', class: 'ip-type-residential' },
                'hosting': { text: '机房', class: 'ip-type-hosting' },
                'business': { text: '商用', class: 'ip-type-business' }
            };

            const typeInfo = typeMap[type.toLowerCase()] || { text: type, class: 'ip-type-unknown' };
            return `<span class="${typeInfo.class}">${typeInfo.text}</span>`;
        }

        // 获取威胁等级的样式类
        function getThreatBadgeClass(score) {
            if (!score) return 'badge-info';

            const numScore = parseFloat(score);
            if (numScore < 0.001) return 'badge-success';
            if (numScore < 0.01) return 'badge-info';
            if (numScore < 0.1) return 'badge-warning';
            return 'badge-danger';
        }

        // 计算综合滥用评分
        function calculateAbuseScore(companyScore, asnScore, securityFlags = {}) {
            // 如果两个分数都无效，返回null
            if (!companyScore || companyScore === '未知') companyScore = 0;
            if (!asnScore || asnScore === '未知') asnScore = 0;

            const company = parseFloat(companyScore) || 0;
            const asn = parseFloat(asnScore) || 0;

            // 计算基础评分：(company + asn) / 2 * 5
            let baseScore = ((company + asn) / 2) * 5;

            // 计算安全风险附加分：每个安全风险项增加 15%
            let riskAddition = 0;
            const riskFlags = [
                securityFlags.is_crawler,   // 爬虫
                securityFlags.is_proxy,     // 代理服务器
                securityFlags.is_vpn,       // VPN
                securityFlags.is_tor,       // Tor 网络
                securityFlags.is_abuser     // 滥用 IP
            ];

            // 统计为 true 的风险项数量
            const riskCount = riskFlags.filter(flag => flag === true).length;
            riskAddition = riskCount * 0.15; // 每个风险项增加 15%

            // 最终评分 = 基础评分 + 风险附加分
            let finalScore = baseScore + riskAddition;

            // 如果是虚假IP (蜜罐)，则风险值增加100%
            if (securityFlags.is_bogon === true) {
                finalScore += 1.0; // 增加100%
            }

            // 如果基础评分和风险附加分都是0且不是虚假IP，返回null
            if (baseScore === 0 && riskAddition === 0 && securityFlags.is_bogon !== true) return null;

            return finalScore;
        }

        // 获取滥用评分的颜色等级
        function getAbuseScoreBadgeClass(percentage) {
            if (percentage === null || percentage === undefined) return 'badge-info';

            if (percentage >= 100) return 'badge-critical';      // 危险红色 >= 100%
            if (percentage >= 20) return 'badge-high';           // 橘黄色 15-99.99%
            if (percentage >= 5) return 'badge-elevated';     // 黄色 5-14.99%
            if (percentage >= 0.25) return 'badge-low';          // 淡绿色 0.25-4.99%
            return 'badge-verylow';                              // 绿色 < 0.25%
        }

        // 格式化滥用评分为百分比
        function formatAbuseScorePercentage(score) {
            if (score === null || score === undefined) return '未知';

            const percentage = score * 100;
            return percentage.toFixed(2) + '%';
        }

        // 切换评分算法说明气泡
        function toggleScoreTooltip(helpIcon) {
            const tooltip = helpIcon.nextElementSibling;
            const isShowing = tooltip.classList.contains('show');

            // 隐藏所有其他气泡
            document.querySelectorAll('.score-tooltip.show').forEach(t => {
                if (t !== tooltip) t.classList.remove('show');
            });

            // 切换当前气泡
            tooltip.classList.toggle('show');

            // 如果显示气泡，调整位置并添加点击事件监听器来关闭它
            if (!isShowing) {
                setTimeout(() => {
                    positionTooltipNearMouse(tooltip, helpIcon);

                    const closeTooltip = (e) => {
                        if (!tooltip.contains(e.target) && !helpIcon.contains(e.target)) {
                            tooltip.classList.remove('show');
                            document.removeEventListener('click', closeTooltip);
                        }
                    };
                    document.addEventListener('click', closeTooltip);
                }, 100);
            }
        }

        // 将气泡位置设置在鼠标附近
        function positionTooltipNearMouse(tooltip, helpIcon) {
            const iconRect = helpIcon.getBoundingClientRect();
            const tooltipWidth = tooltip.offsetWidth;
            const tooltipHeight = tooltip.offsetHeight;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const padding = 10;

            let left = iconRect.right + padding;
            let top = iconRect.top - tooltipHeight / 2;

            // 如果气泡超出右边界，显示在左边
            if (left + tooltipWidth > windowWidth - padding) {
                left = iconRect.left - tooltipWidth - padding;
            }

            // 如果气泡超出顶部，调整到下方
            if (top < padding) {
                top = iconRect.top + padding;
            }

            // 如果气泡超出底部，调整到上方
            if (top + tooltipHeight > windowHeight - padding) {
                top = windowHeight - tooltipHeight - padding;
            }

            tooltip.style.position = 'fixed';
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        // 显示 IP 详情弹窗
        function showIpDetailModal(data) {
            // 创建弹窗
            const modal = document.createElement('div');
            modal.className = 'ip-detail-modal';

            // 计算综合滥用评分（风控值）
            const companyScore = data.company?.abuser_score;
            const asnScore = data.asn?.abuser_score;

            // 收集安全风险标志
            const securityFlags = {
                is_crawler: data.is_crawler,
                is_proxy: data.is_proxy,
                is_vpn: data.is_vpn,
                is_tor: data.is_tor,
                is_abuser: data.is_abuser,
                is_bogon: data.is_bogon
            };

            const combinedScore = calculateAbuseScore(companyScore, asnScore, securityFlags);

            let riskControlHTML = '';
            if (combinedScore !== null) {
                const scorePercentage = combinedScore * 100;
                const badgeClass = getAbuseScoreBadgeClass(scorePercentage);
                const formattedScore = formatAbuseScorePercentage(combinedScore);

                // 根据百分比确定风险等级文本
                let riskLevel = '';
                if (scorePercentage >= 100) riskLevel = '极度危险';
                else if (scorePercentage >= 20) riskLevel = '高风险';
                else if (scorePercentage >= 5) riskLevel = '轻微风险';
                else if (scorePercentage >= 0.25) riskLevel = '纯净';
                else riskLevel = '极度纯净';

                riskControlHTML = `
                    <span class="ip-detail-badge ${badgeClass}">${formattedScore} ${riskLevel}</span>
                `;
            } else {
                riskControlHTML = '未知';
            }

            // 构建详情内容
            let detailHTML = `
                <div class="ip-detail-content">
                    <button class="ip-detail-close" onclick="this.closest('.ip-detail-modal').remove()">×</button>
                    <div class="ip-detail-title">
                        🔍 IP 详细信息
                        <span class="ip-detail-source">数据来源: ipapi.is</span>
                    </div>
            `;

            // 基本信息
            detailHTML += `
                <div class="ip-detail-section">
                    <div class="ip-detail-section-title">📍 基本信息</div>
                    <div class="ip-detail-item">
                        <span class="ip-detail-label">IP 地址</span>
                        <span class="ip-detail-value">${data.ip || '未知'}</span>
                    </div>
                    <div class="ip-detail-item">
                        <span class="ip-detail-label">区域互联网注册机构</span>
                        <span class="ip-detail-value">${data.rir || '未知'}</span>
                    </div>
                    <div class="ip-detail-item">
                        <span class="ip-detail-label">运营商 / ASN 类型</span>
                        <span class="ip-detail-value">${formatIpType(data.company?.type)} / ${formatIpType(data.asn?.type)}</span>
                    </div>
                    <div class="ip-detail-item">
                        <span class="ip-detail-label">
                            综合滥用评分
                            <span class="score-help-icon" onclick="event.stopPropagation(); toggleScoreTooltip(this);" title="点击查看算法说明">?</span>
                            <span class="score-tooltip">
                                <div class="tooltip-header">
                                    <span class="tooltip-title">📊 综合滥用评分算法</span>
                                </div>
                                <div class="tooltip-section">
                                    <p class="tooltip-section-title">评分公式</p>
                                    <div class="formula-item">
                                        <span class="formula-name">基础分</span>
                                        <span class="formula-equation"><code>(运营商分 + ASN分) / 2 * 5</code></span>
                                    </div>
                                    <div class="formula-item">
                                        <span class="formula-name">风险附加</span>
                                        <span class="formula-equation"><code>风险项数量 * 15%</code></span>
                                    </div>
                                </div>
                                <div class="tooltip-section">
                                    <p class="tooltip-section-title">安全风险项</p>
                                    <ul class="risk-list">
                                        <li>爬虫 (Crawler) - 15%</li>
                                        <li>代理 (Proxy) - 15%</li>
                                        <li>VPN - 15%</li>
                                        <li>Tor 网络 - 15%</li>
                                        <li>滥用IP (Abuser) - 15%</li>
                                        <li>虚假IP (Bogon) - <span style="color: #ef4444; font-weight: bold;">100% (蜜罐)</span></li>
                                    </ul>
                                </div>
                            </span>
                        </span>
                        <span class="ip-detail-value">${riskControlHTML}</span>
                    </div>
                </div>
            `;

            // 安全检测
            detailHTML += `
                <div class="ip-detail-section">
                    <div class="ip-detail-section-title">🛡️ 安全检测</div>
                    <div class="ip-detail-item">
                        <span class="ip-detail-label">移动网络</span>
                        <span class="ip-detail-value">${data.is_mobile ? '<span class="success-text">📱 是</span>' : '否'}</span>
                    </div>
                    <div class="ip-detail-item">
                        <span class="ip-detail-label">数据中心</span>
                        <span class="ip-detail-value">${data.is_datacenter ? '<span class="warning-text">🏢 是</span>' : '否'}</span>
                    </div>
                    <div class="ip-detail-item">
                        <span class="ip-detail-label">卫星网络</span>
                        <span class="ip-detail-value">${data.is_satellite ? '<span class="success-text">🛰️ 是</span>' : '否'}</span>
                    </div>
                    <div class="ip-detail-item">
                        <span class="ip-detail-label">爬虫</span>
                        <span class="ip-detail-value">${data.is_crawler ? '<span class="danger-text">🤖 是</span>' : '✅ 否'}</span>
                    </div>
                    <div class="ip-detail-item">
                        <span class="ip-detail-label">代理服务器</span>
                        <span class="ip-detail-value">${data.is_proxy ? '<span class="danger-text">⚠️ 是</span>' : '✅ 否'}</span>
                    </div>
                    <div class="ip-detail-item">
                        <span class="ip-detail-label">VPN</span>
                        <span class="ip-detail-value">${data.is_vpn ? '<span class="danger-text">⚠️ 是</span>' : '✅ 否'}</span>
                    </div>
                    <div class="ip-detail-item">
                        <span class="ip-detail-label">Tor 网络</span>
                        <span class="ip-detail-value">${data.is_tor ? '<span class="danger-text">⚠️ 是</span>' : '✅ 否'}</span>
                    </div>
                    <div class="ip-detail-item">
                        <span class="ip-detail-label">滥用 IP</span>
                        <span class="ip-detail-value">${data.is_abuser ? '<span class="danger-text">⚠️ 是</span>' : '✅ 否'}</span>
                    </div>
                    <div class="ip-detail-item">
                        <span class="ip-detail-label">虚假 IP</span>
                        <span class="ip-detail-value">${data.is_bogon ? '<span class="danger-text">⚠️ 是</span>' : '✅ 否'}</span>
                    </div>
                </div>
            `;

            // 位置信息
            if (data.location) {
                detailHTML += `
                    <div class="ip-detail-section">
                        <div class="ip-detail-section-title">🌍 位置信息</div>
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">国家</span>
                            <span class="ip-detail-value">${data.location.country || '未知'} (${data.location.country_code || '-'})</span>
                        </div>
                        ${data.location.state ? `
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">省份/州</span>
                            <span class="ip-detail-value">${data.location.state}</span>
                        </div>
                        ` : ''}
                        ${data.location.city ? `
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">城市</span>
                            <span class="ip-detail-value">${data.location.city}</span>
                        </div>
                        ` : ''}
                        ${data.location.zip ? `
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">邮编</span>
                            <span class="ip-detail-value">${data.location.zip}</span>
                        </div>
                        ` : ''}
                        ${data.location.latitude && data.location.longitude ? `
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">坐标</span>
                            <span class="ip-detail-value">${data.location.latitude}, ${data.location.longitude}</span>
                        </div>
                        ` : ''}
                        ${data.location.timezone ? `
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">时区</span>
                            <span class="ip-detail-value">${data.location.timezone}</span>
                        </div>
                        ` : ''}
                        ${data.location.local_time ? `
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">当地时间</span>
                            <span class="ip-detail-value">${data.location.local_time}</span>
                        </div>
                        ` : ''}
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">欧盟成员</span>
                            <span class="ip-detail-value">${boolToEmoji(data.location.is_eu_member, '🇪🇺 是', '否')}</span>
                        </div>
                    </div>
                `;
            }

            // 运营商信息
            if (data.company) {
                const abuserScore = data.company.abuser_score || '未知';
                const badgeClass = getThreatBadgeClass(abuserScore);

                detailHTML += `
                    <div class="ip-detail-section">
                        <div class="ip-detail-section-title">🏢 运营商信息</div>
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">运营商名称</span>
                            <span class="ip-detail-value">${data.company.name || '未知'}</span>
                        </div>
                        ${data.company.domain ? `
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">域名</span>
                            <span class="ip-detail-value">${data.company.domain}</span>
                        </div>
                        ` : ''}
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">类型</span>
                            <span class="ip-detail-value">${data.company.type || '未知'}</span>
                        </div>
                        ${data.company.network ? `
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">网络范围</span>
                            <span class="ip-detail-value">${data.company.network}</span>
                        </div>
                        ` : ''}
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">滥用评分</span>
                            <span class="ip-detail-value"><span class="ip-detail-badge ${badgeClass}">${abuserScore}</span></span>
                        </div>
                    </div>
                `;
            }

            // ASN 信息
            if (data.asn) {
                const asnAbuserScore = data.asn.abuser_score || '未知';
                const asnBadgeClass = getThreatBadgeClass(asnAbuserScore);

                detailHTML += `
                    <div class="ip-detail-section">
                        <div class="ip-detail-section-title">🔢 ASN 信息</div>
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">ASN 编号</span>
                            <span class="ip-detail-value">AS${data.asn.asn || '未知'}</span>
                        </div>
                        ${data.asn.org ? `
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">组织</span>
                            <span class="ip-detail-value">${data.asn.org}</span>
                        </div>
                        ` : ''}
                        ${data.asn.route ? `
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">路由</span>
                            <span class="ip-detail-value">${data.asn.route}</span>
                        </div>
                        ` : ''}
                        ${data.asn.type ? `
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">类型</span>
                            <span class="ip-detail-value">${data.asn.type}</span>
                        </div>
                        ` : ''}
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">滥用评分</span>
                            <span class="ip-detail-value"><span class="ip-detail-badge ${asnBadgeClass}">${asnAbuserScore}</span></span>
                        </div>
                        ${data.asn.country ? `
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">国家代码</span>
                            <span class="ip-detail-value">${data.asn.country.toUpperCase()}</span>
                        </div>
                        ` : ''}
                    </div>
                `;
            }

            // 滥用联系信息
            if (data.abuse) {
                detailHTML += `
                    <div class="ip-detail-section">
                        <div class="ip-detail-section-title">📧 滥用举报联系方式</div>
                        ${data.abuse.name ? `
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">联系人</span>
                            <span class="ip-detail-value">${data.abuse.name}</span>
                        </div>
                        ` : ''}
                        ${data.abuse.email ? `
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">邮箱</span>
                            <span class="ip-detail-value">${data.abuse.email}</span>
                        </div>
                        ` : ''}
                        ${data.abuse.phone ? `
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">电话</span>
                            <span class="ip-detail-value">${data.abuse.phone}</span>
                        </div>
                        ` : ''}
                        ${data.abuse.address ? `
                        <div class="ip-detail-item">
                            <span class="ip-detail-label">地址</span>
                            <span class="ip-detail-value">${data.abuse.address}</span>
                        </div>
                        ` : ''}
                    </div>
                `;
            }

            detailHTML += `</div>`;

            modal.innerHTML = detailHTML;

            // 点击背景关闭弹窗
            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            // ESC 键关闭弹窗和气泡
            const closeHandler = function (e) {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', closeHandler);
                }
            };
            document.addEventListener('keydown', closeHandler);

            document.body.appendChild(modal);
        }

        // ==================== 获取更多 PROXYIP 相关函数 ====================

        function showGetMoreProxyIPModal() {
            document.getElementById('getMoreProxyIPModal').classList.add('show');
            // 默认选中第一个非自定义选项 (HK) 并隐藏自定义输入
            const select = document.getElementById('proxyRegionSelect');
            // 查找 HK 选项并选中
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === 'HK') {
                    select.selectedIndex = i;
                    break;
                }
            }
            // 触发一次变更处理，确保UI状态正确
            onProxyRegionChange();
        }

        function closeGetMoreProxyIPModal() {
            document.getElementById('getMoreProxyIPModal').classList.remove('show');
        }

        function onProxyRegionChange() {
            const select = document.getElementById('proxyRegionSelect');
            const customInput = document.getElementById('customRegionInput');

            if (select.value === 'custom') {
                // 自定义模式：启用输入
                customInput.value = '';
                customInput.disabled = false;
                customInput.focus();
            } else {
                // 预选地区模式：禁用输入，自动填充地区代码
                customInput.value = select.value;
                customInput.disabled = true;
            }
        }

        function openFOFA() {
            const select = document.getElementById('proxyRegionSelect');
            const portSelect = document.getElementById('proxyPortSelect');
            let region = select.value;
            let port = portSelect.value;

            if (region === 'custom') {
                const customInput = document.getElementById('customRegionInput');
                region = customInput.value.trim().toUpperCase();
                if (!region || region.length !== 2) {
                    showToast('请输入有效的两位国家代码', 'error');
                    return;
                }
            }

            // 构建查询语句
            let query = '';
            // HK 和 TW 使用 region 字段，其他使用 country 字段
            let regionQuery = '';
            if (region === 'HK' || region === 'TW') {
                regionQuery = `region="${region}"`;
            } else {
                regionQuery = `country="${region}"`;
            }
            
            // 根据端口选择构建查询
            let portQuery = '';
            if (port === '443') {
                portQuery = `port="443"`;
            } else if (port === 'nonstandard') {
                portQuery = `(port!="80" && port!="8080" && port!="8880" && port!="2052" && port!="2082" && port!="2086" && port!="2095" && port!="443" && port!="2053" && port!="2083" && port!="2087" && port!="2096" && port!="8443")`;
            }
            
            query = `server=="cloudflare" && header="Forbidden" && asn!="13335" && asn!="209242" && ${regionQuery} && ${portQuery}`;

            // Base64 编码
            const qbase64 = btoa(query);

            // 构建 URL
            const url = `https://fofa.info/result?qbase64=${encodeURIComponent(qbase64)}`;

            // 打开新窗口
            window.open(url, '_blank');
        }

        function open360Quake() {
            const select = document.getElementById('proxyRegionSelect');
            const portSelect = document.getElementById('proxyPortSelect');
            let region = select.value;
            let port = portSelect.value;

            if (region === 'custom') {
                const customInput = document.getElementById('customRegionInput');
                region = customInput.value.trim().toUpperCase();
                if (!region || region.length !== 2) {
                    showToast('请输入有效的两位国家代码', 'error');
                    return;
                }
            }

            // 基础查询语句
            const baseQuery = `(app:"Cloudflare" AND header:"Forbidden" AND asn!=13335 AND asn!=209242 AND service: "http/ssl")`;
            let regionQuery = '';
            
            // HK 和 TW 使用 province 字段，其他使用 country 字段
            if (region === 'HK') {
                regionQuery = `province: "HongKong"`;
            } else if (region === 'TW') {
                regionQuery = `province: "TaiWan"`;
            }  else if (region === 'MO') {
                regionQuery = `province: "Macao"`;
            } else {
                regionQuery = `country: "${region}"`;
            }
            
            // 根据端口选择构建查询
            let portQuery = '';
            if (port === '443') {
                portQuery = `port: 443`;
            } else if (port === 'nonstandard') {
                portQuery = `NOT (port: 80 OR port: 8080 OR port: 8880 OR port: 2052 OR port: 2082 OR port: 2086 OR port: 2095 OR port: 443 OR port: 2053 OR port: 2083 OR port: 2087 OR port: 2096 OR port: 8443)`;
            }
            
            let query = `${baseQuery} AND ${regionQuery} AND ${portQuery}`;

            // URL 编码
            const searchVal = encodeURIComponent(query);
            const timestamp = Date.now();

            // 构建 URL
            const url = `https://quake.360.net/quake/#/searchResult?searchVal=${searchVal}&selectIndex=quake_service&ignore_cache=false&timeRange=&timeRange=&latest=true&t=${timestamp}`;

            // 打开新窗口
            window.open(url, '_blank');
        }

        // ==================== SOCKS5 相关函数 ====================
        
        // 存储SOCKS5数据
        let socks5ListData = [];
        let socks5CountryMap = {};
        let socks5VerificationStatus = {}; // 存储验证状态
        let socks5VerificationTimeouts = {}; // 存储超时计时器

        function showExploreSocks5Modal() {
            const modal = document.getElementById('exploreSocks5Modal');
            if (!modal) return;

            // 重置状态
            socks5ListData = [];
            socks5CountryMap = {};
            socks5VerificationStatus = {};
            socks5VerificationTimeouts = {};
            
            modal.classList.add('show');
            document.getElementById('socks5RegionSelect').innerHTML = '<option value="">加载中...</option>';
            document.getElementById('socks5ProxySelectGroup').style.display = 'none';
            document.getElementById('socks5LoadingInfo').style.display = 'none';
            document.getElementById('socks5ConfirmBtn').disabled = true;

            // 加载SOCKS5列表
            loadSocks5List();
        }

        function closeExploreSocks5Modal(event) {
            event.preventDefault();
            const modal = document.getElementById('exploreSocks5Modal');
            if (modal) {
                modal.classList.remove('show');
            }
            // 清除所有超时计时器
            for (let timeout of Object.values(socks5VerificationTimeouts)) {
                clearTimeout(timeout);
            }
        }

        function loadSocks5List() {
            const url = 'https://raw.githubusercontent.com/EDT-Pages/Proxy-List/main/data/socks5.json';
            
            fetchWithAutoMirror(url, 'SOCKS5列表')
                .then(text => {
                    const data = JSON.parse(text);
                    socks5ListData = data;
                    buildCountryMap();
                    populateSocks5RegionSelect();
                })
                .catch(error => {
                    console.error('加载SOCKS5列表失败:', error);
                    showToast('加载SOCKS5列表失败: ' + error.message, 'error');
                    document.getElementById('socks5RegionSelect').innerHTML = '<option value="">加载失败</option>';
                });
        }

        function buildCountryMap() {
            socks5CountryMap = {};
            
            // 统计每个国家的SOCKS5数量
            socks5ListData.forEach(item => {
                const country = item.country;
                if (!socks5CountryMap[country]) {
                    socks5CountryMap[country] = [];
                }
                socks5CountryMap[country].push(item);
            });

            // 按数量排序（多到少）
            socks5CountryMap = Object.fromEntries(
                Object.entries(socks5CountryMap).sort((a, b) => b[1].length - a[1].length)
            );
        }

        function populateSocks5RegionSelect() {
            const select = document.getElementById('socks5RegionSelect');
            let html = '<option value="">-- 请选择地区 --</option>';
            
            for (const [country, proxies] of Object.entries(socks5CountryMap)) {
                html += `<option value="${country}">${country}(${proxies.length})</option>`;
            }
            
            select.innerHTML = html;
        }

        function onSocks5RegionChange() {
            const selectedCountry = document.getElementById('socks5RegionSelect').value;
            
            if (!selectedCountry) {
                document.getElementById('socks5ProxySelectGroup').style.display = 'none';
                document.getElementById('socks5LoadingInfo').style.display = 'none';
                document.getElementById('socks5ConfirmBtn').disabled = true;
                return;
            }

            const proxies = socks5CountryMap[selectedCountry] || [];
            
            // 显示加载信息
            document.getElementById('socks5LoadingInfo').style.display = 'block';
            document.getElementById('socks5ProxySelectGroup').style.display = 'block';
            
            // 初始化每个代理的验证状态
            proxies.forEach(proxy => {
                if (!socks5VerificationStatus[proxy.proxy]) {
                    socks5VerificationStatus[proxy.proxy] = {
                        status: 'pending', // pending, success, failed, timeout
                        responseTime: null
                    };
                }
            });

            // 显示代理列表
            populateSocks5ProxySelect(selectedCountry);
            
            // 开始验证所有代理
            verifySocks5Proxies(proxies);
        }

        function populateSocks5ProxySelect(selectedCountry) {
            const select = document.getElementById('socks5ProxySelect');
            const proxies = socks5CountryMap[selectedCountry] || [];
            
            let html = '<option value="">-- 请选择 --</option>';
            
            // 获取当前地区的所有代理，并按状态和延迟排序
            const sortedProxies = [...proxies].sort((a, b) => {
                const statusA = socks5VerificationStatus[a.proxy];
                const statusB = socks5VerificationStatus[b.proxy];
                
                // 可用的在前面，且按延迟从低到高
                if (statusA.status === 'success' && statusB.status === 'success') {
                    return (statusA.responseTime || 0) - (statusB.responseTime || 0);
                }
                if (statusA.status === 'success') return -1;
                if (statusB.status === 'success') return 1;
                
                return 0;
            });
            
            sortedProxies.forEach(proxy => {
                const status = socks5VerificationStatus[proxy.proxy];
                let emoji = '⏳';
                let statusText = '验证中';
                
                if (status.status === 'success') {
                    emoji = '✅';
                    statusText = `${status.responseTime}ms`;
                } else if (status.status === 'timeout') {
                    emoji = '🔴';
                    statusText = '已超时';
                } else if (status.status === 'failed') {
                    emoji = '🔴';
                    statusText = '不可用';
                }
                
                const label = `${emoji}(${statusText}) ${proxy.city} AS${proxy.asn} ${proxy.asOrganization}`;
                const disabled = status.status !== 'success';
                html += `<option value="${proxy.proxy}" ${disabled ? 'disabled' : ''}>${label}</option>`;
            });
            
            select.innerHTML = html;
        }

        function verifySocks5Proxies(proxies) {
            // 并发控制：最多4个并发请求
            const maxConcurrent = 4;
            let currentIndex = 0;
            let activeRequests = 0;

            function startNextProxy() {
                if (currentIndex >= proxies.length || activeRequests >= maxConcurrent) {
                    return;
                }

                activeRequests++;
                const proxy = proxies[currentIndex++];
                
                verifySingleSocks5(proxy).finally(() => {
                    activeRequests--;
                    startNextProxy();
                });
            }

            // 启动初始4个请求
            for (let i = 0; i < Math.min(maxConcurrent, proxies.length); i++) {
                startNextProxy();
            }
        }

        function verifySingleSocks5(proxy) {
            return new Promise((resolve) => {
                const { protocol, proxy: proxyUrl } = proxy;
                const cleanProxy = proxyUrl.replace(protocol + '://', '');
                const checkUrl = `./admin/check?${protocol}=${encodeURIComponent(cleanProxy)}&_t=${Date.now()}`;
                
                // 设置15秒超时
                const timeoutId = setTimeout(() => {
                    socks5VerificationStatus[proxyUrl] = {
                        status: 'timeout',
                        responseTime: null
                    };
                    updateSocks5Display();
                    resolve();
                }, 15000);
                
                socks5VerificationTimeouts[proxyUrl] = timeoutId;
                
                fetch(checkUrl)
                    .then(response => response.json())
                    .then(data => {
                        clearTimeout(timeoutId);
                        delete socks5VerificationTimeouts[proxyUrl];
                        
                        if (data.success) {
                            socks5VerificationStatus[proxyUrl] = {
                                status: 'success',
                                responseTime: data.responseTime
                            };
                        } else {
                            socks5VerificationStatus[proxyUrl] = {
                                status: 'failed',
                                responseTime: null
                            };
                        }
                        updateSocks5Display();
                        resolve();
                    })
                    .catch(error => {
                        clearTimeout(timeoutId);
                        delete socks5VerificationTimeouts[proxyUrl];
                        
                        socks5VerificationStatus[proxyUrl] = {
                            status: 'failed',
                            responseTime: null
                        };
                        updateSocks5Display();
                        resolve();
                    });
            });
        }

        function updateSocks5Display() {
            const selectedCountry = document.getElementById('socks5RegionSelect').value;
            if (selectedCountry) {
                populateSocks5ProxySelect(selectedCountry);
            }
            
            // 检查是否所有代理都验证完成
            const proxies = socks5CountryMap[selectedCountry] || [];
            const allVerified = proxies.every(p => {
                const status = socks5VerificationStatus[p.proxy];
                return status && status.status !== 'pending';
            });
            
            if (allVerified) {
                document.getElementById('socks5LoadingInfo').style.display = 'none';
            }
            
            // 更新确定按钮状态
            const select = document.getElementById('socks5ProxySelect');
            const selectedValue = select.value;
            const isValidSelected = selectedValue && 
                socks5VerificationStatus[selectedValue] &&
                socks5VerificationStatus[selectedValue].status === 'success';
            document.getElementById('socks5ConfirmBtn').disabled = !isValidSelected;
        }

        function confirmSelectSocks5() {
            const select = document.getElementById('socks5ProxySelect');
            const selectedProxy = select.value;
            
            if (!selectedProxy) {
                showToast('请选择一个有效的SOCKS5代理', 'error');
                return;
            }
            
            // 填入SOCKS5地址
            const socks5Input = document.getElementById('socks5Addr');
            if (socks5Input) {
                socks5Input.value = selectedProxy;
                socks5Input.dispatchEvent(new Event('change', { bubbles: true }));
                markModified('proxy');
            }
            
            // 关闭模态框
            closeExploreSocks5Modal({ preventDefault: () => {} });
            
            // 亮起保存和取消按钮
            const saveBtn = document.getElementById('saveProxyBtn');
            const cancelBtn = document.getElementById('cancelProxyBtn');
            if (saveBtn) saveBtn.disabled = false;
            if (cancelBtn) cancelBtn.disabled = false;
        }

        function updateSocks5ConfirmButton() {
            const select = document.getElementById('socks5ProxySelect');
            const selectedValue = select.value;
            const confirmBtn = document.getElementById('socks5ConfirmBtn');
            
            // 检查选中的代理是否可用
            const isValidSelected = selectedValue && 
                socks5VerificationStatus[selectedValue] &&
                socks5VerificationStatus[selectedValue].status === 'success';
            
            if (confirmBtn) {
                confirmBtn.disabled = !isValidSelected;
            }
        }

        // ==================== HTTP 相关函数 ====================
        
        // 存储HTTP数据
        let httpListData = [];
        let httpCountryMap = {};
        let httpVerificationStatus = {}; // 存储验证状态
        let httpVerificationTimeouts = {}; // 存储超时计时器

        function showExploreHTTPModal() {
            const modal = document.getElementById('exploreHTTPModal');
            if (!modal) return;

            // 重置状态
            httpListData = [];
            httpCountryMap = {};
            httpVerificationStatus = {};
            httpVerificationTimeouts = {};
            
            modal.classList.add('show');
            document.getElementById('httpRegionSelect').innerHTML = '<option value="">加载中...</option>';
            document.getElementById('httpProxySelectGroup').style.display = 'none';
            document.getElementById('httpLoadingInfo').style.display = 'none';
            document.getElementById('httpConfirmBtn').disabled = true;

            // 加载HTTP列表
            loadHTTPList();
        }

        function closeExploreHTTPModal(event) {
            event.preventDefault();
            const modal = document.getElementById('exploreHTTPModal');
            if (modal) {
                modal.classList.remove('show');
            }
            // 清除所有超时计时器
            for (let timeout of Object.values(httpVerificationTimeouts)) {
                clearTimeout(timeout);
            }
        }

        function loadHTTPList() {
            const url = 'https://raw.githubusercontent.com/EDT-Pages/Proxy-List/main/data/http.json';
            
            fetchWithAutoMirror(url, 'HTTP列表')
                .then(text => {
                    const data = JSON.parse(text);
                    httpListData = data;
                    buildHTTPCountryMap();
                    populateHTTPRegionSelect();
                })
                .catch(error => {
                    console.error('加载HTTP列表失败:', error);
                    showToast('加载HTTP列表失败: ' + error.message, 'error');
                    document.getElementById('httpRegionSelect').innerHTML = '<option value="">加载失败</option>';
                });
        }

        function buildHTTPCountryMap() {
            httpCountryMap = {};
            
            // 统计每个国家的HTTP数量
            httpListData.forEach(item => {
                const country = item.country;
                if (!httpCountryMap[country]) {
                    httpCountryMap[country] = [];
                }
                httpCountryMap[country].push(item);
            });

            // 按数量排序（多到少）
            httpCountryMap = Object.fromEntries(
                Object.entries(httpCountryMap).sort((a, b) => b[1].length - a[1].length)
            );
        }

        function populateHTTPRegionSelect() {
            const select = document.getElementById('httpRegionSelect');
            let html = '<option value="">-- 请选择地区 --</option>';
            
            for (const [country, proxies] of Object.entries(httpCountryMap)) {
                html += `<option value="${country}">${country}(${proxies.length})</option>`;
            }
            
            select.innerHTML = html;
        }

        function onHTTPRegionChange() {
            const selectedCountry = document.getElementById('httpRegionSelect').value;
            
            if (!selectedCountry) {
                document.getElementById('httpProxySelectGroup').style.display = 'none';
                document.getElementById('httpLoadingInfo').style.display = 'none';
                document.getElementById('httpConfirmBtn').disabled = true;
                return;
            }

            const proxies = httpCountryMap[selectedCountry] || [];
            
            // 显示加载信息
            document.getElementById('httpLoadingInfo').style.display = 'block';
            document.getElementById('httpProxySelectGroup').style.display = 'block';
            
            // 初始化每个代理的验证状态
            proxies.forEach(proxy => {
                if (!httpVerificationStatus[proxy.proxy]) {
                    httpVerificationStatus[proxy.proxy] = {
                        status: 'pending', // pending, success, failed, timeout
                        responseTime: null
                    };
                }
            });

            // 显示代理列表
            populateHTTPProxySelect(selectedCountry);
            
            // 开始验证所有代理
            verifyHTTPProxies(proxies);
        }

        function populateHTTPProxySelect(selectedCountry) {
            const select = document.getElementById('httpProxySelect');
            const proxies = httpCountryMap[selectedCountry] || [];
            
            let html = '<option value="">-- 请选择 --</option>';
            
            // 获取当前地区的所有代理，并按状态和延迟排序
            const sortedProxies = [...proxies].sort((a, b) => {
                const statusA = httpVerificationStatus[a.proxy];
                const statusB = httpVerificationStatus[b.proxy];
                
                // 可用的在前面，且按延迟从低到高
                if (statusA.status === 'success' && statusB.status === 'success') {
                    return (statusA.responseTime || 0) - (statusB.responseTime || 0);
                }
                if (statusA.status === 'success') return -1;
                if (statusB.status === 'success') return 1;
                
                return 0;
            });
            
            sortedProxies.forEach(proxy => {
                const status = httpVerificationStatus[proxy.proxy];
                let emoji = '⏳';
                let statusText = '验证中';
                
                if (status.status === 'success') {
                    emoji = '✅';
                    statusText = `${status.responseTime}ms`;
                } else if (status.status === 'timeout') {
                    emoji = '🔴';
                    statusText = '已超时';
                } else if (status.status === 'failed') {
                    emoji = '🔴';
                    statusText = '不可用';
                }
                
                const label = `${emoji}(${statusText}) ${proxy.city} AS${proxy.asn} ${proxy.asOrganization}`;
                const disabled = status.status !== 'success';
                html += `<option value="${proxy.proxy}" ${disabled ? 'disabled' : ''}>${label}</option>`;
            });
            
            select.innerHTML = html;
        }

        function verifyHTTPProxies(proxies) {
            // 并发控制：最多4个并发请求
            const maxConcurrent = 4;
            let currentIndex = 0;
            let activeRequests = 0;

            function startNextProxy() {
                if (currentIndex >= proxies.length || activeRequests >= maxConcurrent) {
                    return;
                }

                activeRequests++;
                const proxy = proxies[currentIndex++];
                
                verifySingleHTTP(proxy).finally(() => {
                    activeRequests--;
                    startNextProxy();
                });
            }

            // 启动初始4个请求
            for (let i = 0; i < Math.min(maxConcurrent, proxies.length); i++) {
                startNextProxy();
            }
        }

        function verifySingleHTTP(proxy) {
            return new Promise((resolve) => {
                const { protocol, proxy: proxyUrl } = proxy;
                const cleanProxy = proxyUrl.replace(protocol + '://', '');
                const checkUrl = `./admin/check?${protocol}=${encodeURIComponent(cleanProxy)}&_t=${Date.now()}`;
                
                // 设置15秒超时
                const timeoutId = setTimeout(() => {
                    httpVerificationStatus[proxyUrl] = {
                        status: 'timeout',
                        responseTime: null
                    };
                    updateHTTPDisplay();
                    resolve();
                }, 15000);
                
                httpVerificationTimeouts[proxyUrl] = timeoutId;
                
                fetch(checkUrl)
                    .then(response => response.json())
                    .then(data => {
                        clearTimeout(timeoutId);
                        delete httpVerificationTimeouts[proxyUrl];
                        
                        if (data.success) {
                            httpVerificationStatus[proxyUrl] = {
                                status: 'success',
                                responseTime: data.responseTime
                            };
                        } else {
                            httpVerificationStatus[proxyUrl] = {
                                status: 'failed',
                                responseTime: null
                            };
                        }
                        updateHTTPDisplay();
                        resolve();
                    })
                    .catch(error => {
                        clearTimeout(timeoutId);
                        delete httpVerificationTimeouts[proxyUrl];
                        
                        httpVerificationStatus[proxyUrl] = {
                            status: 'failed',
                            responseTime: null
                        };
                        updateHTTPDisplay();
                        resolve();
                    });
            });
        }

        function updateHTTPDisplay() {
            const selectedCountry = document.getElementById('httpRegionSelect').value;
            if (selectedCountry) {
                populateHTTPProxySelect(selectedCountry);
            }
            
            // 检查是否所有代理都验证完成
            const proxies = httpCountryMap[selectedCountry] || [];
            const allVerified = proxies.every(p => {
                const status = httpVerificationStatus[p.proxy];
                return status && status.status !== 'pending';
            });
            
            if (allVerified) {
                document.getElementById('httpLoadingInfo').style.display = 'none';
            }
            
            // 更新确定按钮状态
            const select = document.getElementById('httpProxySelect');
            const selectedValue = select.value;
            const isValidSelected = selectedValue && 
                httpVerificationStatus[selectedValue] &&
                httpVerificationStatus[selectedValue].status === 'success';
            document.getElementById('httpConfirmBtn').disabled = !isValidSelected;
        }

        function confirmSelectHTTP() {
            const select = document.getElementById('httpProxySelect');
            const selectedProxy = select.value;
            
            if (!selectedProxy) {
                showToast('请选择一个有效的HTTP代理', 'error');
                return;
            }
            
            // 填入HTTP地址
            const httpInput = document.getElementById('httpAddr');
            if (httpInput) {
                httpInput.value = selectedProxy;
                httpInput.dispatchEvent(new Event('change', { bubbles: true }));
                markModified('proxy');
            }
            
            // 关闭模态框
            closeExploreHTTPModal({ preventDefault: () => {} });
            
            // 亮起保存和取消按钮
            const saveBtn = document.getElementById('saveProxyBtn');
            const cancelBtn = document.getElementById('cancelProxyBtn');
            if (saveBtn) saveBtn.disabled = false;
            if (cancelBtn) cancelBtn.disabled = false;
        }

        function updateHTTPConfirmButton() {
            const select = document.getElementById('httpProxySelect');
            const selectedValue = select.value;
            const confirmBtn = document.getElementById('httpConfirmBtn');
            
            // 检查选中的代理是否可用
            const isValidSelected = selectedValue && 
                httpVerificationStatus[selectedValue] &&
                httpVerificationStatus[selectedValue].status === 'success';
            
            if (confirmBtn) {
                confirmBtn.disabled = !isValidSelected;
            }
        }

        // ============ HOSTS 检查相关函数 ============

        // 检查当前访问域名是否在 HOSTS 数组中
        function checkHostsMismatch() {
            const currentHostname = window.location.hostname;
            const hosts = currentConfig.HOSTS || [];
            
            // 检查当前 hostname 是否存在于 HOSTS 数组中
            const isHostInArray = hosts.some(host => {
                // 移除端口号后进行比较
                const hostWithoutPort = host.split(':')[0];
                return hostWithoutPort === currentHostname;
            });

            if (!isHostInArray && hosts.length > 0) {
                // 检查缓存，是否在 24 小时内已提示过
                if (shouldShowHostsMismatchNotification()) {
                    showHostsMismatchNotification(currentHostname, hosts);
                }
            }
        }

        // 检查是否应该显示 HOSTS 不匹配提示
        function shouldShowHostsMismatchNotification() {
            const cacheKey = 'hostsMismatchNotificationTime';
            const cachedTime = localStorage.getItem(cacheKey);
            
            if (!cachedTime) {
                // 没有缓存，应该显示
                return true;
            }

            const lastNotificationTime = parseInt(cachedTime, 10);
            const currentTime = Date.now();
            const twentyFourHours = 24 * 60 * 60 * 1000; // 24 小时毫秒数

            // 检查是否超过 24 小时
            return (currentTime - lastNotificationTime) > twentyFourHours;
        }

        // 显示 HOSTS 不匹配提示
        function showHostsMismatchNotification(currentHostname, hosts) {
            // 填充模态框中的内容
            const currentHostnameEl = document.getElementById('currentHostname');
            const hostToAddEl = document.getElementById('hostToAdd');
            const currentHostsEl = document.getElementById('currentHosts');
            
            if (currentHostnameEl) {
                currentHostnameEl.textContent = currentHostname;
            }
            if (hostToAddEl) {
                hostToAddEl.textContent = currentHostname;
            }
            
            // 填充当前 HOSTS 列表 - 用 HTML badge 而不是纯文本
            if (currentHostsEl) {
                // 清空并用 HTML 结构重新填充
                currentHostsEl.innerHTML = '';
                
                hosts.forEach((host) => {
                    const badge = document.createElement('span');
                    badge.className = 'hosts-badge';
                    badge.textContent = host;
                    currentHostsEl.appendChild(badge);
                });
            }
            
            // 显示模态框
            const overlay = document.getElementById('hostsMismatchModal');
            if (overlay) {
                const modal = overlay.querySelector('.modal');
                overlay.classList.add('show');
                console.log('✓ 域名不匹配提示已显示');
            } else {
                console.error('✗ 无法找到 hostsMismatchModal 元素');
            }
        }

        // 关闭 HOSTS 不匹配提示模态框
        function closeHostsMismatchModal(event) {
            // 如果有事件对象且点击的不是 overlay 本身，则返回
            if (event && event.target && event.target.id !== 'hostsMismatchModal') {
                return;
            }
            
            const overlay = document.getElementById('hostsMismatchModal');
            if (overlay) {
                overlay.classList.remove('show');
            }
        }

        // 处理"知道了！24小时内不提示"按钮
        function dismissHostsMismatchNotification() {
            const cacheKey = 'hostsMismatchNotificationTime';
            const currentTime = Date.now();
            
            // 将当前时间戳保存到 localStorage
            localStorage.setItem(cacheKey, currentTime.toString());
            
            // 关闭模态框
            closeHostsMismatchModal({ target: { id: 'hostsMismatchModal' } });
            
            // 显示确认提示
            showToast('24小时内不会再提示', 'info');
        }

    </script>
</body>

</html>