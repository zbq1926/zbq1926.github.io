<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="robots" content="noindex, nofollow">
<title>管理后台</title>
<script src="https://cdn.jsdelivr.net/npm/@keeex/qrcodejs-kx@1.0.2/qrcode.min.js"></script>
<style>     
/* 基础重置 */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box
}

body {
    font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
    overflow: hidden
}

/* 通用动画 */
@keyframes blurOverlayAppear {
    0% {
        opacity: 0;
        backdrop-filter: blur(0px);
        -webkit-backdrop-filter: blur(0px)
    }
    100% {
        opacity: 1;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px)
    }
}

@keyframes containerAppear {
    0% {
        opacity: 0;
        transform: translateY(30px) scale(0.9)
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1)
    }
}

@keyframes fadeIn {
    from {
        opacity: 0
    }
    to {
        opacity: 1
    }
}

@keyframes shake {
    0%,100% {
        transform: translateX(0)
    }
    10%,30%,50%,70%,90% {
        transform: translateX(-5px)
    }
    20%,40%,60%,80% {
        transform: translateX(5px)
    }
}

@keyframes gradientShift {
    0% {
        background-position: 0 50%
    }
    50% {
        background-position: 100% 50%
    }
    100% {
        background-position: 0 50%
    }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px)
    }
    to {
        opacity: 1;
        transform: translateY(0)
    }
}

@keyframes rotate {
    from {
        transform: rotate(0deg)
    }
    to {
        transform: rotate(360deg)
    }
}

/* 背景和遮罩层 */
#background-iframe {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 0;
    z-index: -3!important
}

#blur-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg,rgba(102,126,234,0.1) 0,rgba(118,75,162,0.15) 100%);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    z-index: -2!important;
    animation: blurOverlayAppear 1.5s ease-out forwards .3s;
    pointer-events: none;
    opacity: 0
}

/* 通用容器包装器 */
.page-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1!important;
    padding: 20px;
    overflow-y: auto
}

/* 通用卡片容器 */
.card-container {
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 50px 40px;
    border-radius: 24px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3),0 0 0 1px rgba(255,255,255,0.1) inset;
    width: 100%;
    animation: containerAppear 1s ease-out .8s backwards;
    position: relative;
    overflow: hidden
}

.card-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg,#faab41 0,#f6821f 50%,#faab41 100%);
    background-size: 200% 100%;
    animation: gradientShift 3s ease infinite
}

/* 页面标题和图标 */
.page-header {
    margin-bottom: 35px;
    text-align: center
}

.page-icon {
    width: 70px;
    height: 70px;
    margin: 0 auto 20px;
    background: linear-gradient(135deg,#faab41 0,#f6821f 100%);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 30px rgba(102,126,234,0.4);
    animation: fadeIn .8s ease-out 1s backwards
}

.page-icon svg {
    width: 36px;
    height: 36px;
    fill: white
}

.page-title {
    font-size: 32px;
    font-weight: 700;
    background: linear-gradient(135deg,#faab41 0,#f6821f 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 0 0 12px;
    line-height: 1.2;
    letter-spacing: -0.5px
}

.page-subtitle {
    font-size: 16px;
    color: #6b7280;
    margin: 0;
    line-height: 1.5;
    font-weight: 400
}

/* 表单样式 */
.page-form {
    display: flex;
    flex-direction: column;
    margin-top: 35px
}

.form-group {
    margin-bottom: 24px;
    text-align: left;
    position: relative
}

.form-group label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    letter-spacing: .3px
}

.input-wrapper {
    position: relative
}

.input-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    opacity: .4;
    pointer-events: none;
    transition: opacity .3s ease
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 16px;
    border: 2px solid #e5e7eb!important;
    border-radius: 12px;
    font-size: 16px;
    color: #1f2937!important;
    background-color: #fff!important;
    box-sizing: border-box;
    transition: all .3s ease;
    -webkit-appearance: none;
    font-family: inherit
}

.form-group input.with-icon {
    padding-left: 48px
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: 0!important;
    border-color: #faab41!important;
    box-shadow: 0 0 0 4px rgba(250,171,65,0.1)!important
}

.form-group input:focus+.input-icon {
    opacity: .7
}

.form-group input:disabled,
.form-group select:disabled {
    background-color: #f3f4f6!important;
    color: #9ca3af!important;
    cursor: not-allowed;
    opacity: 1
}

.form-group input[readonly] {
    background-color: #f9fafb!important;
    color: #6b7280!important
}

.form-group textarea {
    resize: vertical;
    min-height: 120px;
    font-family: 'Monaco','Courier New',monospace
}

/* 按钮样式 */
.btn {
    padding: 16px 20px;
    border: 0;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all .3s ease;
    box-sizing: border-box;
    -webkit-appearance: none;
    letter-spacing: .5px;
    position: relative;
    overflow: hidden
}

.btn-primary {
    background: linear-gradient(135deg,#faab41 0,#f6821f 100%);
    color: #fff;
    box-shadow: 0 4px 15px rgba(102,126,234,0.4)
}

.btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);
    transition: left .5s ease
}

.btn-primary:hover::before {
    left: 100%
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(102,126,234,0.5)
}

.btn-primary:active {
    transform: translateY(0);
    box-shadow: 0 2px 10px rgba(102,126,234,0.4)
}

.btn-secondary {
    background: #e5e7eb;
    color: #374151
}

.btn-secondary:hover {
    background: #d1d5db
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none
}

.btn-group {
    display: flex;
    gap: 10px
}

/* 页脚提示 */
.footer-hint {
    margin-top: 30px;
    font-size: 13px;
    color: #9ca3af;
    animation: fadeIn 1s ease-out 1.5s backwards;
    text-align: center
}

.footer-hint a {
    color: #faab41;
    text-decoration: none;
    font-weight: 500;
    transition: color .3s ease
}

.footer-hint a:hover {
    color: #f6821f
}

/* Toast 通知 */
.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: #fff;
    font-size: 14px;
    font-weight: 500;
    z-index: 10000000;
    transform: translateX(100%);
    transition: transform 0.3s ease,opacity 0.3s ease;
    opacity: 0;
    max-width: 300px;
    word-wrap: break-word
}

.toast.show {
    transform: translateX(0);
    opacity: 1
}

.toast-success {
    background: linear-gradient(135deg,#10b981 0,#059669 100%);
    box-shadow: 0 4px 15px rgba(16,185,129,0.3)
}

.toast-error {
    background: linear-gradient(135deg,#ef4444 0,#dc2626 100%);
    box-shadow: 0 4px 15px rgba(239,68,68,0.3)
}

.toast-info {
    background: linear-gradient(135deg,#3b82f6 0,#1d4ed8 100%);
    box-shadow: 0 4px 15px rgba(59,130,246,0.3)
}

/* 消息提示 */
.message {
    margin-top: 24px;
    font-size: 14px;
    line-height: 1.5;
    padding: 14px 18px;
    border-radius: 12px;
    font-weight: 500;
    animation: slideIn .3s ease-out
}

.message-success {
    background: linear-gradient(135deg,#10b981 0,#059669 100%);
    color: #fff;
    box-shadow: 0 4px 15px rgba(16,185,129,0.3)
}

.message-error {
    background: linear-gradient(135deg,#ef4444 0,#dc2626 100%);
    color: #fff;
    box-shadow: 0 4px 15px rgba(239,68,68,0.3);
    animation: shake .5s ease-in-out,slideIn .3s ease-out
}

/* 模态框 */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 2000000000;
    justify-content: center;
    align-items: center
}

.modal-overlay.show {
    display: flex
}

.modal {
    background: #fff;
    border-radius: 16px;
    padding: 30px;
    max-width: 500px;
    width: 95%;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    text-align: center;
    z-index: 2000000001;
    position: relative
}

.modal-close {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #9ca3af
}

.modal-close:hover {
    color: #1f2937
}

/* 社交链接 */
.social-links {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 15px;
    padding: 10px 0;
    border-top: 1px solid rgba(255,255,255,0.1)
}

.social-text {
    font-size: 14px;
    color: #666;
    margin-right: 10px
}

.social-link {
    display: inline-block;
    background: none;
    border: none;
    color: #666;
    text-decoration: none;
    cursor: pointer;
    transition: color 0.3s ease;
    border-radius: 8px;
    padding: 6px;
    border: 1px solid transparent
}

.social-link:hover {
    color: #faab41;
    border-color: #faab41;
    transform: translateY(-2px)
}

.social-link svg {
    width: 20px;
    height: 20px
}

/* 复选框样式 */
.checkbox-group {
    display: flex;
    align-items: center;
    gap: 10px
}

.checkbox-group input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    padding: 0;
    border: 2px solid #e5e7eb;
    border-radius: 4px;
    appearance: none;
    -webkit-appearance: none;
    position: relative;
    transition: all 0.3s ease;
    background-color: #fff
}

.checkbox-group input[type="checkbox"]:hover {
    border-color: #faab41
}

.checkbox-group input[type="checkbox"]:checked {
    background: linear-gradient(135deg, #faab41 0, #f6821f 100%);
    border-color: #faab41
}

.checkbox-group input[type="checkbox"]:checked::after {
    content: '';
    position: absolute;
    left: 5px;
    top: 2px;
    width: 4px;
    height: 8px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg)
}

.checkbox-group input[type="checkbox"]:disabled {
    background-color: #f3f4f6;
    border-color: #d1d5db;
    cursor: not-allowed;
    opacity: 0.6;
}

.checkbox-group input[type="checkbox"]:disabled:hover {
    border-color: #d1d5db;
}

.checkbox-label {
    font-size: 14px;
    color: #374151;
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none
}

/* 响应式设计 - 平板 */
@media(max-width:768px) {
    .page-wrapper {
        padding: 20px 16px;
        padding-top: 20px;
        padding-bottom: 20px;
        justify-content: flex-start;
        align-items: center
    }

    .card-container {
        padding: 40px 28px;
        border-radius: 20px;
        max-width: 100%;
        margin-top: auto;
        margin-bottom: auto
    }

    .page-icon {
        width: 60px;
        height: 60px;
        border-radius: 16px;
        margin-bottom: 16px
    }

    .page-icon svg {
        width: 30px;
        height: 30px
    }

    .page-title {
        font-size: 26px;
        margin-bottom: 10px
    }

    .page-subtitle {
        font-size: 15px
    }

    .page-form {
        margin-top: 28px
    }

    .form-group {
        margin-bottom: 20px
    }

    .form-group label {
        font-size: 13px;
        margin-bottom: 8px
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        padding: 14px;
        font-size: 16px;
        border-radius: 10px
    }

    .form-group input.with-icon {
        padding-left: 44px
    }

    .input-icon {
        left: 14px;
        width: 18px;
        height: 18px
    }

    .btn {
        padding: 15px 20px;
        font-size: 15px;
        border-radius: 10px
    }

    .message {
        margin-top: 20px;
        font-size: 13px;
        padding: 12px 16px;
        border-radius: 10px
    }

    .footer-hint {
        margin-top: 24px;
        font-size: 12px
    }
}

/* 响应式设计 - 手机 */
@media(max-width:480px) {
    .page-wrapper {
        padding: 12px;
        justify-content: flex-start;
        align-items: center
    }

    .card-container {
        padding: 35px 24px;
        border-radius: 18px;
        margin-top: auto;
        margin-bottom: auto
    }

    .page-icon {
        width: 55px;
        height: 55px;
        border-radius: 14px
    }

    .page-icon svg {
        width: 28px;
        height: 28px
    }

    .page-title {
        font-size: 24px
    }

    .page-subtitle {
        font-size: 14px
    }
}

/* 响应式设计 - 横屏 */
@media(max-height:600px) and (orientation:landscape) {
    .page-wrapper {
        padding: 20px;
        justify-content: flex-start;
        align-items: center
    }

    .card-container {
        padding: 30px 35px;
        margin-top: auto;
        margin-bottom: auto
    }

    .page-icon {
        width: 50px;
        height: 50px;
        margin-bottom: 12px
    }

    .page-icon svg {
        width: 26px;
        height: 26px
    }

    .page-title {
        font-size: 22px;
        margin-bottom: 8px
    }

    .page-subtitle {
        font-size: 13px
    }

    .page-form {
        margin-top: 20px
    }

    .form-group {
        margin-bottom: 16px
    }

    .footer-hint {
        margin-top: 16px
    }
}

/* 夜间模式 */
:root {
    --bg-primary: #ffffff;
    --bg-secondary: rgba(255,255,255,0.95);
    --text-primary: #1f2937;
    --text-secondary: #666;
    --border-color: #e5e7eb;
    --border-light: rgba(255,255,255,0.1);
    --input-bg: #f3f4f6;
    --input-border: #e5e7eb;
    --overlay-bg: rgba(255,255,255,0.7);
    --blur-overlay: rgba(0,0,0,0.3)
}

html.dark-mode {
    --bg-primary: #1a1a1a;
    --bg-secondary: #0f0d0a;
    --text-primary: #e5e5e5;
    --text-secondary: #a0a0a0;
    --border-color: #333333;
    --border-light: rgba(255,255,255,0.1);
    --input-bg: #2a2a2a;
    --input-border: #444444;
    --overlay-bg: rgba(32,32,32,0.7);
    --blur-overlay: rgba(0,0,0,0.5)
}

html.dark-mode body {
    background: linear-gradient(135deg,#1a1a1a 0,#2a2a2a 50%,#1a1a1a 100%)!important;
    color: var(--text-primary)
}

html.dark-mode #blur-overlay {
    background: var(--blur-overlay)
}

html.dark-mode .card-container {
    color: var(--text-primary)
}

html.dark-mode .page-wrapper {
    background: transparent
}

html.dark-mode .header {
    background: rgba(39, 39, 39, 0.95);
    border-image: linear-gradient(90deg,#7c3aed 0,#5b21b6 50%,#7c3aed 100%) 1
}

html.dark-mode .module {
    background: rgba(39, 39, 39, 0.95);
    color: var(--text-primary)
}

html.dark-mode .module-title {
    color: var(--text-primary)
}

html.dark-mode .form-group input:not([type="checkbox"]),
html.dark-mode .form-group select,
html.dark-mode .form-group textarea {
    background: var(--input-bg)!important;
    color: var(--text-primary)!important;
    border-color: var(--input-border)!important
}

html.dark-mode .form-group input:not([type="checkbox"])::placeholder,
html.dark-mode .form-group textarea::placeholder {
    color: var(--text-secondary)!important
}

html.dark-mode .form-group input:not([type="checkbox"]):focus,
html.dark-mode .form-group select:focus,
html.dark-mode .form-group textarea:focus {
    border-color: #7c3aed!important;
    box-shadow: 0 0 0 4px rgba(124,58,237,0.1)!important
}

html.dark-mode .form-group input:not([type="checkbox"]):disabled,
html.dark-mode .form-group select:disabled {
    background-color: var(--input-bg)!important;
    color: var(--text-secondary)!important
}

html.dark-mode .form-group input:not([type="checkbox"])[readonly] {
    background-color: var(--input-bg)!important;
    color: var(--text-secondary)!important
}

html.dark-mode .module .form-group input,
html.dark-mode .module .form-group select,
html.dark-mode .module .form-group textarea {
    background: var(--input-bg);
    color: var(--text-primary);
    border-color: var(--input-border)
}

html.dark-mode .module .form-group input::placeholder,
html.dark-mode .module .form-group textarea::placeholder {
    color: var(--text-secondary)
}

html.dark-mode .modal-overlay {
    background: var(--blur-overlay)
}

html.dark-mode .modal {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border-color: var(--border-color)
}

html.dark-mode .modal input,
html.dark-mode .modal select,
html.dark-mode .modal textarea {
    background: var(--input-bg);
    color: var(--text-primary);
    border-color: var(--input-border)
}

html.dark-mode .form-group label {
    color: var(--text-primary)!important
}

html.dark-mode .card-container {
    color: var(--text-primary);
}

html.dark-mode .modal-close {
    color: var(--text-primary)
}

html.dark-mode .page-header {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border-image: linear-gradient(90deg,#7c3aed 0,#5b21b6 50%,#7c3aed 100%) 1!important
}

html.dark-mode .page-title {
    color: var(--text-primary)!important
}

html.dark-mode .page-subtitle {
    color: var(--text-secondary)!important
}

html.dark-mode table {
    color: var(--text-primary)
}

html.dark-mode thead {
    background: #2a2a2a !important
}

html.dark-mode thead th {
    background: #2a2a2a !important;
    color: var(--text-primary) !important;
    border-color: #333333 !important
}

html.dark-mode tbody tr {
    border-color: #333333
}

html.dark-mode tbody td {
    color: var(--text-primary)
}

html.dark-mode .social-link {
    color: var(--text-secondary)
}

html.dark-mode .social-link:hover {
    color: #7c3aed;
    border-color: #7c3aed
}

html.dark-mode .social-links {
    border-color: rgba(255,255,255,0.1)
}

html.dark-mode .btn-secondary {
    background: var(--input-bg)!important;
    color: var(--text-primary)!important;
    border-color: var(--input-border)!important
}

html.dark-mode .btn-qrcode {
    background: linear-gradient(135deg, #0891b2 0, #065f73 100%)!important;
    color: #fff!important;
    box-shadow: 0 4px 15px rgba(8, 145, 178, 0.3)!important;
}

html.dark-mode .checkbox-group input[type="checkbox"] {
    border-color: var(--border-color);
    background: var(--input-bg)
}

html.dark-mode .checkbox-group input[type="checkbox"]:checked {
    background: linear-gradient(135deg,#7c3aed 0,#5b21b6 100%);
    border-color: #7c3aed
}

html.dark-mode .loading {
    border-color: rgba(124,58,237,0.3);
    border-top-color: #7c3aed
}

html.dark-mode .message {
    animation: slideIn .3s ease-out
}

html.dark-mode .success-message {
    background: linear-gradient(135deg,#059669 0,#047857 100%)
}

html.dark-mode .error-message {
    background: linear-gradient(135deg,#dc2626 0,#b91c1c 100%)
}

html.dark-mode .collapse-btn {
    color: #7c3aed
}

html.dark-mode .collapse-btn:hover {
    color: #9f7aea
}

html.dark-mode .collapse-section {
    border-left-color: #7c3aed;
    color: var(--text-primary)
}

html.dark-mode .module-footer {
    border-color: rgba(255,255,255,0.1)
}

html.dark-mode .readonly-wrapper input[readonly] {
    background-color: var(--input-bg)!important;
    border-color: var(--input-border)!important;
    color: var(--text-primary)!important;
}

html.dark-mode .readonly-wrapper input[readonly]:hover {
    border-color: #7c3aed;
    background-color: var(--input-bg);
}

html.dark-mode .subapi-input {
    background-color: var(--input-bg)!important;
    color: var(--text-primary)!important;
}

html.dark-mode .input-icon {
    opacity: 0.6
}

html.dark-mode .module-title {
    color: var(--text-primary)!important
}

html.dark-mode .module-title .collapse-icon {
    fill: var(--text-secondary)
}

html.dark-mode .footer-hint {
    color: var(--text-secondary)!important
}

html.dark-mode .footer-hint a {
    color: #7c3aed!important
}

html.dark-mode .footer-hint a:hover {
    color: #9f7aea!important
}

.theme-icon {
    transition: transform 0.3s ease
}

.social-link.theme-toggle:hover .theme-icon {
    transform: rotate(20deg)
}

.social-link.theme-toggle {
    font-size: 0;
    line-height: 0
}

.theme-icon {
    width: 20px;
    height: 20px;
    display: block !important;
    transition: all 0.3s ease
}

.sun-icon {
    display: none !important;
    opacity: 0
}

.moon-icon {
    display: block !important;
    opacity: 1
}

html.dark-mode .sun-icon {
    display: block !important;
    opacity: 1
}

html.dark-mode .moon-icon {
    display: none !important;
    opacity: 0
}

.page-wrapper {
    justify-content: flex-start;
    align-items: flex-start
}

.card-container {
    max-width: 1200px;
    margin: 20px auto;
    padding: 0;
    background: transparent!important;
    box-shadow: none!important
}

.card-container::before {
    display: none
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 25px 30px;
    border-radius: 16px;
    border-top: 4px solid;
    border-image: linear-gradient(90deg,#faab41 0,#f6821f 50%,#faab41 100%) 1
}

.header-title h1 {
    font-size: 28px;
    font-weight: 700;
    background: linear-gradient(135deg,#faab41 0,#f6821f 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 0
}

.header-buttons {
    display: flex;
    gap: 12px
}

.header .btn {
    padding: 10px 20px;
    font-size: 14px;
    border-radius: 8px
}

.module {
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 16px;
    padding: 30px;
    margin-bottom: 25px;
    box-shadow: 4px 4px 8px -3px rgba(0,0,0,0.12);
    transition: box-shadow 280ms cubic-bezier(.2,.9,.2,1),transform 220ms ease;
    will-change: transform
}

.module:hover,.module:focus-within {
    box-shadow: 0 8px 16px -2px rgba(0,0,0,0.14),0 0 12px rgba(250,171,65,0.08);
    transform: translateY(-4px)
}

.module-title {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 20px;
    color: #1f2937;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer
}

.module-title .collapse-icon {
    width: 24px;
    height: 24px;
    transition: transform 0.28s;
    fill: #666
}

.module.collapsed .collapse-icon {
    transform: rotate(90deg)
}

.module-content {
    display: block;
    overflow: hidden;
    max-height: 2000px;
    opacity: 1;
    transition: max-height 320ms cubic-bezier(.2,.8,.2,1),opacity 220ms ease
}

.module.collapsed .module-content {
    max-height: 0;
    opacity: 0
}

.module .form-group {
    margin-bottom: 20px;
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: 20px;
    align-items: center;
    text-align: left
}

.module .form-group label {
    display: block
}

.module .form-group input,
.module .form-group select,
.module .form-group textarea {
    padding: 8px 8px;
    border-radius: 8px
}

.module .input-wrapper {
    display: flex;
    align-items: center;
    gap: 10px
}

.module .input-wrapper input {
    flex: 1
}

.readonly-wrapper {
    position: relative
}

.readonly-wrapper input[readonly] {
    cursor: pointer;
    background-color: #fff!important;
    border: 2px solid #e5e7eb!important;
    color: #1f2937!important;
}

.readonly-wrapper input[readonly]:hover {
    border-color: #faab41;
    background-color: #fff;
}

.readonly-wrapper input[readonly]:focus {
    outline: 0 !important;
    border-color: #faab41 !important;
    box-shadow: 0 0 0 4px rgba(250, 171, 65, 0.1) !important;
}

.copy-btn {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    padding: 6px 12px;
    font-size: 12px;
    cursor: pointer
}

.module-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 25px;
    padding-top: 20px;
    border-top: 1px solid #e5e7eb
}

.collapse-section {
    margin-top: 15px;
    border-left: 3px solid #faab41;
    padding-left: 20px
}

.collapse-btn {
    background: none;
    border: none;
    color: #faab41;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease
}

.collapse-btn:hover {
    color: #f6821f
}

.success-message,
.error-message {
    display: none;
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px;
    font-weight: 500;
    animation: slideIn 0.3s ease
}

.success-message {
    background: linear-gradient(135deg,#10b981 0,#059669 100%);
    color: #fff
}

.error-message {
    background: linear-gradient(135deg,#ef4444 0,#dc2626 100%);
    color: #fff
}

.loading {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #faab41;
    border-top-color: transparent;
    border-radius: 50%;
    animation: rotate 0.6s linear infinite
}

@media(max-width:768px) {
    .card-container {
        padding: 20px;
        margin: 0
    }

    .header {
        flex-direction: column;
        gap: 15px;
        padding: 20px;
        margin-bottom: 20px
    }

    .module {
        padding: 20px;
        margin-bottom: 20px
    }

    .module .form-group {
        grid-template-columns: 1fr;
        gap: 10px
    }

    .header-buttons {
        width: 100%;
        gap: 10px
    }

    .header-buttons .btn {
        flex: 1
    }
}

@media(max-width:480px) {
    .card-container {
        padding: 15px
    }
}

@media(max-height:600px) and (orientation:landscape) {
    .card-container {
        padding: 15px
    }
}  

/* 自定义按钮样式 */
.btn-reset {
    background: linear-gradient(135deg, #ef4444 0, #dc2626 100%);
    color: #fff;
}

.btn-all-logs {
    background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
    flex-shrink: 0;
}

.btn-close-modal {
    width: 100%;
    margin-top: 20px;
}

.btn-confirm-reset {
    background: linear-gradient(135deg, #ef4444 0, #dc2626 100%);
    color: #fff;
}

.btn-test-api {
    flex: 2;
    background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
    color: #fff;
}

.btn-confirm-api {
    flex: 1;
    opacity: 0.5;
}

.btn-confirm-api:not([disabled]) {
    opacity: 1;
}

.btn-cancel-api {
    flex: 1;
}

.btn-qrcode {
    background: linear-gradient(135deg, #06b6d4 0, #0891b2 100%);
    color: #fff;
    box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
}

.btn-qrcode:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(6, 182, 212, 0.5);
}

.btn-qrcode:active {
    transform: translateY(0);
    box-shadow: 0 2px 10px rgba(6, 182, 212, 0.4);
}

/* 隐藏元素 */
.hidden-section {
    display: none;
}

/* QRCode 容器 */
.qrcode-container {
    margin: 30px 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 350px;
}

/* 重置配置弹窗 */
.reset-modal-title {
    color: #ef4444;
    margin-bottom: 15px;
}

.reset-modal-description {
    margin-bottom: 20px;
    line-height: 1.6;
}

.reset-modal-confirm {
    color: #ef4444;
    font-weight: bold;
    margin-bottom: 20px;
}

.reset-modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: space-between;
}

/* 日志容器 */
.logs-container {
    margin-bottom: 20px;
}

.logs-loading {
    text-align: center;
    padding: 20px;
    color: #6b7280;
}

.logs-footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 15px;
    margin-top: 20px;
}

.logs-footer-text {
    font-size: 12px;
    color: #9ca3af;
    margin: 0;
}

/* 日志模态框 */
.logs-modal {
    overflow-y: auto;
    width: 90vw;
    max-width: 1400px;
    margin: 0 auto;
}

.logs-modal-title {
    margin-bottom: 20px;
}

.logs-all-container {
    max-height: 70vh;
    overflow-y: auto;
    overflow-x: auto;
}

/* 订阅 API 弹窗 */
.subapi-modal-title {
    margin-bottom: 20px;
}

.subapi-form-group {
    grid-template-columns: 1fr;
}

.subapi-status {
    margin: 15px 0;
    padding: 12px 16px;
    border-radius: 8px;
    display: none;
}

.subapi-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

/* 输入字段特殊样式 */
.subapi-input {
    cursor: pointer!important;
    background-color: #fff!important;
    color: #1f2937!important;
}

/* 节点链接输入包装器 */
.link-input-wrapper {
    display: flex;
    align-items: center;
    gap: 10px;
}

.link-input-field {
    flex: 1;
}

/* 消息通知设置样式 */
.notification-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px !important;
}

.notification-row > label:first-child {
    display: flex;
    align-items: center;
    gap: 75px;
    margin: 0 !important;
    white-space: nowrap;
    flex: 1;
}

.notification-row > label:first-child .checkbox-group {
    display: flex;
    margin: 0;
    white-space: nowrap;
    gap: 6px;
}

.notification-controls {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-left: auto;
    flex-shrink: 0;
}

.notification-controls .btn {
    flex-shrink: 0;
    padding: 8px 16px;
    font-size: 14px;
}

.btn-notification-config {
    background: linear-gradient(135deg, #8b5cf6 0, #7c3aed 100%);
    color: #fff;
    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
}

.btn-notification-config:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(139, 92, 246, 0.4);
}

.btn-notification-config:active {
    transform: translateY(0);
    box-shadow: 0 2px 10px rgba(139, 92, 246, 0.3);
}

</style>
</head>
<body>
    <!-- 背景内容 -->
    <iframe id="background-iframe" src="/" title="背景内容"></iframe>

    <!-- 毛玻璃效果遮盖层 -->
    <div id="blur-overlay"></div>

    <!-- 管理后台容器 -->
    <div class="page-wrapper">
        <div class="card-container">
            <div class="success-message" id="successMsg"></div>
            <div class="error-message" id="errorMsg"></div>
            
            <div class="header">
                <div class="header-title">
                    <h1 id="pageTitle">加载中...</h1>
                </div>
                <div class="header-buttons">
                    <button type="button" class="btn btn-danger btn-reset" onclick="resetConfigWithConfirm()">⚠️ 重置配置</button>
                    <button type="button" class="btn btn-primary" onclick="logout()">👋 退出登录</button>
                </div>
            </div>

            <!-- 模块1: 订阅链接 -->
            <div class="module">
                <div class="module-title" onclick="toggleModule(this)">
                    📋 获取节点链接
                    <svg class="collapse-icon" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </div>
                    <div class="form-group">
                        <label for="LinkURL">节点链接格式</label>
                        <div class="input-wrapper">
                            <input type="text" id="LinkURL" title="节点链接格式" readonly>
                            <button type="button" class="btn btn-qrcode" onclick="showQRCode('LinkURL')">📱二维码</button>
                            <button type="button" class="btn btn-primary" onclick="copySubscription('LinkURL')">复制节点</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="subLink">自适应订阅</label>
                        <div class="input-wrapper">
                            <input type="text" id="subLink" title="自适应订阅" readonly>
                            <button type="button" class="btn btn-qrcode" onclick="showQRCode('subLink')">📱二维码</button>
                            <button type="button" class="btn btn-primary" onclick="copySubscription('subLink')">复制订阅</button>
                        </div>
                    </div>
                <div class="module-content">
                        <div class="form-group">
                            <label for="clashLink">Clash订阅</label>
                            <div class="input-wrapper">
                                <input type="text" id="clashLink" title="Clash订阅" readonly>
                                <button type="button" class="btn btn-qrcode" onclick="showQRCode('clashLink')">📱二维码</button>
                                <button type="button" class="btn btn-primary" onclick="copySubscription('clashLink')">复制订阅</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="singboxLink">SingBox订阅</label>
                            <div class="input-wrapper">
                                <input type="text" id="singboxLink" title="SingBox订阅" readonly>
                                <button type="button" class="btn btn-qrcode" onclick="showQRCode('singboxLink')">📱二维码</button>
                                <button type="button" class="btn btn-primary" onclick="copySubscription('singboxLink')">复制订阅</button>
                            </div>
                        </div>
                </div>
            </div>

            <!-- 模块2: 编辑订阅生成 -->
            <div class="module collapsed">
                <div class="module-title" onclick="toggleModule(this)">
                    ⚡️ 优选订阅生成
                    <svg class="collapse-icon" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </div>
                <div class="module-content">
                
                <div class="form-group">
                    <label for="ipMode">优选订阅模式</label>
                    <select id="ipMode" title="优选订阅模式" onchange="updateIPMode()">
                        <option value="random">随机优选</option>
                        <option value="custom">自定义优选</option>
                        <option value="generator">优选订阅生成器</option>
                    </select>
                </div>

                <div id="randomIPSection" class="form-group">
                    <label for="randomCount">随机优选数量</label>
                    <input type="number" id="randomCount" title="随机优选数量" min="1" max="999" value="16" onchange="markModified('sub')">
                </div>

                <div id="customIPSection" class="form-group hidden-section">
                    <label for="customIPs">自定义优选地址</label>
                    <textarea id="customIPs" title="自定义优选地址" placeholder="每行一个地址，格式: IP[:端口]#备注" onchange="markModified('sub')"></textarea>
                </div>

                <div id="generatorSection" class="form-group hidden-section">
                    <label for="generatorURL">优选订阅生成器</label>
                    <input type="text" id="generatorURL" title="优选订阅生成器" placeholder="sub.cmliussss.net" onchange="processGeneratorURL()" oninput="processGeneratorURL()">
                </div>

                <div class="module-footer">
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit('sub')" disabled id="cancelSubBtn">取消</button>
                        <button type="button" class="btn btn-primary" onclick="saveSub()" disabled id="saveSubBtn">保存</button>
                    </div>
                </div>
                </div>
            </div>

            <!-- 模块3: 详细配置信息 -->
            <div class="module collapsed">
                <div class="module-title" onclick="toggleModule(this)">
                    ⚙️ 详细配置信息
                    <svg class="collapse-icon" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </div>
                <div class="module-content">
                
                <div class="form-group">
                    <label for="subName">订阅名称</label>
                    <input type="text" id="subName" title="订阅名称" onchange="markModified('config')">
                </div>

                <div class="form-group">
                    <label for="nodeHost">节点域名</label>
                    <input type="text" id="nodeHost" title="节点域名" readonly>
                </div>

                <div class="form-group">
                    <label for="nodeUUID">UUID</label>
                    <input type="text" id="nodeUUID" title="UUID" readonly>
                </div>

                <div class="form-group">
                    <label for="protocol">节点协议</label>
                    <select id="protocol" title="节点协议" onchange="updateProtocol(); markModified('config')">
                        <option value="vless">VLESS</option>
                        <option value="trojan">Trojan</option>
                    </select>
                </div>
                <!--- 节点配置 
                <div class="form-group">
                    <label>传输协议</label>
                    <select id="transport" onchange="markModified('config')">
                        <option value="ws">WebSocket</option>
                        <option value="xhttp">XHTTP</option>
                    </select>
                </div>
                --->
                <div class="form-group">
                    <label for="skipVerify">跳过证书验证</label>
                    <div class="input-wrapper">
                        <div class="checkbox-group">
                            <input type="checkbox" id="skipVerify" title="跳过证书验证" onchange="markModified('config')">
                            <label for="skipVerify" class="checkbox-label">启用</label>
                        </div>
                    </div>
                </div>

                <div class="module-footer">
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit('config')" disabled id="cancelConfigBtn">取消</button>
                        <button type="button" class="btn btn-primary" onclick="saveConfig()" disabled id="saveConfigBtn">保存</button>
                    </div>
                </div>
                </div>
            </div>

            <!-- 模块4: 反代落地设置 -->
            <div class="module collapsed">
                <div class="module-title" onclick="toggleModule(this)">
                    🌐 Cloudflare CDN 站点落地设置
                    <svg class="collapse-icon" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </div>
                <div class="module-content">
                
                <div class="form-group">
                    <label for="proxyMode">反代模式</label>
                    <select id="proxyMode" title="反代模式" onchange="updateProxyMode()">
                        <option value="auto">PROXYIP</option>
                        <option value="socks5">SOCKS5</option>
                        <option value="http">HTTP</option>
                    </select>
                </div>

                <div id="proxyIPSection" class="form-group">
                    <div class="form-group">
                        <label for="proxyIP">PROXYIP</label>
                        <div class="input-wrapper">
                            <input type="text" id="proxyIP" title="PROXYIP" placeholder="proxyip.cmliussss.net" onchange="processProxyIP()" oninput="processProxyIP()">
                            <div class="checkbox-group">
                                <input type="checkbox" id="autoProxy" title="启用自动获取" onchange="toggleAutoProxy(); markModified('proxy')">
                                <label for="autoProxy" class="checkbox-label">启用自动获取</label>
                            </div>
                        </div>
                    </div>
                </div>


                <div id="socks5Section" class="hidden-section">
                    <div class="form-group">
                        <label for="socks5Addr">SOCKS5</label>
                        <div class="input-wrapper">
                        <input type="text" id="socks5Addr" title="SOCKS5" placeholder="user:password@127.0.0.1:1080" onchange="processProxyAddress('socks5')" oninput="processProxyAddress('socks5')">
                            <div class="checkbox-group">
                                <input type="checkbox" id="globalSocks5" title="启用全局代理" onchange="markModified('proxy')">
                                <label for="globalSocks5" class="checkbox-label">启用全局代理</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="httpSection" class="hidden-section">
                    <div class="form-group">
                        <label for="httpAddr">HTTP</label>
                        <div class="input-wrapper">
                        <input type="text" id="httpAddr" title="HTTP" placeholder="user:password@127.0.0.1:8080" onchange="processProxyAddress('http')" oninput="processProxyAddress('http')">
                            <div class="checkbox-group">
                                <input type="checkbox" id="globalHTTP" title="启用全局代理" onchange="markModified('proxy')">
                                <label for="globalHTTP" class="checkbox-label">启用全局代理</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="module-footer">
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit('proxy')" disabled id="cancelProxyBtn">取消</button>
                        <button type="button" class="btn btn-primary" onclick="saveProxy()" disabled id="saveProxyBtn">保存</button>
                    </div>
                </div>
                </div>
            </div>

            <!-- 模块5: 订阅转换配置 -->
            <div class="module collapsed">
                <div class="module-title" onclick="toggleModule(this)">
                    🔄 订阅转换配置
                    <svg class="collapse-icon" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </div>
                <div class="module-content">
                
                <div class="form-group">
                    <label for="subAPI">订阅转换后端</label>
                    <div class="readonly-wrapper" onclick="openSubAPIModal()">
                        <input type="text" id="subAPI" title="订阅转换后端" readonly placeholder="https://SUBAPI.cmliussss.net" class="subapi-input">
                    </div>
                </div>

                <div class="form-group">
                    <label for="subConfig">订阅转换配置文件</label>
                    <input type="text" id="subConfig" title="订阅转换配置文件" placeholder="https://raw.githubusercontent.com/..." onchange="markModified('convert')">
                </div>

                <div class="form-group">
                    <label for="emoji">Emoji</label>
                    <div class="input-wrapper">
                        <div class="checkbox-group">
                            <input type="checkbox" id="emoji" title="启用Emoji" onchange="markModified('convert')">
                            <label for="emoji" class="checkbox-label">启用</label>
                        </div>
                    </div>
                </div>

                <div class="module-footer">
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit('convert')" disabled id="cancelConvertBtn">取消</button>
                        <button type="button" class="btn btn-primary" onclick="saveConvert()" disabled id="saveConvertBtn">保存</button>
                    </div>
                </div>
                </div>
            </div>

            <!-- 模块6: 消息通知设置 -->
            <div class="module collapsed">
                <div class="module-title" onclick="toggleModule(this)">
                    🔔 消息通知设置
                    <svg class="collapse-icon" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </div>
                <div class="module-content">
                
                <!-- TelegramBot 通知设置 -->
                <div class="form-group notification-row">
                    <label>
                        TelegramBot 通知设置
                        <div class="checkbox-group">
                            <input type="checkbox" id="telegramEnabled" title="启用TelegramBot通知" onchange="markModified('notification')" disabled>
                            <label for="telegramEnabled" class="checkbox-label">启用</label>
                        </div>
                    </label>
                    <div class="notification-controls">
                        <button type="button" class="btn btn-notification-config" onclick="openTelegramConfigModal()">通知参数配置</button>
                    </div>
                </div>

                <!-- Cloudflare 可用请求数统计 -->
                <div class="form-group notification-row">
                    <label>
                        Cloudflare 可用请求数统计
                    </label>
                    <div class="notification-controls">
                        <button type="button" class="btn btn-notification-config" onclick="openCloudflareConfigModal()">通知参数配置</button>
                    </div>
                </div>

                <div class="module-footer">
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit('notification')" disabled id="cancelNotificationBtn">取消</button>
                        <button type="button" class="btn btn-primary" onclick="saveNotification()" disabled id="saveNotificationBtn">保存</button>
                    </div>
                </div>
                </div>
            </div>

            <!-- 模块7: 查看所有日志 -->
            <div class="module collapsed">
                <div class="module-title" onclick="toggleModule(this); loadLogsOnExpand(this)">
                    📋 查看操作日志
                    <svg class="collapse-icon" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </div>
                <div class="module-content">
                    <div id="logsContainer" class="logs-container">
                        <div class="logs-loading">加载中...</div>
                    </div>
                    <div class="logs-footer">
                        <p class="logs-footer-text">因为KV空间有限，所以只保留4MB的操作日志，当日志大小超过该容量会自动清理最老的日志记录。</p>
                        <button type="button" class="btn btn-primary btn-all-logs" onclick="showAllLogs()">全部日志</button>
                    </div>
                </div>
            </div>

            <div class="social-links">
                <a href="https://github.com/cmliu/edgetunnel" target="_blank" rel="noopener" class="social-link" title="GitHub">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                        <path fill="currentColor" fill-rule="evenodd" d="M7.976 0A7.977 7.977 0 0 0 0 7.976c0 3.522 2.3 6.507 5.431 7.584c.392.049.538-.196.538-.392v-1.37c-2.201.49-2.69-1.076-2.69-1.076c-.343-.93-.881-1.175-.881-1.175c-.734-.489.048-.489.048-.489c.783.049 1.224.832 1.224.832c.734 1.223 1.859.88 2.3.685c.048-.538.293-.88.489-1.076c-1.762-.196-3.621-.881-3.621-3.964c0-.88.293-1.566.832-2.153c-.05-.147-.343-.978.098-2.055c0 0 .685-.196 2.201.832c.636-.196 1.322-.245 2.007-.245s1.37.098 2.006.245c1.517-1.027 2.202-.832 2.202-.832c.44 1.077.146 1.908.097 2.104a3.16 3.16 0 0 1 .832 2.153c0 3.083-1.86 3.719-3.62 3.915c.293.244.538.733.538 1.467v2.202c0 .196.146.44.538.392A7.98 7.98 0 0 0 16 7.976C15.951 3.572 12.38 0 7.976 0" clip-rule="evenodd"/>
                    </svg>
                </a>
                <a href="https://t.me/CMLiussss" target="_blank" rel="noopener" class="social-link" title="Telegram">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
                        <defs>
                            <linearGradient id="telegramGradient" x1="50%" x2="50%" y1="0%" y2="100%">
                                <stop offset="0%" stop-color="#2AABEE"/>
                                <stop offset="100%" stop-color="#229ED9"/>
                            </linearGradient>
                        </defs>
                        <path fill="url(#telegramGradient)" d="M128 0C94.06 0 61.48 13.494 37.5 37.49A128.04 128.04 0 0 0 0 128c0 33.934 13.5 66.514 37.5 90.51C61.48 242.506 94.06 256 128 256s66.52-13.494 90.5-37.49c24-23.996 37.5-56.576 37.5-90.51s-13.5-66.514-37.5-90.51C194.52 13.494 161.94 0 128 0"/>
                        <path fill="#FFF" d="M57.94 126.648q55.98-24.384 74.64-32.152c35.56-14.786 42.94-17.354 47.76-17.441c1.06-.017 3.42.245 4.96 1.49c1.28 1.05 1.64 2.47 1.82 3.467c.16.996.38 3.266.2 5.038c-1.92 20.24-10.26 69.356-14.5 92.026c-1.78 9.592-5.32 12.808-8.74 13.122c-7.44.684-13.08-4.912-20.28-9.63c-11.26-7.386-17.62-11.982-28.56-19.188c-12.64-8.328-4.44-12.906 2.76-20.386c1.88-1.958 34.64-31.748 35.26-34.45c.08-.338.16-1.598-.6-2.262c-.74-.666-1.84-.438-2.64-.258c-1.14.256-19.12 12.152-54 35.686c-5.1 3.508-9.72 5.218-13.88 5.128c-4.56-.098-13.36-2.584-19.9-4.708c-8-2.606-14.38-3.984-13.82-8.41c.28-2.304 3.46-4.662 9.52-7.072"/>
                    </svg>
                </a>
                <button type="button" class="social-link theme-toggle" id="themeToggle" title="切换夜间模式" onclick="toggleTheme()">
                    <!-- 太阳图标 (日间模式显示) -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="theme-icon sun-icon">
                        <circle cx="12" cy="12" r="5" fill="currentColor"/>
                        <g stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none">
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                            <line x1="1" y1="12" x2="3" y2="12"/>
                            <line x1="21" y1="12" x2="23" y2="12"/>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                        </g>
                    </svg>
                    <!-- 月亮图标 (夜间模式显示) -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="theme-icon moon-icon">
                        <path fill="currentColor" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

<!-- 二维码弹窗 -->
<div class="modal-overlay" id="qrcodeModal" onclick="closeQRCode(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <button type="button" class="modal-close" onclick="closeQRCode()">×</button>
        <div id="qrcodeContainer" class="qrcode-container"></div>
        <button type="button" class="btn btn-primary btn-close-modal" onclick="closeQRCode()">关闭</button>
    </div>
</div>

<!-- 重置配置确认弹窗 -->
<div class="modal-overlay" id="resetModal" onclick="closeResetModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <h2 class="reset-modal-title">⚠️ 重置配置</h2>
        <p class="reset-modal-description">重置配置将会初始化所有设置，包括订阅生成、节点信息、反代配置等。此操作不可撤销，请谨慎操作。</p>
        <p class="reset-modal-confirm">确定是否完全重置配置？</p>
        <div class="reset-modal-buttons">
            <button type="button" class="btn btn-primary btn-confirm-reset" onclick="confirmReset()">确定重置</button>
            <button type="button" class="btn btn-secondary" onclick="closeResetModal()">取消重置</button>
        </div>
    </div>
</div>

<!-- 日志查看弹窗 -->
<div class="modal-overlay" id="logsModal" onclick="closeLogsModal(event)">
    <div class="modal logs-modal" onclick="event.stopPropagation()">
        <button type="button" class="modal-close" onclick="closeLogsModal()">×</button>
        <h2 class="logs-modal-title">📋 所有操作日志</h2>
        <div id="allLogsContainer" class="logs-all-container"></div>
        <button type="button" class="btn btn-primary btn-close-modal" onclick="closeLogsModal()">关闭</button>
    </div>
</div>

<!-- 订阅转换后端设置弹窗 -->
<div class="modal-overlay" id="subAPIModal" onclick="closeSubAPIModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <button type="button" class="modal-close" onclick="closeSubAPIModal()">×</button>
        <h2 class="subapi-modal-title">⚙️ 订阅转换后端</h2>
        <div class="form-group subapi-form-group">
            <label>订阅转换后端地址</label>
            <input type="text" id="testSubAPIInput" placeholder="输入订阅转换后端地址">
        </div>
        <div id="subAPIStatus" class="subapi-status"></div>
        <div class="subapi-buttons">
            <button type="button" class="btn btn-primary btn-test-api" onclick="testSubAPI()">可用性验证</button>
            <button type="button" class="btn btn-primary btn-confirm-api" id="subAPIConfirmBtn" onclick="confirmSubAPI()" disabled>确定</button>
            <button type="button" class="btn btn-secondary btn-cancel-api" onclick="closeSubAPIModal()">取消</button>
        </div>
    </div>
</div>

<!-- TelegramBot 通知设置弹窗 -->
<div class="modal-overlay" id="telegramConfigModal" onclick="closeTelegramConfigModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <button type="button" class="modal-close" onclick="closeTelegramConfigModal()">×</button>
        <h2 class="subapi-modal-title">🤖 TelegramBot 通知参数配置</h2>
        <div class="form-group subapi-form-group">
            <label>Bot Token</label>
            <input type="text" id="telegramBotToken" placeholder="输入Telegram Bot Token">
        </div>
        <div class="form-group subapi-form-group">
            <label>Chat ID</label>
            <input type="text" id="telegramChatID" placeholder="输入Chat ID">
        </div>
        <div class="subapi-buttons">
            <button type="button" class="btn btn-primary btn-test-api" onclick="testTelegramConfig()">可用性验证</button>
            <button type="button" class="btn btn-primary btn-confirm-api" onclick="confirmTelegramConfig()">确定</button>
            <button type="button" class="btn btn-secondary btn-cancel-api" onclick="closeTelegramConfigModal()">取消</button>
        </div>
    </div>
</div>

<!-- Cloudflare 通知设置弹窗 -->
<div class="modal-overlay" id="cloudflareConfigModal" onclick="closeCloudflareConfigModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <button type="button" class="modal-close" onclick="closeCloudflareConfigModal()">×</button>
        <h2 class="subapi-modal-title">☁️ Cloudflare 可用请求数统计</h2>
        <div class="form-group subapi-form-group">
            <label>API Token</label>
            <input type="text" id="cloudflareToken" placeholder="输入Cloudflare API Token">
        </div>
        <div class="form-group subapi-form-group">
            <label>Zone ID</label>
            <input type="text" id="cloudflareZoneID" placeholder="输入Zone ID">
        </div>
        <div class="form-group subapi-form-group">
            <label>通知阈值 (%)</label>
            <input type="number" id="cloudflareThreshold" placeholder="输入通知阈值，例如20" min="1" max="100" value="20">
        </div>
        <div class="subapi-buttons">
            <button type="button" class="btn btn-primary btn-test-api" onclick="testCloudflareConfig()">可用性验证</button>
            <button type="button" class="btn btn-primary btn-confirm-api" onclick="confirmCloudflareConfig()">确定</button>
            <button type="button" class="btn btn-secondary btn-cancel-api" onclick="closeCloudflareConfigModal()">取消</button>
        </div>
    </div>
</div>

<script>
let currentConfig = {};
let originalConfig = {};
let modifiedSections = new Set();

// 初始化主题
function initializeTheme() {
    const saved = localStorage.getItem('theme');
    let theme = saved;
    
    // 如果第一次打开，按系统主题决定
    if (!saved) {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    
    applyTheme(theme);
}

// 应用主题
function applyTheme(theme) {
    if (theme === 'dark') {
        document.documentElement.classList.add('dark-mode');
        localStorage.setItem('theme', 'dark');
    } else {
        document.documentElement.classList.remove('dark-mode');
        localStorage.setItem('theme', 'light');
    }
}

// 切换主题
function toggleTheme() {
    const isDark = document.documentElement.classList.contains('dark-mode');
    applyTheme(isDark ? 'light' : 'dark');
}

async function loadConfig() {
    try {
    const response = await fetch('/admin/config.json?t=' + Date.now());
        if (!response.ok) throw new Error('加载配置失败');
        currentConfig = await response.json();
        originalConfig = JSON.parse(JSON.stringify(currentConfig));
        renderUI();
        // 设置网页标题
        document.title = `${currentConfig.优选订阅生成?.SUBNAME || 'edgetunnel'}设置页面 - 管理后台`;
    } catch (error) {
        showToast('加载配置失败: ' + error.message, 'error');
    }
}

function renderUI() {
    // 标题
    document.getElementById('pageTitle').textContent = (currentConfig.优选订阅生成?.SUBNAME || 'edgetunnel') + '设置页面';
    
    // 订阅链接
    const token = currentConfig.优选订阅生成?.TOKEN;
    const host = currentConfig.HOST;
    const link = currentConfig.LINK;
    document.getElementById('LinkURL').value = currentConfig.LINK;
    document.getElementById('subLink').value = `https://${host}/sub?token=${token}`;
    document.getElementById('clashLink').value = `https://${host}/sub?token=${token}&clash`;
    document.getElementById('singboxLink').value = `https://${host}/sub?token=${token}&sb`;
    
    // 编辑订阅生成
    const local = currentConfig.优选订阅生成?.local ?? true;
    const randomIP = currentConfig.优选订阅生成?.本地IP库?.随机IP ?? true;
    
    if (!local) {
        document.getElementById('ipMode').value = 'generator';
        document.getElementById('generatorURL').value = currentConfig.优选订阅生成?.SUB || '';
    } else if (randomIP) {
        document.getElementById('ipMode').value = 'random';
        document.getElementById('randomCount').value = currentConfig.优选订阅生成?.本地IP库?.随机数量 || 16;
    } else {
        document.getElementById('ipMode').value = 'custom';
        loadCustomIPs();
    }
    updateIPMode();
    
    // 详细配置
    document.getElementById('subName').value = currentConfig.优选订阅生成?.SUBNAME || '';
    document.getElementById('nodeHost').value = currentConfig.HOST || '';
    document.getElementById('nodeUUID').value = currentConfig.UUID || '';
    document.getElementById('protocol').value = currentConfig.协议类型 || 'vless';
    //document.getElementById('transport').value = currentConfig.传输协议 || 'ws';
    document.getElementById('skipVerify').checked = currentConfig.跳过证书验证 || false;
    
    // 反代落地设置
    const socksEnabled = currentConfig.反代?.SOCKS5?.启用;
    if (!socksEnabled) {
        document.getElementById('proxyMode').value = 'auto';
        document.getElementById('proxyIP').value = currentConfig.反代?.PROXYIP || '';
        document.getElementById('autoProxy').checked = (currentConfig.反代?.PROXYIP === 'auto');
        if (currentConfig.反代?.PROXYIP === 'auto') {
            document.getElementById('proxyIP').disabled = true;
        }
    } else if (socksEnabled === 'socks5') {
        document.getElementById('proxyMode').value = 'socks5';
        document.getElementById('socks5Addr').value = currentConfig.反代?.SOCKS5?.账号 || '';
        document.getElementById('globalSocks5').checked = currentConfig.反代?.SOCKS5?.全局 || false;
    } else if (socksEnabled === 'http') {
        document.getElementById('proxyMode').value = 'http';
        document.getElementById('httpAddr').value = currentConfig.反代?.SOCKS5?.账号 || '';
        document.getElementById('globalHTTP').checked = currentConfig.反代?.SOCKS5?.全局 || false;
    }
    updateProxyMode();
    
    // 订阅转换配置
    document.getElementById('subAPI').value = currentConfig.订阅转换配置?.SUBAPI || '';
    document.getElementById('subConfig').value = currentConfig.订阅转换配置?.SUBCONFIG || '';
    document.getElementById('emoji').checked = currentConfig.订阅转换配置?.SUBEMOJI || false;
    
    // 消息通知设置 - 兼容两种config结构
    // 优先读取 TG 字段，如果没有则读取 通知.Telegram
    const telegramBotToken = currentConfig.TG?.BotToken || currentConfig.通知?.Telegram?.BotToken;
    const telegramChatID = currentConfig.TG?.ChatID || currentConfig.通知?.Telegram?.ChatID;
    const telegramCheckbox = document.getElementById('telegramEnabled');
    
    // 判断TG配置是否完整（BotToken和ChatID都非null且非空字符串）
    if (telegramBotToken && telegramChatID) {
        // 两个都有，启用checkbox，并加载 TG.启用 的状态
        telegramCheckbox.disabled = false;
        telegramCheckbox.checked = currentConfig.TG?.启用 ?? false;
    } else {
        // 任意一个缺少，禁用checkbox
        telegramCheckbox.disabled = true;
        telegramCheckbox.checked = false;
    }
    
    modifiedSections.clear();
    resetAllButtons();
    
    // 从 localStorage 加载模块展开/折叠状态
    loadModuleStates();
}

async function loadCustomIPs() {
    const textarea = document.getElementById('customIPs');
    textarea.disabled = true;
    textarea.value = '正在加载...';
    
    try {
    const response = await fetch('/admin/ADD.txt?t=' + Date.now());
        if (response.ok) {
            textarea.value = await response.text();
        } else {
            textarea.value = '';
        }
    } catch (error) {
        showToast('加载自定义IP失败', 'error');
        textarea.value = '';
    } finally {
        textarea.disabled = false;
    }
}

function updateIPMode() {
    const mode = document.getElementById('ipMode').value;
    document.getElementById('randomIPSection').style.display = mode === 'random' ? 'grid' : 'none';
    document.getElementById('customIPSection').style.display = mode === 'custom' ? 'block' : 'none';
    document.getElementById('generatorSection').style.display = mode === 'generator' ? 'grid' : 'none';
    
    // 当切换到自定义优选时，自动加载现有的ADD.txt内容
    if (mode === 'custom') {
        loadCustomIPs();
    }
    
    markModified('sub');
}

// 处理优选订阅生成器URL
function processGeneratorURL() {
    const input = document.getElementById('generatorURL').value.trim();
    let domain = '';
    
    if (input) {
        // 如果输入不是空的，提取域名
        domain = extractDomain(input);
        document.getElementById('generatorURL').value = domain;
    }
    
    markModified('sub');
}

// 提取URL中的纯域名
function extractDomain(url) {
    try {
        url = url.trim();
        
        // 如果不包含协议，尝试识别是否为完整URL或纯域名
        if (!url.includes('://')) {
            // 检查是否包含路径、查询参数或端口
            if (url.includes('/') || url.includes('?') || url.includes(':')) {
                // 这是一个完整的URL，补充https协议
                url = 'https://' + url;
            } else {
                // 这是纯域名，直接返回
                return url;
            }
        }
        
        // 解析URL
        const urlObj = new URL(url);
        
        // 获取hostname（不包含端口）
        let domain = urlObj.hostname;
        
        // 移除www前缀（如果有）
        if (domain.startsWith('www.')) {
            domain = domain.substring(4);
        }
        
        return domain;
    } catch (error) {
        // 如果URL解析失败，返回原始输入去掉协议部分的结果
        let temp = url.trim();
        if (temp.includes('://')) {
            temp = temp.split('://')[1];
        }
        if (temp.includes('/')) {
            temp = temp.split('/')[0];
        }
        if (temp.includes('?')) {
            temp = temp.split('?')[0];
        }
        if (temp.includes(':')) {
            temp = temp.split(':')[0];
        }
        if (temp.startsWith('www.')) {
            temp = temp.substring(4);
        }
        return temp;
    }
}

function updateProtocol() {
    const protocol = document.getElementById('protocol').value;
    /*
    const transport = document.getElementById('transport');
    if (protocol === 'trojan') {
        transport.value = 'ws';
        transport.disabled = true;
    } else {
        transport.disabled = false;
    }
    */
}

// 处理PROXYIP地址
function processProxyIP() {
    const input = document.getElementById('proxyIP').value.trim();
    
    if (input && input !== 'auto') {
        const cleanAddress = extractProxyIPAddress(input);
        document.getElementById('proxyIP').value = cleanAddress;
    }
    
    markModified('proxy');
}

// 提取PROXYIP地址中的纯格式（保留端口号）
function extractProxyIPAddress(input) {
    input = input.trim();
    
    // 首先检查是否包含 "ip=" (包括 proxyip= 和 pyip=)
    const ipPatterns = ['proxyip=', 'pyip=', 'ip='];
    for (const pattern of ipPatterns) {
        const index = input.toLowerCase().indexOf(pattern);
        if (index !== -1) {
            input = input.substring(index + pattern.length).trim();
            break;
        }
    }
    
    // 移除协议前缀 (http:// 或 https://)
    if (input.toLowerCase().startsWith('http://')) {
        input = input.substring(7).trim();
    } else if (input.toLowerCase().startsWith('https://')) {
        input = input.substring(8).trim();
    }
    
    // 移除末尾的斜杠
    if (input.endsWith('/')) {
        input = input.substring(0, input.length - 1).trim();
    }
    
    // 移除末尾的备注（#符号之后的内容）
    if (input.includes('#')) {
        input = input.split('#')[0].trim();
    }
    
    return input;
}

// 处理SOCKS5和HTTP代理地址
function processProxyAddress(type) {
    const fieldId = type === 'socks5' ? 'socks5Addr' : 'httpAddr';
    const input = document.getElementById(fieldId).value.trim();
    let cleanAddress = '';
    
    if (input) {
        cleanAddress = extractProxyAddress(input, type);
        document.getElementById(fieldId).value = cleanAddress;
        
        // 如果输入内容包含协议标识，自动切换反代模式并转移内容
        switchProxyModeByProtocol(input, cleanAddress);
    }
    
    markModified('proxy');
}

// 提取代理地址中的纯格式
function extractProxyAddress(input, type) {
    input = input.trim();
    
    // 移除开头的 "/" 或 "/"
    if (input.startsWith('/')) {
        input = input.substring(1).trim();
    }
    
    // 检测并移除协议前缀
    const socks5Prefixes = ['socks5://', 'socks5=', 'socks5://'];
    const httpPrefixes = ['http://', 'http=', 'https://'];
    
    for (const prefix of socks5Prefixes) {
        if (input.toLowerCase().startsWith(prefix)) {
            input = input.substring(prefix.length).trim();
            break;
        }
    }
    
    for (const prefix of httpPrefixes) {
        if (input.toLowerCase().startsWith(prefix)) {
            input = input.substring(prefix.length).trim();
            break;
        }
    }
    
    // 移除末尾的备注（#符号之后的内容）
    if (input.includes('#')) {
        input = input.split('#')[0].trim();
    }
    
    return input;
}

// 根据协议自动切换反代模式
function switchProxyModeByProtocol(input, cleanAddress) {
    const lowerInput = input.toLowerCase();
    
    // 检查是否包含socks5协议
    if (lowerInput.includes('socks5://') || lowerInput.includes('socks5=') || lowerInput.startsWith('/socks')) {
        // 切换到SOCKS5模式
        document.getElementById('proxyMode').value = 'socks5';
        
        // 清空其他模式的内容，填充SOCKS5
        document.getElementById('proxyIP').value = '';
        document.getElementById('socks5Addr').value = cleanAddress;
        document.getElementById('httpAddr').value = '';
        
        updateProxyMode();
        return;
    }
    
    // 检查是否包含http协议
    if (lowerInput.includes('http://') || lowerInput.includes('http=') || lowerInput.includes('https://') || lowerInput.startsWith('/http')) {
        // 切换到HTTP模式
        document.getElementById('proxyMode').value = 'http';
        
        // 清空其他模式的内容，填充HTTP
        document.getElementById('proxyIP').value = '';
        document.getElementById('socks5Addr').value = '';
        document.getElementById('httpAddr').value = cleanAddress;
        
        updateProxyMode();
        return;
    }
}

function updateProxyMode() {
    const mode = document.getElementById('proxyMode').value;
    document.getElementById('proxyIPSection').style.display = mode === 'auto' ? 'block' : 'none';
    document.getElementById('socks5Section').style.display = mode === 'socks5' ? 'block' : 'none';
    document.getElementById('httpSection').style.display = mode === 'http' ? 'block' : 'none';
    markModified('proxy');
}

function toggleAutoProxy() {
    const autoProxy = document.getElementById('autoProxy').checked;
    document.getElementById('proxyIP').disabled = autoProxy;
    markModified('proxy');
}

function toggleModule(titleEl) {
    const module = titleEl.parentElement;
    const content = module.querySelector('.module-content');

    // If there's no collapsible content, just toggle the class
    if (!content) {
        module.classList.toggle('collapsed');
        saveModuleStates();
        return;
    }

    // If a transition is currently attached, remove it to avoid duplicate handlers
    if (content._transitionHandler) {
        content.removeEventListener('transitionend', content._transitionHandler);
        content._transitionHandler = null;
    }

    const isCollapsed = module.classList.contains('collapsed');

    if (isCollapsed) {
        // Expand
        content.style.display = 'block';
        // Measure height
        const height = content.scrollHeight;
        // Start from 0
        content.style.maxHeight = '0px';
        content.style.opacity = '0';
        // Force reflow
        content.getBoundingClientRect();
        // Animate to measured height
        content.style.maxHeight = height + 'px';
        content.style.opacity = '1';

        const onEnd = function (e) {
            if (e.propertyName === 'max-height') {
                // Clear fixed max-height so content can grow/shrink naturally
                content.style.maxHeight = '';
                content.removeEventListener('transitionend', onEnd);
                content._transitionHandler = null;
            }
        };
        content._transitionHandler = onEnd;
        content.addEventListener('transitionend', onEnd);

        module.classList.remove('collapsed');
    } else {
        // Collapse
        const height = content.scrollHeight;
        // Ensure starting height is set
        content.style.maxHeight = height + 'px';
        content.style.opacity = '1';
        // Force reflow
        content.getBoundingClientRect();
        // Animate to 0
        content.style.maxHeight = '0px';
        content.style.opacity = '0';

        const onEnd = function (e) {
            if (e.propertyName === 'max-height') {
                // Hide after collapsing to remove from tab order
                content.style.display = 'none';
                content.removeEventListener('transitionend', onEnd);
                content._transitionHandler = null;
            }
        };
        content._transitionHandler = onEnd;
        content.addEventListener('transitionend', onEnd);

        module.classList.add('collapsed');
    }
    
    // 保存模块状态到 localStorage
    saveModuleStates();
}

function markModified(section) {
    modifiedSections.add(section);
    
    // 特殊处理 notification 部分：更新 TG.启用 状态
    if (section === 'notification') {
        const telegramCheckbox = document.getElementById('telegramEnabled');
        if (!currentConfig.TG) currentConfig.TG = {};
        currentConfig.TG.启用 = telegramCheckbox.checked;
    }
    
    updateButtonStates();
}

function updateButtonStates() {
    // 订阅生成模块
    const subModified = modifiedSections.has('sub');
    document.getElementById('saveSubBtn').disabled = !subModified;
    document.getElementById('cancelSubBtn').disabled = !subModified;
    
    // 配置信息模块
    const configModified = modifiedSections.has('config');
    document.getElementById('saveConfigBtn').disabled = !configModified;
    document.getElementById('cancelConfigBtn').disabled = !configModified;
    
    // 反代设置模块
    const proxyModified = modifiedSections.has('proxy');
    document.getElementById('saveProxyBtn').disabled = !proxyModified;
    document.getElementById('cancelProxyBtn').disabled = !proxyModified;
    
    // 订阅转换模块
    const convertModified = modifiedSections.has('convert');
    document.getElementById('saveConvertBtn').disabled = !convertModified;
    document.getElementById('cancelConvertBtn').disabled = !convertModified;
    
    // 通知设置模块
    const notificationModified = modifiedSections.has('notification');
    document.getElementById('saveNotificationBtn').disabled = !notificationModified;
    document.getElementById('cancelNotificationBtn').disabled = !notificationModified;
}

function resetAllButtons() {
    document.querySelectorAll('[id^="save"]').forEach(btn => btn.disabled = true);
    document.querySelectorAll('[id^="cancel"]').forEach(btn => btn.disabled = true);
}

function copySubscription(elementId) {
    const element = document.getElementById(elementId);
    navigator.clipboard.writeText(element.value).then(() => {
        showToast('已复制到剪贴板', 'success');
    }).catch(() => {
        showToast('复制失败', 'error');
    });
}

function showQRCode(elementId) {
    const text = document.getElementById(elementId).value;
    const container = document.getElementById('qrcodeContainer');
    container.innerHTML = '';
    new QRCode(container, {
        text: text,
        width: 300,
        height: 300,
        colorDark: '#000',
        colorLight: '#fff',
        correctLevel: QRCode.CorrectLevel.H
    });
    document.getElementById('qrcodeModal').classList.add('show');
}

function closeQRCode(event) {
    if (!event || event.target.id === 'qrcodeModal') {
        document.getElementById('qrcodeModal').classList.remove('show');
    }
}

async function saveSub() {
    const mode = document.getElementById('ipMode').value;
    
    // 检查文本框内容是否为空
    if (mode === 'random') {
        const randomCount = document.getElementById('randomCount').value.trim();
        if (!randomCount) {
            showToast('随机优选数量不能为空', 'error');
            return;
        }
    } else if (mode === 'custom') {
        const customIPs = document.getElementById('customIPs').value.trim();
        if (!customIPs) {
            showToast('自定义优选地址不能为空', 'error');
            return;
        }
    } else if (mode === 'generator') {
        const generatorURL = document.getElementById('generatorURL').value.trim();
        if (!generatorURL) {
            showToast('优选订阅生成器地址不能为空', 'error');
            return;
        }
    }
    
    const updates = {
        local: mode !== 'generator',
        本地IP库: { 随机IP: mode === 'random', 随机数量: parseInt(document.getElementById('randomCount').value) || 16 },
        SUB: mode === 'generator' ? document.getElementById('generatorURL').value : null,
        SUBNAME: currentConfig.优选订阅生成.SUBNAME,
        SUBUpdateTime: currentConfig.优选订阅生成.SUBUpdateTime,
        TOKEN: currentConfig.优选订阅生成.TOKEN
    };
    
    currentConfig.优选订阅生成 = { ...currentConfig.优选订阅生成, ...updates };
    
    if (mode === 'custom') {
        const customIPs = document.getElementById('customIPs').value;
        try {
            await fetch('/admin/ADD.txt', { method: 'POST', body: customIPs });
        } catch (error) {
            showToast('保存自定义IP失败', 'error');
            return;
        }
    }
    
    await saveConfigToServer('sub');
}

async function saveConfig() {
    currentConfig.优选订阅生成.SUBNAME = document.getElementById('subName').value;
    currentConfig.协议类型 = document.getElementById('protocol').value;
    //currentConfig.传输协议 = currentConfig.协议类型 === 'trojan' ? 'ws' : document.getElementById('transport').value;
    currentConfig.跳过证书验证 = document.getElementById('skipVerify').checked;
    
    await saveConfigToServer('config');
    // 更新网页标题
    document.title = `${currentConfig.优选订阅生成?.SUBNAME || 'edgetunnel'}设置页面 - 管理后台`;
}

async function saveProxy() {
    const mode = document.getElementById('proxyMode').value;
    let socksEnabled = null;
    let socksAccount = '';
    let globalProxy = false;
    let proxyIP = currentConfig.反代.PROXYIP;
    
    // 检查文本框内容是否为空
    if (mode === 'auto') {
        socksEnabled = null;
        const autoProxy = document.getElementById('autoProxy').checked;
        proxyIP = autoProxy ? 'auto' : document.getElementById('proxyIP').value.trim();
        
        if (!autoProxy && !proxyIP) {
            showToast('PROXYIP地址不能为空', 'error');
            return;
        }
    } else if (mode === 'socks5') {
        socksEnabled = 'socks5';
        socksAccount = document.getElementById('socks5Addr').value.trim();
        globalProxy = document.getElementById('globalSocks5').checked;
        
        if (!socksAccount) {
            showToast('SOCKS5地址不能为空', 'error');
            return;
        }
    } else if (mode === 'http') {
        socksEnabled = 'http';
        socksAccount = document.getElementById('httpAddr').value.trim();
        globalProxy = document.getElementById('globalHTTP').checked;
        
        if (!socksAccount) {
            showToast('HTTP地址不能为空', 'error');
            return;
        }
    }
    
    currentConfig.反代 = {
        PROXYIP: proxyIP,
        SOCKS5: {
            启用: socksEnabled,
            全局: globalProxy,
            账号: socksAccount,
            白名单: currentConfig.反代.SOCKS5.白名单
        }
    };
    
    await saveConfigToServer('proxy');
}

async function saveConvert() {
    currentConfig.订阅转换配置 = {
        SUBAPI: document.getElementById('subAPI').value,
        SUBCONFIG: document.getElementById('subConfig').value,
        SUBEMOJI: document.getElementById('emoji').checked
    };
    
    await saveConfigToServer('convert');
}

async function saveConfigToServer(section) {
    try {
        const response = await fetch('/admin/config.json', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(currentConfig)
        });
        
        if (!response.ok) throw new Error('保存失败');
        showToast('配置已保存', 'success');
        modifiedSections.delete(section);
        updateButtonStates();
    } catch (error) {
        showToast('保存失败: ' + error.message, 'error');
    }
}

function cancelEdit(section) {
    currentConfig = JSON.parse(JSON.stringify(originalConfig));
    
    // 只重置该模块的值，不调用 renderUI 以保持展开状态
    if (section === 'sub') {
        const local = currentConfig.优选订阅生成?.local ?? true;
        const randomIP = currentConfig.优选订阅生成?.本地IP库?.随机IP ?? true;
        
        if (!local) {
            document.getElementById('ipMode').value = 'generator';
            document.getElementById('generatorURL').value = currentConfig.优选订阅生成?.SUB || '';
        } else if (randomIP) {
            document.getElementById('ipMode').value = 'random';
            document.getElementById('randomCount').value = currentConfig.优选订阅生成?.本地IP库?.随机数量 || 16;
        } else {
            document.getElementById('ipMode').value = 'custom';
            loadCustomIPs();
        }
        updateIPMode();
    } else if (section === 'config') {
        document.getElementById('subName').value = currentConfig.优选订阅生成?.SUBNAME || '';
        document.getElementById('nodeHost').value = currentConfig.HOST || '';
        document.getElementById('nodeUUID').value = currentConfig.UUID || '';
        document.getElementById('protocol').value = currentConfig.协议类型 || 'vless';
        document.getElementById('skipVerify').checked = currentConfig.跳过证书验证 || false;
        updateProtocol();
    } else if (section === 'proxy') {
        const socksEnabled = currentConfig.反代?.SOCKS5?.启用;
        if (!socksEnabled) {
            document.getElementById('proxyMode').value = 'auto';
            document.getElementById('proxyIP').value = currentConfig.反代?.PROXYIP || '';
            document.getElementById('autoProxy').checked = (currentConfig.反代?.PROXYIP === 'auto');
            if (currentConfig.反代?.PROXYIP === 'auto') {
                document.getElementById('proxyIP').disabled = true;
            }
        } else if (socksEnabled === 'socks5') {
            document.getElementById('proxyMode').value = 'socks5';
            document.getElementById('socks5Addr').value = currentConfig.反代?.SOCKS5?.账号 || '';
            document.getElementById('globalSocks5').checked = currentConfig.反代?.SOCKS5?.全局 || false;
        } else if (socksEnabled === 'http') {
            document.getElementById('proxyMode').value = 'http';
            document.getElementById('httpAddr').value = currentConfig.反代?.SOCKS5?.账号 || '';
            document.getElementById('globalHTTP').checked = currentConfig.反代?.SOCKS5?.全局 || false;
        }
        updateProxyMode();
    } else if (section === 'convert') {
        document.getElementById('subAPI').value = currentConfig.订阅转换配置?.SUBAPI || '';
        document.getElementById('subConfig').value = currentConfig.订阅转换配置?.SUBCONFIG || '';
        document.getElementById('emoji').checked = currentConfig.订阅转换配置?.SUBEMOJI || false;
    }
    
    modifiedSections.delete(section);
    updateButtonStates();
}

// 保存模块展开/折叠状态到 localStorage
function saveModuleStates() {
    const states = {};
    document.querySelectorAll('.module').forEach((module, index) => {
        const title = module.querySelector('.module-title')?.textContent?.trim() || ('module-' + index);
        // 不保存"查看操作日志"模块的状态
        if (title !== '📋 查看操作日志') {
            states[title] = !module.classList.contains('collapsed');
        }
    });
    localStorage.setItem('adminModuleStates', JSON.stringify(states));
}

// 从 localStorage 加载模块展开/折叠状态
function loadModuleStates() {
    const savedStates = localStorage.getItem('adminModuleStates');
    const states = savedStates ? JSON.parse(savedStates) : {};
    
    // 如果是第一次访问（localStorage中没有保存状态），所有模块默认折叠
    const isFirstVisit = !savedStates;
    
    document.querySelectorAll('.module').forEach((module, index) => {
        const title = module.querySelector('.module-title')?.textContent?.trim() || ('module-' + index);
        let shouldBeExpanded;
        
        // "查看操作日志"模块始终保持折叠状态
        if (title === '📋 查看操作日志') {
            shouldBeExpanded = false;
        } else {
            shouldBeExpanded = isFirstVisit ? false : (states[title] !== false); // 第一次默认折叠，之后按保存的状态
        }
        
        const isCurrentlyCollapsed = module.classList.contains('collapsed');
        const content = module.querySelector('.module-content');
        
        if (shouldBeExpanded && isCurrentlyCollapsed) {
            // 需要展开
            module.classList.remove('collapsed');
            if (content) {
                content.style.display = 'block';
                content.style.maxHeight = '';
                content.style.opacity = '1';
            }
        } else if (!shouldBeExpanded && !isCurrentlyCollapsed) {
            // 需要折叠
            module.classList.add('collapsed');
            if (content) {
                content.style.display = 'none';
                content.style.maxHeight = '0px';
                content.style.opacity = '0';
            }
        }
    });
}

async function refreshConfig() {
    await loadConfig();
    const loadTime = currentConfig.加载时间 || '未知';
    showToast(`配置已刷新 (加载时间: ${loadTime})`, 'success');
}

function resetConfigWithConfirm() {
    document.getElementById('resetModal').classList.add('show');
}

function closeResetModal(event) {
    if (event && event.target.id !== 'resetModal') return;
    document.getElementById('resetModal').classList.remove('show');
}

async function confirmReset() {
    try {
        const response = await fetch('/admin/init');
        if (!response.ok) throw new Error('重置失败');
        
        closeResetModal();
        showToast('配置已重置为默认值', 'success');
        
        // 延迟1秒后刷新页面，让用户看到成功提示
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    } catch (error) {
        showToast('重置失败: ' + error.message, 'error');
    }
}

function logout() {
    window.location.href = '/logout';
}

function showToast(message, type = 'info') {
    // 移除现有的toast
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }
    
    // 创建新的toast
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    // 显示动画
    setTimeout(() => toast.classList.add('show'), 10);
    
    // 自动隐藏
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// 日志类型翻译
function translateLogType(type, ua = '') {
    // 如果是 Get_SUB 类型，检查 UA 是否包含 subconverter
    if (type === 'Get_SUB') {
        const uaLowercase = (ua || '').toLowerCase();
        if (uaLowercase.includes('subconverter')) {
            return { text: '订阅转换', color: '#3b82f6' };
        }
        return { text: '获取订阅', color: '#10b981' };
    }
    
    const typeMap = {
        'Admin_Login': { text: '登录后台', color: '#f59e0b' },
        'Save_Config': { text: '保存配置', color: '#8b5cf6' },
        'Init_Config': { text: '重置配置', color: '#ef4444' },
        'Save_Custom_IPs': { text: '自定义优选', color: '#06b6d4' }
    };
    return typeMap[type] || { text: type, color: '#6b7280' };
}

// 格式化时间戳为 UTC+8
function formatTime(timestamp) {
    const date = new Date(timestamp + 8 * 3600 * 1000);
    const year = date.getUTCFullYear();
    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
    const day = String(date.getUTCDate()).padStart(2, '0');
    const hours = String(date.getUTCHours()).padStart(2, '0');
    const minutes = String(date.getUTCMinutes()).padStart(2, '0');
    const seconds = String(date.getUTCSeconds()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

// 在展开日志模块时加载日志
let logsLoaded = false;
function loadLogsOnExpand(titleEl) {
    const module = titleEl.parentElement;
    const isCollapsed = module.classList.contains('collapsed');
    
    // 如果是展开状态且还未加载过日志，则加载
    if (!isCollapsed && !logsLoaded) {
        loadLogs();
    }
}

// 加载最近8条日志
async function loadLogs() {
    try {
        const response = await fetch('/admin/log.json?t=' + Date.now());
        if (!response.ok) throw new Error('加载日志失败');
        const logs = await response.json();
        logsLoaded = true;
        
        // 按时间从新到旧排序，取前6条
        const recentLogs = logs.sort((a, b) => b.TIME - a.TIME).slice(0, 6);
        
        const container = document.getElementById('logsContainer');
        if (recentLogs.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;">暂无日志记录</div>';
            return;
        }
        
        // 检查是否为移动设备
        const isMobile = window.innerWidth <= 768;
        
        let html = '<table style="width: 100%; border-collapse: collapse;">';
        if (isMobile) {
            // 移动设备：显示时间、IP、操作
            html += '<thead><tr style="border-bottom: 2px solid #e5e7eb;"><th style="text-align: left; padding: 10px; font-weight: 600;">时间 (UTC+8)</th><th style="text-align: left; padding: 10px; font-weight: 600;">IP</th><th style="text-align: left; padding: 10px; font-weight: 600;">操作</th></tr></thead>';
        } else {
            // 桌面设备：显示时间、IP、地区、操作
            html += '<thead><tr style="border-bottom: 2px solid #e5e7eb;"><th style="text-align: left; padding: 10px; font-weight: 600;">时间 (UTC+8)</th><th style="text-align: left; padding: 10px; font-weight: 600;">IP</th><th style="text-align: left; padding: 10px; font-weight: 600;">地区</th><th style="text-align: left; padding: 10px; font-weight: 600;">操作</th></tr></thead>';
        }
        html += '<tbody>';
        
        recentLogs.forEach(log => {
            const logType = translateLogType(log.TYPE, log.UA);
            const cc = log.CC || '未知';
            const timeStr = formatTime(log.TIME);
            const ip = log.IP || '未知';
            
            if (isMobile) {
                // 移动设备：不显示地区
                html += `<tr style="border-bottom: 1px solid #f3f4f6;"><td style="padding: 10px; font-size: 12px;">${timeStr}</td><td style="padding: 10px; font-family: monospace; font-size: 12px;">${ip}</td><td style="padding: 10px;"><span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 12px; color: #fff; background-color: ${logType.color};">${logType.text}</span></td></tr>`;
            } else {
                // 桌面设备：显示地区
                html += `<tr style="border-bottom: 1px solid #f3f4f6;"><td style="padding: 10px;">${timeStr}</td><td style="padding: 10px; font-family: monospace; font-size: 12px;">${ip}</td><td style="padding: 10px;">${cc}</td><td style="padding: 10px;"><span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 12px; color: #fff; background-color: ${logType.color};">${logType.text}</span></td></tr>`;
            }
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    } catch (error) {
        const container = document.getElementById('logsContainer');
        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #ef4444;">加载日志失败: ${error.message}</div>`;
    }
}

// 显示全部日志
async function showAllLogs() {
    try {
        const response = await fetch('/admin/log.json?t=' + Date.now());
        if (!response.ok) throw new Error('加载日志失败');
        const logs = await response.json();
        
        // 按时间从新到旧排序
        const sortedLogs = logs.sort((a, b) => b.TIME - a.TIME);
        
        const container = document.getElementById('allLogsContainer');
        let html = '<table style="width: 100%; border-collapse: collapse; font-size: 12px; table-layout: auto;">';
        html += '<thead><tr style="border-bottom: 2px solid #e5e7eb; background: #f9fafb; white-space: nowrap;"><th style="text-align: left; padding: 10px; font-weight: 600; width: 160px;">时间 (UTC+8)</th><th style="text-align: left; padding: 10px; font-weight: 600; width: 120px;">IP</th><th style="text-align: left; padding: 10px; font-weight: 600; width: 80px;">地区</th><th style="text-align: left; padding: 10px; font-weight: 600; width: 80px;">ASN</th><th style="text-align: left; padding: 10px; font-weight: 600; width: 150px;">操作</th><th style="text-align: left; padding: 10px; font-weight: 600; flex: 1; min-width: 300px;">URL</th><th style="text-align: left; padding: 10px; font-weight: 600; flex: 1; min-width: 200px;">UA</th></tr></thead>';
        html += '<tbody>';
        
        sortedLogs.forEach(log => {
            const logType = translateLogType(log.TYPE, log.UA);
            const cc = log.CC || '未知';
            const asn = log.ASN || '未知';
            const timeStr = formatTime(log.TIME);
            const ip = log.IP || '未知';
            const url = log.URL || '无';
            const ua = log.UA ? log.UA.substring(0, 60) : '无';
            
            html += `<tr style="border-bottom: 1px solid #f3f4f6;"><td style="text-align: left; padding: 8px; white-space: nowrap; width: 160px; font-size: 11px;">${timeStr}</td><td style="text-align: left; padding: 8px; font-family: monospace; font-size: 10px; white-space: nowrap; width: 120px; word-break: break-word;">${ip}</td><td style="text-align: left; padding: 8px; white-space: nowrap; width: 80px; font-size: 11px;">${cc}</td><td style="text-align: left; padding: 8px; white-space: nowrap; width: 80px; font-size: 11px; font-family: monospace;">${asn}</td><td style="text-align: left; padding: 8px; width: 150px;"><span style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; color: #fff; background-color: ${logType.color}; white-space: nowrap;">${logType.text}</span></td><td style="text-align: left; padding: 8px; font-size: 11px; word-break: break-word; min-width: 300px;">${url}</td><td style="text-align: left; padding: 8px; font-size: 10px; color: #6b7280; min-width: 200px; word-break: break-word;">${ua}</td></tr>`;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
        document.getElementById('logsModal').classList.add('show');
    } catch (error) {
        showToast('加载日志失败: ' + error.message, 'error');
    }
}

// 关闭日志模态框
function closeLogsModal(event) {
    if (event && event.target.id !== 'logsModal') return;
    document.getElementById('logsModal').classList.remove('show');
}

function openSubAPIModal() {
    const currentValue = document.getElementById('subAPI').value;
    document.getElementById('testSubAPIInput').value = currentValue;
    document.getElementById('subAPIStatus').style.display = 'none';
    document.getElementById('subAPIStatus').textContent = '';
    document.getElementById('subAPIConfirmBtn').disabled = true;
    document.getElementById('subAPIConfirmBtn').style.opacity = '0.5';
    document.getElementById('subAPIModal').classList.add('show');
}

function closeSubAPIModal(event) {
    if (event && event.target.id !== 'subAPIModal') return;
    document.getElementById('subAPIModal').classList.remove('show');
    document.getElementById('testSubAPIInput').value = '';
    document.getElementById('subAPIStatus').style.display = 'none';
}

function normalizeSubAPIURL(url) {
    url = url.trim();
    if (!url) return null;
    
    let parsedURL;
    
    if (!url.includes('://')) {
        url = 'https://' + url;
    }
    
    try {
        parsedURL = new URL(url);
    } catch (e) {
        return null;
    }
    
    const baseURL = parsedURL.origin;
    return baseURL;
}

async function testSubAPI() {
    const input = document.getElementById('testSubAPIInput').value.trim();
    if (!input) {
        showStatus('请输入地址', 'error');
        return;
    }
    
    const baseURL = normalizeSubAPIURL(input);
    if (!baseURL) {
        showStatus('地址格式无效', 'error');
        return;
    }
    
    const testURL = baseURL + '/version';
    const statusEl = document.getElementById('subAPIStatus');
    const buttons = document.querySelectorAll('#subAPIModal button.btn');
    const testBtn = buttons[0];
    
    try {
        testBtn.disabled = true;
        statusEl.textContent = '⏳ 检测中...';
        statusEl.style.display = 'block';
        statusEl.style.background = 'linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%)';
        statusEl.style.color = '#fff';
        
        const response = await fetch(testURL, {
            method: 'GET'
        });
        
        if (response.status === 200) {
            const content = await response.text();
            const lowerContent = content.toLowerCase();
            
            if (lowerContent.includes('subconverter')) {
                statusEl.style.background = 'linear-gradient(135deg, #10b981 0, #059669 100%)';
                statusEl.textContent = '✅ ' + content;
                document.getElementById('subAPIConfirmBtn').disabled = false;
                document.getElementById('subAPIConfirmBtn').style.opacity = '1';
                document.getElementById('subAPIConfirmBtn').dataset.validURL = baseURL;
            } else {
                statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                statusEl.textContent = '❌ 响应内容无效';
                document.getElementById('subAPIConfirmBtn').disabled = true;
                document.getElementById('subAPIConfirmBtn').style.opacity = '0.5';
            }
        } else {
            statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
            statusEl.textContent = '❌ 请求失败 (HTTP ' + response.status + ')';
            document.getElementById('subAPIConfirmBtn').disabled = true;
            document.getElementById('subAPIConfirmBtn').style.opacity = '0.5';
        }
    } catch (error) {
        statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
        statusEl.textContent = '❌ 检测失败: ' + error.message;
        document.getElementById('subAPIConfirmBtn').disabled = true;
        document.getElementById('subAPIConfirmBtn').style.opacity = '0.5';
    } finally {
        testBtn.disabled = false;
    }
}

function showStatus(message, type) {
    const statusEl = document.getElementById('subAPIStatus');
    const prefix = type === 'error' ? '❌' : 'ℹ️';
    statusEl.textContent = prefix + ' ' + message;
    statusEl.style.display = 'block';
    if (type === 'error') {
        statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
    } else {
        statusEl.style.background = 'linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%)';
    }
    statusEl.style.color = '#fff';
}

function confirmSubAPI() {
    const validURL = document.getElementById('subAPIConfirmBtn').dataset.validURL;
    if (!validURL) return;
    
    document.getElementById('subAPI').value = validURL;
    markModified('convert');
    closeSubAPIModal();
}

// ==================== 消息通知设置相关函数 ====================

// 打开 TelegramBot 配置模态框
function openTelegramConfigModal() {
    document.getElementById('telegramConfigModal').classList.add('show');
    // 如果已有配置，加载到输入框
    // 兼容两种config结构：TG 或 通知.Telegram
    const botToken = currentConfig.TG?.BotToken || currentConfig.通知?.Telegram?.BotToken || '';
    const chatID = currentConfig.TG?.ChatID || currentConfig.通知?.Telegram?.ChatID || '';
    document.getElementById('telegramBotToken').value = botToken;
    document.getElementById('telegramChatID').value = chatID;
}

// 关闭 TelegramBot 配置模态框
function closeTelegramConfigModal(event) {
    if (event && event.target.id !== 'telegramConfigModal') return;
    document.getElementById('telegramConfigModal').classList.remove('show');
}

// 测试 TelegramBot 连接
function testTelegramConfig() {
    const token = document.getElementById('telegramBotToken').value.trim();
    const chatID = document.getElementById('telegramChatID').value.trim();
    
    if (!token || !chatID) {
        showToast('请填写Bot Token和Chat ID', 'error');
        return;
    }
    
    showToast('✅ TelegramBot 配置有效 (测试模式)', 'success');
}

// 保存 TelegramBot 配置
function confirmTelegramConfig() {
    const token = document.getElementById('telegramBotToken').value.trim();
    const chatID = document.getElementById('telegramChatID').value.trim();
    
    if (!token && !chatID) {
        // 如果都为空，则认为是禁用
        if (!currentConfig.TG) currentConfig.TG = {};
        currentConfig.TG.BotToken = '';
        currentConfig.TG.ChatID = '';
    } else if (token && chatID) {
        if (!currentConfig.TG) currentConfig.TG = {};
        currentConfig.TG.BotToken = token;
        currentConfig.TG.ChatID = chatID;
    } else {
        showToast('请填写完整的Bot Token和Chat ID', 'error');
        return;
    }
    
    markModified('notification');
    closeTelegramConfigModal();
}

// 打开 Cloudflare 配置模态框
function openCloudflareConfigModal() {
    document.getElementById('cloudflareConfigModal').classList.add('show');
    // 如果已有配置，加载到输入框
    if (currentConfig.通知?.Cloudflare) {
        document.getElementById('cloudflareToken').value = currentConfig.通知?.Cloudflare?.Token || '';
        document.getElementById('cloudflareZoneID').value = currentConfig.通知?.Cloudflare?.ZoneID || '';
        document.getElementById('cloudflareThreshold').value = currentConfig.通知?.Cloudflare?.Threshold || '20';
    }
}

// 关闭 Cloudflare 配置模态框
function closeCloudflareConfigModal(event) {
    if (event && event.target.id !== 'cloudflareConfigModal') return;
    document.getElementById('cloudflareConfigModal').classList.remove('show');
}

// 测试 Cloudflare 连接
function testCloudflareConfig() {
    const token = document.getElementById('cloudflareToken').value.trim();
    const zoneID = document.getElementById('cloudflareZoneID').value.trim();
    
    if (!token || !zoneID) {
        showToast('请填写API Token和Zone ID', 'error');
        return;
    }
    
    showToast('✅ Cloudflare 配置有效 (测试模式)', 'success');
}

// 保存 Cloudflare 配置
function confirmCloudflareConfig() {
    const token = document.getElementById('cloudflareToken').value.trim();
    const zoneID = document.getElementById('cloudflareZoneID').value.trim();
    const threshold = parseInt(document.getElementById('cloudflareThreshold').value) || 20;
    
    if (!token || !zoneID) {
        showToast('请填写完整的API Token和Zone ID', 'error');
        return;
    }
    
    if (threshold < 1 || threshold > 100) {
        showToast('通知阈值必须在1-100之间', 'error');
        return;
    }
    
    if (!currentConfig.通知) currentConfig.通知 = {};
    currentConfig.通知.Cloudflare = { Token: token, ZoneID: zoneID, Threshold: threshold };
    
    markModified('notification');
    closeCloudflareConfigModal();
}

// 保存通知设置
async function saveNotification() {
    // 将通知配置保存到 currentConfig
    currentConfig.通知 = {
        Telegram: {
            BotToken: document.getElementById('telegramBotToken').value || '',
            ChatID: document.getElementById('telegramChatID').value || ''
        },
        Cloudflare: currentConfig.通知?.Cloudflare || {}
    };
    
    // 如果启用了TelegramBot，确保相关配置不为空
    if (document.getElementById('telegramEnabled').checked) {
        if (!document.getElementById('telegramBotToken').value || !document.getElementById('telegramChatID').value) {
            showToast('请先配置TelegramBot的参数', 'error');
            return;
        }
    }
    
    await saveConfigToServer('notification');
}

// 取消通知设置编辑
function cancelEdit(section) {
    if (section === 'notification') {
        // 重置通知模块的所有输入
        document.getElementById('telegramEnabled').checked = currentConfig.通知?.Telegram?.BotToken ? true : false;
        currentConfig = JSON.parse(JSON.stringify(originalConfig));
    } else {
        // 原有的cancelEdit逻辑
        currentConfig = JSON.parse(JSON.stringify(originalConfig));
        
        if (section === 'sub') {
            const local = currentConfig.优选订阅生成?.local ?? true;
            const randomIP = currentConfig.优选订阅生成?.本地IP库?.随机IP ?? true;
            
            if (!local) {
                document.getElementById('ipMode').value = 'generator';
                document.getElementById('generatorURL').value = currentConfig.优选订阅生成?.SUB || '';
            } else if (randomIP) {
                document.getElementById('ipMode').value = 'random';
                document.getElementById('randomCount').value = currentConfig.优选订阅生成?.本地IP库?.随机数量 || 16;
            } else {
                document.getElementById('ipMode').value = 'custom';
                loadCustomIPs();
            }
            updateIPMode();
        } else if (section === 'config') {
            document.getElementById('subName').value = currentConfig.优选订阅生成?.SUBNAME || '';
            document.getElementById('nodeHost').value = currentConfig.HOST || '';
            document.getElementById('nodeUUID').value = currentConfig.UUID || '';
            document.getElementById('protocol').value = currentConfig.协议类型 || 'vless';
            document.getElementById('skipVerify').checked = currentConfig.跳过证书验证 || false;
            updateProtocol();
        } else if (section === 'proxy') {
            const socksEnabled = currentConfig.反代?.SOCKS5?.启用;
            if (!socksEnabled) {
                document.getElementById('proxyMode').value = 'auto';
                document.getElementById('proxyIP').value = currentConfig.反代?.PROXYIP || '';
                document.getElementById('autoProxy').checked = (currentConfig.反代?.PROXYIP === 'auto');
                if (currentConfig.反代?.PROXYIP === 'auto') {
                    document.getElementById('proxyIP').disabled = true;
                }
            } else if (socksEnabled === 'socks5') {
                document.getElementById('proxyMode').value = 'socks5';
                document.getElementById('socks5Addr').value = currentConfig.反代?.SOCKS5?.账号 || '';
                document.getElementById('globalSocks5').checked = currentConfig.反代?.SOCKS5?.全局 || false;
            } else if (socksEnabled === 'http') {
                document.getElementById('proxyMode').value = 'http';
                document.getElementById('httpAddr').value = currentConfig.反代?.SOCKS5?.账号 || '';
                document.getElementById('globalHTTP').checked = currentConfig.反代?.SOCKS5?.全局 || false;
            }
            updateProxyMode();
        } else if (section === 'convert') {
            document.getElementById('subAPI').value = currentConfig.订阅转换配置?.SUBAPI || '';
            document.getElementById('subConfig').value = currentConfig.订阅转换配置?.SUBCONFIG || '';
            document.getElementById('emoji').checked = currentConfig.订阅转换配置?.SUBEMOJI || false;
        }
    }
    
    modifiedSections.delete(section);
    updateButtonStates();
}

// 初始化
initializeTheme();
window.addEventListener('DOMContentLoaded', loadConfig);
</script>
</body>
</html>